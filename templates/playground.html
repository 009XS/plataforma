{% extends "base.html" %}
{% block title %}Playground de Código | EduPlatform{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
{% endblock %}
{% block content %}
<div class="flex h-screen">
    <!-- Sidebar -->
    <div class="w-16 bg-dark-900 flex flex-col items-center py-4 space-y-4">
        <a href="/panel-alumno"
            class="w-10 h-10 rounded-lg hover:bg-dark-800 flex items-center justify-center text-gray-400 hover:text-white"
            title="Volver">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div class="flex-1"></div>
        <button onclick="runCode()"
            class="w-10 h-10 rounded-lg bg-green-600 flex items-center justify-center text-white hover:bg-green-700"
            title="Ejecutar">
            <i class="fas fa-play"></i>
        </button>
        <button onclick="saveCode()"
            class="w-10 h-10 rounded-lg hover:bg-dark-800 flex items-center justify-center text-gray-400 hover:text-white"
            title="Guardar">
            <i class="fas fa-save"></i>
        </button>
        <button onclick="formatCode()"
            class="w-10 h-10 rounded-lg hover:bg-dark-800 flex items-center justify-center text-gray-400 hover:text-white"
            title="Formatear">
            <i class="fas fa-align-left"></i>
        </button>
    </div>

    <!-- Main Editor Area -->
    <div class="flex-1 flex flex-col">
        <!-- Toolbar -->
        <div class="bg-dark-800 px-4 py-2 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <select id="language" class="bg-dark-700 text-white px-4 py-2 rounded-lg border-none">
                    <option value="python">Python</option>
                    <option value="javascript">JavaScript</option>
                    <option value="java">Java</option>
                    <option value="cpp">C++</option>
                    <option value="html">HTML</option>
                </select>
                <input type="text" id="filename" value="main.py"
                    class="bg-dark-700 text-white px-4 py-2 rounded-lg border-none w-48">
            </div>
            <div class="flex items-center space-x-2 text-gray-400 text-sm">
                <span id="status">Listo</span>
            </div>
        </div>

        <!-- Code Editor -->
        <div class="flex-1 flex">
            <div class="flex-1">
                <textarea id="code-editor" class="w-full h-full"># Escribe tu código aquí
print("¡Hola, mundo!")
</textarea>
            </div>
        </div>

        <!-- Output Panel -->
        <div class="h-48 bg-dark-900 border-t border-dark-700">
            <div class="flex items-center justify-between px-4 py-2 border-b border-dark-700">
                <span class="text-white font-medium">Consola</span>
                <button onclick="clearOutput()" class="text-gray-400 hover:text-white text-sm">
                    <i class="fas fa-trash mr-1"></i>Limpiar
                </button>
            </div>
            <pre id="output" class="p-4 text-green-400 font-mono text-sm overflow-auto h-full"></pre>
        </div>
    </div>

    <!-- AI Assistant Sidebar -->
    <div class="w-80 bg-white border-l flex flex-col">
        <div class="p-4 border-b">
            <h3 class="font-bold text-gray-800"><i class="fas fa-robot text-brand-500 mr-2"></i>Asistente IA</h3>
        </div>
        <div class="flex-1 overflow-auto p-4" id="ai-chat">
            <div class="bg-gray-100 rounded-lg p-3 mb-3">
                <p class="text-sm text-gray-700">¡Hola! Soy tu asistente de código. Puedo ayudarte a:</p>
                <ul class="text-sm text-gray-600 mt-2 list-disc list-inside">
                    <li>Explicar código</li>
                    <li>Encontrar errores</li>
                    <li>Sugerir mejoras</li>
                    <li>Generar código</li>
                </ul>
            </div>
        </div>
        <div class="p-4 border-t">
            <div class="flex space-x-2">
                <input type="text" id="ai-input" placeholder="Pregunta algo..."
                    class="flex-1 px-4 py-2 border rounded-lg text-sm">
                <button onclick="askAI()" class="bg-brand-600 text-white px-4 py-2 rounded-lg"><i
                        class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
<script>
    const editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
        mode: 'python',
        theme: 'dracula',
        lineNumbers: true,
        autoCloseBrackets: true,
        indentUnit: 4,
        tabSize: 4
    });
    editor.setSize('100%', '100%');

    async function runCode() {
        const code = editor.getValue();
        const lang = document.getElementById('language').value;
        document.getElementById('status').textContent = 'Ejecutando...';

        try {
            const res = await fetch('/api/compilar_codigo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code, language: lang })
            });
            const data = await res.json();
            document.getElementById('output').textContent = data.output || data.error || 'Sin salida';
            document.getElementById('status').textContent = data.success ? 'Ejecutado' : 'Error';
        } catch (e) {
            document.getElementById('output').textContent = 'Error de conexión';
            document.getElementById('status').textContent = 'Error';
        }
    }

    function clearOutput() {
        document.getElementById('output').textContent = '';
    }

    async function askAI() {
        const input = document.getElementById('ai-input');
        const question = input.value;
        if (!question) return;

        const chat = document.getElementById('ai-chat');
        chat.innerHTML += `<div class="bg-brand-100 rounded-lg p-3 mb-3 ml-8"><p class="text-sm">${question}</p></div>`;
        input.value = '';

        try {
            const res = await fetch('/api/ai-chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: question, code: editor.getValue() })
            });
            const data = await res.json();
            chat.innerHTML += `<div class="bg-gray-100 rounded-lg p-3 mb-3"><p class="text-sm">${data.response}</p></div>`;
            chat.scrollTop = chat.scrollHeight;
        } catch (e) {
            chat.innerHTML += `<div class="bg-red-100 rounded-lg p-3 mb-3"><p class="text-sm text-red-600">Error de conexión</p></div>`;
        }
    }
</script>
{% endblock %}