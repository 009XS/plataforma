<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Pagos - EduPlatform</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #F8F9FA 0%, #FFFFFF 100%);
            min-height: 100vh;
        }

        .navbar {
            background: #FFFFFF;
            padding: 15px 0;
            box-shadow: rgba(0, 0, 0, 0.1) 0px 2px 8px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #000000;
        }

        .logo span {
            color: #8A6BBE;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #8A6BBE, #5A9BD5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .back-btn {
            background: none;
            border: 2px solid #8A6BBE;
            color: #8A6BBE;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .back-btn:hover {
            background: #8A6BBE;
            color: white;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .page-header {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            text-align: center;
        }

        .page-header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .page-header p {
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .stat-card {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 25px;
            box-shadow: rgba(0, 0, 0, 0.1) 0px 4px 12px;
            text-align: center;
        }

        .stat-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #000;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        .stat-value.warning {
            color: #dc2626;
        }

        .stat-value.success {
            color: #059669;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 968px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 25px;
            box-shadow: rgba(0, 0, 0, 0.1) 0px 4px 12px;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #E8E9EA;
        }

        .card-icon {
            font-size: 24px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #000000;
        }

        .pago-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border: 1px solid #E8E9EA;
            border-radius: 10px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .pago-item:hover {
            border-color: #8A6BBE;
            background: rgba(138, 107, 190, 0.02);
        }

        .pago-info {
            flex: 1;
        }

        .pago-info h4 {
            font-size: 14px;
            font-weight: 600;
            color: #000;
            margin-bottom: 4px;
        }

        .pago-info p {
            font-size: 12px;
            color: #666;
        }

        .pago-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        .pago-alumno {
            font-size: 11px;
            padding: 3px 8px;
            background: rgba(90, 155, 213, 0.1);
            color: #5A9BD5;
            border-radius: 10px;
        }

        .pago-monto {
            font-size: 16px;
            font-weight: 700;
            margin-right: 15px;
        }

        .pago-monto.pendiente {
            color: #dc2626;
        }

        .pago-monto.pagado {
            color: #059669;
        }

        .pago-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-pendiente {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }

        .status-pagado {
            background: rgba(34, 197, 94, 0.1);
            color: #059669;
        }

        .btn-pagar {
            padding: 8px 16px;
            background: linear-gradient(135deg, #5A9BD5, #8A6BBE);
            color: white;
            border: none;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-pagar:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(90, 155, 213, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .historial-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-left: 3px solid #059669;
            background: rgba(5, 150, 105, 0.05);
            border-radius: 0 10px 10px 0;
            margin-bottom: 10px;
        }

        .historial-icon {
            font-size: 20px;
            margin-right: 15px;
        }

        .historial-info {
            flex: 1;
        }

        .historial-info h4 {
            font-size: 13px;
            font-weight: 600;
            color: #000;
        }

        .historial-info p {
            font-size: 11px;
            color: #666;
        }

        .historial-monto {
            font-size: 14px;
            font-weight: 600;
            color: #059669;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-tab {
            padding: 8px 16px;
            border: 2px solid #E8E9EA;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .filter-tab:hover {
            border-color: #8A6BBE;
        }

        .filter-tab.active {
            background: linear-gradient(135deg, #8A6BBE, #5A9BD5);
            color: white;
            border-color: transparent;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                Edu<span>Platform</span>
            </div>
            <div class="user-info">
                <div class="user-avatar">{{ iniciales }}</div>
                <a href="{{ url_for('panel_tutor') }}" class="back-btn">‚Üê Volver al Panel</a>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="page-header">
            <h1>üí∞ Historial de Pagos</h1>
            <p>Consulta los pagos pendientes y el historial de colegiaturas</p>
        </div>

        <!-- Estad√≠sticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üí≥</div>
                <div class="stat-value warning" id="statPendiente">$0.00</div>
                <div class="stat-label">Total Pendiente</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-value" id="statPagosRealizados">0</div>
                <div class="stat-label">Pagos Realizados</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üë®‚Äçüéì</div>
                <div class="stat-value" id="statHijos">{{ hijos | length }}</div>
                <div class="stat-label">Estudiantes</div>
            </div>
        </div>

        <div class="content-grid">
            <!-- Pagos Pendientes -->
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">‚ö†Ô∏è</span>
                    <h2 class="card-title">Pagos Pendientes</h2>
                </div>

                <div id="pendientesContainer">
                    <div class="loading">‚è≥ Cargando...</div>
                </div>
            </div>

            <!-- Historial de Pagos -->
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">‚úÖ</span>
                    <h2 class="card-title">Historial de Pagos</h2>
                </div>

                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="filtrarHistorial('todos', this)">Todos</button>
                    {% for hijo in hijos %}
                    <button class="filter-tab" onclick="filtrarHistorial('{{ hijo.id }}', this)">{{
                        hijo.nombre.split()[0] }}</button>
                    {% endfor %}
                </div>

                <div id="historialContainer">
                    <div class="loading">‚è≥ Cargando...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allHistorial = [];

        async function cargarPagos() {
            try {
                const response = await fetch('/api/tutor/pagos/historial');
                const data = await response.json();

                if (data.error) {
                    document.getElementById('pendientesContainer').innerHTML = `<p style="color:red;">${data.error}</p>`;
                    return;
                }

                // Actualizar estad√≠sticas
                document.getElementById('statPendiente').textContent = `$${data.resumen.total_pendiente.toFixed(2)}`;
                document.getElementById('statPagosRealizados').textContent = data.resumen.pagos_realizados;

                // Renderizar pendientes
                renderPendientes(data.pendientes);

                // Guardar y renderizar historial
                allHistorial = data.historial;
                renderHistorial(allHistorial);

            } catch (err) {
                console.error(err);
                document.getElementById('pendientesContainer').innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
            }
        }

        function renderPendientes(pendientes) {
            const container = document.getElementById('pendientesContainer');

            if (pendientes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéâ</div>
                        <p>¬°No hay pagos pendientes!</p>
                    </div>
                `;
                return;
            }

            let html = '';
            pendientes.forEach(p => {
                html += `
                    <div class="pago-item">
                        <div class="pago-info">
                            <h4>${p.concepto || 'Pago'}</h4>
                            <p>Vence: ${p.fecha_vencimiento || 'Sin fecha'}</p>
                            <div class="pago-meta">
                                <span class="pago-alumno">üë§ ${p.alumno_nombre}</span>
                            </div>
                        </div>
                        <span class="pago-monto pendiente">$${p.monto.toFixed(2)}</span>
                        <button class="btn-pagar" onclick="simularPago(${p.id})">
                            üí≥ Pagar
                        </button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderHistorial(historial) {
            const container = document.getElementById('historialContainer');

            if (historial.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No hay pagos registrados</p>
                    </div>
                `;
                return;
            }

            let html = '';
            historial.forEach(h => {
                html += `
                    <div class="historial-item" data-alumno="${h.alumno_id || ''}">
                        <span class="historial-icon">‚úÖ</span>
                        <div class="historial-info">
                            <h4>${h.concepto || 'Pago'}</h4>
                            <p>${h.fecha_pago || 'Sin fecha'} ‚Ä¢ ${h.alumno_nombre || ''}</p>
                        </div>
                        <span class="historial-monto">$${(h.monto || 0).toFixed(2)}</span>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function filtrarHistorial(filtro, btn) {
            // Actualizar tabs activos
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');

            if (filtro === 'todos') {
                renderHistorial(allHistorial);
            } else {
                const filtrado = allHistorial.filter(h => h.alumno_id == filtro);
                renderHistorial(filtrado);
            }
        }

        function simularPago(pagoId) {
            if (!confirm('¬øDesea simular el pago? (Esto conectar√° con Stripe en producci√≥n)')) return;

            alert('‚è≥ Conectando con pasarela de pago...');
            setTimeout(() => {
                alert('‚úÖ Pago simulado exitosamente. En producci√≥n esto procesar√≠a el pago real.');
                location.reload();
            }, 1500);
        }

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', cargarPagos);
    </script>
</body>

</html>