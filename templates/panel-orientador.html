<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Orientador</title>
    <style type="text/css">
        @font-face {
            font-family: Poppins;
            font-style: normal;
            font-weight: 400;
            src: url(/cf-fonts/s/poppins/5.0.11/devanagari/400/normal.woff2);
            unicode-range: U+0900-097F, U+1CD0-1CF9, U+200C-200D, U+20A8, U+20B9, U+25CC, U+A830-A839, U+A8E0-A8FF;
            font-display: swap;
        }

        @font-face {
            font-family: Poppins;
            font-style: normal;
            font-weight: 400;
            src: url(/cf-fonts/s/poppins/5.0.11/latin-ext/400/normal.woff2);
            unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
            font-display: swap;
        }

        @font-face {
            font-family: Poppins;
            font-style: normal;
            font-weight: 400;
            src: url(/cf-fonts/s/poppins/5.0.11/latin/400/normal.woff2);
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
            font-display: swap;
        }

        @font-face {
            font-family: Poppins;
            font-style: normal;
            font-weight: 500;
            src: url(/cf-fonts/s/poppins/5.0.11/latin-ext/500/normal.woff2);
            unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
            font-display: swap;
        }

        @font-face {
            font-family: Poppins;
            font-style: normal;
            font-weight: 500;
            src: url(/cf-fonts/s/poppins/5.0.11/devanagari/500/normal.woff2);
            unicode-range: U+0900-097F, U+1CD0-1CF9, U+200C-200D, U+20A8, U+20B9, U+25CC, U+A830-A839, U+A8E0-A8FF;
            font-display: swap;
        }

        @font-face {
            font-family: Poppins;
            font-style: normal;
            font-weight: 500;
            src: url(/cf-fonts/s/poppins/5.0.11/latin/500/normal.woff2);
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
            font-display: swap;
        }

        @font-face {
            font-family: Poppins;
            font-style: normal;
            font-weight: 600;
            src: url(/cf-fonts/s/poppins/5.0.11/latin/600/normal.woff2);
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
            font-display: swap;
        }

        @font-face {
            font-family: Poppins;
            font-style: normal;
            font-weight: 600;
            src: url(/cf-fonts/s/poppins/5.0.11/devanagari/600/normal.woff2);
            unicode-range: U+0900-097F, U+1CD0-1CF9, U+200C-200D, U+20A8, U+20B9, U+25CC, U+A830-A839, U+A8E0-A8FF;
            font-display: swap;
        }

        @font-face {
            font-family: Poppins;
            font-style: normal;
            font-weight: 600;
            src: url(/cf-fonts/s/poppins/5.0.11/latin-ext/600/normal.woff2);
            unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
            font-display: swap;
        }

        @font-face {
            font-family: Poppins;
            font-style: normal;
            font-weight: 700;
            src: url(/cf-fonts/s/poppins/5.0.11/latin/700/normal.woff2);
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
            font-display: swap;
        }

        @font-face {
            font-family: Poppins;
            font-style: normal;
            font-weight: 700;
            src: url(/cf-fonts/s/poppins/5.0.11/devanagari/700/normal.woff2);
            unicode-range: U+0900-097F, U+1CD0-1CF9, U+200C-200D, U+20A8, U+20B9, U+25CC, U+A830-A839, U+A8E0-A8FF;
            font-display: swap;
        }

        @font-face {
            font-family: Poppins;
            font-style: normal;
            font-weight: 700;
            src: url(/cf-fonts/s/poppins/5.0.11/latin-ext/700/normal.woff2);
            unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
            font-display: swap;
        }
    </style>
    <!-- Select2 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #F8F9FA 0%, #FFFFFF 100%);
            min-height: 100vh;
            margin: 0;
        }

        .navbar {
            background: #FFFFFF;
            padding: 15px 0;
            box-shadow: rgba(0, 0, 0, 0.1) 0px 2px 8px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #000000;
        }

        .logo span {
            color: #8A6BBE;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #8A6BBE, #5A9BD5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .user-details h3 {
            font-size: 14px;
            color: #000000;
            font-weight: 600;
        }

        .user-details p {
            font-size: 12px;
            color: #666;
        }

        .logout-btn {
            background: none;
            border: 2px solid #8A6BBE;
            color: #8A6BBE;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .logout-btn:hover {
            background: #8A6BBE;
            color: white;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .welcome-section {
            grid-column: span 2;
            background: linear-gradient(135deg, #8A6BBE, #5A9BD5);
            color: white;
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 10px;
        }

        .welcome-section h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .welcome-section p {
            font-size: 16px;
            opacity: 0.9;
        }

        .card {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 25px;
            box-shadow: rgba(0, 0, 0, 0.1) 0px 4px 12px;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .card-icon {
            font-size: 24px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: #000000;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            color: #000000;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input[type="text"],
        input[type="date"],
        textarea,
        select {
            padding: 10px;
            font-size: 16px;
            border: 2px solid #8A6BBE;
            border-radius: 0.5rem;
            width: 100%;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #7a5ba8;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #8A6BBE;
            color: white;
            border: none;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            background-color: #7a5ba8;
            transform: scale(1.02);
        }

        /* Select2 overrides */
        .select2-container--default .select2-selection--single {
            border: 2px solid #8A6BBE !important;
            border-radius: 0.5rem !important;
            height: 45px !important;
            padding: 5px !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 35px !important;
            color: #000 !important;
            padding-left: 10px !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 40px !important;
            right: 10px !important;
        }

        .success-msg {
            color: #059669;
            background: rgba(34, 197, 94, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid rgba(34, 197, 94, 0.3);
            text-align: center;
        }

        .error-msg {
            color: #dc2626;
            background: rgba(239, 68, 68, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid rgba(239, 68, 68, 0.3);
            text-align: center;
        }

        .full-width {
            grid-column: span 2;
        }

        /* ESTILOS PARA HORARIOS */
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-container input {
            flex: 1;
        }

        .schedule-item {
            border: 2px solid #8A6BBE;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f5ff;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .schedule-item img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-top: 10px;
        }

        .schedule-item a {
            display: inline-block;
            margin-top: 10px;
            color: #8A6BBE;
            font-weight: 600;
            text-decoration: none;
        }

        .schedule-item a:hover {
            text-decoration: underline;
        }

        .no-schedules {
            color: #666;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
            }

            .welcome-section {
                grid-column: span 1;
            }

            .search-container {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>

    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">Edu<span>Platform</span></div>
            <div class="user-info">
                <div class="user-avatar">{{ iniciales }}</div>
                <div class="user-details">
                    <h3>{{ nombre }}</h3>
                    <p>{{ email }}</p>
                </div>
                <a href="{{ url_for('logout') }}" class="logout-btn"
                    onclick="return confirm('¿Estás seguro de que quieres cerrar sesión?')">
                    Cerrar Sesión
                </a>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="welcome-section">
            <h1>Bienvenido al Panel de Orientador</h1>
            <p>Gestiona reportes, horarios, avisos, justificantes y asistencias de manera eficiente.</p>
        </div>

        <!-- CARD REPORTES DE CONDUCTA -->
        <div class="card">
            <div class="card-header">
                <span class="card-icon">Reporte</span>
                <h2 class="card-title">Reportes de Conducta o Incumplimiento</h2>
            </div>
            <form id="report-form">
                <div class="form-group">
                    <label for="student-select">Nombre del Alumno</label>
                    <select id="student-select" style="width:100%;" required>
                        <option value="">Escribe al menos 3 letras para buscar...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="report-type">Tipo de Reporte</label>
                    <select id="report-type" required>
                        <option value="">Selecciona...</option>
                        <option value="conducta">Reporte de Conducta</option>
                        <option value="incumplimiento">Incumplimiento</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="report-description">Descripción</label>
                    <textarea id="report-description" placeholder="Describe el incidente con detalle..."
                        required></textarea>
                </div>
                <button type="submit" id="btn-enviar">Enviar Reporte</button>
            </form>
            <div id="report-results"></div>
        </div>

        <!-- CARD HORARIOS DE GRUPOS (100% REAL) -->
        <div class="card">
            <div class="card-header">
                <span class="card-icon">Horario</span>
                <h2 class="card-title">Acceso a Horarios de Grupos</h2>
            </div>
            <div class="search-container">
                <input type="text" id="group-search" placeholder="Ej: 1A, 303, 2B...">
                <button id="search-schedules">Buscar</button>
            </div>
            <div id="schedule-results">
                <p class="no-schedules">Escribe un grupo y presiona "Buscar"</p>
            </div>
        </div>

        <!-- CARD AVISOS Y RECORDATORIOS -->
        <div class="card">
            <div class="card-header">
                <span class="card-icon">Aviso</span>
                <h2 class="card-title">Avisos y Recordatorios</h2>
            </div>
            <form id="notice-form">
                <div class="form-group">
                    <label for="notice-target">Destinatario</label>
                    <input type="text" id="notice-target" placeholder="Ej: Grupo 1A o Juan Pérez" required>
                </div>
                <div class="form-group">
                    <label for="notice-type">Tipo</label>
                    <select id="notice-type" required>
                        <option value="">Selecciona...</option>
                        <option value="aviso">Aviso</option>
                        <option value="recordatorio">Recordatorio</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="notice-message">Mensaje</label>
                    <textarea id="notice-message" placeholder="Escribe el mensaje..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="notice-date">Fecha</label>
                    <input type="date" id="notice-date" required>
                </div>
                <button type="submit">Enviar Aviso</button>
            </form>
            <div id="notice-results"></div>
        </div>

        <!-- CARD JUSTIFICANTES -->
        <div class="card">
            <div class="card-header">
                <span class="card-icon">Justificante</span>
                <h2 class="card-title">Crear Justificantes</h2>
            </div>
            <form id="excuse-form">
                <div class="form-group">
                    <label for="excuse-student">Nombre del Alumno</label>
                    <input type="text" id="excuse-student" placeholder="Ej: Juan Pérez" required>
                </div>
                <div class="form-group">
                    <label for="excuse-date">Fecha de la Falta</label>
                    <input type="date" id="excuse-date" required>
                </div>
                <div class="form-group">
                    <label for="excuse-reason">Motivo</label>
                    <textarea id="excuse-reason" placeholder="Describe el motivo..." required></textarea>
                </div>
                <button type="submit">Generar Justificante</button>
            </form>
            <div id="excuse-results"></div>
        </div>

        <!-- CARD ASISTENCIAS -->
        <div class="card full-width">
            <div class="card-header">
                <span class="card-icon">Asistencia</span>
                <h2 class="card-title">Sistema de Asistencias</h2>
            </div>
            <form id="attendance-form">
                <div class="form-group">
                    <label for="attendance-group">Grupo</label>
                    <input type="text" id="attendance-group" placeholder="Ej: Grupo 1A" required>
                </div>
                <div class="form-group">
                    <label for="attendance-date">Fecha</label>
                    <input type="date" id="attendance-date" required>
                </div>
                <button type="button" id="load-students">Cargar Alumnos</button>
                <ul class="attendance-list" id="attendance-students"></ul>
                <button type="submit" style="display: none;" id="submit-attendance">Registrar Asistencias</button>
            </form>
            <div id="attendance-results"></div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function () {
            // === AUTOCOMPLETADO DE ALUMNOS ===
            $('#student-select').select2({
                placeholder: "Buscar alumno por nombre o número de control...",
                minimumInputLength: 3,
                allowClear: true,
                ajax: {
                    url: '/api/buscar_alumnos',
                    dataType: 'json',
                    delay: 400,
                    data: function (params) {
                        return { q: params.term };
                    },
                    processResults: function (data) {
                        return {
                            results: data.map(item => ({
                                id: item.id,
                                text: `${item.nombre} (${item.numero_control || 'Sin control'})`
                            }))
                        };
                    },
                    cache: true
                }
            });

            // === ENVÍO DE REPORTE ===
            $('#report-form').on('submit', function (e) {
                e.preventDefault();
                const btn = $('#btn-enviar');
                const results = $('#report-results');
                btn.prop('disabled', true).text('Enviando...');
                results.html('');

                const alumno_id = $('#student-select').val();
                const tipo = $('#report-type').val();
                const descripcion = $('#report-description').val().trim();

                if (!alumno_id || !tipo || !descripcion) {
                    results.html('<div class="error-msg">Completa todos los campos</div>');
                    btn.prop('disabled', false).text('Enviar Reporte');
                    return;
                }

                fetch('/api/enviar_reporte', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ alumno_id, tipo, descripcion })
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success || data.message) {
                            results.html(`<div class="success-msg">${data.message || data.success}</div>`);
                            $('#report-form')[0].reset();
                            $('#student-select').val(null).trigger('change');
                        } else {
                            results.html(`<div class="error-msg">${data.error || 'Error desconocido'}</div>`);
                        }
                    })
                    .catch(() => results.html('<div class="error-msg">Error de conexión</div>'))
                    .finally(() => btn.prop('disabled', false).text('Enviar Reporte'));
            });

            // === BUSCAR HORARIOS (REAL) ===
            function buscarHorarios() {
                const query = $('#group-search').val().trim().toUpperCase();
                const results = $('#schedule-results');

                if (!query) {
                    results.html('<p class="no-schedules">Escribe un grupo para buscar</p>');
                    return;
                }

                results.html('<p style="text-align:center; color:#666;">Buscando...</p>');

                fetch(`/api/buscar_horarios?grupo=${encodeURIComponent(query)}`)
                    .then(r => r.json())
                    .then(horarios => {
                        if (!horarios || horarios.length === 0) {
                            results.html('<p class="no-schedules">No se encontró horario para este grupo</p>');
                            return;
                        }

                        let html = '';
                        horarios.forEach(h => {
                            const url = `/uploads/${encodeURIComponent(h.archivo_ruta)}?t=${Date.now()}`;
                            const esImagen = /\.(jpg|jpeg|png|gif|webp)$/i.test(h.archivo_ruta);
                            html += `
                                <div class="schedule-item">
                                    <strong style="font-size:18px;">${h.grupo}</strong> 
                                    <small>(${h.semestre})</small><br><br>
                                    ${esImagen
                                    ? `<img src="${url}" alt="Horario ${h.grupo}">`
                                    : `<a href="${url}" target="_blank">Abrir PDF del horario</a>`
                                }
                                    <br><small style="color:#666; display:block; margin-top:8px;">
                                        Actualizado: ${new Date(h.fecha_actualizacion).toLocaleString('es-MX')}
                                    </small>

                                    <!-- BOTÓN ELIMINAR FLOTANTE -->
                                    <button onclick="eliminarHorario(${h.id}, '${h.archivo_ruta}', this)" 
                                            style="position:absolute; bottom:-15px; right:15px; width:44px; height:44px; background:#ef4444; color:white; border:none; border-radius:50%; cursor:pointer; font-size:18px; box-shadow:0 4px 12px rgba(239,68,68,0.4); display:flex; align-items:center; justify-content:center; z-index:10;"
                                            title="Eliminar horario">
                                        x
                                    </button>
                                </div>`;
                        });
                        results.html(html);
                    })
                    .catch(() => {
                        results.html('<div class="error-msg">Error al cargar horarios</div>');
                    });
            }

            $('#search-schedules').on('click', buscarHorarios);
            $('#group-search').on('keypress', function (e) {
                if (e.which === 13) buscarHorarios();
            });

            // === ELIMINAR HORARIO ===
            window.eliminarHorario = function (id, archivo_ruta, btn) {
                if (!confirm('¿Seguro que quieres eliminar este horario?')) return;

                btn.disabled = true;
                btn.innerHTML = '...';

                fetch('/api/eliminar_horario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, archivo_ruta })
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            btn.closest('.schedule-item').remove();
                            if ($('#schedule-results .schedule-item').length === 0) {
                                $('#schedule-results').html('<p class="no-schedules">No hay horarios</p>');
                            }
                        } else {
                            alert(data.error || 'Error al eliminar');
                            btn.disabled = false;
                            btn.innerHTML = 'x';
                        }
                    })
                    .catch(() => {
                        alert('Error de conexión');
                        btn.disabled = false;
                        btn.innerHTML = 'x';
                    });
            };

            // === ENVIAR AVISO REAL ===
            $('#notice-form').on('submit', function (e) {
                e.preventDefault();
                const btn = $(this).find('button[type="submit"]');
                const results = $('#notice-results');
                btn.prop('disabled', true).text('Enviando...');
                results.html('');

                const destinatario = $('#notice-target').val().trim();
                const tipo = $('#notice-type').val();
                const mensaje = $('#notice-message').val().trim();
                const fecha = $('#notice-date').val();

                if (!destinatario || !tipo || !mensaje) {
                    results.html('<div class="error-msg">Completa todos los campos</div>');
                    btn.prop('disabled', false).text('Enviar Aviso');
                    return;
                }

                fetch('/api/orientador/avisos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ destinatario, tipo, mensaje, fecha })
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            results.html(`<div class="success-msg">${data.message}</div>`);
                            $('#notice-form')[0].reset();
                        } else {
                            results.html(`<div class="error-msg">${data.error || 'Error desconocido'}</div>`);
                        }
                    })
                    .catch(() => results.html('<div class="error-msg">Error de conexión</div>'))
                    .finally(() => btn.prop('disabled', false).text('Enviar Aviso'));
            });

            // === GENERAR JUSTIFICANTE REAL ===
            $('#excuse-form').on('submit', function (e) {
                e.preventDefault();
                const btn = $(this).find('button[type="submit"]');
                const results = $('#excuse-results');
                btn.prop('disabled', true).text('Generando...');
                results.html('');

                const alumno = $('#excuse-student').val().trim();
                const fecha = $('#excuse-date').val();
                const motivo = $('#excuse-reason').val().trim();

                if (!alumno || !fecha || !motivo) {
                    results.html('<div class="error-msg">Completa todos los campos</div>');
                    btn.prop('disabled', false).text('Generar Justificante');
                    return;
                }

                fetch('/api/orientador/justificantes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ alumno, fecha, motivo })
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            results.html(`<div class="success-msg">${data.message}</div>`);
                            $('#excuse-form')[0].reset();
                        } else {
                            results.html(`<div class="error-msg">${data.error || 'Error desconocido'}</div>`);
                        }
                    })
                    .catch(() => results.html('<div class="error-msg">Error de conexión</div>'))
                    .finally(() => btn.prop('disabled', false).text('Generar Justificante'));
            });

            // === CARGAR ALUMNOS POR GRUPO (REAL) ===
            $('#load-students').on('click', function () {
                const grupo = $('#attendance-group').val().trim();
                const studentList = $('#attendance-students');

                if (!grupo) {
                    alert('Ingresa el nombre del grupo');
                    return;
                }

                studentList.html('<li style="padding:12px; color:#666;">Cargando alumnos...</li>');

                fetch(`/api/orientador/grupo/${encodeURIComponent(grupo)}/alumnos`)
                    .then(r => r.json())
                    .then(alumnos => {
                        if (!alumnos || alumnos.length === 0) {
                            studentList.html('<li style="padding:12px; color:#666;">No se encontraron alumnos</li>');
                            return;
                        }

                        let html = '';
                        alumnos.forEach(a => {
                            html += `
                                <li style="padding:8px; border-bottom:1px solid #eee;">
                                    <label>
                                        <input type="checkbox" checked data-id="${a.id}"> 
                                        ${a.nombre} (${a.numero_control || 'N/C'})
                                    </label>
                                </li>
                            `;
                        });
                        studentList.html(html);
                        $('#submit-attendance').show();
                    })
                    .catch(() => {
                        studentList.html('<li style="padding:12px; color:#ef4444;">Error al cargar</li>');
                    });
            });

            // === REGISTRAR ASISTENCIAS (REAL) ===
            $('#attendance-form').on('submit', function (e) {
                e.preventDefault();
                const btn = $('#submit-attendance');
                const results = $('#attendance-results');
                btn.prop('disabled', true).text('Registrando...');
                results.html('');

                const grupo = $('#attendance-group').val().trim();
                const fecha = $('#attendance-date').val();
                const asistencias = [];

                $('#attendance-students input[type="checkbox"]').each(function () {
                    asistencias.push({
                        alumno_id: $(this).data('id'),
                        presente: $(this).is(':checked')
                    });
                });

                if (!grupo || !fecha || asistencias.length === 0) {
                    results.html('<div class="error-msg">Completa todos los campos</div>');
                    btn.prop('disabled', false).text('Registrar Asistencias');
                    return;
                }

                fetch('/api/orientador/asistencias', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ grupo, fecha, asistencias })
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            results.html(`<div class="success-msg">${data.message}</div>`);
                            $('#attendance-students').html('');
                            $('#submit-attendance').hide();
                        } else {
                            results.html(`<div class="error-msg">${data.error || 'Error'}</div>`);
                        }
                    })
                    .catch(() => results.html('<div class="error-msg">Error de conexión</div>'))
                    .finally(() => btn.prop('disabled', false).text('Registrar Asistencias'));
            });

        });
    </script>
    <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'9a9e85902ec4c033',t:'MTc2NTA1MjgyMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
</body>

</html>