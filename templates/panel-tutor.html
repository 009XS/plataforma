{% extends "base.html" %}
{% block title %}Panel de Tutor | EduPlatform{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
{% endblock %}
{% block content %}

<body class="bg-slate-50 dark:bg-background-dark min-h-screen">
    <!-- Header con Estadísticas del Tutor -->
    <header id="header-stats" class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 text-white">
        <div class="max-w-md mx-auto p-6 pb-8">
            <!-- Perfil del Tutor -->
            <div class="flex items-center gap-4 mb-6">
                <div class="h-16 w-16 rounded-full border-4 border-white shadow-lg bg-cover bg-center" 
                    style="background-image: url('{{ foto_perfil or avatar_url or \'https://ui-avatars.com/api/?name=\' + nombre }}');"></div>
                <div class="flex-1">
                    <h1 class="text-xl font-bold">{{ nombre }}</h1>
                    <p class="text-sm opacity-90">Tutor Académico</p>
                    <p class="text-xs opacity-75">{{ estudiantes|length }} estudiante(s) asignado(s)</p>
                </div>
                <button onclick="toggleNotifications()" class="p-2 hover:bg-white/20 rounded-full relative">
                    <span class="material-symbols-outlined">notifications</span>
                    <span id="notif-badge" class="hidden absolute top-1 right-1 h-3 w-3 bg-red-500 rounded-full"></span>
                </button>
            </div>

            <!-- Cards de Estadísticas -->
            <div class="grid grid-cols-3 gap-3">
                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-3 text-center">
                    <p class="text-xs opacity-75 mb-1">Sesiones</p>
                    <p id="total-sesiones" class="text-2xl font-bold">-</p>
                    <p class="text-[10px] opacity-75">Este mes</p>
                </div>
                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-3 text-center">
                    <p class="text-xs opacity-75 mb-1">Alertas</p>
                    <p id="total-alertas" class="text-2xl font-bold">-</p>
                    <p class="text-[10px] opacity-75">Sin atender</p>
                </div>
                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-3 text-center">
                    <p class="text-xs opacity-75 mb-1">Citas</p>
                    <p id="total-citas" class="text-2xl font-bold">-</p>
                    <p class="text-[10px] opacity-75">Próximas</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-md mx-auto bg-white dark:bg-background-dark -mt-4 rounded-t-3xl shadow-xl min-h-screen pb-20 relative">
        <!-- Vista Dashboard (Principal) -->
        <div id="dashboard-view" class="p-4 space-y-4">
            <!-- Mis Estudiantes -->
            <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined text-indigo-500">school</span>
                    Mis Estudiantes
                </h3>
                <div id="estudiantes-list" class="space-y-2">
                    <p class="text-center text-slate-500 text-sm">Cargando estudiantes...</p>
                </div>
            </div>

            <!-- Alertas Recientes -->
            <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                        <span class="material-symbols-outlined text-orange-500">warning</span>
                        Alertas Recientes
                    </h3>
                    <button onclick="verTodasAlertas()" class="text-xs text-indigo-600 hover:text-indigo-700">Ver todas</button>
                </div>
                <div id="alertas-list" class="space-y-2">
                    <p class="text-center text-slate-500 text-sm">Cargando alertas...</p>
                </div>
            </div>

            <!-- Próximas Sesiones -->
            <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                        <span class="material-symbols-outlined text-green-500">event</span>
                        Próximas Sesiones
                    </h3>
                    <button onclick="agendarSesion()" class="text-xs text-indigo-600 hover:text-indigo-700">+ Nueva</button>
                </div>
                <div id="sesiones-list" class="space-y-2">
                    <p class="text-center text-slate-500 text-sm">Cargando sesiones...</p>
                </div>
            </div>

            <!-- Comunicados -->
            <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined text-blue-500">campaign</span>
                    Comunicados
                </h3>
                <div id="comunicados-list" class="space-y-2">
                    <p class="text-center text-slate-500 text-sm">Cargando comunicados...</p>
                </div>
            </div>
        </div>

        <!-- Vista Alertas -->
        <div id="alertas-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
            <div class="flex items-center gap-2 mb-2">
                <button onclick="showPanel('dashboard')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <h2 class="text-xl font-bold text-slate-900 dark:text-white">Alertas</h2>
            </div>
            <div id="alertas-container" class="flex flex-col gap-3"></div>
        </div>

        <!-- Vista Sesiones -->
        <div id="sesiones-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
            <div class="flex items-center gap-2 mb-2">
                <button onclick="showPanel('dashboard')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <h2 class="text-xl font-bold text-slate-900 dark:text-white">Sesiones de Tutoría</h2>
            </div>
            <button onclick="agendarSesion()" class="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl font-medium shadow-lg hover:shadow-xl transition mb-4">
                <span class="material-symbols-outlined inline-block align-middle">add</span>
                Agendar Nueva Sesión
            </button>
            <div id="sesiones-container" class="flex flex-col gap-3"></div>
        </div>

        <!-- Vista Observaciones -->
        <div id="observaciones-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
            <div class="flex items-center gap-2 mb-2">
                <button onclick="showPanel('dashboard')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <h2 class="text-xl font-bold text-slate-900 dark:text-white">Observaciones</h2>
            </div>
            <button onclick="crearObservacion()" class="w-full py-3 bg-gradient-to-r from-blue-500 to-cyan-600 text-white rounded-xl font-medium shadow-lg hover:shadow-xl transition mb-4">
                <span class="material-symbols-outlined inline-block align-middle">note_add</span>
                Nueva Observación
            </button>
            <div id="observaciones-container" class="flex flex-col gap-3"></div>
        </div>

        <!-- Vista Reportes -->
        <div id="reportes-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
            <div class="flex items-center gap-2 mb-2">
                <button onclick="showPanel('dashboard')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <h2 class="text-xl font-bold text-slate-900 dark:text-white">Reportes</h2>
            </div>
            <button onclick="generarReporteSeguimiento()" class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-600 text-white rounded-xl font-medium shadow-lg hover:shadow-xl transition mb-4">
                <span class="material-symbols-outlined inline-block align-middle">analytics</span>
                Generar Reporte de Seguimiento
            </button>
            <div id="reportes-list" class="flex flex-col gap-3"></div>
        </div>

        <!-- Vista Perfil -->
        <div id="perfil-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
            <div class="flex items-center gap-2 mb-2">
                <button onclick="showPanel('dashboard')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <h2 class="text-xl font-bold text-slate-900 dark:text-white">Mi Perfil</h2>
            </div>
            
            <!-- Información del Tutor -->
            <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl p-6 text-white shadow-lg">
                <div class="flex items-center gap-4 mb-4">
                    <div class="h-20 w-20 rounded-full border-4 border-white shadow-lg bg-cover bg-center"
                        style="background-image: url('{{ foto_perfil or avatar_url or 'https://ui-avatars.com/api/?name=' + nombre }}');"></div>
                    <div>
                        <h3 class="text-xl font-bold">{{ nombre }}</h3>
                        <p class="text-sm opacity-90">{{ email }}</p>
                        <p class="text-xs opacity-75">Tutor Académico</p>
                    </div>
                </div>
            </div>

            <!-- Opciones -->
            <div class="space-y-2">
                <a href="/logout" class="flex items-center gap-3 p-3 bg-white dark:bg-surface-dark rounded-xl border border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 transition">
                    <span class="material-symbols-outlined text-red-500">logout</span>
                    <span class="font-medium text-slate-900 dark:text-white">Cerrar Sesión</span>
                </a>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-surface-dark border-t border-slate-200 dark:border-slate-800 z-50">
        <div class="max-w-md mx-auto flex justify-around items-center h-16 px-2">
            <button onclick="showPanel('dashboard')" class="nav-btn flex flex-col items-center gap-1 px-3 py-2 rounded-lg text-indigo-600 bg-indigo-50 dark:bg-indigo-900/20">
                <span class="material-symbols-outlined text-xl">home</span>
                <span class="text-[10px] font-medium">Inicio</span>
            </button>
            <button onclick="showPanel('alertas')" class="nav-btn flex flex-col items-center gap-1 px-3 py-2 rounded-lg text-slate-600 dark:text-slate-400 hover:text-indigo-600 hover:bg-slate-50 dark:hover:bg-slate-800">
                <span class="material-symbols-outlined text-xl">warning</span>
                <span class="text-[10px] font-medium">Alertas</span>
            </button>
            <button onclick="showPanel('sesiones')" class="nav-btn flex flex-col items-center gap-1 px-3 py-2 rounded-lg text-slate-600 dark:text-slate-400 hover:text-indigo-600 hover:bg-slate-50 dark:hover:bg-slate-800">
                <span class="material-symbols-outlined text-xl">event</span>
                <span class="text-[10px] font-medium">Sesiones</span>
            </button>
            <button onclick="showPanel('observaciones')" class="nav-btn flex flex-col items-center gap-1 px-3 py-2 rounded-lg text-slate-600 dark:text-slate-400 hover:text-indigo-600 hover:bg-slate-50 dark:hover:bg-slate-800">
                <span class="material-symbols-outlined text-xl">edit_note</span>
                <span class="text-[10px] font-medium">Notas</span>
            </button>
            <button onclick="showPanel('reportes')" class="nav-btn flex flex-col items-center gap-1 px-3 py-2 rounded-lg text-slate-600 dark:text-slate-400 hover:text-indigo-600 hover:bg-slate-50 dark:hover:bg-slate-800">
                <span class="material-symbols-outlined text-xl">analytics</span>
                <span class="text-[10px] font-medium">Reportes</span>
            </button>
            <button onclick="showPanel('perfil')" class="nav-btn flex flex-col items-center gap-1 px-3 py-2 rounded-lg text-slate-600 dark:text-slate-400 hover:text-indigo-600 hover:bg-slate-50 dark:hover:bg-slate-800">
                <span class="material-symbols-outlined text-xl">person</span>
                <span class="text-[10px] font-medium">Perfil</span>
            </button>
        </div>
    </nav>

    <script>
        // --- FUNCIONES DE NAVEGACIÓN ---
        function showPanel(panelName) {
            // Ocultar todas las vistas
            document.querySelectorAll('[id$="-view"]').forEach(v => v.classList.add('hidden'));
            
            // Mostrar vista seleccionada
            const targetView = document.getElementById(panelName + '-view');
            if (targetView) {
                targetView.classList.remove('hidden');
            }
            
            // Actualizar navegación
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-indigo-600', 'bg-indigo-50', 'dark:bg-indigo-900/20');
                btn.classList.add('text-slate-600', 'dark:text-slate-400');
            });
            event.currentTarget.classList.remove('text-slate-600', 'dark:text-slate-400');
            event.currentTarget.classList.add('text-indigo-600', 'bg-indigo-50', 'dark:bg-indigo-900/20');
            
            // Cargar datos según panel
            if (panelName === 'dashboard') loadDashboard();
            else if (panelName === 'alertas') loadAllAlertas();
            else if (panelName === 'sesiones') loadAllSesiones();
            else if (panelName === 'observaciones') loadObservaciones();
            else if (panelName === 'reportes') loadReportes();
        }

        // --- FUNCIONES DE CARGA ---
        async function loadDashboard() {
            await Promise.all([
                loadEstudiantes(),
                loadAlertas(),
                loadSesiones(),
                loadComunicados(),
                loadStats()
            ]);
        }

        async function loadStats() {
            try {
                // Cargar estadísticas del header
                const [sesionesRes, alertasRes] = await Promise.all([
                    fetch('/api/tutor/sesiones').then(r => r.json()),
                    fetch('/api/tutor/alertas').then(r => r.json())
                ]);
                
                // Actualizar stats
                const now = new Date();
                const currentMonth = now.getMonth();
                const sesiones = sesionesRes.sesiones || [];
                const alertas = alertasRes.alertas || [];
                
                const sesionesEsteMes = sesiones.filter(s => {
                    if (!s.fecha) return false;
                    const fecha = new Date(s.fecha);
                    return fecha.getMonth() === currentMonth;
                }).length;
                
                const alertasSinAtender = alertas.filter(a => !a.leida).length;
                
                // Contar citas programadas (sesiones con estado programada)
                const citasProximas = sesiones.filter(s => s.estado === 'programada').length;
                
                document.getElementById('total-sesiones').textContent = sesionesEsteMes;
                document.getElementById('total-alertas').textContent = alertasSinAtender;
                document.getElementById('total-citas').textContent = citasProximas;
                
                // Actualizar badge de notificaciones
                if (alertasSinAtender > 0) {
                    document.getElementById('notif-badge').classList.remove('hidden');
                }
            } catch (e) {
                console.error('Error en loadStats:', e);
            }
        }

        async function loadEstudiantes() {
            const list = document.getElementById('estudiantes-list');
            list.innerHTML = '<div class="flex justify-center p-4"><span class="text-slate-400">Cargando...</span></div>';
            
            try {
                const res = await fetch('/api/tutor/mis-alumnos');
                const data = await res.json();
                
                if (!data.alumnos || data.alumnos.length === 0) {
                    list.innerHTML = '<p class="text-center text-slate-500 text-sm py-4">No tienes estudiantes asignados</p>';
                    return;
                }
                
                let html = '';
                data.alumnos.slice(0, 5).forEach(est => {
                    html += `
                        <div onclick="verEstudiante(${est.id})" class="flex items-center gap-3 p-3 rounded-lg bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer transition">
                            <div class="h-10 w-10 rounded-full bg-gradient-to-br from-indigo-400 to-purple-400 flex items-center justify-center text-white font-bold">
                                ${est.nombre.substring(0, 2).toUpperCase()}
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-sm text-slate-900 dark:text-white">${est.nombre}</p>
                                <p class="text-xs text-slate-500">${est.numero_control || est.email}</p>
                            </div>
                            <span class="material-symbols-outlined text-slate-400">chevron_right</span>
                        </div>
                    `;
                });
                
                if (data.alumnos.length > 5) {
                    html += `<p class="text-center text-xs text-slate-500 mt-2">+${data.alumnos.length - 5} más</p>`;
                }
                
                list.innerHTML = html;
            } catch (e) {
                console.error('Error en loadEstudiantes:', e);
                list.innerHTML = '<p class="text-center text-red-500 text-sm">Error al cargar estudiantes</p>';
            }
        }

        // Cargar alertas recientes
        async function loadAlertas() {
            const list = document.getElementById('alertas-list');
            list.innerHTML = '<div class="flex justify-center p-4"><span class="text-slate-400">Cargando...</span></div>';
            
            try {
                const res = await fetch('/api/tutor/alertas?limite=5');
                const data = await res.json();
                
                if (!data.alertas || data.alertas.length === 0) {
                    list.innerHTML = '<p class="text-center text-slate-500 text-sm py-4">No hay alertas recientes</p>';
                    return;
                }
                
                const prioridadColors = {
                    'alta': 'bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-300',
                    'media': 'bg-orange-100 text-orange-600 dark:bg-orange-900 dark:text-orange-300',
                    'baja': 'bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300'
                };
                
                let html = '';
                data.alertas.forEach(alert => {
                    html += `
                        <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 transition">
                            <div class="flex items-start gap-3">
                                <div class="h-8 w-8 rounded-full ${prioridadColors[alert.prioridad] || prioridadColors.baja} flex items-center justify-center">
                                    <span class="material-symbols-outlined text-sm">priority_high</span>
                                </div>
                                <div class="flex-1">
                                    <p class="font-medium text-sm text-slate-900 dark:text-white">${alert.titulo}</p>
                                    <p class="text-xs text-slate-500 mt-1">${alert.estudiante_nombre}</p>
                                    <p class="text-xs text-slate-400 mt-1">${alert.fecha_creacion}</p>
                                </div>
                                ${!alert.leida ? '<span class="h-2 w-2 bg-blue-500 rounded-full"></span>' : ''}
                            </div>
                        </div>
                    `;
                });
                
                list.innerHTML = html;
            } catch (e) {
                console.error('Error en loadAlertas:', e);
                list.innerHTML = '<p class="text-center text-red-500 text-sm">Error al cargar alertas</p>';
            }
        }

        // Cargar sesiones recientes
        async function loadSesiones() {
            const list = document.getElementById('sesiones-list');
            list.innerHTML = '<div class="flex justify-center p-4"><span class="text-slate-400">Cargando...</span></div>';
            
            try {
                const res = await fetch('/api/tutor/sesiones?limite=5');
                const data = await res.json();
                
                if (!data.sesiones || data.sesiones.length === 0) {
                    list.innerHTML = '<p class="text-center text-slate-500 text-sm py-4">No hay sesiones programadas</p>';
                    return;
                }
                
                const estadoColors = {
                    'programada': 'bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300',
                    'completada': 'bg-green-100 text-green-600 dark:bg-green-900 dark:text-green-300',
                    'cancelada': 'bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-300'
                };
                
                let html = '';
                data.sesiones.forEach(ses => {
                    html += `
                        <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 transition">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex-1">
                                    <p class="font-medium text-sm text-slate-900 dark:text-white">${ses.estudiante_nombre}</p>
                                    <p class="text-xs text-slate-500 mt-1">${ses.fecha} ${ses.hora}</p>
                                    <p class="text-xs text-slate-400 mt-1">${ses.tipo}</p>
                                </div>
                                <span class="px-2 py-1 text-xs rounded-full ${estadoColors[ses.estado] || estadoColors.programada}">${ses.estado}</span>
                            </div>
                        </div>
                    `;
                });
                
                list.innerHTML = html;
            } catch (e) {
                console.error('Error en loadSesiones:', e);
                list.innerHTML = '<p class="text-center text-red-500 text-sm">Error al cargar sesiones</p>';
            }
        }

        // Cargar comunicados
        async function loadComunicados() {
            const list = document.getElementById('comunicados-list');
            list.innerHTML = '<div class="flex justify-center p-4"><span class="text-slate-400">Cargando...</span></div>';
            
            try {
                const res = await fetch('/api/tutor/comunicados');
                const data = await res.json();
                
                if (!data.comunicados || data.comunicados.length === 0) {
                    list.innerHTML = '<p class="text-center text-slate-500 text-sm py-4">No hay comunicados</p>';
                    return;
                }
                
                let html = '';
                data.comunicados.slice(0, 3).forEach(com => {
                    html += `
                        <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-800">
                            <p class="font-medium text-sm text-slate-900 dark:text-white">${com.titulo}</p>
                            <p class="text-xs text-slate-500 mt-1">${com.mensaje}</p>
                            <p class="text-xs text-slate-400 mt-2">${com.fecha}</p>
                        </div>
                    `;
                });
                
                list.innerHTML = html;
            } catch (e) {
                console.error('Error en loadComunicados:', e);
                list.innerHTML = '<p class="text-center text-red-500 text-sm">Error al cargar comunicados</p>';
            }
        }

        // Vista completa de alertas
        async function loadAllAlertas() {
            const container = document.getElementById('alertas-container');
            container.innerHTML = '<div class="flex justify-center p-8"><span class="text-slate-400">Cargando...</span></div>';
            
            try {
                const res = await fetch('/api/tutor/alertas');
                const data = await res.json();
                
                if (!data.alertas || data.alertas.length === 0) {
                    container.innerHTML = '<p class="text-center text-slate-500 py-8">No hay alertas</p>';
                    return;
                }
                
                const prioridadColors = {
                    'alta': 'bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-300',
                    'media': 'bg-orange-100 text-orange-600 dark:bg-orange-900 dark:text-orange-300',
                    'baja': 'bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300'
                };
                
                let html = '<div class="space-y-3">';
                data.alertas.forEach(alert => {
                    html += `
                        <div class="bg-white dark:bg-slate-800 rounded-lg p-4 shadow-sm border border-slate-200 dark:border-slate-700">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex items-start gap-3 flex-1">
                                    <div class="h-10 w-10 rounded-full ${prioridadColors[alert.prioridad] || prioridadColors.baja} flex items-center justify-center">
                                        <span class="material-symbols-outlined">priority_high</span>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-medium text-slate-900 dark:text-white">${alert.titulo}</p>
                                        <p class="text-sm text-slate-600 dark:text-slate-300 mt-1">${alert.mensaje || ''}</p>
                                        <div class="flex items-center gap-4 mt-2">
                                            <p class="text-xs text-slate-500">${alert.estudiante_nombre}</p>
                                            <p class="text-xs text-slate-400">${alert.fecha_creacion}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    ${!alert.leida ? `<button onclick="marcarAlertaLeida(${alert.id})" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition">
                                        <span class="material-symbols-outlined text-blue-600">check</span>
                                    </button>` : ''}
                                    <button onclick="archivarAlerta(${alert.id})" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition">
                                        <span class="material-symbols-outlined text-slate-600">archive</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
            } catch (e) {
                console.error('Error en loadAllAlertas:', e);
                container.innerHTML = '<p class="text-center text-red-500">Error al cargar alertas</p>';
            }
        }

        // Vista completa de sesiones
        async function loadAllSesiones() {
            const container = document.getElementById('sesiones-container');
            container.innerHTML = '<div class="flex justify-center p-8"><span class="text-slate-400">Cargando...</span></div>';
            
            try {
                const res = await fetch('/api/tutor/sesiones');
                const data = await res.json();
                
                if (!data.sesiones || data.sesiones.length === 0) {
                    container.innerHTML = '<p class="text-center text-slate-500 py-8">No hay sesiones</p>';
                    return;
                }
                
                const estadoColors = {
                    'programada': 'bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300',
                    'completada': 'bg-green-100 text-green-600 dark:bg-green-900 dark:text-green-300',
                    'cancelada': 'bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-300'
                };
                
                let html = '<div class="space-y-3">';
                data.sesiones.forEach(ses => {
                    html += `
                        <div class="bg-white dark:bg-slate-800 rounded-lg p-4 shadow-sm border border-slate-200 dark:border-slate-700">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2">
                                        <p class="font-medium text-slate-900 dark:text-white">${ses.estudiante_nombre}</p>
                                        <span class="px-2 py-1 text-xs rounded-full ${estadoColors[ses.estado] || estadoColors.programada}">${ses.estado}</span>
                                    </div>
                                    <p class="text-sm text-slate-600 dark:text-slate-300 mt-1">${ses.tipo}</p>
                                    <div class="flex items-center gap-4 mt-2">
                                        <p class="text-xs text-slate-500"><span class="material-symbols-outlined text-xs align-middle">calendar_today</span> ${ses.fecha}</p>
                                        <p class="text-xs text-slate-500"><span class="material-symbols-outlined text-xs align-middle">schedule</span> ${ses.hora}</p>
                                    </div>
                                    ${ses.notas ? `<p class="text-sm text-slate-500 mt-2 italic">${ses.notas}</p>` : ''}
                                </div>
                                ${ses.estado === 'programada' ? `
                                <div class="flex gap-2">
                                    <button onclick="completarSesion(${ses.id})" class="p-2 hover:bg-green-50 dark:hover:bg-green-900 rounded-lg transition">
                                        <span class="material-symbols-outlined text-green-600">check_circle</span>
                                    </button>
                                    <button onclick="cancelarSesion(${ses.id})" class="p-2 hover:bg-red-50 dark:hover:bg-red-900 rounded-lg transition">
                                        <span class="material-symbols-outlined text-red-600">cancel</span>
                                    </button>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
            } catch (e) {
                console.error('Error en loadAllSesiones:', e);
                container.innerHTML = '<p class="text-center text-red-500">Error al cargar sesiones</p>';
            }
        }

        // Vista de observaciones
        async function loadObservaciones() {
            const container = document.getElementById('observaciones-container');
            container.innerHTML = '<div class="flex justify-center p-8"><span class="text-slate-400">Cargando...</span></div>';
            
            try {
                const res = await fetch('/api/tutor/observaciones');
                const data = await res.json();
                
                if (!data.observaciones || data.observaciones.length === 0) {
                    container.innerHTML = '<p class="text-center text-slate-500 py-8">No hay observaciones</p>';
                    return;
                }
                
                const tipoColors = {
                    'conductual': 'bg-purple-100 text-purple-600 dark:bg-purple-900 dark:text-purple-300',
                    'academico': 'bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300',
                    'social': 'bg-green-100 text-green-600 dark:bg-green-900 dark:text-green-300',
                    'emocional': 'bg-orange-100 text-orange-600 dark:bg-orange-900 dark:text-orange-300'
                };
                
                let html = '<div class="space-y-3">';
                data.observaciones.forEach(obs => {
                    html += `
                        <div class="bg-white dark:bg-slate-800 rounded-lg p-4 shadow-sm border border-slate-200 dark:border-slate-700">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2">
                                        <p class="font-medium text-slate-900 dark:text-white">${obs.estudiante_nombre}</p>
                                        <span class="px-2 py-1 text-xs rounded-full ${tipoColors[obs.tipo] || tipoColors.academico}">${obs.tipo}</span>
                                    </div>
                                    <p class="text-sm text-slate-600 dark:text-slate-300 mt-2">${obs.observacion}</p>
                                    <p class="text-xs text-slate-400 mt-2">${obs.fecha}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
            } catch (e) {
                console.error('Error en loadObservaciones:', e);
                container.innerHTML = '<p class="text-center text-red-500">Error al cargar observaciones</p>';
            }
        }

        // Marcar alerta como leída
        async function marcarAlertaLeida(id) {
            try {
                const res = await fetch(`/api/tutor/alertas/${id}/leer`, { method: 'POST' });
                const data = await res.json();
                
                if (data.success) {
                    showToast('Alerta marcada como leída', 'success');
                    loadAllAlertas();
                    loadStats();
                } else {
                    showToast(data.message || 'Error al marcar alerta', 'error');
                }
            } catch (e) {
                console.error('Error en marcarAlertaLeida:', e);
                showToast('Error al marcar alerta', 'error');
            }
        }

        // Archivar alerta
        async function archivarAlerta(id) {
            if (!confirm('¿Archivar esta alerta?')) return;
            
            try {
                const res = await fetch(`/api/tutor/alertas/${id}/archivar`, { method: 'POST' });
                const data = await res.json();
                
                if (data.success) {
                    showToast('Alerta archivada', 'success');
                    loadAllAlertas();
                    loadStats();
                } else {
                    showToast(data.message || 'Error al archivar alerta', 'error');
                }
            } catch (e) {
                console.error('Error en archivarAlerta:', e);
                showToast('Error al archivar alerta', 'error');
            }
        }

        // Agendar nueva sesión
        async function agendarSesion() {
            const { value: formValues } = await Swal.fire({
                title: 'Agendar Sesión de Tutoría',
                html: `
                    <div class="space-y-4">
                        <select id="swal-estudiante" class="swal2-input">
                            <option value="">Seleccionar estudiante...</option>
                        </select>
                        <input id="swal-fecha" type="date" class="swal2-input" placeholder="Fecha">
                        <input id="swal-hora" type="time" class="swal2-input" placeholder="Hora">
                        <select id="swal-tipo" class="swal2-input">
                            <option value="individual">Individual</option>
                            <option value="grupal">Grupal</option>
                            <option value="seguimiento">Seguimiento</option>
                        </select>
                        <textarea id="swal-notas" class="swal2-textarea" placeholder="Notas o tema a tratar"></textarea>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Agendar',
                cancelButtonText: 'Cancelar',
                didOpen: async () => {
                    const select = document.getElementById('swal-estudiante');
                    const res = await fetch('/api/tutor/mis-alumnos');
                    const data = await res.json();
                    data.alumnos.forEach(est => {
                        select.innerHTML += `<option value="${est.id}">${est.nombre}</option>`;
                    });
                },
                preConfirm: () => {
                    return {
                        estudiante_id: document.getElementById('swal-estudiante').value,
                        fecha: document.getElementById('swal-fecha').value,
                        hora: document.getElementById('swal-hora').value,
                        tipo: document.getElementById('swal-tipo').value,
                        notas: document.getElementById('swal-notas').value
                    };
                }
            });

            if (formValues && formValues.estudiante_id && formValues.fecha && formValues.hora) {
                try {
                    const res = await fetch('/api/tutor/sesiones', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formValues)
                    });
                    const data = await res.json();
                    
                    if (data.success) {
                        showToast('Sesión agendada exitosamente', 'success');
                        loadAllSesiones();
                        loadStats();
                    } else {
                        showToast(data.message || 'Error al agendar sesión', 'error');
                    }
                } catch (e) {
                    console.error('Error en agendarSesion:', e);
                    showToast('Error al agendar sesión', 'error');
                }
            }
        }

        // Completar sesión
        async function completarSesion(id) {
            const { value: notas } = await Swal.fire({
                title: 'Completar Sesión',
                input: 'textarea',
                inputLabel: 'Resumen de la sesión',
                inputPlaceholder: 'Escribe un resumen de lo tratado en la sesión...',
                showCancelButton: true,
                confirmButtonText: 'Completar',
                cancelButtonText: 'Cancelar'
            });

            if (notas) {
                try {
                    const res = await fetch(`/api/tutor/sesiones/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ estado: 'completada', notas })
                    });
                    const data = await res.json();
                    
                    if (data.success) {
                        showToast('Sesión completada', 'success');
                        loadAllSesiones();
                        loadStats();
                    } else {
                        showToast(data.message || 'Error al completar sesión', 'error');
                    }
                } catch (e) {
                    console.error('Error en completarSesion:', e);
                    showToast('Error al completar sesión', 'error');
                }
            }
        }

        // Cancelar sesión
        async function cancelarSesion(id) {
            const { value: motivo } = await Swal.fire({
                title: '¿Cancelar sesión?',
                input: 'text',
                inputLabel: 'Motivo de cancelación',
                inputPlaceholder: 'Escribe el motivo...',
                showCancelButton: true,
                confirmButtonText: 'Sí, cancelar',
                cancelButtonText: 'No'
            });

            if (motivo) {
                try {
                    const res = await fetch(`/api/tutor/sesiones/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ estado: 'cancelada', notas: motivo })
                    });
                    const data = await res.json();
                    
                    if (data.success) {
                        showToast('Sesión cancelada', 'success');
                        loadAllSesiones();
                        loadStats();
                    } else {
                        showToast(data.message || 'Error al cancelar sesión', 'error');
                    }
                } catch (e) {
                    console.error('Error en cancelarSesion:', e);
                    showToast('Error al cancelar sesión', 'error');
                }
            }
        }

        // Crear observación
        async function crearObservacion() {
            const { value: formValues } = await Swal.fire({
                title: 'Nueva Observación',
                html: `
                    <div class="space-y-4">
                        <select id="swal-estudiante" class="swal2-input">
                            <option value="">Seleccionar estudiante...</option>
                        </select>
                        <select id="swal-tipo" class="swal2-input">
                            <option value="academico">Académico</option>
                            <option value="conductual">Conductual</option>
                            <option value="social">Social</option>
                            <option value="emocional">Emocional</option>
                        </select>
                        <textarea id="swal-observacion" class="swal2-textarea" placeholder="Escribe la observación..."></textarea>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Guardar',
                cancelButtonText: 'Cancelar',
                didOpen: async () => {
                    const select = document.getElementById('swal-estudiante');
                    const res = await fetch('/api/tutor/mis-alumnos');
                    const data = await res.json();
                    data.alumnos.forEach(est => {
                        select.innerHTML += `<option value="${est.id}">${est.nombre}</option>`;
                    });
                },
                preConfirm: () => {
                    return {
                        estudiante_id: document.getElementById('swal-estudiante').value,
                        tipo: document.getElementById('swal-tipo').value,
                        observacion: document.getElementById('swal-observacion').value
                    };
                }
            });

            if (formValues && formValues.estudiante_id && formValues.observacion) {
                try {
                    const res = await fetch('/api/tutor/observaciones', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formValues)
                    });
                    const data = await res.json();
                    
                    if (data.success) {
                        showToast('Observación guardada', 'success');
                        loadObservaciones();
                    } else {
                        showToast(data.message || 'Error al guardar observación', 'error');
                    }
                } catch (e) {
                    console.error('Error en crearObservacion:', e);
                    showToast('Error al guardar observación', 'error');
                }
            }
        }

        // Ver detalle de estudiante
        async function verEstudiante(id) {
            try {
                const res = await fetch(`/api/tutor/estudiante/${id}/detalle`);
                const data = await res.json();
                
                if (data.success) {
                    const est = data.estudiante;
                    Swal.fire({
                        title: est.nombre,
                        html: `
                            <div class="text-left space-y-3">
                                <p><strong>Número de Control:</strong> ${est.numero_control || 'N/A'}</p>
                                <p><strong>Email:</strong> ${est.email}</p>
                                <p><strong>Grupo:</strong> ${est.grupo || 'N/A'}</p>
                                <p><strong>Promedio:</strong> ${est.promedio || 'N/A'}</p>
                                <p><strong>Asistencia:</strong> ${est.asistencia || 'N/A'}%</p>
                                <p><strong>Sesiones realizadas:</strong> ${est.sesiones_realizadas || 0}</p>
                                ${est.observaciones_recientes ? `<p><strong>Última observación:</strong> ${est.observaciones_recientes}</p>` : ''}
                            </div>
                        `,
                        confirmButtonText: 'Cerrar'
                    });
                } else {
                    showToast(data.message || 'Error al cargar datos', 'error');
                }
            } catch (e) {
                console.error('Error en verEstudiante:', e);
                showToast('Error al cargar datos del estudiante', 'error');
            }
        }

        // Generar reporte de seguimiento
        async function generarReporteSeguimiento() {
            const { value: formValues } = await Swal.fire({
                title: 'Generar Reporte de Seguimiento',
                html: `
                    <div class="space-y-4">
                        <select id="swal-estudiante" class="swal2-input">
                            <option value="">Seleccionar estudiante...</option>
                            <option value="todos">Todos los estudiantes</option>
                        </select>
                        <input id="swal-fecha-inicio" type="date" class="swal2-input" placeholder="Fecha inicio">
                        <input id="swal-fecha-fin" type="date" class="swal2-input" placeholder="Fecha fin">
                        <select id="swal-formato" class="swal2-input">
                            <option value="pdf">PDF</option>
                            <option value="excel">Excel</option>
                        </select>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Generar',
                cancelButtonText: 'Cancelar',
                didOpen: async () => {
                    const select = document.getElementById('swal-estudiante');
                    const res = await fetch('/api/tutor/mis-alumnos');
                    const data = await res.json();
                    data.alumnos.forEach(est => {
                        select.innerHTML += `<option value="${est.id}">${est.nombre}</option>`;
                    });
                },
                preConfirm: () => {
                    return {
                        estudiante_id: document.getElementById('swal-estudiante').value,
                        fecha_inicio: document.getElementById('swal-fecha-inicio').value,
                        fecha_fin: document.getElementById('swal-fecha-fin').value,
                        formato: document.getElementById('swal-formato').value
                    };
                }
            });

            if (formValues && formValues.fecha_inicio && formValues.fecha_fin) {
                try {
                    const res = await fetch('/api/tutor/reporte-seguimiento', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formValues)
                    });
                    const data = await res.json();
                    
                    if (data.success && data.url) {
                        showToast('Reporte generado exitosamente', 'success');
                        window.open(data.url, '_blank');
                    } else {
                        showToast(data.message || 'Error al generar reporte', 'error');
                    }
                } catch (e) {
                    console.error('Error en generarReporteSeguimiento:', e);
                    showToast('Error al generar reporte', 'error');
                }
            }
        }

        // Vista de reportes (placeholder)
        function loadReportes() {
            // Esta función se llama cuando se muestra el panel de reportes
            // El contenido principal es el botón de generar reporte
            console.log('Panel de reportes cargado');
        }

        // Utilidades
        function showToast(message, type = 'info') {
            const bgColors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-orange-500'
            };
            
            const toast = document.createElement('div');
            toast.className = `fixed top-20 right-4 ${bgColors[type]} text-white px-4 py-3 rounded-lg shadow-lg z-50`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        function toggleNotifications() {
            showPanel('alertas');
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
        });
    </script>
</body>
{% endblock %}
