<!DOCTYPE html>
<html class="light" lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Panel Alumno</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <!-- Material Symbols -->
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Theme Configuration -->
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "surface-light": "#FFFFFF",
                        "surface-dark": "#1A2633",
                        "text-main-light": "#111418",
                        "text-main-dark": "#F3F4F6",
                        "text-sec-light": "#617589",
                        "text-sec-dark": "#9CA3AF",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        /* Hide scrollbar for clean UI */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        body {
            min-height: max(884px, 100dvh);
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-white antialiased transition-colors duration-200">
    <div id="main-app-container"
        class="relative flex flex-col w-full max-w-md mx-auto bg-white dark:bg-background-dark shadow-2xl min-h-screen h-screen overflow-hidden">

        <!-- Header / Stats Container -->
        <!-- ID requested for: header-stats (XP, Nivel, Monedas) -->
        <div id="header-stats" class="w-full flex flex-col items-center pt-8 pb-4 bg-white dark:bg-background-dark">
            <!-- Profile Section -->
            <div class="relative mb-3">
                <div class="h-24 w-24 rounded-full border-4 border-white dark:border-surface-dark shadow-md bg-cover bg-center"
                    data-avatar="{{ avatar_url if 'http' in avatar_url else url_for('uploaded_file', filename=avatar_url) if avatar_url else 'https://ui-avatars.com/api/?name=' + nombre + '&background=random' }}">
                </div>
                <div
                    class="absolute bottom-0 right-0 bg-primary text-white rounded-full p-1 border-2 border-white dark:border-surface-dark cursor-pointer hover:bg-blue-600 transition">
                    <span class="material-symbols-outlined text-[16px] block">edit</span>
                </div>
            </div>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">{{ nombre }}</h2>
            <p class="text-sm text-slate-500 dark:text-slate-400 font-medium"><span id="user-level">{{ rango
                }}</span> • <span id="xp-val">{{ xp }}</span> XP</p>

            <!-- Stats Cards Grid -->
            <div class="grid grid-cols-2 gap-3 w-full px-4 mt-6">
                <!-- XP Card -->
                <div
                    class="bg-gradient-to-br from-blue-500 to-cyan-400 rounded-xl p-4 text-white shadow-lg relative overflow-hidden group">
                    <div
                        class="absolute -right-2 -top-2 opacity-20 group-hover:scale-110 transition-transform duration-500">
                        <span class="material-symbols-outlined text-[80px]">star</span>
                    </div>
                    <p class="text-white/80 text-xs font-medium mb-1">Total XP</p>
                    <h3 class="text-2xl font-bold" id="xp-card-val">{{ xp }}</h3>
                    <div class="w-full bg-white/30 h-1 rounded-full mt-2">
                        <div id="xp-progress-bar" class="bg-white h-1 rounded-full transition-all duration-1000"
                            style="width: 0%"></div>
                    </div>
                </div>
                <!-- Coins Card -->
                <div
                    class="bg-gradient-to-br from-yellow-400 to-orange-500 rounded-xl p-4 text-white shadow-lg relative overflow-hidden group">
                    <div
                        class="absolute -right-2 -top-2 opacity-20 group-hover:scale-110 transition-transform duration-500">
                        <span class="material-symbols-outlined text-[80px]">monetization_on</span>
                    </div>
                    <p class="text-white/80 text-xs font-medium mb-1">EduCoins</p>
                    <h3 class="text-2xl font-bold" id="coin-count">{{ educoins }}</h3>
                    <button onclick="alert('Próximamente estaremos abriendo la tienda de recompensas.')"
                        class="mt-2 text-[10px] bg-white/20 hover:bg-white/30 px-2 py-0.5 rounded text-white font-medium transition">
                        Canjear
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <!-- Main scrollable area -->
        <main class="flex-1 overflow-y-auto no-scrollbar p-4 space-y-6" id="dashboard-main">

            <!-- Missions Container -->
            <!-- ID requested: missions-container -->
            <!-- Missions Container -->
            <div id="missions-container" class="w-full">
                <div class="flex items-center justify-between mb-3 px-1">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white">Misiones diarias</h3>
                    <button onclick="showPanel('misiones')" class="text-xs text-primary font-medium hover:underline">Ver todas</button>
                </div>
                <!-- Horizontal Scroll List -->
                <!-- Filled by JS loadMissions() -->
                <div id="missions-scroll-area" class="flex gap-3 overflow-x-auto no-scrollbar pb-2">
                    <p class="text-xs text-slate-400 p-2">Cargando misiones...</p>
                </div>
            </div>

            <!-- Schedule Container -->
            <!-- ID requested: schedule-container -->
            <!-- Schedule Container -->
            <div id="schedule-container" class="w-full">
                <div
                    class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white">Horario</h3>
                        <button onclick="showPanel('hoy')" class="text-xs text-primary font-medium hover:underline">Calendario completo</button>
                    </div>
                    <!-- Timeline Items Loop -->
                    {% if materias %}
                    {% for materia in materias %}
                    <!-- Simple logic to alternate timeline styles or just list them -->
                    <div class="flex gap-3 mb-4 last:mb-0 relative">
                        <div class="flex flex-col items-center">
                            <!-- Helper logic for 'current' class could go here, for now generic style -->
                            <div
                                class="w-3 h-3 bg-blue-500 rounded-full ring-2 ring-blue-100 dark:ring-blue-900/30 z-10">
                            </div>
                            {% if not loop.last %}
                            <div class="w-0.5 bg-slate-200 dark:bg-slate-700 h-full -my-1 absolute top-3"></div>
                            {% endif %}
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs text-blue-600 font-bold uppercase tracking-wide mb-0.5">
                                        {{ materia.horario if materia.horario else '--:--' }}
                                    </p>
                                    <p class="text-base font-bold text-slate-900 dark:text-white">{{ materia.nombre }}
                                    </p>
                                    <p class="text-xs text-slate-500 dark:text-slate-400">Prof. {{ materia.docente }}
                                    </p>
                                </div>
                                <!-- <span class="material-symbols-outlined text-green-500 text-[20px]">play_circle</span> -->
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-sm text-slate-500 text-center py-2">No hay horario disponible.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Assignments Container -->
            <!-- ID requested: assignments-container -->
            <!-- Assignments Container -->
            <div id="assignments-container" class="w-full pb-6">
                <div class="flex items-center justify-between mb-3 px-1">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white">Tareas</h3>
                    <div class="flex bg-slate-100 dark:bg-slate-800 rounded-lg p-0.5">
                        <button
                            onclick="filtrarTareas('pendientes')"
                            class="filtro-tareas px-2 py-0.5 text-xs font-medium rounded-md bg-white dark:bg-surface-dark shadow-sm text-slate-900 dark:text-white" data-filtro="pendientes">Pendientes</button>
                        <button
                            onclick="filtrarTareas('completadas')"
                            class="filtro-tareas px-2 py-0.5 text-xs font-medium rounded-md text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white" data-filtro="completadas">Completadas</button>
                    </div>
                </div>

                <div class="flex flex-col gap-3">
                    {% for tarea in tareas %}
                    {% set is_pending = not tarea.entregada %}
                    {% set is_late = tarea.vencida %}
                    <div class="assignment-item group flex flex-col gap-4 rounded-xl bg-white dark:bg-surface-dark p-4 shadow-sm ring-1 ring-slate-200 dark:ring-slate-800 transition-all hover:shadow-md cursor-pointer"
                        data-tarea-id="{{ tarea.id }}">
                        <div class="flex items-start justify-between gap-4">
                            <div class="flex flex-1 flex-col gap-1">
                                <div class="flex items-center gap-2 mb-1">
                                    {% if tarea.entregada %}
                                    <span
                                        class="inline-flex items-center rounded-full bg-green-100 dark:bg-green-900/30 px-2.5 py-0.5 text-xs font-medium text-green-700 dark:text-green-300">
                                        Entregada
                                    </span>
                                    {% elif tarea.vencida %}
                                    <span
                                        class="inline-flex items-center rounded-full bg-red-100 dark:bg-red-900/30 px-2.5 py-0.5 text-xs font-medium text-red-700 dark:text-red-300">
                                        Vencida
                                    </span>
                                    {% else %}
                                    <span
                                        class="inline-flex items-center rounded-full bg-orange-100 dark:bg-orange-900/30 px-2.5 py-0.5 text-xs font-medium text-orange-700 dark:text-orange-300">
                                        Pendiente
                                    </span>
                                    {% endif %}

                                    <span class="text-xs text-slate-400 dark:text-slate-500">•</span>
                                    <span class="text-xs font-medium text-slate-500 dark:text-slate-400">{{
                                        tarea.materia }}</span>
                                </div>
                                <h3 class="text-lg font-bold text-slate-900 dark:text-white leading-tight">{{
                                    tarea.titulo }}</h3>
                                <div class="mt-1 flex items-center gap-1.5 text-slate-500 dark:text-slate-400">
                                    <span class="material-symbols-outlined text-[18px]">event</span>
                                    <p class="text-sm">Vence: {{ tarea.fecha_vencimiento }}</p>
                                </div>
                            </div>
                            <!-- Thumbnail with darker background fallback -->
                            <div
                                class="h-16 w-16 shrink-0 overflow-hidden rounded-lg bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-300">
                                <span class="material-symbols-outlined text-[32px]">assignment</span>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="p-6 text-center text-slate-500">
                        <p>No tienes tareas asignadas por el momento.</p>
                    </div>
                    {% endfor %}
                </div>

                <button onclick="showPanel('dashboard')"
                    class="w-full mt-4 py-3 text-sm font-medium text-primary hover:text-primary/80 transition flex items-center justify-center gap-1">
                    Ver todas las tareas
                    <span class="material-symbols-outlined text-[18px]">arrow_forward</span>
                </button>
            </div>

        </main>

        <!-- Bottom Navigation -->
        <!-- Based on 4.html (Fixed Bottom Nav) -->
        <nav
            class="fixed bottom-0 left-0 right-0 z-30 max-w-md mx-auto bg-white/95 dark:bg-background-dark/95 backdrop-blur-md border-t border-slate-200 dark:border-slate-800 shadow-lg">
            <div class="flex h-16 items-center justify-between px-1" id="bottom-nav">
                <!-- Los accesos directos se renderizan por JS -->
            </div>
            <script>
                // --- Estado activo de navegación ---
                const navItems = [
                    { key: 'dashboard', icon: 'home', label: 'Inicio', action: () => showPanel('dashboard') },
                    { key: 'subjects', icon: 'school', label: 'Materias', action: () => showPanel('subjects') },
                    { key: 'notes', icon: 'sticky_note_2', label: 'Notas', action: () => showPanel('notes') },
                    { key: 'portfolio', icon: 'workspaces', label: 'Portafolio', action: () => showPanel('portfolio') },
                    { key: 'tutorias', icon: 'support_agent', label: 'Tutorías', action: () => showPanel('tutorias') },
                    { key: 'equipos', icon: 'groups', label: 'Equipos', action: () => showPanel('equipos') },
                    { key: 'community', icon: 'chat_bubble', label: 'Comunidad', action: () => showPanel('community') },
                    { key: 'more', icon: 'apps', label: 'Más', action: () => showPanel('more') },
                    { key: 'perfil', icon: 'person', label: 'Perfil', action: () => openProfileModal() }
                ];

                let activeNav = 'dashboard';

                function renderBottomNav() {
                    const nav = document.getElementById('bottom-nav');
                    nav.innerHTML = navItems.map(item => `
                        <a href="#" onclick="setActiveNav('${item.key}'); return false;"
                            class="flex flex-1 flex-col items-center justify-center gap-0.5 ${activeNav === item.key ? 'text-primary font-bold' : 'text-slate-400'} transition-colors hover:text-primary dark:text-slate-500 dark:hover:text-primary hover:bg-primary/10 dark:hover:bg-primary/10 rounded-xl py-1 mx-0.5">
                            <span class="material-symbols-outlined text-[26px]">${item.icon}</span>
                            <span class="text-[11px] font-semibold">${item.label}</span>
                        </a>
                    `).join('');
                }

                function setActiveNav(key) {
                    activeNav = key;
                    renderBottomNav();
                    const item = navItems.find(i => i.key === key);
                    if (item && typeof item.action === 'function') item.action();
                }

                // Inicializar nav al cargar
                document.addEventListener('DOMContentLoaded', () => {
                    renderBottomNav();
                });
            </script>
    </div>

    <!-- Home Indicator (iOS Style) -->
    <div class="flex justify-center pb-2 pt-1">
        <div class="h-1 w-24 rounded-full bg-slate-300 dark:bg-slate-700"></div>
    </div>
    <!-- Notas personales View -->
    <div id="notes-view"
        class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('dashboard')"
                class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Mis Notas</h2>
        </div>
        <div id="notes-list" class="flex flex-col gap-3"></div>
        <button onclick="openNoteModal()"
            class="w-full py-3 rounded-lg bg-primary text-white font-bold shadow-lg hover:bg-blue-600 transition mt-4">Nueva
            Nota</button>
    </div>

    <!-- Portafolio View -->
    <div id="portfolio-view"
        class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('dashboard')"
                class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Portafolio</h2>
        </div>
        <div id="portfolio-list" class="flex flex-col gap-3"></div>
    </div>

    <!-- Tutorías View -->
    <div id="tutorias-view"
        class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('dashboard')"
                class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Tutorías</h2>
        </div>
        <div id="tutorias-list" class="flex flex-col gap-3"></div>
    </div>

    <!-- Equipos View -->
    <div id="equipos-view"
        class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('dashboard')"
                class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Equipos</h2>
        </div>
        <div id="equipos-list" class="flex flex-col gap-3"></div>
    </div>

    <!-- Más funcionalidades View -->
    <div id="more-view"
        class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('dashboard')"
                class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Más</h2>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <button onclick="showPanel('hoy')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-blue-600">today</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Hoy</p>
                <p class="text-xs text-slate-500">Agenda diaria</p>
            </button>
            <button onclick="showPanel('objetivos')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-purple-600">flag</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Objetivos</p>
                <p class="text-xs text-slate-500">Metas y progreso</p>
            </button>
            <button onclick="showPanel('habitos')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-green-600">check_circle</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Hábitos</p>
                <p class="text-xs text-slate-500">Check-in diario</p>
            </button>
            <button onclick="showPanel('notificaciones')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-orange-600">notifications</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Notificaciones</p>
                <p class="text-xs text-slate-500">Alertas inteligentes</p>
            </button>
            <button onclick="showPanel('recomendaciones')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-indigo-600">lightbulb</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Recomendaciones</p>
                <p class="text-xs text-slate-500">Estudio guiado</p>
            </button>
            <button onclick="showPanel('progreso')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-cyan-600">insights</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Progreso</p>
                <p class="text-xs text-slate-500">Historial y grupo</p>
            </button>
            <button onclick="showPanel('riesgo')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-red-600">health_and_safety</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Riesgo</p>
                <p class="text-xs text-slate-500">Seguimiento personal</p>
            </button>
            <button onclick="showPanel('funciones')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-emerald-600">lock_open</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Funciones</p>
                <p class="text-xs text-slate-500">Desbloqueos</p>
            </button>
            <button onclick="showPanel('recompensas')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-yellow-600">military_tech</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Recompensas</p>
                <p class="text-xs text-slate-500">Historial</p>
            </button>
            <button onclick="showPanel('balance')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-amber-600">account_balance_wallet</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Balance</p>
                <p class="text-xs text-slate-500">XP y EduCoins</p>
            </button>
            <button onclick="showPanel('examenes')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-fuchsia-600">quiz</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Exámenes</p>
                <p class="text-xs text-slate-500">Disponibles</p>
            </button>
            <button onclick="showPanel('encuestas')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-sky-600">fact_check</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Encuestas</p>
                <p class="text-xs text-slate-500">Pendientes</p>
            </button>
            <button onclick="showPanel('feedback')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-lime-600">feedback</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Feedback</p>
                <p class="text-xs text-slate-500">IA y docentes</p>
            </button>
            <button onclick="showPanel('exportaciones')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-teal-600">download</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Exportar</p>
                <p class="text-xs text-slate-500">Reportes</p>
            </button>
            <button onclick="showPanel('ayuda')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-slate-600">help</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Ayuda</p>
                <p class="text-xs text-slate-500">Guías rápidas</p>
            </button>
            <button onclick="showPanel('documentos')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-rose-600">description</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Documentos</p>
                <p class="text-xs text-slate-500">Constancias/Boletas</p>
            </button>
            <button onclick="showPanel('logros')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-yellow-600">emoji_events</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Logros</p>
                <p class="text-xs text-slate-500">Diarios y semanales</p>
            </button>
            <button onclick="showPanel('insignias')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-amber-600">workspace_premium</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Insignias</p>
                <p class="text-xs text-slate-500">Colección personal</p>
            </button>
            <button onclick="showPanel('ranking')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-indigo-600">leaderboard</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Ranking</p>
                <p class="text-xs text-slate-500">Posiciones</p>
            </button>
            <button onclick="showPanel('mensajeria')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-cyan-600">mail</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Mensajería</p>
                <p class="text-xs text-slate-500">Inbox interno</p>
            </button>
            <button onclick="showPanel('notificaciones-internas')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-orange-600">notifications</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Notifs internas</p>
                <p class="text-xs text-slate-500">Centro interno</p>
            </button>
            <button onclick="showPanel('foros')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-teal-600">forum</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Foros</p>
                <p class="text-xs text-slate-500">Comunidad</p>
            </button>
            <button onclick="showPanel('flashcards')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-emerald-600">style</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Flashcards</p>
                <p class="text-xs text-slate-500">Memorización</p>
            </button>
            <button onclick="showPanel('ia-tutor')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-fuchsia-600">smart_toy</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Tutor IA</p>
                <p class="text-xs text-slate-500">Asistencia guiada</p>
            </button>
            <button onclick="showPanel('playground')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-purple-600">terminal</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Playground</p>
                <p class="text-xs text-slate-500">Código rápido</p>
            </button>
            <button onclick="showPanel('snippets')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-slate-600">code</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Snippets</p>
                <p class="text-xs text-slate-500">Compartir código</p>
            </button>
            <button onclick="showPanel('tienda')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-orange-600">store</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Tienda</p>
                <p class="text-xs text-slate-500">Recompensas</p>
            </button>
            <button onclick="showPanel('learning-paths')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-blue-600">route</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Learning Paths</p>
                <p class="text-xs text-slate-500">Trayectorias</p>
            </button>
            <button onclick="showPanel('labs')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-lime-600">science</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Labs Virtuales</p>
                <p class="text-xs text-slate-500">Prácticas</p>
            </button>
            <button onclick="showPanel('external-resources')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-cyan-600">travel_explore</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Recursos</p>
                <p class="text-xs text-slate-500">Externos</p>
            </button>
            <button onclick="showPanel('eventos')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-rose-600">event</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Eventos</p>
                <p class="text-xs text-slate-500">Calendario</p>
            </button>
            <button onclick="showPanel('coursera')"
                class="p-4 rounded-xl bg-white dark:bg-surface-dark border border-slate-100 dark:border-slate-800 shadow-sm text-left">
                <span class="material-symbols-outlined text-sky-600">school</span>
                <p class="mt-2 text-sm font-bold text-slate-900 dark:text-white">Coursera</p>
                <p class="text-xs text-slate-500">Recomendaciones</p>
            </button>
        </div>
    </div>

    <!-- Subviews de más funcionalidades -->
    <div id="misiones-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('dashboard')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Misiones</h2>
        </div>
        <div id="misiones-list" class="flex flex-col gap-3"></div>
    </div>

    <div id="hoy-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Agenda de Hoy</h2>
        </div>
        <div id="hoy-list" class="flex flex-col gap-3"></div>
    </div>

    <div id="objetivos-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Objetivos</h2>
        </div>
        <button onclick="crearObjetivo()" class="w-full py-3 rounded-lg bg-primary text-white font-bold shadow-lg hover:bg-blue-600 transition">Nuevo objetivo</button>
        <div id="objetivos-list" class="flex flex-col gap-3"></div>
    </div>

    <div id="habitos-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Hábitos</h2>
        </div>
        <div id="habitos-list" class="flex flex-col gap-3"></div>
        <div id="habitos-rachas" class="text-xs text-slate-500"></div>
    </div>

    <div id="notificaciones-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Notificaciones</h2>
        </div>
        <button onclick="leerTodasNotificaciones()" class="w-full py-2 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200">Marcar todo como leído</button>
        <div id="notificaciones-list" class="flex flex-col gap-3"></div>
    </div>

    <div id="recomendaciones-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Recomendaciones</h2>
        </div>
        <div id="recomendaciones-list" class="flex flex-col gap-3"></div>
    </div>

    <div id="progreso-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Progreso</h2>
        </div>
        <div id="progreso-resumen" class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm"></div>
        <div id="progreso-list" class="flex flex-col gap-3"></div>
    </div>

    <div id="riesgo-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Riesgo Personal</h2>
        </div>
        <div id="riesgo-card" class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm"></div>
        <div id="riesgo-historial" class="flex flex-col gap-3"></div>
    </div>

    <div id="funciones-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Funciones Desbloqueables</h2>
        </div>
        <div id="funciones-list" class="flex flex-col gap-3"></div>
    </div>

    <div id="recompensas-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Recompensas</h2>
        </div>
        <div id="recompensas-list" class="flex flex-col gap-3"></div>
    </div>

    <div id="balance-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Balance</h2>
        </div>
        <div id="balance-card" class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm"></div>
    </div>

    <div id="examenes-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Exámenes</h2>
        </div>
        <button onclick="loadExamenes()" class="w-full inline-flex items-center justify-center gap-1 py-3 rounded-lg bg-primary text-white font-bold shadow-lg hover:bg-blue-600 transition">
            Actualizar Exámenes
            <span class="material-symbols-outlined text-[18px]">refresh</span>
        </button>
        <div id="examenes-list" class="flex flex-col gap-3"></div>
    </div>

    <div id="encuestas-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Encuestas</h2>
        </div>
        <div id="encuestas-list" class="flex flex-col gap-3"></div>
    </div>

    <div id="feedback-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Feedback</h2>
        </div>
        <div id="feedback-list" class="flex flex-col gap-3"></div>
    </div>

    <div id="exportaciones-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Exportaciones</h2>
        </div>
        <button onclick="abrirExportacion()" class="w-full py-3 rounded-lg bg-primary text-white font-bold shadow-lg hover:bg-blue-600 transition">Nueva exportación</button>
        <div id="exportaciones-list" class="flex flex-col gap-3"></div>
    </div>

    <div id="ayuda-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Ayuda</h2>
        </div>
        <div class="flex gap-2">
            <input id="ayuda-seccion" type="text" placeholder="Sección (ej: dashboard)"
                class="flex-1 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-dark px-3 py-2 text-sm" />
            <button onclick="loadAyuda()" class="px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200">Buscar</button>
        </div>
        <div id="ayuda-list" class="flex flex-col gap-3"></div>
    </div>

    <div id="documentos-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Documentos</h2>
        </div>
        <div class="flex flex-col gap-3">
            <button onclick="descargarConstancia()" class="w-full py-3 rounded-lg bg-emerald-500 text-white font-bold shadow-lg hover:bg-emerald-600 transition">Generar constancia</button>
            <button onclick="descargarBoleta()" class="w-full py-3 rounded-lg bg-blue-500 text-white font-bold shadow-lg hover:bg-blue-600 transition">Descargar boleta</button>
        </div>
    </div>

    <!-- Logros View -->
    <div id="logros-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Logros</h2>
        </div>
        <div id="logros-hoy" class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm"></div>
        <div id="logros-semana" class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm"></div>
        <div>
            <h3 class="text-sm font-bold text-slate-900 dark:text-white mb-2">Recompensas disponibles</h3>
            <div id="logros-recompensas" class="flex flex-col gap-3"></div>
        </div>
        <div>
            <h3 class="text-sm font-bold text-slate-900 dark:text-white mb-2">Historial de canjes</h3>
            <div id="logros-historial" class="flex flex-col gap-3"></div>
        </div>
    </div>

    <!-- Insignias View -->
    <div id="insignias-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Mis Insignias</h2>
        </div>
        <div id="insignias-stats" class="text-xs text-slate-500"></div>
        <div id="insignias-list" class="grid grid-cols-2 gap-3"></div>
    </div>

    <!-- Ranking View -->
    <div id="ranking-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Ranking</h2>
        </div>
        <div class="flex gap-2">
            <button onclick="loadRanking('semanal')" class="px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 text-xs">Semanal</button>
            <button onclick="loadRanking('mensual')" class="px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 text-xs">Mensual</button>
            <button onclick="loadRanking('global')" class="px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 text-xs">Global</button>
        </div>
        <div id="ranking-list" class="flex flex-col gap-3"></div>
    </div>

    <!-- Mensajería View -->
    <div id="mensajeria-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Mensajería</h2>
        </div>
        <div id="mensajeria-list" class="flex flex-col gap-3"></div>
        <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
            <h3 class="text-sm font-bold mb-2">Nuevo mensaje</h3>
            <div class="grid grid-cols-2 gap-2">
                <input id="msg-destinatario" type="number" placeholder="ID destinatario" class="rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2 text-sm" />
                <select id="msg-tipo" class="rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2 text-sm">
                    <option value="usuario">Usuario</option>
                    <option value="materia">Materia</option>
                </select>
            </div>
            <input id="msg-asunto" type="text" placeholder="Asunto" class="w-full mt-2 rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2 text-sm" />
            <textarea id="msg-contenido" rows="3" placeholder="Mensaje" class="w-full mt-2 rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2 text-sm"></textarea>
            <button onclick="enviarMensaje()" class="w-full mt-2 py-2 rounded-lg bg-primary text-white font-bold">Enviar</button>
        </div>
    </div>

    <!-- Notificaciones internas View -->
    <div id="notificaciones-internas-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Notificaciones internas</h2>
        </div>
        <button onclick="marcarTodasNotificacionesInternas()" class="w-full py-2 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200">Marcar todo como leído</button>
        <div id="notificaciones-internas-list" class="flex flex-col gap-3"></div>
    </div>

    <!-- Foros View -->
    <div id="foros-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Foros</h2>
        </div>
        <button onclick="crearPostForo()" class="w-full py-3 rounded-lg bg-primary text-white font-bold shadow-lg hover:bg-blue-600 transition">Nuevo post</button>
        <div id="foros-list" class="flex flex-col gap-3"></div>
    </div>

    <!-- Flashcards View -->
    <div id="flashcards-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Flashcards</h2>
        </div>
        <button onclick="crearFlashcard()" class="w-full py-3 rounded-lg bg-primary text-white font-bold shadow-lg hover:bg-blue-600 transition">Nueva flashcard</button>
        <div id="flashcards-list" class="flex flex-col gap-3"></div>
    </div>

    <!-- Tutor IA View -->
    <div id="ia-tutor-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Tutor IA</h2>
        </div>
        <div id="ia-chat" class="flex flex-col gap-3"></div>
        <div class="flex gap-2">
            <input id="ia-input" type="text" placeholder="Pregunta al tutor..." class="flex-1 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-dark px-3 py-2 text-sm" />
            <button onclick="enviarPreguntaIA()" class="px-3 py-2 rounded-xl bg-primary text-white">Enviar</button>
        </div>
    </div>

    <!-- Playground View -->
    <div id="playground-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Playground</h2>
        </div>
        <textarea id="playground-code" rows="10" class="w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-dark px-3 py-2 text-sm" placeholder="Escribe tu código aquí..."></textarea>
        <div class="flex gap-2">
            <button onclick="loadPlayground()" class="flex-1 py-2 rounded-lg bg-slate-100 dark:bg-slate-800">Cargar</button>
            <button onclick="savePlayground()" class="flex-1 py-2 rounded-lg bg-primary text-white">Guardar</button>
        </div>
    </div>

    <!-- Snippets View -->
    <div id="snippets-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Snippets</h2>
        </div>
        <textarea id="snippet-code" rows="6" class="w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-dark px-3 py-2 text-sm" placeholder="Código a compartir..."></textarea>
        <button onclick="shareSnippet()" class="w-full py-2 rounded-lg bg-primary text-white">Compartir</button>
        <div class="flex gap-2">
            <input id="snippet-id" type="text" placeholder="ID de snippet" class="flex-1 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-dark px-3 py-2 text-sm" />
            <button onclick="loadSnippet()" class="px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800">Ver</button>
        </div>
        <pre id="snippet-viewer" class="whitespace-pre-wrap text-xs bg-slate-100 dark:bg-slate-800 rounded-xl p-3"></pre>
    </div>

    <!-- Tienda View -->
    <div id="tienda-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Tienda</h2>
        </div>
        <div id="tienda-balance" class="text-xs text-slate-500"></div>
        <div id="tienda-list" class="grid grid-cols-2 gap-3"></div>
    </div>

    <!-- Learning Paths View -->
    <div id="learning-paths-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Learning Paths</h2>
        </div>
        <div id="learning-paths-list" class="flex flex-col gap-3"></div>
    </div>

    <!-- Labs View -->
    <div id="labs-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Labs Virtuales</h2>
        </div>
        <select id="labs-materia" class="w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-dark px-3 py-2 text-sm"></select>
        <div id="labs-list" class="flex flex-col gap-3"></div>
    </div>

    <!-- Recursos Externos View -->
    <div id="external-resources-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Recursos Externos</h2>
        </div>
        <select id="external-materia" class="w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-dark px-3 py-2 text-sm"></select>
        <div id="external-list" class="flex flex-col gap-3"></div>
    </div>

    <!-- Eventos View -->
    <div id="eventos-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Eventos</h2>
        </div>
        <div id="eventos-list" class="flex flex-col gap-3"></div>
    </div>

    <!-- Coursera View -->
    <div id="coursera-view" class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('more')" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Coursera</h2>
        </div>
        <select id="coursera-materia" class="w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-dark px-3 py-2 text-sm"></select>
        <div id="coursera-list" class="flex flex-col gap-3"></div>
    </div>
    <script>

        // --- APIs: Notas personales ---
        async function loadNotes() {
            const list = document.getElementById('notes-list');
            list.innerHTML = '<div class="flex justify-center p-4"><span class="text-slate-400">Cargando notas...</span></div>';
            try {
                const res = await fetch('/api/notes');
                const notes = await res.json();
                
                // Botón para crear nueva nota
                let html = `
                    <button onclick="crearNota()" class="w-full py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl font-medium shadow-lg hover:shadow-xl transition mb-4">
                        <span class="material-symbols-outlined inline-block align-middle">add</span>
                        Nueva Nota
                    </button>
                `;
                
                if (!notes || notes.length === 0) {
                    html += `
                        <div class="bg-slate-100 dark:bg-slate-800 rounded-xl p-8 text-center">
                            <span class="material-symbols-outlined text-5xl text-slate-400 mb-3">note_add</span>
                            <p class="text-slate-600 dark:text-slate-400">No tienes notas aún</p>
                            <p class="text-sm text-slate-500 mt-1">Crea tu primera nota para empezar</p>
                        </div>
                    `;
                } else {
                    html += '<div class="space-y-3">';
                    notes.forEach(n => {
                        const colores = ['bg-yellow-100 border-yellow-300', 'bg-blue-100 border-blue-300', 'bg-green-100 border-green-300', 'bg-pink-100 border-pink-300', 'bg-purple-100 border-purple-300'];
                        const colorAleatorio = colores[n.id % colores.length];
                        html += `
                            <div class="p-4 rounded-xl shadow-sm border-l-4 ${colorAleatorio} relative">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-bold text-slate-900 dark:text-white pr-16">${n.titulo}</h4>
                                    <div class="absolute top-3 right-3 flex gap-1">
                                        <button onclick="editarNota(${n.id})" class="p-1 hover:bg-white/50 rounded" title="Editar">
                                            <span class="material-symbols-outlined text-sm text-blue-600">edit</span>
                                        </button>
                                        <button onclick="eliminarNota(${n.id})" class="p-1 hover:bg-white/50 rounded" title="Eliminar">
                                            <span class="material-symbols-outlined text-sm text-red-600">delete</span>
                                        </button>
                                    </div>
                                </div>
                                <p class="text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap">${n.contenido || 'Sin contenido'}</p>
                                ${n.fecha_creacion ? '<p class="text-xs text-slate-500 mt-2">📅 ' + n.fecha_creacion + '</p>' : ''}
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                list.innerHTML = html;
            } catch (e) {
                console.error('Error en loadNotes:', e);
                list.innerHTML = '<p class="text-center text-red-500">Error al cargar notas.</p>';
            }
        }
        
        function crearNota() {
            Swal.fire({
                title: 'Nueva Nota',
                html: `
                    <input id="swal-titulo" type="text" class="swal2-input" placeholder="Título de la nota" required>
                    <textarea id="swal-contenido" class="swal2-textarea" rows="5" placeholder="Contenido de la nota"></textarea>
                `,
                showCancelButton: true,
                confirmButtonText: 'Crear',
                cancelButtonText: 'Cancelar',
                width: '600px',
                preConfirm: () => {
                    const titulo = document.getElementById('swal-titulo').value;
                    const contenido = document.getElementById('swal-contenido').value;
                    if (!titulo) {
                        Swal.showValidationMessage('El título es requerido');
                        return false;
                    }
                    return { titulo, contenido };
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const res = await fetch('/api/notes', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(result.value)
                        });
                        const data = await res.json();
                        if (data.success) {
                            showToast('Nota creada exitosamente', 'success');
                            loadNotes();
                        } else {
                            showToast(data.error || 'Error al crear nota', 'error');
                        }
                    } catch (e) {
                        showToast('Error de conexión', 'error');
                    }
                }
            });
        }
        
        async function editarNota(notaId) {
            try {
                // Obtener datos de la nota
                const res = await fetch('/api/notes/' + notaId);
                const nota = await res.json();
                
                Swal.fire({
                    title: 'Editar Nota',
                    html: `
                        <input id="swal-titulo" type="text" class="swal2-input" placeholder="Título" value="${nota.titulo || ''}" required>
                        <textarea id="swal-contenido" class="swal2-textarea" rows="5" placeholder="Contenido">${nota.contenido || ''}</textarea>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Guardar',
                    cancelButtonText: 'Cancelar',
                    width: '600px',
                    preConfirm: () => {
                        const titulo = document.getElementById('swal-titulo').value;
                        if (!titulo) {
                            Swal.showValidationMessage('El título es requerido');
                            return false;
                        }
                        return {
                            titulo: titulo,
                            contenido: document.getElementById('swal-contenido').value
                        };
                    }
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        const updateRes = await fetch('/api/notes/' + notaId, {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(result.value)
                        });
                        const data = await updateRes.json();
                        if (data.success) {
                            showToast('Nota actualizada', 'success');
                            loadNotes();
                        } else {
                            showToast(data.error || 'Error al actualizar', 'error');
                        }
                    }
                });
            } catch (e) {
                showToast('Error al cargar la nota', 'error');
            }
        }
        
        function eliminarNota(notaId) {
            Swal.fire({
                title: '¿Eliminar nota?',
                text: 'Esta acción no se puede deshacer',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#ef4444'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const res = await fetch('/api/notes/' + notaId, {
                            method: 'DELETE'
                        });
                        const data = await res.json();
                        if (data.success) {
                            showToast('Nota eliminada', 'success');
                            loadNotes();
                        } else {
                            showToast(data.error || 'Error al eliminar', 'error');
                        }
                    } catch (e) {
                        showToast('Error de conexión', 'error');
                    }
                }
            });
        }

        // --- APIs: Portafolio ---
        async function loadPortfolio() {
            const list = document.getElementById('portfolio-list');
            list.innerHTML = '<div class="flex justify-center p-4"><span class="text-slate-400">Cargando portafolio...</span></div>';
            try {
            const res = await fetch('/api/alumno/portafolio');
            const data = await res.json();
            const itemsRes = await fetch('/api/portfolio');
            const items = await itemsRes.json();
                
                if (data.error) {
                    list.innerHTML = '<p class="text-center text-red-500">Error: ' + data.error + '</p>';
                    return;
                }
                
                // Construir vista del portafolio
                let html = `
                    <!-- Información del Alumno -->
                    <div class="bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl p-6 text-white shadow-lg">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="h-16 w-16 rounded-full border-4 border-white shadow-lg bg-cover bg-center"
                                style="background-image: url('${data.alumno.foto_perfil || data.alumno.avatar_url || 'https://ui-avatars.com/api/?name=' + data.alumno.nombre}');"></div>
                            <div>
                                <h3 class="text-xl font-bold">${data.alumno.nombre}</h3>
                                <p class="text-sm opacity-90">${data.alumno.email}</p>
                                <p class="text-xs opacity-75">Semestre: ${data.alumno.semestre}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-3 mt-4">
                            <div class="text-center">
                                <p class="text-2xl font-bold">${data.promedio_general}</p>
                                <p class="text-xs opacity-75">Promedio</p>
                            </div>
                            <div class="text-center">
                                <p class="text-2xl font-bold">${data.porcentaje_asistencia}%</p>
                                <p class="text-xs opacity-75">Asistencia</p>
                            </div>
                            <div class="text-center">
                                <p class="text-2xl font-bold">${data.total_entregas}</p>
                                <p class="text-xs opacity-75">Entregas</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Insignias -->
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <h4 class="font-bold text-slate-900 dark:text-white mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-yellow-500">military_tech</span>
                            Insignias (${data.insignias.length})
                        </h4>
                        <div class="grid grid-cols-4 gap-3">
                            ${data.insignias.map(ins => `
                                <div class="flex flex-col items-center gap-1 p-2 rounded-lg bg-slate-50 dark:bg-slate-800">
                                    <span class="text-2xl">${ins.icono || '🏆'}</span>
                                    <p class="text-[10px] text-center font-medium text-slate-600 dark:text-slate-400">${ins.nombre}</p>
                                </div>
                            `).join('') || '<p class="text-sm text-slate-500 col-span-4 text-center py-2">Sin insignias aún</p>'}
                        </div>
                    </div>
                    
                    <!-- Historial de Calificaciones -->
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <h4 class="font-bold text-slate-900 dark:text-white mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-blue-500">analytics</span>
                            Historial de Calificaciones
                        </h4>
                        <div class="space-y-2 max-h-64 overflow-y-auto">
                            ${data.calificaciones.slice(0, 10).map(cal => `
                                <div class="flex justify-between items-center p-3 rounded-lg bg-slate-50 dark:bg-slate-800">
                                    <div class="flex-1">
                                        <p class="font-medium text-sm text-slate-900 dark:text-white">${cal.titulo}</p>
                                        <p class="text-xs text-slate-500">${cal.materia} • ${cal.fecha_entrega}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-lg font-bold ${cal.calificacion >= 8 ? 'text-green-600' : cal.calificacion >= 6 ? 'text-yellow-600' : 'text-red-600'}">
                                            ${cal.calificacion}
                                        </p>
                                    </div>
                                </div>
                            `).join('') || '<p class="text-sm text-slate-500 text-center py-2">Sin calificaciones registradas</p>'}
                        </div>
                    </div>
                    
                    <!-- Materias -->
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <h4 class="font-bold text-slate-900 dark:text-white mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-purple-500">school</span>
                            Materias del Semestre
                        </h4>
                        <div class="space-y-2">
                            ${data.materias.map(mat => `
                                <div class="flex justify-between items-center p-3 rounded-lg bg-slate-50 dark:bg-slate-800">
                                    <div>
                                        <p class="font-medium text-sm text-slate-900 dark:text-white">${mat.nombre}</p>
                                        <p class="text-xs text-slate-500">Prof. ${mat.docente}</p>
                                    </div>
                                </div>
                            `).join('') || '<p class="text-sm text-slate-500 text-center py-2">Sin materias registradas</p>'}
                        </div>
                    </div>

                    <!-- Evidencias del Portafolio -->
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                <span class="material-symbols-outlined text-indigo-500">workspaces</span>
                                Evidencias
                            </h4>
                            <div class="flex gap-2">
                                <button onclick="openPortfolioItemModal()" class="text-xs text-primary font-medium">+ Texto</button>
                                <button onclick="openPortfolioUpload()" class="text-xs text-primary font-medium">+ Archivo</button>
                            </div>
                        </div>
                        <div class="space-y-2">
                            ${(Array.isArray(items) && items.length) ? items.map(item => {
                                const fileUrl = item.archivo_ruta ? `/uploads/${item.archivo_ruta}` : null;
                                return `
                                    <div class="flex items-start justify-between p-3 rounded-lg bg-slate-50 dark:bg-slate-800">
                                        <div class="flex-1">
                                            <p class="font-medium text-sm text-slate-900 dark:text-white">${item.titulo}</p>
                                            <p class="text-xs text-slate-500">${item.descripcion || item.materia || ''}</p>
                                            ${item.fecha_subida ? `<p class="text-[10px] text-slate-400">${item.fecha_subida}</p>` : ''}
                                            ${fileUrl ? `<a href="${fileUrl}" target="_blank" class="text-xs text-blue-600">Ver archivo</a>` : ''}
                                        </div>
                                        <div class="flex gap-1">
                                            <button onclick="openPortfolioItemModal(${item.id}, '${item.titulo.replace(/'/g, "\\'")}', '${(item.descripcion || '').replace(/'/g, "\\'")}')" class="p-1 text-slate-500 hover:text-primary">
                                                <span class="material-symbols-outlined text-sm">edit</span>
                                            </button>
                                            <button onclick="deletePortfolioItem(${item.id})" class="p-1 text-slate-500 hover:text-red-500">
                                                <span class="material-symbols-outlined text-sm">delete</span>
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('') : '<p class="text-sm text-slate-500 text-center py-2">Sin evidencias aún</p>'}
                        </div>
                    </div>
                `;
                
                list.innerHTML = html;
            } catch (e) {
                console.error('Error en loadPortfolio:', e);
                list.innerHTML = '<p class="text-center text-red-500">Error al cargar portafolio.</p>';
            }
        }

        function openPortfolioItemModal(id = null, titulo = '', descripcion = '') {
            Swal.fire({
                title: id ? 'Editar evidencia' : 'Nueva evidencia',
                html: `
                    <input id="pf-titulo" type="text" class="swal2-input" placeholder="Título" value="${titulo}" required>
                    <textarea id="pf-desc" class="swal2-textarea" placeholder="Descripción">${descripcion}</textarea>
                `,
                showCancelButton: true,
                confirmButtonText: id ? 'Guardar' : 'Crear',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const t = document.getElementById('pf-titulo').value.trim();
                    if (!t) {
                        Swal.showValidationMessage('Título requerido');
                        return false;
                    }
                    return {
                        titulo: t,
                        descripcion: document.getElementById('pf-desc').value.trim()
                    };
                }
            }).then(async (result) => {
                if (!result.isConfirmed) return;
                try {
                    const url = id ? `/api/portfolio/${id}` : '/api/portfolio';
                    const method = id ? 'PUT' : 'POST';
                    const res = await fetch(url, {
                        method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(result.value)
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Error al guardar');
                    showToast('Evidencia guardada', 'success');
                    loadPortfolio();
                } catch (e) {
                    showToast(e.message, 'error');
                }
            });
        }

        function openPortfolioUpload() {
            Swal.fire({
                title: 'Subir archivo',
                html: `
                    <input id="pf-nombre" type="text" class="swal2-input" placeholder="Nombre del archivo" />
                    <input id="pf-materia" type="text" class="swal2-input" placeholder="Materia (opcional)" />
                    <input id="pf-file" type="file" class="swal2-file" />
                `,
                showCancelButton: true,
                confirmButtonText: 'Subir',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const file = document.getElementById('pf-file').files[0];
                    if (!file) {
                        Swal.showValidationMessage('Selecciona un archivo');
                        return false;
                    }
                    return {
                        file,
                        nombre: document.getElementById('pf-nombre').value || file.name,
                        materia: document.getElementById('pf-materia').value || 'General'
                    };
                }
            }).then(async (result) => {
                if (!result.isConfirmed) return;
                try {
                    const form = new FormData();
                    form.append('file', result.value.file);
                    form.append('nombre', result.value.nombre);
                    form.append('materia', result.value.materia);

                    const res = await fetch('/api/portfolio/upload', {
                        method: 'POST',
                        body: form
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Error al subir');
                    showToast('Archivo subido', 'success');
                    loadPortfolio();
                } catch (e) {
                    showToast(e.message, 'error');
                }
            });
        }

        function deletePortfolioItem(id) {
            Swal.fire({
                title: 'Eliminar evidencia',
                text: 'Esta acción no se puede deshacer',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Eliminar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#ef4444'
            }).then(async (result) => {
                if (!result.isConfirmed) return;
                try {
                    const res = await fetch(`/api/portfolio/${id}`, { method: 'DELETE' });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Error al eliminar');
                    showToast('Evidencia eliminada', 'success');
                    loadPortfolio();
                } catch (e) {
                    showToast(e.message, 'error');
                }
            });
        }

        // --- APIs: Tutorías ---
        async function loadTutorias() {
            const list = document.getElementById('tutorias-list');
            list.innerHTML = '<div class="flex justify-center p-4"><span class="text-slate-400">Cargando tutorías...</span></div>';
            try {
                const res = await fetch('/api/alumno/tutorias');
                const data = await res.json();
                
                if (data.error) {
                    list.innerHTML = '<p class="text-center text-red-500">Error: ' + data.error + '</p>';
                    return;
                }
                
                let html = '';
                
                // Información del Tutor
                if (data.tutor) {
                    html += `
                        <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl p-6 text-white shadow-lg">
                            <div class="flex items-center gap-4">
                                <div class="h-16 w-16 rounded-full border-4 border-white shadow-lg bg-cover bg-center"
                                    style="background-image: url('${data.tutor.foto_perfil || 'https://ui-avatars.com/api/?name=' + data.tutor.nombre}');"></div>
                                <div>
                                    <p class="text-sm opacity-75">Tu Tutor Asignado</p>
                                    <h3 class="text-xl font-bold">${data.tutor.nombre}</h3>
                                    <p class="text-sm opacity-90">${data.tutor.email}</p>
                                    ${data.tutor.telefono ? '<p class="text-xs opacity-75">📞 ' + data.tutor.telefono + '</p>' : ''}
                                </div>
                            </div>
                            <button onclick="solicitarTutoria()" class="mt-4 w-full py-2 bg-white/20 hover:bg-white/30 rounded-lg font-medium transition">
                                📝 Solicitar Nueva Sesión
                            </button>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="bg-slate-100 dark:bg-slate-800 rounded-xl p-6 text-center">
                            <span class="material-symbols-outlined text-5xl text-slate-400 mb-2">support_agent</span>
                            <p class="text-slate-600 dark:text-slate-400">${data.mensaje || 'Aún no tienes un tutor asignado'}</p>
                        </div>
                    `;
                }
                
                // Sesiones de Tutoría
                if (data.sesiones && data.sesiones.length > 0) {
                    html += `
                        <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                            <h4 class="font-bold text-slate-900 dark:text-white mb-3 flex items-center gap-2">
                                <span class="material-symbols-outlined text-indigo-500">event</span>
                                Sesiones de Tutoría
                            </h4>
                            <div class="space-y-3">
                                ${data.sesiones.map(sesion => {
                                    const estadoColor = sesion.estado === 'completada' ? 'green' : sesion.estado === 'programada' ? 'blue' : 'slate';
                                    const tutorNombre = sesion.tutor_nombre || (data.tutor && data.tutor.nombre) || 'Tutor';
                                    const fechaSesion = sesion.fecha || sesion.fecha_hora || '';
                                    return `
                                        <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-800">
                                            <div class="flex justify-between items-start mb-2">
                                                <div>
                                                    <p class="font-medium text-sm text-slate-900 dark:text-white">
                                                        Sesión con ${tutorNombre}
                                                    </p>
                                                    <p class="text-xs text-slate-500">
                                                        <span class="material-symbols-outlined text-[14px] inline-block align-middle">schedule</span>
                                                        ${fechaSesion}
                                                    </p>
                                                </div>
                                                <span class="text-xs px-2 py-1 rounded-full bg-${estadoColor}-100 text-${estadoColor}-700 dark:bg-${estadoColor}-900/30 dark:text-${estadoColor}-300">
                                                    ${sesion.estado}
                                                </span>
                                            </div>
                                            ${sesion.notas ? `<p class="text-xs text-slate-600 dark:text-slate-400 mt-2">${sesion.notas}</p>` : ''}
                                            ${sesion.duracion_minutos ? `<p class="text-xs text-slate-400 mt-1">⏱️ ${sesion.duracion_minutos} minutos</p>` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="bg-white dark:bg-surface-dark rounded-xl p-6 text-center border border-dashed border-slate-200 dark:border-slate-700">
                            <span class="material-symbols-outlined text-3xl text-slate-400 mb-2">event_busy</span>
                            <p class="text-sm text-slate-500">No tienes sesiones programadas</p>
                        </div>
                    `;
                }
                
                list.innerHTML = html;
            } catch (e) {
                console.error('Error en loadTutorias:', e);
                list.innerHTML = '<p class="text-center text-red-500">Error al cargar tutorías.</p>';
            }
        }
        
        function solicitarTutoria() {
            Swal.fire({
                title: 'Solicitar Sesión de Tutoría',
                html: `
                    <input id="swal-fecha" type="date" class="swal2-input" placeholder="Fecha">
                    <input id="swal-hora" type="time" class="swal2-input" placeholder="Hora">
                    <textarea id="swal-motivo" class="swal2-textarea" placeholder="Motivo de la sesión"></textarea>
                `,
                showCancelButton: true,
                confirmButtonText: 'Solicitar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const fecha = document.getElementById('swal-fecha').value;
                    const hora = document.getElementById('swal-hora').value;
                    if (!fecha || !hora) {
                        Swal.showValidationMessage('Fecha y hora son requeridas');
                        return false;
                    }
                    return {
                        fecha_hora: `${fecha} ${hora}:00`,
                        motivo: document.getElementById('swal-motivo').value || 'academico'
                    };
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const res = await fetch('/api/alumno/tutorias', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(result.value)
                        });
                        const data = await res.json();
                        if (data.success) {
                            showToast('Solicitud enviada a tu tutor', 'success');
                            loadTutorias();
                        } else {
                            showToast(data.error || 'No se pudo solicitar', 'error');
                        }
                    } catch (e) {
                        showToast('Error de conexión', 'error');
                    }
                }
            });
        }

        // --- APIs: Equipos ---
        async function loadEquipos() {
            const list = document.getElementById('equipos-list');
            list.innerHTML = '<div class="flex justify-center p-4"><span class="text-slate-400">Cargando equipos...</span></div>';
            try {
                const res = await fetch('/api/alumno/equipos');
                const data = await res.json();

                if (data.error) {
                    list.innerHTML = '<p class="text-center text-red-500">Error: ' + data.error + '</p>';
                    return;
                }

                const equipos = Array.isArray(data) ? data : (data.equipos || []);
                equiposCache = equipos;
                let html = `
                    <div class="flex gap-2 mb-4">
                        <button onclick="crearEquipo()" class="flex-1 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl font-medium shadow-lg hover:shadow-xl transition">
                            <span class="material-symbols-outlined inline-block align-middle">group_add</span>
                            Crear Equipo
                        </button>
                        <button onclick="unirseEquipo()" class="flex-1 py-3 bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-xl font-medium shadow-lg hover:shadow-xl transition">
                            <span class="material-symbols-outlined inline-block align-middle">login</span>
                            Unirse con Código
                        </button>
                    </div>
                `;

                if (equipos.length > 0) {
                    html += `
                        <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm mb-4">
                            <h4 class="font-bold text-slate-900 dark:text-white mb-3 flex items-center gap-2">
                                <span class="material-symbols-outlined text-blue-500">groups</span>
                                Mis Equipos
                            </h4>
                            <div class="space-y-3">
                                ${equipos.map(equipo => `
                                    <div class="p-4 rounded-lg bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-900 border border-slate-200 dark:border-slate-700">
                                        <div class="flex justify-between items-start mb-3">
                                            <div>
                                                <h5 class="font-bold text-slate-900 dark:text-white">${equipo.nombre}</h5>
                                                <p class="text-xs text-slate-500 mt-1">${equipo.descripcion || 'Sin descripción'}</p>
                                                ${equipo.materia ? `<p class="text-xs text-slate-400">Materia: ${equipo.materia}</p>` : ''}
                                            </div>
                                            <span class="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300">
                                                ${equipo.total_miembros || 0} miembros
                                            </span>
                                        </div>
                                        ${equipo.codigo_acceso ? `
                                            <div class="flex items-center gap-2 mb-2 p-2 bg-white/50 dark:bg-slate-950/30 rounded">
                                                <span class="material-symbols-outlined text-sm text-slate-500">key</span>
                                                <span class="text-xs font-mono text-slate-600 dark:text-slate-400">Código: ${equipo.codigo_acceso}</span>
                                                <button onclick="copiarCodigo('${equipo.codigo_acceso}')" class="ml-auto text-xs text-blue-600 hover:text-blue-700">
                                                    <span class="material-symbols-outlined text-sm">content_copy</span>
                                                </button>
                                            </div>
                                        ` : ''}
                                        <button onclick="verDetalleEquipo(${equipo.id})" class="w-full mt-2 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium transition">
                                            Ver Detalles
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="bg-slate-100 dark:bg-slate-800 rounded-xl p-8 text-center mb-4">
                            <span class="material-symbols-outlined text-5xl text-slate-400 mb-3">groups_3</span>
                            <p class="text-slate-600 dark:text-slate-400">Aún no perteneces a ningún equipo</p>
                            <p class="text-sm text-slate-500 mt-1">Crea uno o únete con un código</p>
                        </div>
                    `;
                }

                list.innerHTML = html;
            } catch (e) {
                console.error('Error en loadEquipos:', e);
                list.innerHTML = '<p class="text-center text-red-500">Error al cargar equipos.</p>';
            }
        }
        
        function crearEquipo() {
            Swal.fire({
                title: 'Crear Nuevo Equipo',
                html: `
                    <input id="swal-nombre" type="text" class="swal2-input" placeholder="Nombre del equipo" required>
                    <textarea id="swal-desc" class="swal2-textarea" placeholder="Descripción (opcional)"></textarea>
                    <input id="swal-max" type="number" class="swal2-input" placeholder="Máximo de miembros" min="2" max="20" value="5">
                `,
                showCancelButton: true,
                confirmButtonText: 'Crear',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const nombre = document.getElementById('swal-nombre').value;
                    if (!nombre) {
                        Swal.showValidationMessage('El nombre es requerido');
                        return false;
                    }
                    return {
                        nombre: nombre,
                        descripcion: document.getElementById('swal-desc').value,
                        max_miembros: document.getElementById('swal-max').value
                    };
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const res = await fetch('/api/alumno/equipos', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(result.value)
                        });
                        const data = await res.json();
                        if (data.success) {
                            showToast(data.message || 'Equipo creado exitosamente', 'success');
                            loadEquipos();
                        } else {
                            showToast(data.error || 'Error al crear equipo', 'error');
                        }
                    } catch (e) {
                        showToast('Error de conexión', 'error');
                    }
                }
            });
        }
        
        function unirseEquipo() {
            Swal.fire({
                title: 'Unirse a Equipo',
                input: 'text',
                inputLabel: 'Ingresa el código del equipo',
                inputPlaceholder: 'Ej: ABC123',
                showCancelButton: true,
                confirmButtonText: 'Unirse',
                cancelButtonText: 'Cancelar'
            }).then(async (result) => {
                if (result.isConfirmed && result.value) {
                    try {
                        const res = await fetch('/api/alumno/equipos/unirse', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ codigo: result.value })
                        });
                        const data = await res.json();
                        if (data.success) {
                            showToast(data.message || 'Te uniste al equipo', 'success');
                            loadEquipos();
                        } else {
                            showToast(data.error || 'Código inválido', 'error');
                        }
                    } catch (e) {
                        showToast('Error de conexión', 'error');
                    }
                }
            });
        }
        
        async function solicitarUnirseEquipo(equipoId) {
            try {
                const res = await fetch('/api/alumno/equipos/' + equipoId + '/unirse', {
                    method: 'POST'
                });
                const data = await res.json();
                if (data.success) {
                    showToast(data.message || 'Te uniste al equipo', 'success');
                    loadEquipos();
                } else {
                    showToast(data.error || 'No se pudo unir', 'error');
                }
            } catch (e) {
                showToast('Error de conexión', 'error');
            }
        }
        
        function copiarCodigo(codigo) {
            navigator.clipboard.writeText(codigo);
            showToast('Código copiado: ' + codigo, 'success');
        }
        
        function verDetalleEquipo(equipoId) {
            const equipo = equiposCache.find(e => e.id === equipoId);
            if (!equipo) {
                showToast('No se encontró el equipo', 'error');
                return;
            }
            Swal.fire({
                title: equipo.nombre,
                html: `
                    <div class="text-left space-y-2">
                        <p><strong>Descripción:</strong> ${equipo.descripcion || 'Sin descripción'}</p>
                        <p><strong>Materia:</strong> ${equipo.materia || 'N/A'}</p>
                        <p><strong>Miembros:</strong> ${equipo.total_miembros || 0}</p>
                        ${equipo.codigo_acceso ? `<p><strong>Código:</strong> ${equipo.codigo_acceso}</p>` : ''}
                    </div>
                `,
                confirmButtonText: 'Cerrar'
            });
        }
    </script>
    </nav>

    </div>

    <!-- Quiz Zen Mode (Phase 6) -->
    <!-- Subjects View (Materias) -->
    <div id="subjects-container"
        class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-4">
            <button onclick="showPanel('dashboard')"
                class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Mis Materias</h2>
        </div>
        {% if materias and materias|length > 0 %}
        <div id="subjects-list" class="flex flex-col gap-4">
            {% for materia in materias %}
            <div
                class="flex items-center justify-between bg-white dark:bg-surface-dark rounded-xl shadow-sm border border-slate-100 dark:border-slate-800 p-4 hover:shadow-md transition cursor-pointer">
                <div class="flex items-center gap-3">
                    <div
                        class="h-12 w-12 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 text-xl font-bold">
                        <span class="material-symbols-outlined">menu_book</span>
                    </div>
                    <div>
                        <div class="font-bold text-slate-900 dark:text-white">{{ materia.nombre }}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400 font-medium">{{ materia.docente }}</div>
                        <div class="text-xs text-slate-400 mt-1">Promedio: <span class="font-semibold">{{
                                materia.promedio }}</span></div>
                    </div>
                </div>
                <button
                    class="subject-item-action ml-2 px-3 py-1 rounded-lg bg-primary text-white text-xs font-bold shadow hover:bg-blue-700 transition flex items-center gap-1"
                    data-materia-id="{{ materia.id }}" data-materia-nombre="{{ materia.nombre }}">
                    Ver recursos
                    <span class="material-symbols-outlined text-[16px]">arrow_forward</span>
                </button>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="flex flex-col items-center justify-center h-64 text-slate-400">
            <span class="material-symbols-outlined text-5xl mb-2">school</span>
            <div class="text-lg font-semibold mb-1">No tienes materias inscritas</div>
            <div class="text-sm">Contacta a tu coordinador académico si esto es un error.</div>
        </div>
        {% endif %}
    </div>
    <div id="quiz-mode"
        class="fixed inset-0 z-[200] bg-white dark:bg-background-dark flex flex-col hidden overflow-hidden">
        <!-- Progress Header -->
        <div class="px-6 py-4">
            <div class="flex justify-between items-center mb-2">
                <span id="quiz-progress-text"
                    class="text-xs font-bold text-slate-500 uppercase tracking-widest">Question 1/10</span>
                <button onclick="quitQuiz()" class="text-slate-400 hover:text-red-500 transition">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="h-1.5 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                <div id="quiz-progress-bar" class="h-full bg-purple-600 transition-all duration-500" style="width: 0%">
                </div>
            </div>
        </div>

        <!-- Question Container -->
        <div class="flex-1 flex flex-col justify-center px-6 max-w-lg mx-auto w-full">
            <div id="quiz-content" class="space-y-8">
                <!-- Injected via JS -->
            </div>
        </div>

        <!-- Footer Actions -->
        <div class="p-6 border-t border-slate-100 dark:border-slate-800 flex justify-end">
            <button id="quiz-next-btn" onclick="nextQuestion()"
                class="px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl shadow-lg shadow-purple-200 dark:shadow-none transition flex items-center gap-2">
                Siguiente
                <span class="material-symbols-outlined">arrow_forward</span>
            </button>
        </div>
    </div>

    <div id="upload-modal"
        class="fixed inset-0 z-[60] hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div
            class="bg-white dark:bg-surface-dark w-full max-w-md rounded-2xl p-6 shadow-2xl transform scale-95 transition-transform duration-300">
            <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-4">Subir Entrega</h3>
            <input type="hidden" id="upload-task-id">
            <textarea id="upload-comment" rows="2" placeholder="Comentario opcional..."
                class="w-full mt-3 mb-2 p-2 rounded border border-slate-200 dark:border-slate-700 text-sm"></textarea>

            <div
                class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-8 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition relative">
                <input type="file" id="fileInput" class="absolute inset-0 opacity-0 cursor-pointer"
                    accept=".pdf,.doc,.docx,.jpg,.png">
                <span class="material-symbols-outlined text-4xl text-slate-400 mb-2">cloud_upload</span>
                <p class="text-sm font-medium text-slate-700 dark:text-slate-300">Click para seleccionar archivo</p>
                <p id="file-name-display" class="text-xs text-slate-500 mt-1">PDF, Word, Imagen (Max 10MB)</p>
            </div>

            <!-- Progress Bar -->
            <div id="upload-progress-container" class="hidden mt-4">
                <div class="flex justify-between text-xs mb-1">
                    <span class="text-slate-500">Subiendo...</span>
                    <span id="upload-percent" class="text-primary font-bold">0%</span>
                </div>
                <div class="w-full bg-slate-100 dark:bg-slate-700 h-2 rounded-full overflow-hidden">
                    <div id="upload-bar" class="bg-primary h-full rounded-full transition-all duration-300"
                        style="width: 0%"></div>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeUploadModal()"
                    class="flex-1 py-2 rounded-lg text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 transition font-medium">Cancelar</button>
                <button onclick="enviarTarea(document.getElementById('upload-task-id').value)"
                    class="flex-1 py-2 rounded-lg bg-primary text-white font-bold shadow-lg hover:bg-blue-600 transition">Entregar</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal (Phase 4) -->
    <div id="profile-modal"
        class="fixed inset-0 z-[60] hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div
            class="bg-white dark:bg-surface-dark w-full max-w-md rounded-2xl p-6 shadow-2xl transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Perfil & Ajustes</h3>
                <button onclick="closeProfileModal()"
                    class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <form onsubmit="updateProfile(event)" class="space-y-4">
                <!-- Avatar Upload -->
                <div class="flex flex-col items-center gap-2 mb-4">
                    <div class="relative group cursor-pointer">
                        <div id="profile-preview"
                            class="h-24 w-24 rounded-full border-4 border-slate-100 dark:border-slate-700 bg-cover bg-center"
                            data-avatar="{{ avatar_url if 'http' in avatar_url else url_for('uploaded_file', filename=avatar_url) if avatar_url else 'https://ui-avatars.com/api/?name=' + nombre + '&background=random' }}">
                        </div>
                        <div
                            class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                            <span class="material-symbols-outlined text-white">camera_alt</span>
                        </div>
                        <input type="file" name="avatar" class="absolute inset-0 opacity-0 cursor-pointer"
                            accept="image/*" onchange="previewAvatar(this)">
                    </div>
                    <p class="text-xs text-slate-500">Toque para cambiar foto</p>
                </div>

                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Nueva Contraseña</label>
                    <input type="password" name="password" placeholder="Mínimo 6 caracteres"
                        class="w-full bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white rounded-lg px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                </div>

                <div class="pt-4 flex flex-col gap-3">
                    <button type="submit"
                        class="w-full py-3 rounded-lg bg-primary text-white font-bold shadow-lg hover:bg-blue-600 transition">
                        Guardar Cambios
                    </button>
                    <button type="button" onclick="logout()"
                        class="w-full py-3 rounded-lg border border-red-200 dark:border-red-900/30 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition font-medium">
                        Cerrar Sesión
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Courses View (Grid) -->
    <div id="courses-view"
        class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('dashboard')"
                class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">Mis Materias</h2>
        </div>
        <div id="courses-list" class="grid grid-cols-2 gap-4">
            <!-- Courses injected here -->
        </div>
    </div>

    <!-- Resources View (Detail) -->
    <div id="resources-view"
        class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark p-4 space-y-4 pb-20 overflow-y-auto z-20">
        <div class="flex items-center gap-2 mb-2">
            <button onclick="showPanel('subjects')"
                class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 id="resource-subject-title" class="text-xl font-bold text-slate-900 dark:text-white">Recursos</h2>
        </div>
        <div id="resources-list" class="flex flex-col gap-3">
            <!-- Resources injected here -->
        </div>
    </div>
    <!-- Community/Chat Container (Hidden) -->
    <div id="community-container"
        class="hidden absolute inset-0 w-full h-full max-w-md mx-auto bg-white dark:bg-background-dark flex flex-col pb-20 overflow-y-auto z-20">
        <!-- Chat Header -->
        <div
            class="px-4 py-3 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center sticky top-0 bg-white/90 dark:bg-background-dark/90 backdrop-blur-sm z-10">
            <div class="flex items-center gap-3">
                <button onclick="showPanel('dashboard')"
                    class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-900 dark:text-white">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <div class="relative">
                    <div class="h-10 w-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center">
                        <span class="material-symbols-outlined">groups</span>
                    </div>
                    <span
                        class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-white rounded-full"></span>
                </div>
                <div>
                    <h2 class="font-bold text-slate-900 dark:text-white leading-tight">Aula General</h2>
                    <p class="text-xs text-slate-500">32 en línea • Grupo 501</p>
                </div>
            </div>
            <button class="text-slate-400 hover:text-indigo-600 transition">
                <span class="material-symbols-outlined">info</span>
            </button>
        </div>

        <!-- Chat Messages -->
        <div id="community-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 dark:bg-slate-900/50">
            <!-- Messages will be injected here via JS -->
            <!-- Placeholder -->
            <div class="flex justify-center my-4">
                <span class="text-xs bg-slate-200 dark:bg-slate-800 text-slate-500 px-3 py-1 rounded-full">Hoy</span>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="p-3 border-t border-slate-100 dark:border-slate-800 bg-white dark:bg-surface-dark">
            <form onsubmit="sendGroupMessage(event)" class="flex gap-2 items-center">
                <button type="button" class="text-slate-400 hover:text-indigo-500 transition p-2">
                    <span class="material-symbols-outlined text-[20px]">add_circle</span>
                </button>
                <input type="text" id="group-chat-input" placeholder="Escribe un mensaje..."
                    class="flex-1 bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white rounded-full px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button type="submit"
                    class="p-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full transition shadow-md">
                    <span class="material-symbols-outlined text-[18px] block">send</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Toast Notifications Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none"></div>

    <!-- Notification Sound -->
    <audio id="notification-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"
        preload="auto"></audio>

    <!-- AI Chat Plugin -->
    <!-- AI Chat Plugin (Phase 7 Final) -->
    <!-- FAB -->
    <button onclick="toggleChat()"
        class="fixed bottom-20 right-4 z-50 h-14 w-14 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full shadow-lg flex items-center justify-center text-white hover:scale-110 transition-transform animate-bounce-slow">
        <span class="material-symbols-outlined text-[28px]">smart_toy</span>
    </button>

    <!-- Chat Widget -->
    <div id="ai-chat-widget"
        class="fixed bottom-4 right-6 z-[60] w-80 md:w-96 h-[500px] bg-white dark:bg-surface-dark rounded-2xl shadow-2xl flex flex-col hidden border border-slate-200 dark:border-slate-800 transform origin-bottom-right transition-all duration-300 scale-90 opacity-0">
        <!-- Header -->
        <div
            class="h-16 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-t-2xl flex items-center justify-between px-4">
            <div class="flex items-center gap-3">
                <div class="bg-white/20 p-1.5 rounded-lg">
                    <span class="material-symbols-outlined text-white">psychology</span>
                </div>
                <div>
                    <h3 class="font-bold text-white text-sm">Tutor IA</h3>
                    <p class="text-[10px] text-white/80 flex items-center gap-1">
                        <span class="w-1.5 h-1.5 bg-green-400 rounded-full"></span> En línea
                    </p>
                </div>
            </div>
            <button onclick="toggleChat()" class="text-white/80 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <!-- Messages Area -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 dark:bg-background-dark/50">
            <!-- Welcome Message -->
            <div class="flex gap-3">
                <div
                    class="h-8 w-8 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center text-purple-600 shrink-0">
                    <span class="material-symbols-outlined text-[18px]">smart_toy</span>
                </div>
                <div
                    class="bg-white dark:bg-surface-dark p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-800 dark:text-slate-200 border border-slate-100 dark:border-slate-800 max-w-[85%]">
                    ¡Hola Alex! Soy tu tutor IA. ¿En qué materia necesitas ayuda hoy? 🤖
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-white dark:bg-surface-dark border-t border-slate-200 dark:border-slate-800 rounded-b-2xl">
            <form onsubmit="sendAIMessage(event)" class="relative">
                <input type="text" id="ai-input" placeholder="Pregunta algo..."
                    class="w-full bg-slate-100 dark:bg-slate-900 text-slate-900 dark:text-white rounded-full pl-4 pr-12 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                <button type="submit"
                    class="absolute right-2 top-2 h-8 w-8 bg-purple-600 rounded-full flex items-center justify-center text-white hover:bg-purple-700 transition">
                    <span class="material-symbols-outlined text-[18px]">send</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Socket.IO & SweetAlert2 -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        let socket;

        document.addEventListener('DOMContentLoaded', () => {
            console.log('Student Panel Logic Initialized');

            document.querySelectorAll('[data-avatar]').forEach(el => {
                const url = el.getAttribute('data-avatar');
                if (url) el.style.backgroundImage = `url('${url}')`;
            });

            // 1. Socket.IO Connection
            socket = io();

            socket.on('connect', () => {
                console.log('Conectado al servidor SocketIO');
                socket.emit('join', { room: 'grupo_501', role: 'student' });
            });

            socket.on('notification', (data) => {
                showToast(data.message, data.type || 'info');
                const audio = document.getElementById('notification-sound');
                if (audio) audio.play().catch(e => console.log('Audio blocked', e));
            });

            socket.on('message', (data) => {
                appendGroupMessage(data);
            });

            socket.on('disconnect', () => {
                console.log('Desconectado del servidor');
            });

            document.addEventListener('click', (e) => {
                const item = e.target.closest('.assignment-item');
                if (item && item.dataset.tareaId) {
                    openAssignment(parseInt(item.dataset.tareaId, 10));
                }

                const subjectBtn = e.target.closest('.subject-item-action');
                if (subjectBtn && subjectBtn.dataset.materiaId) {
                    openSubjectDetails(parseInt(subjectBtn.dataset.materiaId, 10), subjectBtn.dataset.materiaNombre || 'Materia');
                }
            });

            // --- Dashboard Inicio: cargar datos dinámicamente ---
            loadDashboard();

            const panelParam = new URLSearchParams(window.location.search).get('panel');
            if (panelParam) {
                showPanel(panelParam);
            }
        });

        let tareasCache = [];
        let filtroTareas = 'pendientes';
        let equiposCache = [];

        async function loadDashboard() {
            await loadStats();
            await loadMissions();
            await loadAssignments();
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/student/stats');
                if (!response.ok) throw new Error('Failed to fetch stats');
                const data = await response.json();

                // Update DOM elements by ID
                const userLevel = document.getElementById('user-level');
                const xpVal = document.getElementById('xp-val');
                const xpCardVal = document.getElementById('xp-card-val');
                const coinCount = document.getElementById('coin-count');
                const xpBar = document.getElementById('xp-progress-bar');

                if (userLevel) userLevel.innerText = data.rango || 'Nivel 1';
                if (xpVal) xpVal.innerText = data.xp || 0;
                if (xpCardVal) xpCardVal.innerText = data.xp || 0;
                if (coinCount) coinCount.innerText = data.educoins || 0;

                // Animate XP Bar
                if (xpBar) {
                    // Force reflow for animation
                    xpBar.style.width = '0%';
                    setTimeout(() => {
                        xpBar.style.width = (data.xp_percent || 0) + '%';
                    }, 100);
                }

                // Update avatar if needed (optional based on user request, but good for consistency)
                // const avatarEl = document.querySelector('.bg-cover'); 
                // if (avatarEl && data.avatar_url) ... 

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Alias for user request compatibility
        const loadStudentStats = loadStats;

        async function loadMissions() {
            try {
                const response = await fetch('/api/alumno/misiones');
                if (!response.ok) throw new Error('Failed to fetch missions');
                const missions = await response.json();

                const container = document.getElementById('missions-scroll-area');

                if (!missions || missions.length === 0) {
                    container.innerHTML = '<p class="text-center text-sm text-slate-500 p-4">No hay misiones activas.</p>';
                    return;
                }

                // Shell for scrollable area (Already in HTML, just clear it)
                container.innerHTML = '';
                let html = '';
                // Note: We append items to html then set innerHTML of the scroll-area container directly


                missions.forEach(m => {
                    // Determine colors/icons based on mission type (using 'tipo' from DB)
                    const isTarget = m.tipo === 'academica'; // Example type logic
                    const bgColor = isTarget ? 'bg-purple-100 dark:bg-purple-900/30' : 'bg-green-100 dark:bg-green-900/30';
                    const textColor = isTarget ? 'text-purple-600' : 'text-green-600';
                    const barColor = isTarget ? 'bg-purple-500' : 'bg-green-500';
                    const icon = m.icono || (isTarget ? 'school' : 'menu_book');
                    // Use safe defaults if total is 0
                    const total = m.requisito_cantidad || 1;
                    const progress = m.progreso || 0;
                    const percent = Math.min((progress / total) * 100, 100);

                    html += `
                            <div class="min-w-[200px] bg-white dark:bg-surface-dark p-3 rounded-xl border border-slate-100 dark:border-slate-800 shadow-sm flex flex-col gap-2 relative">
                                <!-- Complete Check Overlay (Hidden by default unless done) -->
                                ${m.completada ? `
                                <div class="absolute top-2 right-2 text-green-500">
                                    <span class="material-symbols-outlined">check_circle</span>
                                </div>` : ''}
                                
                                <div class="flex items-center gap-2">
                                    <div class="p-2 ${bgColor} ${textColor} rounded-lg shrink-0">
                                        <span class="material-symbols-outlined text-[20px]">${icon}</span>
                                    </div>
    
                                    <p class="text-sm font-bold text-slate-900 dark:text-white leading-tight">${m.titulo}</p>
                                </div>
                                <div class="w-full bg-slate-100 dark:bg-slate-700 h-1.5 rounded-full mt-1">
                                    <div class="${barColor} h-1.5 rounded-full" style="width: ${percent}%"></div>
                                </div>
                                <div class="flex justify-between items-center text-xs text-slate-500">
                                    <span>+${m.xp_recompensa} XP</span>
                                    <span>${progress}/${total}</span>
                                </div>
                                
                                ${!m.completada ? `
                                <button onclick="updateMissionProgress(${m.id}, 1)" class="mt-1 w-full text-[10px] py-1 bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 rounded text-slate-600 dark:text-slate-400 transition">
                                    Registrar Progreso
                                </button>
                                ` : ''}

                            </div>
                        `;
                });

                container.innerHTML = html;

            } catch (error) {
                console.error('Error loading missions:', error);
            }
        }

        async function updateMissionProgress(id, increment) {
            try {
                const response = await fetch('/api/alumno/misiones/progreso', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mision_id: id, incremento: increment })
                });

                if (response.ok) {
                    showToast('¡Progreso registrado!', 'success');
                    // Play small sound or effect?
                    loadMissions(); // Refresh UI
                    // Also refresh stats if leveled up (optional, but good)
                    // window.location.reload(); // Too heavy, maybe just leave it
                } else {
                    showToast('No se pudo registrar', 'error');
                }
            } catch (e) {
                console.error(e);
            }
        }

        function renderAssignments(tareas, filtro) {
            const container = document.getElementById('assignments-container');
            const pendientesActivo = filtro === 'pendientes';
            const completadasActivo = filtro === 'completadas';

            const tareasFiltradas = (tareas || []).filter(task => {
                if (filtro === 'pendientes') return !task.entrega_id;
                if (filtro === 'completadas') return !!task.entrega_id;
                return true;
            });

            let html = `
                    <div class="flex items-center justify-between mb-3 px-1">
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white">Tareas</h3>
                        <div class="flex bg-slate-100 dark:bg-slate-800 rounded-lg p-0.5">
                            <button onclick="filtrarTareas('pendientes')" class="filtro-tareas px-2 py-0.5 text-xs font-medium rounded-md ${pendientesActivo ? 'bg-white dark:bg-surface-dark shadow-sm text-slate-900 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white'}" data-filtro="pendientes">Pendientes</button>
                            <button onclick="filtrarTareas('completadas')" class="filtro-tareas px-2 py-0.5 text-xs font-medium rounded-md ${completadasActivo ? 'bg-white dark:bg-surface-dark shadow-sm text-slate-900 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white'}" data-filtro="completadas">Completadas</button>
                        </div>
                    </div>
                    <div class="flex flex-col gap-3">
                `;

            if (!tareas || tareas.length === 0) {
                html += `
                        <div class="flex flex-col items-center justify-center py-8 text-center bg-white dark:bg-surface-dark rounded-xl border border-dashed border-slate-200 dark:border-slate-700">
                            <span class="material-symbols-outlined text-4xl text-green-500 mb-2">check_circle</span>
                            <p class="text-slate-900 dark:text-white font-medium">¡Todo al día!</p>
                            <p class="text-xs text-slate-500">No tienes tareas pendientes.</p>
                        </div>
                     `;
            } else if (tareasFiltradas.length === 0) {
                html += `
                        <div class="p-6 text-center text-slate-500 bg-white dark:bg-surface-dark rounded-xl border border-dashed border-slate-200 dark:border-slate-700">
                            <p>No hay tareas ${filtro === 'completadas' ? 'completadas' : 'pendientes'}.</p>
                        </div>
                    `;
            } else {
                tareasFiltradas.forEach(task => {
                    const isPending = !task.fecha_entrega_alumno;
                    const badgeBg = isPending ? 'bg-orange-100 dark:bg-orange-900/30' : 'bg-green-100 dark:bg-green-900/30';
                    const badgeText = isPending ? 'text-orange-700 dark:text-orange-300' : 'text-green-700 dark:text-green-300';
                    const estadoTexto = isPending ? 'Pendiente' : 'Entregada';
                    const fechaVencimiento = task.fecha_limite || 'Sin fecha';
                    const esUrgente = task.dias_restantes !== undefined && task.dias_restantes <= 2;

                    html += `
                        <div class="group flex flex-col gap-4 rounded-xl bg-white dark:bg-surface-dark p-4 shadow-sm ring-1 ring-slate-200 dark:ring-slate-800 transition-all hover:shadow-md cursor-pointer ${esUrgente && isPending ? 'ring-red-300 dark:ring-red-800' : ''}" onclick="verTarea(${task.id})">
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex flex-1 flex-col gap-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="inline-flex items-center rounded-full ${badgeBg} px-2.5 py-0.5 text-xs font-medium ${badgeText}">
                                            ${estadoTexto}
                                        </span>
                                        ${esUrgente && isPending ? '<span class="inline-flex items-center rounded-full bg-red-100 dark:bg-red-900/30 px-2.5 py-0.5 text-xs font-medium text-red-700 dark:text-red-300">Urgente</span>' : ''}
                                        <span class="text-xs text-slate-400 dark:text-slate-500">•</span>
                                        <span class="text-xs font-medium text-slate-500 dark:text-slate-400">${task.materia || 'Sin materia'}</span>
                                    </div>
                                    <h3 class="text-lg font-bold text-slate-900 dark:text-white leading-tight">${task.titulo}</h3>
                                    <div class="mt-1 flex items-center gap-1.5 text-slate-500 dark:text-slate-400">
                                        <span class="material-symbols-outlined text-[18px]">event</span>
                                        <p class="text-sm">Vence: ${fechaVencimiento}</p>
                                        ${task.dias_restantes !== undefined ? '<span class="text-xs">(' + task.dias_restantes + ' días)</span>' : ''}
                                    </div>
                                    ${task.calificacion ? '<div class="mt-1 flex items-center gap-1.5"><span class="material-symbols-outlined text-[18px] text-green-600">grade</span><p class="text-sm font-bold text-green-600">Calificación: ' + task.calificacion + '</p></div>' : ''}
                                </div>
                                <div class="h-16 w-16 shrink-0 overflow-hidden rounded-lg bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-300">
                                     <span class="material-symbols-outlined text-[32px]">description</span>
                                </div>
                            </div>
                        </div>
                        `;
                });
            }

            html += `
                    </div>
                    <button onclick="showPanel('dashboard')" class="w-full mt-4 py-3 text-sm font-medium text-primary hover:text-primary/80 transition flex items-center justify-center gap-1">
                        Ver todas las tareas
                        <span class="material-symbols-outlined text-[18px]">arrow_forward</span>
                    </button>
                `;

            container.innerHTML = html;
        }

        async function loadAssignments() {
            try {
                const response = await fetch('/api/alumno/tareas');
                if (!response.ok) throw new Error('Error al obtener tareas');
                const data = await response.json();
                
                const tareas = data.tareas || [];
                tareasCache = tareas;
                renderAssignments(tareasCache, filtroTareas);

            } catch (error) {
                console.error('Error loading assignments:', error);
                const container = document.getElementById('assignments-container');
                if (container) {
                    container.innerHTML = '<div class="p-6 text-center text-red-500">Error al cargar tareas.</div>';
                }
            }
        }
        
        function verTarea(tareaId) {
            const tarea = tareasCache.find(t => t.id === tareaId);
            if (!tarea) {
                Swal.fire('Tarea', 'No se pudo cargar el detalle.', 'info');
                return;
            }
            const entregada = !!tarea.entrega_id;
            Swal.fire({
                title: tarea.titulo,
                html: `
                    <div class="text-left space-y-2">
                        <p><strong>Materia:</strong> ${tarea.materia || 'N/A'}</p>
                        <p><strong>Docente:</strong> ${tarea.docente || 'N/A'}</p>
                        <p><strong>Descripción:</strong> ${tarea.descripcion || 'Sin descripción'}</p>
                        <p><strong>Vence:</strong> ${tarea.fecha_limite || 'Sin fecha'}</p>
                        ${tarea.calificacion ? `<p><strong>Calificación:</strong> ${tarea.calificacion}</p>` : ''}
                        ${tarea.retroalimentacion ? `<p><strong>Retroalimentación:</strong> ${tarea.retroalimentacion}</p>` : ''}
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: entregada ? 'Cerrar' : 'Entregar tarea',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#137fec'
            }).then((result) => {
                if (result.isConfirmed && !entregada) {
                    openUploadModal(tareaId);
                }
            });
        }

        function openAssignment(tareaId) {
            verTarea(tareaId);
        }
        
        function filtrarTareas(filtro) {
            // Actualizar estilos de botones
            document.querySelectorAll('.filtro-tareas').forEach(btn => {
                if (btn.dataset.filtro === filtro) {
                    btn.classList.add('bg-white', 'dark:bg-surface-dark', 'shadow-sm', 'text-slate-900', 'dark:text-white');
                    btn.classList.remove('text-slate-500', 'dark:text-slate-400');
                } else {
                    btn.classList.remove('bg-white', 'dark:bg-surface-dark', 'shadow-sm', 'text-slate-900', 'dark:text-white');
                    btn.classList.add('text-slate-500', 'dark:text-slate-400');
                }
            });
            filtroTareas = filtro;
            if (tareasCache && tareasCache.length) {
                renderAssignments(tareasCache, filtroTareas);
            } else {
                loadAssignments();
            }
        }

        // --- Phase 1: Academic Core Additions ---

        // Modal Logic
        function openUploadModal(id) {
            document.getElementById('upload-task-id').value = id;
            const modal = document.getElementById('upload-modal');
            modal.classList.remove('hidden');
            // Tick to allow transition
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-95');
                modal.querySelector('div').classList.add('scale-100');
            }, 10);

            // File input listener for name display
            document.getElementById('fileInput').onchange = function () {
                if (this.files[0]) document.getElementById('file-name-display').innerText = this.files[0].name;
            };
        }

        function closeUploadModal() {
            const modal = document.getElementById('upload-modal');
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.remove('scale-100');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('upload-progress-container').classList.add('hidden');
                document.getElementById('fileInput').value = '';
                document.getElementById('file-name-display').innerText = 'PDF, Word, Imagen (Max 10MB)';
            }, 300);
        }

        async function enviarTarea(tareaId) {
            const fileInput = document.getElementById('fileInput');
            const commentInput = document.getElementById('upload-comment');
            if (!fileInput.files[0]) {
                Swal.fire('Error', 'Debes seleccionar un archivo', 'warning');
                return;
            }
            // Mostrar barra de progreso
            const progressContainer = document.getElementById('upload-progress-container');
            const progressBar = document.getElementById('upload-bar');
            const progressText = document.getElementById('upload-percent');
            progressContainer.classList.remove('hidden');
            let percent = 0;
            const interval = setInterval(() => {
                percent += 10;
                if (percent > 90) clearInterval(interval);
                progressBar.style.width = percent + '%';
                progressText.innerText = percent + '%';
            }, 200);

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('tarea_id', tareaId);
            formData.append('comentarios', commentInput.value);

            try {
                const response = await fetch('/upload_entrega', {
                    method: 'POST',
                    body: formData
                });

                clearInterval(interval);
                progressBar.style.width = '100%';
                progressText.innerText = '100%';

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.message || response.statusText);
                }

                setTimeout(() => {
                    closeUploadModal();
                    Swal.fire({
                        title: '¡Enviado!',
                        text: 'Tu tarea se ha subido correctamente.',
                        icon: 'success',
                        confirmButtonColor: '#137fec'
                    });
                    loadAssignments();
                }, 500);
            } catch (error) {
                clearInterval(interval);
                progressContainer.classList.add('hidden');
                Swal.fire('Error', `Hubo un problema: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // 5. Courses & Resources Logic
        async function loadCourses() {
            try {
                const res = await fetch('/api/alumno/materias');
                const courses = await res.json();

                const list = document.getElementById('subjects-list') || document.getElementById('courses-list');
                if (!list) return;

                if (!Array.isArray(courses) || courses.length === 0) {
                    list.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-48 text-slate-400">
                            <span class="material-symbols-outlined text-5xl mb-2">school</span>
                            <div class="text-sm">No hay materias registradas</div>
                        </div>
                    `;
                    return;
                }

                list.innerHTML = courses.map(c => `
                    <div onclick="openSubjectDetails(${c.id}, '${c.nombre}')"
                        class="bg-white dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-800 flex items-center justify-between gap-3 cursor-pointer hover:shadow-md transition">
                        <div class="flex items-center gap-3">
                            <div class="h-10 w-10 rounded-lg bg-gradient-to-br from-blue-500 to-cyan-400 flex items-center justify-center text-white shadow-lg">
                                <span class="material-symbols-outlined">menu_book</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-900 dark:text-white truncate">${c.nombre}</h3>
                                <p class="text-xs text-slate-500 truncate">${c.docente || 'Docente'}</p>
                                ${c.horario ? `<p class="text-[10px] text-slate-400">${c.horario}</p>` : ''}
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-slate-400">chevron_right</span>
                    </div>
                `).join('');
            } catch (e) {
                console.error(e);
            }
        }

        let currentSubjectId = null;
        let currentSubjectName = '';

        async function openSubjectDetails(courseId, courseName) {
            currentSubjectId = courseId;
            currentSubjectName = courseName;
            // Switch to Resources Panel manually
            const subjectsView = document.getElementById('subjects-container') || document.getElementById('courses-view');
            if (subjectsView) subjectsView.classList.add('hidden');
            document.getElementById('resources-view').classList.remove('hidden');
            document.getElementById('resource-subject-title').innerText = courseName;

            const list = document.getElementById('resources-list');
            list.innerHTML = '<div class="flex justify-center p-4"><span class="loader">Loading...</span></div>';

            try {
                const [resRecursos, resPortfolio] = await Promise.all([
                    fetch(`/api/alumno/recursos/${courseId}`),
                    fetch('/api/portfolio')
                ]);
                const resources = await resRecursos.json();
                const portfolioItems = await resPortfolio.json();
                const savedResourceIds = new Set(
                    (Array.isArray(portfolioItems) ? portfolioItems : []).map(i => {
                        const match = (i.descripcion || '').match(/recurso_id:(\d+)/);
                        return match ? parseInt(match[1], 10) : null;
                    }).filter(Boolean)
                );

                if (!Array.isArray(resources) || resources.length === 0) {
                    list.innerHTML = '<p class="text-center text-slate-500">No hay recursos disponibles.</p>';
                    return;
                }

                list.innerHTML = resources.map(r => {
                    const isSaved = savedResourceIds.has(r.id);
                    return `
                <div class="flex items-center justify-between p-3 bg-white dark:bg-surface-dark rounded-xl border border-slate-100 dark:border-slate-800">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="h-10 w-10 shrink-0 rounded-lg ${r.tipo_archivo === 'documento' ? 'bg-red-100 text-red-500' : 'bg-blue-100 text-blue-500'} flex items-center justify-center">
                            <span class="material-symbols-outlined">${r.tipo_archivo === 'documento' ? 'picture_as_pdf' : 'description'}</span>
                        </div>
                        <div class="min-w-0">
                            <h4 class="font-medium text-sm text-slate-900 dark:text-white truncate">${r.titulo || r.nombre_archivo}</h4>
                            <p class="text-xs text-slate-500">${(r.tipo_archivo || 'archivo').toUpperCase()}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-1">
                        ${isSaved ? `
                        <button onclick="removeResourceFromPortfolio(${r.id})" class="p-2 text-slate-400 hover:text-red-500 transition rounded-full hover:bg-slate-50 dark:hover:bg-slate-800" title="Quitar del portafolio">
                            <span class="material-symbols-outlined">bookmark_remove</span>
                        </button>
                        ` : `
                        <button onclick="saveResourceToPortfolio(${r.id}, '${(r.titulo || r.nombre_archivo || '').replace(/'/g, "\\'")}')" class="p-2 text-slate-400 hover:text-primary transition rounded-full hover:bg-slate-50 dark:hover:bg-slate-800" title="Guardar en portafolio">
                            <span class="material-symbols-outlined">bookmark_add</span>
                        </button>
                        `}
                        <a href="/descargar-recurso/${r.id}" target="_blank" class="p-2 text-slate-400 hover:text-primary transition rounded-full hover:bg-slate-50 dark:hover:bg-slate-800">
                            <span class="material-symbols-outlined">download</span>
                        </a>
                    </div>
                </div>
                `;
                }).join('');

            } catch (e) {
                list.innerHTML = '<p class="text-center text-slate-500">Error cargando recursos.</p>';
            }
        }

        async function saveResourceToPortfolio(resourceId, titulo) {
            try {
                const body = {
                    titulo: titulo || 'Recurso guardado',
                    descripcion: `Recurso guardado (ID ${resourceId}) recurso_id:${resourceId}`
                };
                const res = await fetch('/api/portfolio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'No se pudo guardar');
                showToast('Recurso guardado en portafolio', 'success');
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        async function removeResourceFromPortfolio(resourceId) {
            try {
                const res = await fetch('/api/portfolio');
                const items = await res.json();
                const item = (Array.isArray(items) ? items : []).find(i => (i.descripcion || '').includes(`recurso_id:${resourceId}`));
                if (!item) {
                    showToast('No se encontró en portafolio', 'info');
                    return;
                }
                const del = await fetch(`/api/portfolio/${item.id}`, { method: 'DELETE' });
                const data = await del.json();
                if (!del.ok) throw new Error(data.error || 'No se pudo eliminar');
                showToast('Recurso quitado del portafolio', 'success');
                if (currentSubjectId) {
                    openSubjectDetails(currentSubjectId, currentSubjectName || 'Materia');
                }
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        // Alias for compat
        const loadSubjects = loadCourses;
        // --- Phase 2: The Brain (AI & Quiz) ---

        // 1. AI Chat
        function toggleChat() {
            const widget = document.getElementById('ai-chat-widget');
            const isHidden = widget.classList.contains('hidden');

            if (isHidden) {
                widget.classList.remove('hidden');
                // Animate In
                setTimeout(() => {
                    widget.classList.remove('scale-90', 'opacity-0');
                    widget.classList.add('scale-100', 'opacity-100');
                }, 10);
            } else {
                // Animate Out
                widget.classList.remove('scale-100', 'opacity-100');
                widget.classList.add('scale-90', 'opacity-0');
                setTimeout(() => {
                    widget.classList.add('hidden');
                }, 300);
            }
        }

        async function sendAIMessage(e) {
            e.preventDefault();
            const input = document.getElementById('ai-input');
            const message = input.value.trim();
            if (!message) return;

            // Add User Message
            addChatMessage(message, 'user');
            input.value = '';

            // Show Typing Indicator
            const typingId = addTypingIndicator();

            try {
                const response = await fetch('/api/chat/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });

                removeChatMessage(typingId);

                if (response.ok) {
                    const data = await response.json();
                    addChatMessage(data.response, 'bot'); // Assumed { response: "text" }
                } else {
                    addChatMessage("Lo siento, no puedo conectarme con mi cerebro ahora. 🧠💤", 'bot');
                }

            } catch (error) {
                removeChatMessage(typingId);
                addChatMessage("Error de conexión. Intenta más tarde.", 'bot');
                console.error(error);
            }

            // Auto scroll
            const container = document.getElementById('chat-messages');
            container.scrollTop = container.scrollHeight;
        }

        function addChatMessage(text, sender) {
            const container = document.getElementById('chat-messages');
            const isBot = sender === 'bot';

            const html = `
    <div class="flex gap-3 ${isBot ? '' : 'flex-row-reverse'} animate-fade-in-up">
        ${isBot ? `
        <div
            class="h-8 w-8 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center text-purple-600 shrink-0">
            <span class="material-symbols-outlined text-[18px]">smart_toy</span>
        </div>` : ''}

        <div class="p-3 rounded-2xl shadow-sm text-sm max-w-[85%] 
                    ${isBot ? 'bg-white dark:bg-surface-dark text-slate-800 dark:text-slate-200 border border-slate-100 dark:border-slate-800 rounded-tl-none'
                    : 'bg-purple-600 text-white rounded-tr-none'}">
            ${text}
        </div>
    </div>
    `;
            container.insertAdjacentHTML('beforeend', html);
            container.scrollTop = container.scrollHeight;
        }

        function addTypingIndicator() {
            const id = 'typing-' + Date.now();
            const container = document.getElementById('chat-messages');
            const html = `
    <div id="${id}" class="flex gap-3 animate-pulse">
        <div
            class="h-8 w-8 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center text-purple-600 shrink-0">
            <span class="material-symbols-outlined text-[18px]">smart_toy</span>
        </div>
        <div
            class="bg-white dark:bg-surface-dark p-3 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 dark:border-slate-800">
            <div class="flex gap-1 h-5 items-center">
                <div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce"></div>
                <div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce delay-100"></div>
                <div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce delay-200"></div>
            </div>
        </div>
    </div>
    `;
            container.insertAdjacentHTML('beforeend', html);
            return id;
        }
        function removeChatMessage(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // 2. Quiz Module (Phase 6 Refactor)
        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let quizAnswers = {};

        async function startQuiz(quizId) {
            Swal.fire({
                title: 'Preparando Entorno...',
                timer: 800,
                didOpen: () => Swal.showLoading()
            }).then(async () => {
                try {
                    // Fetch Quiz Data (Mock or Real)
                    // const res = await fetch(`/api/quiz/${quizId}`);
                    // currentQuiz = await res.json();

                    // Mock Data
                    currentQuiz = {
                        id: quizId,
                        title: "Física Fundamental",
                        questions: [
                            { id: 1, text: "¿Cuál es la unidad de fuerza en el SI?", options: ["Newton", "Joule", "Pascal", "Watt"] },
                            { id: 2, text: "La velocidad es una magnitud...", options: ["Escalar", "Vectorial", "Fundamental", "Derivada"] },
                            { id: 3, text: "¿Quién formuló las leyes del movimiento?", options: ["Einstein", "Newton", "Galileo", "Tesla"] }
                        ]
                    };

                    currentQuestionIndex = 0;
                    quizAnswers = {};

                    // Enter Zen Mode
                    document.getElementById('main-app-container').classList.add('hidden');
                    document.getElementById('quiz-mode').classList.remove('hidden');

                    renderQuestion();

                } catch (e) {
                    Swal.fire('Error', 'No se pudo cargar el examen.', 'error');
                }
            });
        }

        function renderQuestion() {
            const q = currentQuiz.questions[currentQuestionIndex];
            const total = currentQuiz.questions.length;

            // Update Progress
            const progress = ((currentQuestionIndex + 1) / total) * 100;
            document.getElementById('quiz-progress-bar').style.width = `${progress}%`;
            document.getElementById('quiz-progress-text').innerText = `Pregunta ${currentQuestionIndex + 1}/${total}`;

            // Render Content
            const container = document.getElementById('quiz-content');
            container.innerHTML = `
                <h2 class="text-2xl md:text-3xl font-bold text-slate-900 dark:text-white leading-tight animate-fade-in-up">
                     ${q.text}
                </h2>
                <div class="space-y-3 mt-6">
                     ${q.options.map((opt, idx) => `
                        <label class="block cursor-pointer group animate-fade-in-up" style="animation-delay: ${idx * 50}ms">
                            <input type="radio" name="q_current" value="${idx}" class="peer sr-only" onchange="selectAnswer(${q.id}, ${idx})">
                            <div class="w-full text-left p-4 rounded-xl border-2 border-slate-200 dark:border-slate-800 bg-white dark:bg-surface-dark 
                                        peer-checked:border-purple-600 peer-checked:bg-purple-50 dark:peer-checked:bg-purple-900/20 
                                        hover:border-purple-400 transition-all duration-200 flex items-center justify-between">
                                <span class="font-medium text-slate-700 dark:text-slate-300 peer-checked:text-purple-700 dark:peer-checked:text-purple-300">${opt}</span>
                                <span class="material-symbols-outlined text-purple-600 opacity-0 transform scale-50 peer-checked:opacity-100 peer-checked:scale-100 transition-all">check_circle</span>
                            </div>
                        </label>
                     `).join('')}
                </div>
            `;

            // Update Button Logic
            const btn = document.getElementById('quiz-next-btn');
            const isLast = currentQuestionIndex === total - 1;
            btn.innerHTML = isLast ? 'Finalizar <span class="material-symbols-outlined">check</span>' : 'Siguiente <span class="material-symbols-outlined">arrow_forward</span>';
            // Disable button until selection (optional, here we let them skip? No, assume selection required)
            // btn.disabled = true; // Could re-enable on selectAnswer
        }

        function selectAnswer(qid, answerIdx) {
            quizAnswers[qid] = answerIdx;
        }

        function nextQuestion() {
            const q = currentQuiz.questions[currentQuestionIndex];
            if (quizAnswers[q.id] === undefined) {
                Swal.fire({
                    toast: true, position: 'top', icon: 'warning',
                    title: 'Selecciona una respuesta', showConfirmButton: false, timer: 1500
                });
                return;
            }

            if (currentQuestionIndex < currentQuiz.questions.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            } else {
                submitQuizResults();
            }
        }

        async function submitQuizResults() {
            Swal.fire({
                title: 'Calificando...',
                timer: 2000,
                timerProgressBar: true,
                didOpen: () => Swal.showLoading()
            }).then(async () => {
                // Mock Backend Submission
                // await fetch('/api/submit_quiz', { method: 'POST', body: JSON.stringify(quizAnswers) });

                // Mock Score randomized
                const score = Math.floor(Math.random() * 3) + 8; // 8, 9 or 10

                Swal.fire({
                    title: '¡Examen Completado!',
                    html: `
                        <div class="flex flex-col items-center">
                            <div class="h-24 w-24 rounded-full bg-green-100 text-green-600 flex items-center justify-center mb-4">
                                <span class="material-symbols-outlined text-5xl">emoji_events</span>
                            </div>
                            <p class="text-4xl font-bold text-slate-900 dark:text-white mb-1">${score}/10</p>
                            <p class="text-slate-500">¡Gran trabajo!</p>
                        </div>
                    `,
                    confirmButtonText: 'Volver al Inicio',
                    confirmButtonColor: '#137fec',
                    allowOutsideClick: false
                }).then(() => {
                    quitQuiz();
                });
            });
        }

        function quitQuiz() {
            document.getElementById('quiz-mode').classList.add('hidden');
            document.getElementById('main-app-container').classList.remove('hidden');
        }

        function restoreDashboard() {
            quitQuiz();
        }



        // --- Phase 3: Social & Real-time ---
        // Group Chat Logic
        function sendGroupMessage(e) {
            e.preventDefault();
            const input = document.getElementById('group-chat-input');
            const text = input.value.trim();
            if (!text) return;

            // Optimistic UI Update
            const myData = {
                user: "Yo",
                text: text,
                avatar: "https://ui-avatars.com/api/?name=Alex+Doe&background=random", // Current User Avatar
                isMe: true,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            };
            appendGroupMessage(myData);

            // Emit to Server
            socket.emit('message', { room: 'grupo_501', text: text, user: 'Alex Doe' }); // Mock user name

            input.value = '';
        }

        function appendGroupMessage(data) {
            const container = document.getElementById('community-messages');
            const isMe = data.isMe || data.user === 'Alex Doe'; // Simple check

            const html = `
    <div class="flex gap-3 mb-4 ${isMe ? 'flex-row-reverse' : ''} animate-fade-in-up">
        <div class="h-8 w-8 rounded-full bg-slate-200 border border-white shadow-sm flex-shrink-0 bg-cover bg-center"
            style="background-image: url('${data.avatar || 'https://ui-avatars.com/api/?name=' + data.user}');"></div>

        <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} max-w-[75%]">
            <span class="text-[10px] text-slate-500 mb-1 ml-1">${data.user} • ${data.time || 'Now'}</span>
            <div
                class="px-4 py-2 rounded-2xl shadow-sm text-sm 
                        ${isMe ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white dark:bg-surface-dark text-slate-800 dark:text-slate-200 border border-slate-100 dark:border-slate-800 rounded-tl-none'}">
                ${data.text}
            </div>
        </div>
    </div>
    `;

            container.insertAdjacentHTML('beforeend', html);
            scrollToBottomChat();
        }

        function scrollToBottomChat() {
            const container = document.getElementById('community-messages');
            if (container) container.scrollTop = container.scrollHeight;
        }

        // Toast Notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');

            // Icons/Colors
            const config = {
                success: { icon: 'check_circle', color: 'bg-green-500' },
                error: { icon: 'error', color: 'bg-red-500' },
                info: { icon: 'notifications_active', color: 'bg-blue-500' },
                warning: { icon: 'warning', color: 'bg-orange-500' }
            };
            const style = config[type] || config.info;

            const toast = document.createElement('div');
            toast.className = `pointer-events-auto flex items-center gap-3 w-full max-w-xs p-4 rounded-xl shadow-lg bg-white
    dark:bg-surface-dark border-l-4 ${style.color.replace('bg-', 'border-')} transform transition-all duration-300
    translate-x-full opacity-0`;

            toast.innerHTML = `
    <div class="p-2 rounded-full ${style.color} text-white shrink-0">
        <span class="material-symbols-outlined text-[20px]">${style.icon}</span>
    </div>
    <div>
        <h4 class="font-bold text-sm text-slate-900 dark:text-white capitalize">${type}</h4>
        <p class="text-xs text-slate-500 dark:text-slate-400">${message}</p>
    </div>
    `;

            container.appendChild(toast);

            // Animate In
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            });

            // Auto Remove
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        async function apiGet(url) {
            const res = await fetch(url, { credentials: 'same-origin' });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.error || 'Error en la solicitud');
            return data;
        }

        async function apiPost(url, body = {}) {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.error || 'Error en la solicitud');
            return data;
        }

        async function loadHoy() {
            const container = document.getElementById('hoy-list');
            container.innerHTML = '<div class="flex justify-center p-4"><span class="text-slate-400">Cargando...</span></div>';
            try {
                const data = await apiGet('/api/alumno/hoy');
                const agenda = data.agenda || [];
                const resumen = data.resumen || {};
                let html = '';

                if (resumen.mensaje_motivacional) {
                    html += `
                        <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl p-4 text-white shadow-lg">
                            <p class="text-sm opacity-90">${resumen.mensaje_motivacional}</p>
                        </div>
                    `;
                }

                if (!agenda.length) {
                    html += '<div class="p-6 text-center text-slate-500">No hay actividades para hoy.</div>';
                } else {
                    html += agenda.map(item => `
                        <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                            <div class="flex items-start justify-between gap-3">
                                <div>
                                    <p class="font-medium text-slate-900 dark:text-white">${item.titulo || 'Actividad'}</p>
                                    <p class="text-xs text-slate-500">${item.hora_inicio || ''} - ${item.hora_fin || ''}</p>
                                    <p class="text-xs text-slate-400">${item.descripcion || ''}</p>
                                </div>
                                ${item.completado ? '<span class="text-xs text-green-600">Completado</span>' : `
                                    <button onclick="completarHoy(${item.id})" class="px-2 py-1 text-xs rounded bg-green-500 text-white">Completar</button>
                                `}
                            </div>
                        </div>
                    `).join('');
                }

                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = '<p class="text-center text-red-500">Error al cargar agenda.</p>';
            }
        }

        async function completarHoy(id) {
            try {
                await apiPost(`/api/alumno/hoy/completar/${id}`);
                showToast('Actividad completada', 'success');
                loadHoy();
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        async function loadObjetivos() {
            const container = document.getElementById('objetivos-list');
            container.innerHTML = '<div class="flex justify-center p-4"><span class="text-slate-400">Cargando...</span></div>';
            try {
                const objetivos = await apiGet('/api/alumno/objetivos');
                if (!objetivos.length) {
                    container.innerHTML = '<div class="p-6 text-center text-slate-500">No hay objetivos.</div>';
                    return;
                }
                container.innerHTML = objetivos.map(o => {
                    const meta = o.meta_valor || 100;
                    const progreso = o.progreso_actual || 0;
                    const percent = Math.min((progreso / meta) * 100, 100);
                    return `
                        <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-semibold text-slate-900 dark:text-white">${o.titulo}</p>
                                    <p class="text-xs text-slate-500">${o.descripcion || ''}</p>
                                    <p class="text-[10px] text-slate-400">${o.tipo} • ${o.categoria}</p>
                                </div>
                                <span class="text-xs text-slate-500">${o.completado ? 'Completado' : 'En progreso'}</span>
                            </div>
                            <div class="w-full bg-slate-100 dark:bg-slate-700 h-1.5 rounded-full mt-2">
                                <div class="bg-primary h-1.5 rounded-full" style="width: ${percent}%"></div>
                            </div>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-xs text-slate-500">${progreso}/${meta}</span>
                                <button onclick="actualizarObjetivo(${o.id}, ${progreso}, ${meta}, ${o.completado ? 'true' : 'false'})" class="text-xs text-primary">Actualizar</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                container.innerHTML = '<p class="text-center text-red-500">Error al cargar objetivos.</p>';
            }
        }

        function crearObjetivo() {
            Swal.fire({
                title: 'Nuevo objetivo',
                html: `
                    <input id="obj-titulo" class="swal2-input" placeholder="Título">
                    <textarea id="obj-desc" class="swal2-textarea" placeholder="Descripción"></textarea>
                    <select id="obj-tipo" class="swal2-input">
                        <option value="corto_plazo">Corto plazo</option>
                        <option value="largo_plazo">Largo plazo</option>
                    </select>
                    <input id="obj-meta" type="number" class="swal2-input" placeholder="Meta" value="100">
                    <input id="obj-fecha" type="date" class="swal2-input">
                `,
                showCancelButton: true,
                confirmButtonText: 'Crear',
                preConfirm: () => {
                    const titulo = document.getElementById('obj-titulo').value;
                    if (!titulo) {
                        Swal.showValidationMessage('Título requerido');
                        return false;
                    }
                    return {
                        titulo,
                        descripcion: document.getElementById('obj-desc').value,
                        tipo: document.getElementById('obj-tipo').value,
                        meta_valor: parseInt(document.getElementById('obj-meta').value || '100', 10),
                        fecha_limite: document.getElementById('obj-fecha').value
                    };
                }
            }).then(async result => {
                if (result.isConfirmed) {
                    try {
                        await apiPost('/api/alumno/objetivos', result.value);
                        showToast('Objetivo creado', 'success');
                        loadObjetivos();
                    } catch (e) {
                        showToast(e.message, 'error');
                    }
                }
            });
        }

        function actualizarObjetivo(id, progreso, meta, completadoActual) {
            Swal.fire({
                title: 'Actualizar objetivo',
                html: `
                    <input id="obj-progreso" type="number" class="swal2-input" value="${progreso}" min="0" max="${meta}">
                    <label class="swal2-checkbox"><input id="obj-completado" type="checkbox" ${completadoActual ? 'checked' : ''}> <span>Marcar como completado</span></label>
                `,
                showCancelButton: true,
                confirmButtonText: 'Guardar'
            }).then(async result => {
                if (result.isConfirmed) {
                    const nuevoProgreso = parseInt(document.getElementById('obj-progreso').value || '0', 10);
                    const completado = document.getElementById('obj-completado').checked;
                    try {
                        const res = await fetch(`/api/alumno/objetivos/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ progreso: nuevoProgreso, completado })
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || 'Error al actualizar');
                        showToast('Objetivo actualizado', 'success');
                        loadObjetivos();
                    } catch (e) {
                        showToast(e.message, 'error');
                    }
                }
            });
        }

        async function loadHabitos() {
            const container = document.getElementById('habitos-list');
            container.innerHTML = '<div class="flex justify-center p-4"><span class="text-slate-400">Cargando...</span></div>';
            try {
                const habitos = await apiGet('/api/alumno/habitos');
                const rachas = await apiGet('/api/alumno/racha-habitos');
                document.getElementById('habitos-rachas').textContent = `Racha actual: ${rachas.racha_actual || 0} • Máxima: ${rachas.racha_maxima || 0}`;
                if (!habitos.length) {
                    container.innerHTML = '<div class="p-6 text-center text-slate-500">No hay hábitos activos.</div>';
                    return;
                }
                container.innerHTML = habitos.map(h => `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm flex items-center justify-between">
                        <div>
                            <p class="font-medium text-slate-900 dark:text-white">${h.nombre || h.titulo}</p>
                            <p class="text-xs text-slate-500">${h.descripcion || ''}</p>
                        </div>
                        ${h.completado_hoy ? '<span class="text-xs text-green-600">Completado</span>' : `
                            <button onclick="checkinHabito(${h.id})" class="px-2 py-1 text-xs rounded bg-green-500 text-white">Check-in</button>
                        `}
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<p class="text-center text-red-500">Error al cargar hábitos.</p>';
            }
        }

        async function checkinHabito(id) {
            try {
                await apiPost('/api/alumno/habitos/checkin', { habito_id: id });
                showToast('¡Hábito registrado!', 'success');
                loadHabitos();
                loadStats();
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        async function loadNotificaciones() {
            const container = document.getElementById('notificaciones-list');
            container.innerHTML = '<div class="flex justify-center p-4"><span class="text-slate-400">Cargando...</span></div>';
            try {
                const notifs = await apiGet('/api/alumno/notificaciones');
                if (!notifs.length) {
                    container.innerHTML = '<div class="p-6 text-center text-slate-500">No hay notificaciones.</div>';
                    return;
                }
                container.innerHTML = notifs.map(n => `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-medium text-slate-900 dark:text-white">${n.titulo || n.tipo}</p>
                                <p class="text-xs text-slate-500">${n.mensaje || n.descripcion || ''}</p>
                                <p class="text-[10px] text-slate-400">${n.fecha_creacion || ''}</p>
                            </div>
                            ${n.leida ? '<span class="text-xs text-slate-400">Leída</span>' : `<button onclick="leerNotificacion(${n.id})" class="text-xs text-primary">Marcar</button>`}
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<p class="text-center text-red-500">Error al cargar notificaciones.</p>';
            }
        }

        async function leerNotificacion(id) {
            try {
                await apiPost(`/api/alumno/notificaciones/${id}/leer`);
                loadNotificaciones();
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        async function leerTodasNotificaciones() {
            try {
                await apiPost('/api/alumno/notificaciones/leer-todas');
                showToast('Notificaciones marcadas', 'success');
                loadNotificaciones();
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        async function loadRecomendaciones() {
            const container = document.getElementById('recomendaciones-list');
            container.innerHTML = '<div class="flex justify-center p-4"><span class="text-slate-400">Cargando...</span></div>';
            try {
                const recs = await apiGet('/api/alumno/recomendaciones');
                if (!recs.length) {
                    container.innerHTML = '<div class="p-6 text-center text-slate-500">No hay recomendaciones.</div>';
                    return;
                }
                container.innerHTML = recs.map(r => `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-medium text-slate-900 dark:text-white">${r.titulo || 'Recomendación'}</p>
                                <p class="text-xs text-slate-500">${r.descripcion || r.mensaje || ''}</p>
                                <p class="text-[10px] text-slate-400">Prioridad: ${r.prioridad || 'media'}</p>
                            </div>
                            <button onclick="aceptarRecomendacion(${r.id})" class="text-xs text-primary">Aceptar</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<p class="text-center text-red-500">Error al cargar recomendaciones.</p>';
            }
        }

        async function aceptarRecomendacion(id) {
            try {
                await apiPost(`/api/alumno/recomendaciones/${id}/aceptar`);
                showToast('Recomendación aceptada', 'success');
                loadRecomendaciones();
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        async function loadProgreso() {
            const resumen = document.getElementById('progreso-resumen');
            const list = document.getElementById('progreso-list');
            resumen.innerHTML = 'Cargando...';
            list.innerHTML = '';
            try {
                const [historial, mensual, comparacion, inactividad] = await Promise.all([
                    apiGet('/api/alumno/historial-progreso'),
                    apiGet('/api/alumno/progreso-mensual'),
                    apiGet('/api/alumno/comparacion-grupo'),
                    apiGet('/api/alumno/inactividad')
                ]);

                resumen.innerHTML = `
                    <p class="text-sm text-slate-600 dark:text-slate-300">Comparación grupo: ${comparacion?.grupo?.promedio_general || 'N/A'}</p>
                    <p class="text-xs text-slate-500">Tu XP: ${comparacion?.mi_posicion?.xp || 0} • EduCoins: ${comparacion?.mi_posicion?.educoins || 0}</p>
                    <p class="text-xs text-slate-500">Inactividad: ${inactividad.dias_inactivo || 0} días</p>
                `;

                if (Array.isArray(historial) && historial.length) {
                    list.innerHTML += historial.map(h => `
                        <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                            <p class="text-sm text-slate-900 dark:text-white">${h.descripcion || h.tipo || 'Progreso'}</p>
                            <p class="text-[10px] text-slate-400">${h.fecha || ''}</p>
                        </div>
                    `).join('');
                }

                if (Array.isArray(mensual) && mensual.length) {
                    list.innerHTML += `
                        <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                            <p class="text-sm font-bold text-slate-900 dark:text-white">Progreso mensual</p>
                            <div class="mt-2 space-y-1">
                                ${mensual.slice(0, 6).map(m => `<p class="text-xs text-slate-500">${m.mes}/${m.anio}: ${m.xp || 0} XP</p>`).join('')}
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                resumen.innerHTML = '<p class="text-sm text-red-500">Error al cargar progreso.</p>';
            }
        }

        async function loadRiesgo() {
            const card = document.getElementById('riesgo-card');
            const list = document.getElementById('riesgo-historial');
            card.innerHTML = 'Cargando...';
            list.innerHTML = '';
            try {
                const riesgo = await apiGet('/api/alumno/riesgo');
                const historial = await apiGet('/api/alumno/historial-riesgo');

                card.innerHTML = `
                    <p class="text-sm text-slate-500">Nivel de riesgo</p>
                    <p class="text-2xl font-bold text-slate-900 dark:text-white">${riesgo.nivel_riesgo || 'bajo'}</p>
                    <p class="text-xs text-slate-500">${riesgo.explicacion_ia || ''}</p>
                `;

                if (Array.isArray(historial) && historial.length) {
                    list.innerHTML = historial.map(h => `
                        <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                            <p class="text-sm text-slate-900 dark:text-white">${h.nivel_riesgo || h.puntuacion_riesgo}</p>
                            <p class="text-xs text-slate-400">${h.fecha || ''}</p>
                        </div>
                    `).join('');
                }
            } catch (e) {
                card.innerHTML = '<p class="text-sm text-red-500">Error al cargar riesgo.</p>';
            }
        }

        async function loadFunciones() {
            const container = document.getElementById('funciones-list');
            container.innerHTML = '<div class="flex justify-center p-4"><span class="text-slate-400">Cargando...</span></div>';
            try {
                const funcs = await apiGet('/api/alumno/funciones');
                if (!funcs.length) {
                    container.innerHTML = '<div class="p-6 text-center text-slate-500">No hay funciones disponibles.</div>';
                    return;
                }
                container.innerHTML = funcs.map(f => `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-medium text-slate-900 dark:text-white">${f.nombre || 'Función'}</p>
                                <p class="text-xs text-slate-500">${f.descripcion || ''}</p>
                            </div>
                            ${f.desbloqueada ? '<span class="text-xs text-green-600">Desbloqueada</span>' : `<button onclick="desbloquearFuncion(${f.id})" class="text-xs text-primary">Desbloquear</button>`}
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<p class="text-center text-red-500">Error al cargar funciones.</p>';
            }
        }

        async function desbloquearFuncion(id) {
            try {
                const data = await apiPost(`/api/alumno/funciones/desbloquear/${id}`);
                if (data.success) {
                    showToast('Función desbloqueada', 'success');
                    loadFunciones();
                } else {
                    showToast(data.error || 'No se pudo desbloquear', 'error');
                }
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        async function loadRecompensas() {
            const container = document.getElementById('recompensas-list');
            container.innerHTML = '<div class="flex justify-center p-4"><span class="text-slate-400">Cargando...</span></div>';
            try {
                const items = await apiGet('/api/alumno/recompensas');
                if (!items.length) {
                    container.innerHTML = '<div class="p-6 text-center text-slate-500">No hay recompensas.</div>';
                    return;
                }
                container.innerHTML = items.map(i => `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <p class="font-medium text-slate-900 dark:text-white">${i.titulo || i.descripcion || 'Recompensa'}</p>
                        <p class="text-xs text-slate-500">${i.fecha || i.fecha_obtencion || ''}</p>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<p class="text-center text-red-500">Error al cargar recompensas.</p>';
            }
        }

        async function loadBalance() {
            const container = document.getElementById('balance-card');
            container.innerHTML = 'Cargando...';
            try {
                const data = await apiGet('/api/alumno/balance');
                container.innerHTML = `
                    <p class="text-sm text-slate-500">Rango: ${data.usuario?.rango || 'bronce'}</p>
                    <p class="text-xl font-bold text-slate-900 dark:text-white">XP: ${data.usuario?.xp || 0}</p>
                    <p class="text-xl font-bold text-slate-900 dark:text-white">EduCoins: ${data.usuario?.educoins || 0}</p>
                    <p class="text-xs text-slate-500">Racha: ${data.usuario?.racha || 0}</p>
                `;
            } catch (e) {
                container.innerHTML = '<p class="text-sm text-red-500">Error al cargar balance.</p>';
            }
        }

        async function loadExamenes() {
            const container = document.getElementById('examenes-list');
            container.innerHTML = '<div class="flex justify-center p-4"><span class="text-slate-400">Cargando...</span></div>';
            try {
                const data = await apiGet('/api/alumno/examenes');
                const examenes = data.examenes || [];
                if (!examenes.length) {
                    container.innerHTML = '<div class="p-6 text-center text-slate-500">No hay exámenes disponibles.</div>';
                    return;
                }
                container.innerHTML = examenes.map(e => `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <p class="font-medium text-slate-900 dark:text-white">${e.titulo}</p>
                        <p class="text-xs text-slate-500">${e.materia}</p>
                        <p class="text-xs text-slate-400">${e.fecha_fin || ''}</p>
                        <span class="text-xs ${e.presentado ? 'text-green-600' : 'text-orange-600'}">${e.presentado ? 'Presentado' : 'Pendiente'}</span>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<p class="text-center text-red-500">Error al cargar exámenes.</p>';
            }
        }

        async function loadEncuestas() {
            const container = document.getElementById('encuestas-list');
            container.innerHTML = '<div class="flex justify-center p-4"><span class="text-slate-400">Cargando...</span></div>';
            try {
                const encuestas = await apiGet('/api/alumno/encuestas');
                if (!encuestas.length) {
                    container.innerHTML = '<div class="p-6 text-center text-slate-500">No hay encuestas.</div>';
                    return;
                }
                container.innerHTML = encuestas.map(e => `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <p class="font-medium text-slate-900 dark:text-white">${e.titulo}</p>
                        <p class="text-xs text-slate-500">${e.descripcion || ''}</p>
                        <p class="text-[10px] text-slate-400">${e.fecha_fin || ''}</p>
                        <span class="text-xs ${e.respondida ? 'text-green-600' : 'text-orange-600'}">${e.respondida ? 'Respondida' : 'Pendiente'}</span>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<p class="text-center text-red-500">Error al cargar encuestas.</p>';
            }
        }

        async function loadFeedback() {
            const container = document.getElementById('feedback-list');
            container.innerHTML = '<div class="flex justify-center p-4"><span class="text-slate-400">Cargando...</span></div>';
            try {
                const feedbacks = await apiGet('/api/alumno/feedback');
                if (!feedbacks.length) {
                    container.innerHTML = '<div class="p-6 text-center text-slate-500">No hay feedback.</div>';
                    return;
                }
                container.innerHTML = feedbacks.map(f => `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <p class="font-medium text-slate-900 dark:text-white">${f.titulo || 'Feedback'}</p>
                        <p class="text-xs text-slate-500">${f.mensaje || f.descripcion || ''}</p>
                        <p class="text-[10px] text-slate-400">${f.fecha_creacion || ''}</p>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<p class="text-center text-red-500">Error al cargar feedback.</p>';
            }
        }

        async function loadLogros() {
            const hoy = document.getElementById('logros-hoy');
            const semana = document.getElementById('logros-semana');
            const recompensas = document.getElementById('logros-recompensas');
            const historial = document.getElementById('logros-historial');
            hoy.innerHTML = 'Cargando...';
            semana.innerHTML = '';
            recompensas.innerHTML = '';
            historial.innerHTML = '';
            try {
                const data = await apiGet('/api/alumno/logros');
                const lh = data.logros_hoy || {};
                const ls = data.logros_semana || {};
                hoy.innerHTML = `
                    <p class="font-bold text-slate-900 dark:text-white mb-1">Hoy</p>
                    <div class="text-xs text-slate-500">Tareas: ${lh.tareas_completadas || 0} • Exámenes: ${lh.examenes_completados || 0}</div>
                    <div class="text-xs text-slate-500">Minutos estudio: ${lh.minutos_estudio || 0} • Preguntas: ${lh.preguntas_respondidas || 0}</div>
                    <div class="text-xs text-slate-500">Racha: ${lh.racha_dias || 0} días</div>
                `;
                semana.innerHTML = `
                    <p class="font-bold text-slate-900 dark:text-white mb-1">Semana</p>
                    <div class="text-xs text-slate-500">Tareas: ${ls?.tareas_completadas || 0} • Exámenes: ${ls?.examenes_completados || 0}</div>
                    <div class="text-xs text-slate-500">Minutos estudio: ${ls?.minutos_estudio || 0} • Preguntas: ${ls?.preguntas_respondidas || 0}</div>
                `;
                const recompensasList = data.recompensas || [];
                recompensas.innerHTML = recompensasList.length ? recompensasList.map(r => `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <p class="font-medium text-slate-900 dark:text-white">${r.nombre}</p>
                        <p class="text-xs text-slate-500">${r.descripcion || ''}</p>
                        <p class="text-xs text-slate-400">Costo: ${r.costo_educoins} EduCoins</p>
                    </div>
                `).join('') : '<div class="p-4 text-center text-slate-500">Sin recompensas disponibles.</div>';

                const historialList = data.historial || [];
                historial.innerHTML = historialList.length ? historialList.map(h => `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <p class="font-medium text-slate-900 dark:text-white">${h.nombre}</p>
                        <p class="text-xs text-slate-500">${h.descripcion || ''}</p>
                        <p class="text-xs text-slate-400">${h.fecha_canje || ''}</p>
                    </div>
                `).join('') : '<div class="p-4 text-center text-slate-500">Sin canjes.</div>';
            } catch (e) {
                hoy.innerHTML = '<p class="text-sm text-red-500">Error al cargar logros.</p>';
            }
        }

        async function loadInsignias() {
            const list = document.getElementById('insignias-list');
            const stats = document.getElementById('insignias-stats');
            list.innerHTML = '<div class="col-span-2 text-center text-slate-400">Cargando...</div>';
            try {
                const data = await apiGet('/api/alumno/insignias');
                const insignias = data.insignias || [];
                const resumen = (data.stats || []).map(s => `${s.rareza}: ${s.count}`).join(' • ');
                stats.textContent = resumen || 'Sin estadísticas aún.';
                list.innerHTML = insignias.length ? insignias.map(i => `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-3 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <p class="text-xs font-bold text-slate-900 dark:text-white">${i.nombre}</p>
                        <p class="text-[10px] text-slate-500">${i.rareza || ''}</p>
                    </div>
                `).join('') : '<div class="col-span-2 text-center text-slate-500">No hay insignias.</div>';
            } catch (e) {
                list.innerHTML = '<div class="col-span-2 text-center text-red-500">Error al cargar insignias.</div>';
            }
        }

        async function loadRanking(periodo = 'semanal') {
            const list = document.getElementById('ranking-list');
            list.innerHTML = '<div class="text-center text-slate-400">Cargando...</div>';
            try {
                const data = await apiGet(`/api/alumno/ranking?periodo=${periodo}`);
                const ranking = data.ranking || [];
                list.innerHTML = ranking.length ? ranking.map((r, idx) => `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-3 border border-slate-100 dark:border-slate-800 shadow-sm flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-xs font-bold text-slate-500">#${idx + 1}</span>
                            <div>
                                <p class="text-sm font-bold text-slate-900 dark:text-white">${r.nombre}</p>
                                <p class="text-xs text-slate-500">${r.rango || ''}</p>
                            </div>
                        </div>
                        <span class="text-xs font-bold text-primary">${r.xp_periodo || 0} XP</span>
                    </div>
                `).join('') : '<div class="text-center text-slate-500">Sin datos de ranking.</div>';
            } catch (e) {
                list.innerHTML = '<div class="text-center text-red-500">Error al cargar ranking.</div>';
            }
        }

        async function loadMensajeria() {
            const list = document.getElementById('mensajeria-list');
            list.innerHTML = '<div class="text-center text-slate-400">Cargando...</div>';
            try {
                const mensajes = await apiGet('/api/messages');
                list.innerHTML = mensajes.length ? mensajes.map(m => `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <p class="font-medium text-slate-900 dark:text-white">${m.asunto || 'Sin asunto'}</p>
                        <p class="text-xs text-slate-500">De: ${m.remitente_nombre || 'Sistema'}</p>
                        <p class="text-xs text-slate-400">${m.fecha_envio || ''}</p>
                        <p class="text-sm text-slate-700 dark:text-slate-300 mt-2">${m.contenido || ''}</p>
                    </div>
                `).join('') : '<div class="text-center text-slate-500">Sin mensajes.</div>';
            } catch (e) {
                list.innerHTML = '<div class="text-center text-red-500">Error al cargar mensajes.</div>';
            }
        }

        async function loadNotificacionesInternas() {
            const list = document.getElementById('notificaciones-internas-list');
            list.innerHTML = '<div class="text-center text-slate-400">Cargando...</div>';
            try {
                const data = await apiGet('/api/notificaciones_internas');
                const noLeidas = data.no_leidas || [];
                const leidas = data.leidas || [];
                const renderItem = (n, unread) => `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm ${unread ? 'ring-1 ring-orange-300' : ''}">
                        <p class="font-medium text-slate-900 dark:text-white">${n.tipo_texto || 'Notificación'}</p>
                        <p class="text-xs text-slate-500">${n.titulo || n.asunto || ''}</p>
                        <p class="text-xs text-slate-400">${n.tiempo_relativo || ''}</p>
                        <p class="text-sm text-slate-600 dark:text-slate-300 mt-2">${n.mensaje || n.contenido || ''}</p>
                    </div>
                `;
                const htmlNoLeidas = noLeidas.map(n => renderItem(n, true)).join('');
                const htmlLeidas = leidas.map(n => renderItem(n, false)).join('');
                list.innerHTML = (htmlNoLeidas || htmlLeidas) ? `${htmlNoLeidas}${htmlLeidas}` : '<div class="text-center text-slate-500">Sin notificaciones.</div>';
            } catch (e) {
                list.innerHTML = '<div class="text-center text-red-500">Error al cargar notificaciones.</div>';
            }
        }

        async function marcarTodasNotificacionesInternas() {
            try {
                await apiPost('/api/notificaciones/marcar-todas-leidas');
                showToast('Notificaciones marcadas', 'success');
                loadNotificacionesInternas();
            } catch (e) {
                showToast('No se pudo marcar', 'error');
            }
        }

        async function enviarMensaje() {
            const destinatarioId = document.getElementById('msg-destinatario').value;
            const tipo = document.getElementById('msg-tipo').value;
            const asunto = document.getElementById('msg-asunto').value;
            const contenido = document.getElementById('msg-contenido').value;
            if (!destinatarioId || !contenido) {
                showToast('Completa destinatario y mensaje', 'warning');
                return;
            }
            try {
                await apiPost('/api/send_message', { destinatario_id: destinatarioId, destinatario_tipo: tipo, asunto, contenido });
                showToast('Mensaje enviado', 'success');
                document.getElementById('msg-contenido').value = '';
                loadMensajeria();
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        async function loadForos() {
            const list = document.getElementById('foros-list');
            list.innerHTML = '<div class="text-center text-slate-400">Cargando...</div>';
            try {
                const posts = await apiGet('/api/get_posts');
                list.innerHTML = posts.length ? posts.map(p => `
                    <button onclick="verPostForo(${p.id})" class="text-left bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <p class="font-bold text-slate-900 dark:text-white">${p.title}</p>
                        <p class="text-xs text-slate-500">${p.nombre} • ${p.date || ''}</p>
                        <p class="text-sm text-slate-600 dark:text-slate-300 mt-2 line-clamp-2">${p.content}</p>
                    </button>
                `).join('') : '<div class="text-center text-slate-500">No hay posts.</div>';
            } catch (e) {
                list.innerHTML = '<div class="text-center text-red-500">Error al cargar foros.</div>';
            }
        }

        async function crearPostForo() {
            const { value: formValues } = await Swal.fire({
                title: 'Nuevo post',
                html: `
                    <input id="foro-title" class="swal2-input" placeholder="Título">
                    <textarea id="foro-content" class="swal2-textarea" placeholder="Contenido"></textarea>
                `,
                showCancelButton: true,
                confirmButtonText: 'Publicar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const title = document.getElementById('foro-title').value;
                    const content = document.getElementById('foro-content').value;
                    if (!title || !content) {
                        Swal.showValidationMessage('Título y contenido son requeridos');
                        return false;
                    }
                    return { title, content };
                }
            });
            if (formValues) {
                await apiPost('/api/create_post', formValues);
                showToast('Post creado', 'success');
                loadForos();
            }
        }

        async function verPostForo(postId) {
            try {
                const data = await apiGet(`/api/foros/${postId}`);
                const post = data.post;
                const comments = data.comments || [];
                const commentsHtml = comments.map(c => `<div class="text-xs text-slate-500"><strong>${c.nombre}</strong>: ${c.content}</div>`).join('') || '<div class="text-xs text-slate-400">Sin comentarios.</div>';
                const { value: comentario } = await Swal.fire({
                    title: post.title,
                    html: `<div class="text-left"><p class="text-sm mb-2">${post.content}</p>${commentsHtml}</div>`,
                    input: 'text',
                    inputPlaceholder: 'Escribe un comentario',
                    showCancelButton: true,
                    confirmButtonText: 'Comentar'
                });
                if (comentario) {
                    await apiPost(`/api/foros/${postId}/comentarios`, { content: comentario });
                    showToast('Comentario enviado', 'success');
                }
            } catch (e) {
                showToast('Error al abrir el post', 'error');
            }
        }

        async function loadFlashcards() {
            const list = document.getElementById('flashcards-list');
            list.innerHTML = '<div class="text-center text-slate-400">Cargando...</div>';
            try {
                const data = await apiGet('/api/flashcards');
                const cards = data.flashcards || data || [];
                list.innerHTML = (cards || []).length ? cards.map(c => `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <p class="font-medium text-slate-900 dark:text-white">${c.pregunta}</p>
                        <p class="text-xs text-slate-500">${c.respuesta}</p>
                    </div>
                `).join('') : '<div class="text-center text-slate-500">Sin flashcards.</div>';
            } catch (e) {
                list.innerHTML = '<div class="text-center text-red-500">Error al cargar flashcards.</div>';
            }
        }

        async function crearFlashcard() {
            const { value: formValues } = await Swal.fire({
                title: 'Nueva flashcard',
                html: `
                    <input id="fc-pregunta" class="swal2-input" placeholder="Pregunta">
                    <input id="fc-respuesta" class="swal2-input" placeholder="Respuesta">
                `,
                showCancelButton: true,
                confirmButtonText: 'Crear',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const pregunta = document.getElementById('fc-pregunta').value;
                    const respuesta = document.getElementById('fc-respuesta').value;
                    if (!pregunta || !respuesta) {
                        Swal.showValidationMessage('Completa pregunta y respuesta');
                        return false;
                    }
                    return { pregunta, respuesta };
                }
            });
            if (formValues) {
                await apiPost('/api/flashcards', formValues);
                showToast('Flashcard creada', 'success');
                loadFlashcards();
            }
        }

        async function enviarPreguntaIA() {
            const input = document.getElementById('ia-input');
            const chat = document.getElementById('ia-chat');
            const message = input.value.trim();
            if (!message) return;
            chat.insertAdjacentHTML('beforeend', `<div class="text-right text-sm"><span class="inline-block bg-primary text-white px-3 py-2 rounded-xl">${message}</span></div>`);
            input.value = '';
            try {
                const data = await apiPost('/api/chat/gemini', { message });
                chat.insertAdjacentHTML('beforeend', `<div class="text-left text-sm"><span class="inline-block bg-slate-100 dark:bg-slate-800 px-3 py-2 rounded-xl">${data.response}</span></div>`);
            } catch (e) {
                showToast('Error en tutor IA', 'error');
            }
        }

        async function loadPlayground() {
            try {
                const data = await apiGet('/api/load_playground');
                document.getElementById('playground-code').value = data.code || '';
            } catch (e) {
                showToast('Error al cargar playground', 'error');
            }
        }

        async function savePlayground() {
            try {
                const code = document.getElementById('playground-code').value;
                await apiPost('/api/save_playground', { code });
                showToast('Playground guardado', 'success');
            } catch (e) {
                showToast('Error al guardar', 'error');
            }
        }

        async function shareSnippet() {
            try {
                const code = document.getElementById('snippet-code').value;
                if (!code) {
                    showToast('Agrega código', 'warning');
                    return;
                }
                const data = await apiPost('/api/share_snippet', { code });
                document.getElementById('snippet-id').value = (data.share_url || '').split('/').pop();
                showToast('Snippet compartido', 'success');
            } catch (e) {
                showToast('Error al compartir', 'error');
            }
        }

        async function loadSnippet() {
            const id = document.getElementById('snippet-id').value.trim();
            const viewer = document.getElementById('snippet-viewer');
            if (!id) return;
            viewer.textContent = 'Cargando...';
            try {
                const data = await apiGet(`/api/snippets/${id}`);
                viewer.textContent = data.code || '';
            } catch (e) {
                viewer.textContent = 'No se encontró el snippet.';
            }
        }

        async function loadTienda() {
            const list = document.getElementById('tienda-list');
            const balance = document.getElementById('tienda-balance');
            list.innerHTML = '<div class="col-span-2 text-center text-slate-400">Cargando...</div>';
            try {
                const data = await apiGet('/api/tienda');
                balance.textContent = `EduCoins: ${data.educoins}`;
                const items = data.items || [];
                list.innerHTML = items.length ? items.map(i => `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-3 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <p class="text-xs font-bold text-slate-900 dark:text-white">${i.nombre || 'Item'}</p>
                        <p class="text-[10px] text-slate-500">${i.descripcion || ''}</p>
                        <p class="text-[10px] text-slate-400">${i.precio_educoins} EduCoins</p>
                        <button onclick="comprarItem(${i.id})" class="mt-2 w-full py-1 text-xs bg-primary text-white rounded">Comprar</button>
                    </div>
                `).join('') : '<div class="col-span-2 text-center text-slate-500">Sin items.</div>';
            } catch (e) {
                list.innerHTML = '<div class="col-span-2 text-center text-red-500">Error al cargar tienda.</div>';
            }
        }

        async function comprarItem(itemId) {
            try {
                await apiPost('/api/tienda/comprar', { item_id: itemId });
                showToast('Compra exitosa', 'success');
                loadTienda();
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        async function loadLearningPaths() {
            const list = document.getElementById('learning-paths-list');
            list.innerHTML = '<div class="text-center text-slate-400">Cargando...</div>';
            try {
                const data = await apiGet('/api/learning_paths');
                let paths = data.paths || data || [];
                if (!Array.isArray(paths)) {
                    paths = Object.keys(paths).map(key => ({ id: key, nombre: key, descripcion: (paths[key] || []).join(', ') }));
                }
                list.innerHTML = paths.length ? paths.map(p => `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <p class="font-medium text-slate-900 dark:text-white">${p.nombre || p.title || 'Path'}</p>
                        <p class="text-xs text-slate-500">${p.descripcion || ''}</p>
                        <button onclick="enrollPath('${p.id}')" class="mt-2 text-xs text-primary">Inscribirme</button>
                    </div>
                `).join('') : '<div class="text-center text-slate-500">Sin rutas disponibles.</div>';
            } catch (e) {
                list.innerHTML = '<div class="text-center text-red-500">Error al cargar rutas.</div>';
            }
        }

        async function enrollPath(pathId) {
            try {
                if (isNaN(parseInt(pathId, 10))) {
                    showToast('Ruta no disponible para inscripción', 'warning');
                    return;
                }
                await fetch(`/enroll-path/${pathId}`, { method: 'POST' });
                showToast('Inscripción realizada', 'success');
            } catch (e) {
                showToast('Error al inscribir', 'error');
            }
        }

        const materiasData = {{ materias|tojson|safe }};

        function fillMateriaSelect(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            select.innerHTML = (materiasData || []).map(m => `<option value="${m.id}">${m.nombre}</option>`).join('');
        }

        async function loadLabs() {
            fillMateriaSelect('labs-materia');
            const select = document.getElementById('labs-materia');
            select.onchange = () => loadLabs();
            const materiaId = select.value;
            const list = document.getElementById('labs-list');
            list.innerHTML = '<div class="text-center text-slate-400">Cargando...</div>';
            try {
                const data = await apiGet(`/api/virtual_labs/${materiaId}`);
                const labs = data.labs || [];
                list.innerHTML = labs.length ? labs.map(l => `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <p class="font-medium text-slate-900 dark:text-white">${l.titulo || 'Lab'}</p>
                        <p class="text-xs text-slate-500">${l.descripcion || ''}</p>
                    </div>
                `).join('') : '<div class="text-center text-slate-500">Sin labs.</div>';
            } catch (e) {
                list.innerHTML = '<div class="text-center text-red-500">Error al cargar labs.</div>';
            }
        }

        async function loadExternalResources() {
            fillMateriaSelect('external-materia');
            const select = document.getElementById('external-materia');
            select.onchange = () => loadExternalResources();
            const materiaId = select.value;
            const list = document.getElementById('external-list');
            list.innerHTML = '<div class="text-center text-slate-400">Cargando...</div>';
            try {
                const data = await apiGet(`/api/external_resources/${materiaId}`);
                const resources = data.resources || {};
                const items = [...(resources.videos || []), ...(resources.exercises || [])];
                list.innerHTML = items.length ? items.map(r => `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-3 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <p class="text-sm text-slate-900 dark:text-white">${r}</p>
                    </div>
                `).join('') : '<div class="text-center text-slate-500">Sin recursos.</div>';
            } catch (e) {
                list.innerHTML = '<div class="text-center text-red-500">Error al cargar recursos.</div>';
            }
        }

        async function loadEventos() {
            const list = document.getElementById('eventos-list');
            list.innerHTML = '<div class="text-center text-slate-400">Cargando...</div>';
            try {
                const eventos = await apiGet('/api/events');
                list.innerHTML = (eventos || []).length ? eventos.map(ev => `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <p class="font-medium text-slate-900 dark:text-white">${ev.title || ev.titulo || 'Evento'}</p>
                        <p class="text-xs text-slate-500">${ev.date || ev.fecha || ''}</p>
                        <p class="text-xs text-slate-400">${ev.description || ev.descripcion || ''}</p>
                    </div>
                `).join('') : '<div class="text-center text-slate-500">Sin eventos.</div>';
            } catch (e) {
                list.innerHTML = '<div class="text-center text-red-500">Error al cargar eventos.</div>';
            }
        }

        async function loadCoursera() {
            fillMateriaSelect('coursera-materia');
            const select = document.getElementById('coursera-materia');
            select.onchange = () => loadCoursera();
            const materiaId = select.value;
            const list = document.getElementById('coursera-list');
            list.innerHTML = '<div class="text-center text-slate-400">Cargando...</div>';
            try {
                const data = await apiGet(`/api/coursera/${materiaId}`);
                const courses = data.courses || [];
                list.innerHTML = courses.length ? courses.map(c => `
                    <a href="https://${c.url}" target="_blank" rel="noreferrer" class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <p class="font-medium text-slate-900 dark:text-white">${c.title}</p>
                        <p class="text-xs text-primary">${c.url}</p>
                    </a>
                `).join('') : '<div class="text-center text-slate-500">Sin cursos.</div>';
            } catch (e) {
                list.innerHTML = '<div class="text-center text-red-500">Error al cargar cursos.</div>';
            }
        }

        async function abrirExportacion() {
            const { value: formValues } = await Swal.fire({
                title: 'Nueva exportación',
                html: `
                    <input id="exp-fecha-inicio" type="date" class="swal2-input">
                    <input id="exp-fecha-fin" type="date" class="swal2-input">
                    <select id="exp-formato" class="swal2-input">
                        <option value="pdf">PDF</option>
                        <option value="excel">Excel</option>
                    </select>
                `,
                showCancelButton: true,
                confirmButtonText: 'Exportar',
                preConfirm: () => {
                    const fecha_inicio = document.getElementById('exp-fecha-inicio').value;
                    const fecha_fin = document.getElementById('exp-fecha-fin').value;
                    if (!fecha_inicio || !fecha_fin) {
                        Swal.showValidationMessage('Fechas requeridas');
                        return false;
                    }
                    return {
                        formato: document.getElementById('exp-formato').value,
                        fecha_inicio,
                        fecha_fin,
                        tipo_exportacion: 'progreso'
                    };
                }
            });

            if (formValues) {
                try {
                    await apiPost('/api/alumno/exportar', formValues);
                    showToast('Exportación solicitada', 'success');
                    loadExportaciones();
                } catch (e) {
                    showToast(e.message, 'error');
                }
            }
        }

        async function loadExportaciones() {
            const container = document.getElementById('exportaciones-list');
            container.innerHTML = '<div class="flex justify-center p-4"><span class="text-slate-400">Cargando...</span></div>';
            try {
                const exps = await apiGet('/api/alumno/exportaciones');
                if (!exps.length) {
                    container.innerHTML = '<div class="p-6 text-center text-slate-500">No hay exportaciones.</div>';
                    return;
                }
                container.innerHTML = exps.map(e => `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm flex justify-between items-center">
                        <div>
                            <p class="font-medium text-slate-900 dark:text-white">${e.tipo_exportacion || 'Exportación'}</p>
                            <p class="text-xs text-slate-500">${e.formato || ''} • ${e.estado || ''}</p>
                        </div>
                        <a href="/api/alumno/exportar/descargar/${e.id}" class="text-xs text-primary">Descargar</a>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<p class="text-center text-red-500">Error al cargar exportaciones.</p>';
            }
        }

        async function loadAyuda() {
            const seccion = document.getElementById('ayuda-seccion').value || 'dashboard';
            const container = document.getElementById('ayuda-list');
            container.innerHTML = '<div class="flex justify-center p-4"><span class="text-slate-400">Cargando...</span></div>';
            try {
                const ayudas = await apiGet(`/api/alumno/ayuda/${seccion}`);
                if (!ayudas.length) {
                    container.innerHTML = '<div class="p-6 text-center text-slate-500">Sin ayuda para esta sección.</div>';
                    return;
                }
                container.innerHTML = ayudas.map(a => `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <p class="font-medium text-slate-900 dark:text-white">${a.titulo || 'Ayuda'}</p>
                        <p class="text-xs text-slate-500">${a.descripcion || ''}</p>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<p class="text-center text-red-500">Error al cargar ayuda.</p>';
            }
        }

        function descargarConstancia() {
            window.open('/api/alumno/generar-constancia', '_blank');
        }

        function descargarBoleta() {
            window.open('/api/alumno/boleta-calificaciones', '_blank');
        }

        async function loadMisionesView() {
            const container = document.getElementById('misiones-list');
            if (!container) return;
            container.innerHTML = '<div class="flex justify-center p-4"><span class="text-slate-400">Cargando misiones...</span></div>';
            try {
                const response = await fetch('/api/alumno/misiones');
                if (!response.ok) throw new Error('Error al obtener misiones');
                const missions = await response.json();

                if (!missions || missions.length === 0) {
                    container.innerHTML = '<div class="p-6 text-center text-slate-500">No hay misiones activas.</div>';
                    return;
                }

                container.innerHTML = missions.map(m => {
                    const isTarget = m.tipo === 'academica';
                    const bgColor = isTarget ? 'bg-purple-100 dark:bg-purple-900/30' : 'bg-green-100 dark:bg-green-900/30';
                    const textColor = isTarget ? 'text-purple-600' : 'text-green-600';
                    const barColor = isTarget ? 'bg-purple-500' : 'bg-green-500';
                    const icon = m.icono || (isTarget ? 'school' : 'menu_book');
                    const total = m.requisito_cantidad || 1;
                    const progress = m.progreso || 0;
                    const percent = Math.min((progress / total) * 100, 100);

                    return `
                        <div class="bg-white dark:bg-surface-dark p-4 rounded-xl border border-slate-100 dark:border-slate-800 shadow-sm flex flex-col gap-2 relative">
                            ${m.completada ? `
                            <div class="absolute top-2 right-2 text-green-500">
                                <span class="material-symbols-outlined">check_circle</span>
                            </div>` : ''}

                            <div class="flex items-center gap-2">
                                <div class="p-2 ${bgColor} ${textColor} rounded-lg shrink-0">
                                    <span class="material-symbols-outlined text-[20px]">${icon}</span>
                                </div>
                                <div>
                                    <p class="text-sm font-bold text-slate-900 dark:text-white leading-tight">${m.titulo}</p>
                                    <p class="text-xs text-slate-500">${m.descripcion || ''}</p>
                                </div>
                            </div>
                            <div class="w-full bg-slate-100 dark:bg-slate-700 h-1.5 rounded-full mt-1">
                                <div class="${barColor} h-1.5 rounded-full" style="width: ${percent}%"></div>
                            </div>
                            <div class="flex justify-between items-center text-xs text-slate-500">
                                <span>+${m.xp_recompensa} XP • ${m.educoins_recompensa || 0} EduCoins</span>
                                <span>${progress}/${total}</span>
                            </div>
                            ${!m.completada ? `
                            <button onclick="updateMissionProgress(${m.id}, 1)" class="mt-1 w-full text-[11px] py-1.5 bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 rounded text-slate-600 dark:text-slate-400 transition">
                                Registrar progreso
                            </button>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            } catch (e) {
                container.innerHTML = '<p class="text-center text-red-500">Error al cargar misiones.</p>';
            }
        }

        function showPanel(panelName) {
            const dashboard = document.querySelector('main');
            const header = document.getElementById('header-stats');

            const views = [
                'notes-view', 'portfolio-view', 'tutorias-view', 'equipos-view',
                'community-container', 'subjects-container', 'courses-view', 'resources-view', 'more-view',
                'misiones-view', 'hoy-view', 'objetivos-view', 'habitos-view', 'notificaciones-view',
                'recomendaciones-view', 'progreso-view', 'riesgo-view', 'funciones-view',
                'recompensas-view', 'balance-view', 'examenes-view', 'encuestas-view',
                'feedback-view', 'exportaciones-view', 'ayuda-view', 'documentos-view',
                'logros-view', 'insignias-view', 'ranking-view', 'mensajeria-view', 'notificaciones-internas-view', 'foros-view',
                'flashcards-view', 'ia-tutor-view', 'playground-view', 'snippets-view', 'tienda-view',
                'learning-paths-view', 'labs-view', 'external-resources-view', 'eventos-view', 'coursera-view'
            ];

            // Ocultar todo
            dashboard.classList.add('hidden');
            header.classList.add('hidden');
            views.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });

            if (panelName === 'dashboard') {
                dashboard.classList.remove('hidden');
                header.classList.remove('hidden');
                return;
            }

            const show = (id) => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('hidden');
            };

            switch (panelName) {
                case 'subjects':
                    show('subjects-container');
                    loadSubjects();
                    break;
                case 'resources':
                    show('resources-view');
                    break;
                case 'community':
                    show('community-container');
                    scrollToBottomChat();
                    break;
                case 'notes':
                    show('notes-view');
                    loadNotes();
                    break;
                case 'portfolio':
                    show('portfolio-view');
                    loadPortfolio();
                    break;
                case 'tutorias':
                    show('tutorias-view');
                    loadTutorias();
                    break;
                case 'equipos':
                    show('equipos-view');
                    loadEquipos();
                    break;
                case 'more':
                    show('more-view');
                    break;
                case 'misiones':
                    show('misiones-view');
                    loadMisionesView();
                    break;
                case 'hoy':
                    show('hoy-view');
                    loadHoy();
                    break;
                case 'objetivos':
                    show('objetivos-view');
                    loadObjetivos();
                    break;
                case 'habitos':
                    show('habitos-view');
                    loadHabitos();
                    break;
                case 'notificaciones':
                    show('notificaciones-view');
                    loadNotificaciones();
                    break;
                case 'recomendaciones':
                    show('recomendaciones-view');
                    loadRecomendaciones();
                    break;
                case 'progreso':
                    show('progreso-view');
                    loadProgreso();
                    break;
                case 'riesgo':
                    show('riesgo-view');
                    loadRiesgo();
                    break;
                case 'funciones':
                    show('funciones-view');
                    loadFunciones();
                    break;
                case 'recompensas':
                    show('recompensas-view');
                    loadRecompensas();
                    break;
                case 'balance':
                    show('balance-view');
                    loadBalance();
                    break;
                case 'examenes':
                    show('examenes-view');
                    loadExamenes();
                    break;
                case 'encuestas':
                    show('encuestas-view');
                    loadEncuestas();
                    break;
                case 'feedback':
                    show('feedback-view');
                    loadFeedback();
                    break;
                case 'exportaciones':
                    show('exportaciones-view');
                    loadExportaciones();
                    break;
                case 'ayuda':
                    show('ayuda-view');
                    break;
                case 'documentos':
                    show('documentos-view');
                    break;
                case 'logros':
                    show('logros-view');
                    loadLogros();
                    break;
                case 'insignias':
                    show('insignias-view');
                    loadInsignias();
                    break;
                case 'ranking':
                    show('ranking-view');
                    loadRanking('semanal');
                    break;
                case 'mensajeria':
                    show('mensajeria-view');
                    loadMensajeria();
                    break;
                case 'notificaciones-internas':
                    show('notificaciones-internas-view');
                    loadNotificacionesInternas();
                    break;
                case 'foros':
                    show('foros-view');
                    loadForos();
                    break;
                case 'flashcards':
                    show('flashcards-view');
                    loadFlashcards();
                    break;
                case 'ia-tutor':
                    show('ia-tutor-view');
                    break;
                case 'playground':
                    show('playground-view');
                    loadPlayground();
                    break;
                case 'snippets':
                    show('snippets-view');
                    break;
                case 'tienda':
                    show('tienda-view');
                    loadTienda();
                    break;
                case 'learning-paths':
                    show('learning-paths-view');
                    loadLearningPaths();
                    break;
                case 'labs':
                    show('labs-view');
                    loadLabs();
                    break;
                case 'external-resources':
                    show('external-resources-view');
                    loadExternalResources();
                    break;
                case 'eventos':
                    show('eventos-view');
                    loadEventos();
                    break;
                case 'coursera':
                    show('coursera-view');
                    loadCoursera();
                    break;
                default:
                    dashboard.classList.remove('hidden');
                    header.classList.remove('hidden');
            }
        }

        // --- Phase 4: Profile & Settings ---

        function openProfileModal() {
            // Pre-fill if we had the data stored, but for now just open
            const modal = document.getElementById('profile-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-95');
                modal.querySelector('div').classList.add('scale-100');
            }, 10);
        }

        function closeProfileModal() {
            const modal = document.getElementById('profile-modal');
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.remove('scale-100');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function previewAvatar(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('profile-preview').style.backgroundImage = `url('${e.target.result}')`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateAvatarUI(url) {
            document.getElementById('profile-preview').style.backgroundImage = `url('${url}')`;
            document.querySelectorAll('[data-avatar]').forEach(el => {
                el.style.backgroundImage = `url('${url}')`;
            });
        }

        async function updateProfile(e) {
            e.preventDefault();
            const form = e.target;
            const avatarInput = form.querySelector('input[name="avatar"]');
            const passwordInput = form.querySelector('input[name="password"]');

            const hasAvatar = avatarInput && avatarInput.files && avatarInput.files[0];
            const hasPassword = passwordInput && passwordInput.value;

            if (!hasAvatar && !hasPassword) {
                Swal.fire('Info', 'No has realizado cambios.', 'info');
                return;
            }

            try {
                if (hasAvatar) {
                    const photoData = new FormData();
                    photoData.append('photo', avatarInput.files[0]);
                    const photoRes = await fetch('/api/profile/upload-photo', {
                        method: 'POST',
                        body: photoData
                    });
                    const photoJson = await photoRes.json();
                    if (photoRes.ok && (photoJson.success || photoJson.foto_perfil)) {
                        updateAvatarUI(photoJson.foto_perfil);
                    } else {
                        throw new Error(photoJson.error || 'Error al subir foto');
                    }
                }

                if (hasPassword) {
                    const passRes = await fetch('/api/change_password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ new_password: passwordInput.value })
                    });
                    if (!passRes.ok) {
                        throw new Error('Error al cambiar contraseña');
                    }
                }

                Swal.fire('¡Éxito!', 'Perfil actualizado correctamente.', 'success');
                closeProfileModal();
                loadStats();
            } catch (error) {
                console.error(error);
                Swal.fire('Error', error.message || 'No se pudo actualizar el perfil.', 'error');
            }
        }

        function logout() {
            Swal.fire({
                title: '¿Cerrar Sesión?',
                text: "Tendrás que iniciar sesión de nuevo.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Sí, cerrar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/logout';
                }
            });
        }

    </script>
</body>

</html>