<!DOCTYPE html>
<html class="light" lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Docente | EduPlatform</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "surface-light": "#FFFFFF",
                        "surface-dark": "#1A2633",
                        "text-main-light": "#111418",
                        "text-main-dark": "#F3F4F6",
                        "text-sec-light": "#617589",
                        "text-sec-dark": "#9CA3AF",
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#137fec', 600: '#0f6fd6', 900: '#0c4a6e' },
                        dark: { 800: '#1e293b', 900: '#0f172a' }
                    },
                    fontFamily: {
                        display: ["Lexend", "sans-serif"]
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Lexend', sans-serif;
            background: #f6f7f8;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .nav-item.active {
            background-color: #137fec;
            color: white;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .animate-enter {
            animation: enter 0.3s ease-out;
        }

        @keyframes enter {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-white antialiased transition-colors duration-200 min-h-screen">

    <div id="main-app-container"
        class="relative flex flex-col w-full max-w-md mx-auto bg-white dark:bg-background-dark shadow-2xl min-h-screen overflow-hidden">

    <!-- SIDEBAR -->
    <aside class="hidden w-64 bg-dark-900 text-white flex flex-col shadow-2xl z-20 fixed md:relative h-full" id="sidebar">
        <div class="p-6 border-b border-gray-700">
            <h1 class="text-2xl font-bold">Edu<span class="text-brand-500">Platform</span></h1>
        </div>
        <div class="p-4 flex items-center space-x-3 border-b border-gray-700 bg-dark-800">
            <div class="w-10 h-10 rounded-full bg-brand-500 flex items-center justify-center font-bold">D</div>
            <div>
                <p class="font-semibold text-sm">{{ session.get('user_name', 'Docente') }}</p>
                <p class="text-xs text-gray-400">Docente</p>
            </div>
        </div>
        <nav class="flex-1 overflow-y-auto py-4">
            <ul class="space-y-1 px-3">
                <li><a href="#" onclick="showSection('dashboard')"
                        class="nav-item active flex items-center p-3 rounded-lg hover:bg-dark-800"><i
                            class="fas fa-home w-8"></i> Inicio</a></li>
                <li><a href="#" onclick="showSection('materias')"
                        class="nav-item flex items-center p-3 rounded-lg hover:bg-dark-800"><i
                            class="fas fa-book w-8"></i> Mis Materias</a></li>
                <li><a href="#" onclick="showSection('tareas')"
                        class="nav-item flex items-center p-3 rounded-lg hover:bg-dark-800"><i
                            class="fas fa-tasks w-8"></i> Gesti√≥n Tareas</a></li>
                <li><a href="#" onclick="showSection('estudiantes')"
                        class="nav-item flex items-center p-3 rounded-lg hover:bg-dark-800"><i
                            class="fas fa-users w-8"></i> Estudiantes</a></li>
                <li class="pt-4 pb-2 px-3 text-xs text-gray-500 font-bold">HERRAMIENTAS</li>
                <li><a href="#" onclick="showSection('asistencia')"
                        class="nav-item flex items-center p-3 rounded-lg hover:bg-dark-800"><i
                            class="fas fa-qrcode w-8"></i> Asistencia QR</a></li>
                <li><a href="#" onclick="showSection('recursos')"
                        class="nav-item flex items-center p-3 rounded-lg hover:bg-dark-800"><i
                            class="fas fa-folder w-8"></i> Recursos</a></li>
                <li><a href="#" onclick="showSection('mensajes')"
                        class="nav-item flex items-center p-3 rounded-lg hover:bg-dark-800"><i
                            class="fas fa-envelope w-8"></i> Mensajes</a></li>
                <li><a href="#" onclick="showSection('reportes')"
                        class="nav-item flex items-center p-3 rounded-lg hover:bg-dark-800"><i
                            class="fas fa-chart-bar w-8"></i> Reportes</a></li>
                <li><a href="#" onclick="showSection('evaluaciones')"
                        class="nav-item flex items-center p-3 rounded-lg hover:bg-dark-800"><i
                            class="fas fa-file-alt w-8"></i> Evaluaciones</a></li>
                <li><a href="#" onclick="showSection('comunicados')"
                        class="nav-item flex items-center p-3 rounded-lg hover:bg-dark-800"><i
                            class="fas fa-bullhorn w-8"></i> Comunicados</a></li>
                <li><a href="#" onclick="showSection('retos')"
                        class="nav-item flex items-center p-3 rounded-lg hover:bg-dark-800"><i
                            class="fas fa-code w-8"></i> Retos de C√≥digo</a></li>
                <li><a href="#" onclick="showSection('calendario')"
                        class="nav-item flex items-center p-3 rounded-lg hover:bg-dark-800"><i
                            class="fas fa-calendar-alt w-8"></i> Calendario</a></li>
                <li class="pt-4 pb-2 px-3 text-xs text-gray-500 font-bold">INTELIGENCIA ARTIFICIAL</li>
                <li><a href="#" onclick="showSection('chatia')"
                        class="nav-item flex items-center p-3 rounded-lg hover:bg-dark-800"><i
                            class="fas fa-robot w-8 text-purple-400"></i> Asistente IA</a></li>
                <li><a href="#" onclick="showSection('quizgen')"
                        class="nav-item flex items-center p-3 rounded-lg hover:bg-dark-800"><i
                            class="fas fa-magic w-8 text-indigo-400"></i> Generador Quiz</a></li>
                <li><a href="#" onclick="showSection('tutorias')"
                        class="nav-item flex items-center p-3 rounded-lg hover:bg-dark-800"><i
                            class="fas fa-user-graduate w-8 text-green-400"></i> Tutor√≠as</a></li>
                <li><a href="#" onclick="showSection('horario')"
                        class="nav-item flex items-center p-3 rounded-lg hover:bg-dark-800"><i
                            class="fas fa-clock w-8 text-blue-400"></i> Mi Horario</a></li>
                <li><a href="#" onclick="lanzarAulaVirtual()"
                        class="nav-item flex items-center p-3 rounded-lg hover:bg-dark-800 text-red-400"><i
                            class="fas fa-video w-8"></i> Aula Virtual</a></li>
            </ul>
        </nav>
        <div class="p-4 border-t border-gray-700">
            <button onclick="openModalPerfil()"
                class="flex items-center w-full p-2 hover:bg-dark-800 rounded-lg transition">
                <div
                    id="docente-avatar-mini"
                    class="w-8 h-8 rounded-full bg-brand-500 flex items-center justify-center text-white font-bold mr-3 bg-cover bg-center"
                    style="background-image: url('{{ foto_perfil|default('') }}');">
                    {{ nombre_docente[0] if nombre_docente else 'D' }}
                </div>
                <div class="text-left">
                    <p class="text-sm font-medium">{{ nombre_docente }}</p>
                    <p class="text-xs text-gray-400">Docente</p>
                </div>
            </button>
            <a href="{{ url_for('logout') }}"
                class="mt-4 flex items-center justify-center w-full p-2 text-red-400 hover:bg-red-400/10 rounded-lg transition text-sm">
                <i class="fas fa-sign-out-alt mr-2"></i> Cerrar Sesi√≥n
            </a>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- HEADER -->
        <header class="bg-white dark:bg-background-dark shadow-sm h-16 flex items-center justify-between px-6 z-20">
            <div class="flex items-center">
                <button id="mobile-menu-btn" class="lg:hidden mr-4 text-gray-600"><i
                        class="fas fa-bars text-xl"></i></button>
                <h2 class="text-xl font-bold text-gray-800" id="page-title">Panel Docente</h2>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="lanzarAulaVirtual()"
                    class="hidden md:flex items-center bg-red-100 text-red-600 px-3 py-1 rounded-full text-sm font-bold hover:bg-red-200 transition">
                    <i class="fas fa-video mr-2"></i> En vivo
                </button>

                <!-- Notificaciones Dropdown -->
                <div class="relative" id="notif-container">
                    <button onclick="toggleNotificaciones()" class="relative p-2 text-gray-400 hover:text-gray-600">
                        <i class="fas fa-bell text-xl"></i>
                        <span id="notif-badge"
                            class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full hidden"></span>
                    </button>
                    <div id="notif-dropdown"
                        class="hidden absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-2xl border z-50 overflow-hidden">
                        <div class="p-3 bg-gray-50 border-b flex justify-between items-center">
                            <span class="font-bold text-sm">Notificaciones</span>
                            <button onclick="marcarTodasLeidas()" class="text-xs text-brand-600 hover:underline">Marcar
                                le√≠das</button>
                        </div>
                        <div id="notif-list" class="max-h-80 overflow-y-auto divide-y">
                            <div class="p-4 text-center text-gray-400 text-sm">Cargando...</div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6 bg-gray-100" id="main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="mb-6">
                {% for category, message in messages %}
                <div
                    class="p-4 rounded-lg mb-2 {{ 'bg-green-100 text-green-700' if category == 'success' else 'bg-red-100 text-red-700' }}">
                    {{ message }}</div>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}

            <!-- DASHBOARD -->
            <section id="section-dashboard" class="content-section active animate-enter space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border hover:shadow-md transition text-center flex flex-col items-center gap-1">
                        <p class="text-xs text-gray-500 uppercase">Total Estudiantes</p>
                        <h3 class="text-3xl font-bold mt-1">{{ total_students or 0 }}</h3>
                        <p class="text-xs text-blue-500 mt-2"><i class="fas fa-users mr-1"></i> Matriculados</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border hover:shadow-md transition text-center flex flex-col items-center gap-1">
                        <p class="text-xs text-gray-500 uppercase">Materias Activas</p>
                        <h3 class="text-3xl font-bold mt-1">{{ materias|length if materias else 0 }}</h3>
                        <p class="text-xs text-green-500 mt-2"><i class="fas fa-check-circle mr-1"></i> Este semestre
                        </p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border hover:shadow-md transition text-center flex flex-col items-center gap-1">
                        <p class="text-xs text-gray-500 uppercase">Tareas Activas</p>
                        <h3 class="text-3xl font-bold mt-1">{{ tareas|length if tareas else 0 }}</h3>
                        <p class="text-xs text-orange-500 mt-2"><i class="fas fa-clock mr-1"></i> Pendientes evaluar</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border hover:shadow-md transition text-center flex flex-col items-center gap-1">
                        <p class="text-xs text-gray-500 uppercase">Retos de C√≥digo</p>
                        <h3 class="text-3xl font-bold mt-1">{{ retos|length if retos else 0 }}</h3>
                        <p class="text-xs text-purple-500 mt-2"><i class="fas fa-code mr-1"></i> Lanzados</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="p-5 border-b flex justify-between items-center">
                            <h3 class="font-bold">Tareas Pendientes de Evaluar</h3>
                            <button onclick="showSection('tareas')" class="text-brand-600 text-sm hover:underline">Ver
                                todas</button>
                        </div>
                        <div class="p-4">
                            {% if tareas %}
                            {% for t in tareas[:5] %}
                            <div class="flex items-center justify-between py-3 border-b last:border-0">
                                <div>
                                    <p class="font-medium">{{ t.titulo }}</p>
                                    <p class="text-xs text-gray-500">{{ t.materia }}</p>
                                </div>
                                <span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded">{{
                                    t.entregas_totales - t.entregas_calificadas }} sin calificar</span>
                            </div>
                            {% endfor %}
                            {% else %}
                            <p class="text-center text-gray-400 py-8">No hay tareas pendientes</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="p-5 border-b flex justify-between items-center">
                            <h3 class="font-bold">Acciones R√°pidas</h3>
                        </div>
                        <div class="p-4 grid grid-cols-2 gap-4">
                            <button onclick="openModalCrearTarea()"
                                class="p-4 bg-blue-50 rounded-lg text-center hover:bg-blue-100 transition">
                                <i class="fas fa-plus-circle text-2xl text-blue-500 mb-2"></i>
                                <p class="text-sm font-medium">Nueva Tarea</p>
                            </button>
                            <button onclick="openModalQR()"
                                class="p-4 bg-green-50 rounded-lg text-center hover:bg-green-100 transition">
                                <i class="fas fa-qrcode text-2xl text-green-500 mb-2"></i>
                                <p class="text-sm font-medium">Generar QR</p>
                            </button>
                            <button onclick="showSection('recursos')"
                                class="p-4 bg-purple-50 rounded-lg text-center hover:bg-purple-100 transition">
                                <i class="fas fa-upload text-2xl text-purple-500 mb-2"></i>
                                <p class="text-sm font-medium">Subir Recurso</p>
                            </button>
                            <button onclick="showSection('mensajes')"
                                class="p-4 bg-orange-50 rounded-lg text-center hover:bg-orange-100 transition">
                                <i class="fas fa-paper-plane text-2xl text-orange-500 mb-2"></i>
                                <p class="text-sm font-medium">Enviar Mensaje</p>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Estudiantes en Riesgo de Deserci√≥n -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border-l-4 border-red-500">
                    <div class="p-5 border-b flex justify-between items-center bg-red-50">
                        <div>
                            <h3 class="font-bold text-red-700"><i
                                    class="fas fa-exclamation-triangle mr-2"></i>Estudiantes en Riesgo</h3>
                            <p class="text-xs text-red-600">Predicci√≥n basada en ML</p>
                        </div>
                        <button onclick="cargarEstudiantesRiesgo()" class="text-red-600 text-sm hover:underline"><i
                                class="fas fa-sync mr-1"></i>Actualizar</button>
                    </div>
                    <div class="p-4" id="estudiantes-riesgo-list">
                        <div class="text-center text-gray-400 py-6">Cargando predicciones...</div>
                    </div>
                </div>
            </section>

            <!-- MATERIAS -->
            <section id="section-materias" class="content-section space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Mis Materias</h2>
                    <button onclick="openMateriaModal('crear')" class="bg-brand-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>Nueva Materia
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {% for m in materias %}
                    <div class="materia-card bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-lg transition cursor-pointer"
                        data-id="{{ m.id }}"
                        data-nombre="{{ m.nombre|e }}"
                        data-descripcion="{{ (m.descripcion or '')|e }}"
                        data-semestre="{{ m.semestre or '' }}"
                        onclick="loadSubjectDetails({{ m.id }})">
                        <div class="h-28 bg-gradient-to-r from-blue-500 to-cyan-400 p-4 flex items-end">
                            <h3 class="text-white font-bold text-lg">{{ m.nombre }}</h3>
                        </div>
                        <div class="p-4">
                            <p class="text-sm text-gray-500 mb-3">{{ m.descripcion[:60] if m.descripcion else 'Sin
                                descripci√≥n' }}...</p>
                            <div class="flex justify-between text-xs">
                                <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded">Semestre {{ m.semestre
                                    }}</span>
                                <span class="text-gray-500">{{ m.quiz_generado }} quizzes</span>
                            </div>
                            <div class="flex justify-between mt-3">
                                <button onclick="openMateriaFromCard(event, this)" class="text-brand-600 text-xs hover:underline">
                                    <i class="fas fa-edit mr-1"></i>Editar
                                </button>
                                <button onclick="desactivarMateriaFromCard(event, this)" class="text-red-500 text-xs hover:underline">
                                    <i class="fas fa-trash mr-1"></i>Desactivar
                                </button>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="col-span-full bg-white p-8 rounded-xl text-center">
                        <i class="fas fa-book-open text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">No tienes materias asignadas</p>
                    </div>
                    {% endfor %}
                </div>
            </section>

            <!-- TAREAS -->
            <section id="section-tareas" class="content-section space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Gesti√≥n de Tareas</h2>
                    <button onclick="openModalCrearTarea()" class="bg-brand-600 text-white px-4 py-2 rounded-lg"><i
                            class="fas fa-plus mr-2"></i>Nueva Tarea</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                            <tr>
                                <th class="px-6 py-3">Tarea</th>
                                <th class="px-6 py-3">Materia</th>
                                <th class="px-6 py-3">Vence</th>
                                <th class="px-6 py-3">Entregas</th>
                                <th class="px-6 py-3">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            {% for t in tareas %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4">
                                    <p class="font-medium">{{ t.titulo }}</p>
                                    {% if t.plagio_detectado %}<span class="text-xs text-red-500"><i
                                            class="fas fa-exclamation-triangle"></i> Plagio detectado</span>{% endif %}
                                </td>
                                <td class="px-6 py-4 text-sm">{{ t.materia }}</td>
                                <td class="px-6 py-4 text-sm">{{ t.fecha_vencimiento.strftime('%d/%m/%Y %H:%M') if
                                    t.fecha_vencimiento else 'N/A' }}</td>
                                <td class="px-6 py-4"><span
                                        class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs">{{
                                        t.entregas_calificadas }}/{{ t.entregas_totales }}</span></td>
                                <td class="px-6 py-4">
                                    <button onclick="verEntregas({{ t.id }})"
                                        class="text-brand-600 hover:underline text-sm mr-2"><i class="fas fa-eye"></i>
                                        Ver</button>
                                    <button onclick="detectarPlagio({{ t.id }})"
                                        class="text-purple-600 hover:underline text-sm mr-2" title="Detectar Plagio"><i
                                            class="fas fa-search"></i></button>
                                    <button onclick="eliminarTarea({{ t.id }})"
                                        class="text-red-500 hover:underline text-sm"><i
                                            class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="px-6 py-8 text-center text-gray-400">No hay tareas creadas</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- ESTUDIANTES -->
            <section id="section-estudiantes" class="content-section space-y-6">
                <h2 class="text-2xl font-bold">Mis Estudiantes</h2>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-4 border-b">
                        <input type="text" id="buscar-estudiante" placeholder="Buscar estudiante..."
                            class="w-full border rounded-lg px-4 py-2" onkeyup="filtrarEstudiantes()">
                    </div>
                    <div class="divide-y" id="lista-estudiantes">
                        {% for e in estudiantes %}
                        <div class="p-4 flex items-center justify-between hover:bg-gray-50 estudiante-item">
                            <div class="flex items-center space-x-3">
                                <div
                                    class="w-10 h-10 rounded-full bg-brand-100 flex items-center justify-center text-brand-600 font-bold">
                                    {{ e.nombre[0] }}</div>
                                <div>
                                    <p class="font-medium">{{ e.nombre }}</p>
                                    <p class="text-xs text-gray-500">{{ e.numero_control }}</p>
                                </div>
                            </div>
                            <button onclick="enviarMensajeA({{ e.id }}, '{{ e.nombre }}')"
                                class="text-brand-600 text-sm hover:underline"><i class="fas fa-envelope"></i>
                                Mensaje</button>
                        </div>
                        {% else %}
                        <div class="p-8 text-center text-gray-400">No hay estudiantes matriculados</div>
                        {% endfor %}
                    </div>
                </div>
            </section>

            <!-- ASISTENCIA QR -->
            <section id="section-asistencia" class="content-section space-y-6">
                <h2 class="text-2xl font-bold">Control de Asistencia con QR</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="font-bold mb-4">Generar C√≥digo QR</h3>
                        <select id="materia-qr" class="w-full border rounded-lg px-4 py-2 mb-4">
                            <option value="">Selecciona una materia</option>
                            {% for m in materias %}
                            <option value="{{ m.id }}">{{ m.nombre }}</option>
                            {% endfor %}
                        </select>
                        <button onclick="generarQR()"
                            class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700"><i
                                class="fas fa-qrcode mr-2"></i>Generar QR</button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6 flex flex-col items-center justify-center"
                        id="qr-display">
                        <i class="fas fa-qrcode text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">El c√≥digo QR aparecer√° aqu√≠</p>
                    </div>
                </div>
            </section>

            <!-- RECURSOS -->
            <section id="section-recursos" class="content-section space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Recursos Did√°cticos</h2>
                    <button onclick="openModalRecurso()" class="bg-purple-600 text-white px-4 py-2 rounded-lg"><i
                            class="fas fa-upload mr-2"></i>Subir Recurso</button>
                </div>
                <div id="recursos-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="col-span-full text-center py-8 text-gray-400">Cargando recursos...</div>
                </div>
            </section>

            <!-- MENSAJES -->
            <section id="section-mensajes" class="content-section space-y-6">
                <h2 class="text-2xl font-bold">Mensajes</h2>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="divide-y">
                        {% for m in mensajes %}
                        <div class="p-4 hover:bg-gray-50">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium">{{ m.remitente }}</p>
                                    <p class="text-sm text-gray-600">{{ m.asunto or 'Sin asunto' }}</p>
                                    <p class="text-xs text-gray-400 mt-1">{{ m.contenido[:100] }}...</p>
                                </div>
                                <span class="text-xs text-gray-400">{{ m.fecha_envio.strftime('%d/%m/%Y') if
                                    m.fecha_envio else '' }}</span>
                            </div>
                        </div>
                        {% else %}
                        <div class="p-8 text-center text-gray-400">No hay mensajes</div>
                        {% endfor %}
                    </div>
                </div>
            </section>

            <!-- REPORTES -->
            <section id="section-reportes" class="content-section space-y-6">
                <h2 class="text-2xl font-bold">Reportes y Estad√≠sticas</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="font-bold mb-4">Promedio General</h3>
                        <p id="stat-promedio" class="text-4xl font-bold text-brand-600">‚Äî</p>
                        <p class="text-sm text-gray-500 mt-2">Calculando...</p>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="font-bold mb-4">Tasa de Entrega</h3>
                        <p id="stat-entregas" class="text-4xl font-bold text-green-600">‚Äî</p>
                        <p class="text-sm text-gray-500 mt-2">Basado en entregas registradas</p>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="font-bold mb-4">Asistencia Promedio</h3>
                        <p id="stat-asistencia" class="text-4xl font-bold text-purple-600">‚Äî</p>
                        <p class="text-sm text-gray-500 mt-2">Calculando...</p>
                    </div>
                </div>
            </section>

            <!-- EVALUACIONES -->
            <section id="section-evaluaciones" class="content-section space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Evaluaciones y Ex√°menes</h2>
                    <button onclick="openModalEvaluacion()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg"><i
                            class="fas fa-plus mr-2"></i>Crear Evaluaci√≥n</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="evaluaciones-grid">
                    <div class="col-span-full text-center py-8 text-gray-400">Cargando evaluaciones...</div>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="font-bold mb-4">Generar Evaluaci√≥n con IA</h3>
                    <p class="text-sm text-gray-500 mb-4">Utiliza Gemini AI para generar preguntas autom√°ticamente
                        basadas en el tema que indiques.</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <select id="ai-materia-eval" class="border rounded-lg px-4 py-2">
                            {% for m in materias %}<option value="{{ m.id }}">{{ m.nombre }}</option>{% endfor %}
                        </select>
                        <input type="text" id="ai-tema-eval" placeholder="Tema (ej: Herencia en POO)"
                            class="border rounded-lg px-4 py-2">
                        <button onclick="generarEvaluacionAI()"
                            class="bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700"><i
                                class="fas fa-magic mr-2"></i>Generar con IA</button>
                    </div>
                </div>
            </section>

            <!-- COMUNICADOS -->
            <section id="section-comunicados" class="content-section space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Comunicados</h2>
                    <button onclick="openModalComunicado()" class="bg-orange-600 text-white px-4 py-2 rounded-lg"><i
                            class="fas fa-plus mr-2"></i>Nuevo Comunicado</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="divide-y" id="comunicados-list">
                        <div class="p-6 text-center text-gray-400">Cargando comunicados...</div>
                    </div>
                </div>
            </section>

            <!-- RETOS DE CODIGO -->
            <section id="section-retos" class="content-section space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Retos de C√≥digo (Gamificaci√≥n)</h2>
                    <button onclick="openModalReto()"
                        class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-4 py-2 rounded-lg shadow-lg hover:shadow-xl transition"><i
                            class="fas fa-gamepad mr-2"></i>Lanzar Nuevo Reto</button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-4">
                        <div id="retos-list" class="space-y-4">
                            <div class="bg-white rounded-xl shadow-sm p-8 text-center border-2 border-dashed border-gray-300">
                                <i class="fas fa-code text-4xl text-gray-300 mb-4"></i>
                                <p class="text-gray-500">Cargando retos...</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="font-bold mb-4">Ranking Global</h3>
                        <ul id="retos-ranking" class="space-y-4">
                            <li class="text-sm text-gray-400">Cargando ranking...</li>
                        </ul>
                    </div>
                </div>
            </section>
            <!-- DETALLE MATERIA (SPA) -->
            <section id="section-detalle-materia" class="content-section space-y-6 hidden">
                <div class="flex items-center space-x-4 mb-6">
                    <button onclick="closeMateriaDetails()" class="p-2 rounded-full hover:bg-gray-200 transition">
                        <i class="fas fa-arrow-left text-xl text-gray-600"></i>
                    </button>
                    <div>
                        <h2 class="text-2xl font-bold" id="materia-titulo">Cargando...</h2>
                        <p class="text-sm text-gray-500" id="materia-desc">...</p>
                    </div>
                </div>

                <!-- Tabs Materia -->
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button onclick="switchMateriaTab('m-tareas')"
                            class="materia-tab active border-brand-500 text-brand-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                            Tareas
                        </button>
                        <button onclick="switchMateriaTab('m-estudiantes')"
                            class="materia-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                            Estudiantes
                        </button>
                        <button onclick="switchMateriaTab('m-recursos')"
                            class="materia-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                            Recursos
                        </button>
                        <button onclick="switchMateriaTab('m-evaluaciones')"
                            class="materia-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                            Evaluaciones
                        </button>
                    </nav>
                </div>

                <!-- Contenido Tabs -->
                <div id="m-tareas" class="materia-tab-content active animate-enter space-y-6">
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-lg">Tareas Asignadas</h3>
                        <button onclick="openModalCrearTarea()"
                            class="bg-brand-600 text-white px-3 py-1 rounded text-sm hover:bg-brand-700">
                            <i class="fas fa-plus mr-1"></i> Nueva Tarea
                        </button>
                    </div>
                    <div id="m-tareas-list" class="bg-white rounded-xl shadow-sm overflow-hidden divide-y">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div id="m-estudiantes" class="materia-tab-content hidden animate-enter">
                    <div id="m-estudiantes-list" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div id="m-recursos" class="materia-tab-content hidden animate-enter space-y-6">
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-lg">Material Did√°ctico</h3>
                        <button onclick="openModalRecurso()"
                            class="bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700">
                            <i class="fas fa-upload mr-1"></i> Subir
                        </button>
                    </div>
                    <div id="m-recursos-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div id="m-evaluaciones" class="materia-tab-content hidden animate-enter space-y-6">
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-lg">Ex√°menes y Quizzes</h3>
                        <button onclick="openModalEvaluacion()"
                            class="bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700">
                            <i class="fas fa-plus mr-1"></i> Crear
                        </button>
                    </div>
                    <div id="m-evaluaciones-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Populated by JS -->
                    </div>
                </div>

            </section>
        </main>
        <!-- Bottom Navigation (Mobile) -->
        <nav class="fixed bottom-0 left-0 right-0 z-50 max-w-md mx-auto bg-white/95 dark:bg-background-dark/95 backdrop-blur-md border-t border-slate-200 dark:border-slate-800">
            <div class="flex h-16 items-center justify-between px-1">
                <button onclick="showSection('dashboard')" class="nav-btn flex flex-1 flex-col items-center justify-center gap-0.5 text-primary bg-primary/10 rounded-xl py-1 mx-0.5">
                    <span class="material-symbols-outlined text-[22px]">home</span>
                    <span class="text-[11px] font-semibold">Inicio</span>
                </button>
                <button onclick="showSection('materias')" class="nav-btn flex flex-1 flex-col items-center justify-center gap-0.5 text-slate-500 hover:text-primary hover:bg-primary/10 rounded-xl py-1 mx-0.5">
                    <span class="material-symbols-outlined text-[22px]">school</span>
                    <span class="text-[11px] font-semibold">Materias</span>
                </button>
                <button onclick="showSection('tareas')" class="nav-btn flex flex-1 flex-col items-center justify-center gap-0.5 text-slate-500 hover:text-primary hover:bg-primary/10 rounded-xl py-1 mx-0.5">
                    <span class="material-symbols-outlined text-[22px]">task</span>
                    <span class="text-[11px] font-semibold">Tareas</span>
                </button>
                <button onclick="showSection('mensajes')" class="nav-btn flex flex-1 flex-col items-center justify-center gap-0.5 text-slate-500 hover:text-primary hover:bg-primary/10 rounded-xl py-1 mx-0.5">
                    <span class="material-symbols-outlined text-[22px]">chat</span>
                    <span class="text-[11px] font-semibold">Mensajes</span>
                </button>
                <button onclick="openModalPerfil()" class="nav-btn flex flex-1 flex-col items-center justify-center gap-0.5 text-slate-500 hover:text-primary hover:bg-primary/10 rounded-xl py-1 mx-0.5">
                    <span class="material-symbols-outlined text-[22px]">person</span>
                    <span class="text-[11px] font-semibold">Perfil</span>
                </button>
            </div>
        </nav>
    </div>

</div>

    <!-- MODAL: Lanzar Reto -->
    <div id="modal-reto" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg animate-enter">
            <div
                class="p-6 border-b flex justify-between items-center bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-t-xl">
                <h3 class="text-xl font-bold"><i class="fas fa-code mr-2"></i>Lanzar Reto de C√≥digo</h3>
                <button onclick="closeModal('modal-reto')" class="text-white hover:text-gray-200"><i
                        class="fas fa-times"></i></button>
            </div>
            <form onsubmit="lanzarReto(event)" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">T√≠tulo del Reto</label>
                    <input type="text" id="reto-titulo" required class="w-full border rounded-lg px-4 py-2"
                        placeholder="Ej: Suma de Dos N√∫meros">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Materia</label>
                    <select id="reto-materia" required class="w-full border rounded-lg px-4 py-2">
                        {% for m in materias %}<option value="{{ m.id }}">{{ m.nombre }}</option>{% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Descripci√≥n</label>
                    <textarea id="reto-desc" rows="3" class="w-full border rounded-lg px-4 py-2"
                        placeholder="Explica el problema..."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Dificultad</label>
                        <select id="reto-dificultad" class="w-full border rounded-lg px-4 py-2">
                            <option value="facil">F√°cil</option>
                            <option value="medio" selected>Medio</option>
                            <option value="dificil">Dif√≠cil</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Recompensa (XP)</label>
                        <input type="number" id="reto-xp" value="100" class="w-full border rounded-lg px-4 py-2">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Casos de Prueba (JSON)</label>
                    <textarea id="reto-tests" rows="4"
                        class="w-full border rounded-lg px-4 py-2 font-mono text-sm bg-gray-50"
                        placeholder='[{"input": [2, 3], "output": 5}, {"input": [-1, 1], "output": 0}]'></textarea>
                    <p class="text-xs text-gray-500 mt-1">Define entradas y salidas esperadas en formato JSON.</p>
                </div>
                <button type="submit"
                    class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700 shadow-lg">üöÄ
                    ¬°Lanzar Reto!</button>
            </form>
        </div>
    </div>

    <!-- MODAL: Detalle de Estudiante -->
    <div id="modal-estudiante"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl animate-enter">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 rounded-full bg-brand-500 text-white flex items-center justify-center text-xl font-bold"
                        id="detalle-avatar">A</div>
                    <div>
                        <h3 class="text-xl font-bold" id="detalle-nombre">Nombre Estudiante</h3>
                        <p class="text-sm text-gray-500" id="detalle-matricula">Matr√≠cula</p>
                    </div>
                </div>
                <button onclick="closeModal('modal-estudiante')" class="text-gray-400 hover:text-gray-600"><i
                        class="fas fa-times"></i></button>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-blue-50 p-4 rounded-xl">
                    <p class="text-sm text-blue-700 font-bold uppercase mb-2">Desempe√±o Acad√©mico</p>
                    <div class="flex justify-between items-end">
                        <div>
                            <span class="text-3xl font-bold text-blue-900">8.7</span>
                            <span class="text-sm text-blue-600">Promedio</span>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-medium">95% Asistencia</p>
                            <p class="text-sm font-medium">12 Tareas completadas</p>
                        </div>
                    </div>
                    <div class="mt-3 w-full bg-blue-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full" style="width: 87%"></div>
                    </div>
                </div>
                <div class="bg-purple-50 p-4 rounded-xl">
                    <p class="text-sm text-purple-700 font-bold uppercase mb-2">Gamificaci√≥n</p>
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-2xl font-bold text-purple-900">Nvl. 5</span>
                            <p class="text-xs text-purple-600">Mago del C√≥digo</p>
                        </div>
                        <div class="text-right">
                            <span class="block font-bold text-yellow-600"><i class="fas fa-coins"></i> 1,250</span>
                            <span class="block text-xs text-gray-500">EduCoins</span>
                        </div>
                    </div>
                </div>
                <div class="col-span-full">
                    <h4 class="font-bold mb-3">Acciones R√°pidas</h4>
                    <div class="flex space-x-3">
                        <button
                            onclick="enviarMensajeA(currentEstudianteId, document.getElementById('detalle-nombre').textContent)"
                            class="flex-1 border border-gray-300 py-2 rounded-lg hover:bg-gray-50"><i
                                class="fas fa-comment-alt mr-2 text-blue-500"></i>Enviar Mensaje</button>
                        <button
                            onclick="abrirReporteConducta(currentEstudianteId, document.getElementById('detalle-nombre').textContent)"
                            class="flex-1 border border-gray-300 py-2 rounded-lg hover:bg-gray-50"><i
                                class="fas fa-file-alt mr-2 text-red-500"></i>Reporte Conducta</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="modal-tarea" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg animate-enter">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Nueva Tarea</h3>
                <button onclick="closeModal('modal-tarea')" class="text-gray-400 hover:text-gray-600"><i
                        class="fas fa-times"></i></button>
            </div>
            <form id="form-tarea" onsubmit="crearTarea(event)" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">T√≠tulo</label>
                    <input type="text" id="tarea-titulo" required class="w-full border rounded-lg px-4 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Descripci√≥n</label>
                    <textarea id="tarea-desc" rows="3" class="w-full border rounded-lg px-4 py-2"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Materia</label>
                        <select id="tarea-materia" required class="w-full border rounded-lg px-4 py-2">
                            {% for m in materias %}<option value="{{ m.id }}">{{ m.nombre }}</option>{% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Valor (%)</label>
                        <input type="number" id="tarea-valor" value="10" min="1" max="100"
                            class="w-full border rounded-lg px-4 py-2">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Fecha de Vencimiento</label>
                    <input type="datetime-local" id="tarea-fecha" required class="w-full border rounded-lg px-4 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Archivo Adjunto (Opcional)</label>
                    <input type="file" id="tarea-archivo" class="w-full border rounded-lg px-4 py-2 bg-gray-50 text-sm">
                    <p class="text-xs text-gray-400 mt-1">Gu√≠as, ejercicios o material de apoyo.</p>
                </div>
                <button type="submit"
                    class="w-full bg-brand-600 text-white py-3 rounded-lg font-bold hover:bg-brand-700">Crear
                    Tarea</button>
            </form>
        </div>
    </div>

    <!-- MODAL: Subir Recurso -->
    <div id="modal-recurso"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg animate-enter">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Subir Recurso</h3>
                <button onclick="closeModal('modal-recurso')" class="text-gray-400 hover:text-gray-600"><i
                        class="fas fa-times"></i></button>
            </div>
            <form id="form-recurso" onsubmit="subirRecurso(event)" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">T√≠tulo</label>
                    <input type="text" id="recurso-titulo" required class="w-full border rounded-lg px-4 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Descripci√≥n</label>
                    <textarea id="recurso-desc" rows="2" class="w-full border rounded-lg px-4 py-2"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Materia</label>
                    <select id="recurso-materia" required class="w-full border rounded-lg px-4 py-2">
                        {% for m in materias %}<option value="{{ m.id }}">{{ m.nombre }}</option>{% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Archivos</label>
                    <input type="file" id="recurso-files" multiple class="w-full border rounded-lg px-4 py-2">
                </div>
                <button type="submit"
                    class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700">Subir
                    Recurso</button>
            </form>
        </div>
    </div>
        <!-- CALENDARIO CONTENT -->
        <div id="section-calendario" class="content-section hidden h-full flex flex-col">
            <div class="bg-white rounded-xl shadow-sm p-6 h-full flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold flex items-center"><i
                            class="fas fa-calendar-alt text-brand-600 mr-2"></i> <span id="calendar-title">Calendario</span></h3>
                    <div class="flex space-x-2">
                        <button onclick="changeCalendarMonth(-1)" class="p-2 hover:bg-gray-100 rounded-lg"><i class="fas fa-chevron-left"></i></button>
                        <button onclick="changeCalendarMonth(1)" class="p-2 hover:bg-gray-100 rounded-lg"><i class="fas fa-chevron-right"></i></button>
                        <button onclick="goToToday()" class="bg-brand-600 text-white px-3 py-1 rounded-lg text-sm">Hoy</button>
                    </div>
                </div>

                <div class="grid grid-cols-7 gap-1 text-center font-bold text-gray-500 text-sm mb-2 border-b pb-2">
                    <div>Dom</div>
                    <div>Lun</div>
                    <div>Mar</div>
                    <div>Mi√©</div>
                    <div>Jue</div>
                    <div>Vie</div>
                    <div>S√°b</div>
                </div>

                <div class="grid grid-cols-7 gap-1 flex-1 text-sm bg-gray-200 p-1 rounded-lg overflow-y-auto"
                    id="calendar-grid">
                    <div class="col-span-full text-center text-gray-400 py-8">Cargando calendario...</div>
                </div>
            </div>

            <!-- CHAT IA CONTENT -->
            <div id="section-chatia" class="content-section hidden h-full flex flex-col">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                    <div class="lg:col-span-2 bg-white rounded-xl shadow-sm flex flex-col overflow-hidden">
                        <div class="p-4 border-b bg-gradient-to-r from-purple-600 to-indigo-600 text-white">
                            <h3 class="font-bold flex items-center"><i class="fas fa-robot mr-2"></i> Asistente IA
                                Docente</h3>
                            <p class="text-xs opacity-80">Powered by Gemini AI</p>
                        </div>
                        <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4 bg-gray-50">
                            <div class="flex items-start space-x-3">
                                <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center"><i
                                        class="fas fa-robot text-purple-600"></i></div>
                                <div class="bg-white p-3 rounded-lg shadow-sm max-w-[80%]">
                                    <p class="text-sm">¬°Hola! Soy tu asistente IA. Puedo ayudarte con:</p>
                                    <ul class="text-sm mt-2 space-y-1 text-gray-600">
                                        <li>‚Ä¢ Generar contenido para clases</li>
                                        <li>‚Ä¢ Crear r√∫bricas de evaluaci√≥n</li>
                                        <li>‚Ä¢ Sugerir actividades did√°cticas</li>
                                        <li>‚Ä¢ Resolver dudas pedag√≥gicas</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 border-t bg-white">
                            <form onsubmit="enviarChatIA(event)" class="flex space-x-2">
                                <input type="text" id="chat-input" placeholder="Escribe tu pregunta..."
                                    class="flex-1 border rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                <button type="submit"
                                    class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 font-bold"><i
                                        class="fas fa-paper-plane"></i></button>
                            </form>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-white rounded-xl shadow-sm p-4">
                            <h4 class="font-bold mb-3">Sugerencias R√°pidas</h4>
                            <div class="space-y-2">
                                <button onclick="sugerenciaChat('Crea una r√∫brica para evaluar proyectos')"
                                    class="w-full text-left p-2 bg-gray-50 rounded-lg hover:bg-purple-50 text-sm">üìã
                                    Crear r√∫brica de proyecto</button>
                                <button onclick="sugerenciaChat('Dame 5 actividades para ense√±ar algoritmos')"
                                    class="w-full text-left p-2 bg-gray-50 rounded-lg hover:bg-purple-50 text-sm">üí°
                                    Ideas para actividades</button>
                                <button onclick="sugerenciaChat('Genera un plan de clase sobre bases de datos')"
                                    class="w-full text-left p-2 bg-gray-50 rounded-lg hover:bg-purple-50 text-sm">üìÖ
                                    Plan de clase</button>
                                <button onclick="sugerenciaChat('C√≥mo motivar estudiantes desmotivados')"
                                    class="w-full text-left p-2 bg-gray-50 rounded-lg hover:bg-purple-50 text-sm">üéØ
                                    Consejos pedag√≥gicos</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GENERADOR QUIZ CONTENT -->
            <div id="section-quizgen" class="content-section hidden h-full flex flex-col">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-xl font-bold flex items-center"><i
                                    class="fas fa-magic text-indigo-600 mr-2"></i> Generador de Quiz con IA</h3>
                            <p class="text-gray-500 text-sm">Sube un PDF y genera preguntas autom√°ticamente</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="border-2 border-dashed border-indigo-300 rounded-xl p-8 text-center bg-indigo-50/50 hover:bg-indigo-100/50 transition cursor-pointer"
                            onclick="document.getElementById('quiz-pdf').click()">
                            <input type="file" id="quiz-pdf" accept=".pdf" class="hidden" onchange="previewPDF(this)">
                            <i class="fas fa-file-pdf text-6xl text-indigo-400 mb-4"></i>
                            <p class="font-bold text-indigo-700">Arrastra tu PDF aqu√≠</p>
                            <p class="text-sm text-indigo-500">o haz clic para seleccionar</p>
                            <p id="pdf-name" class="mt-3 text-sm font-medium text-gray-600 hidden"></p>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Materia</label>
                                <select id="quiz-materia" class="w-full border rounded-lg px-4 py-2">
                                    {% for m in materias %}<option value="{{ m.id }}">{{ m.nombre }}</option>{% endfor
                                    %}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Cantidad de preguntas</label>
                                <input type="number" id="quiz-cantidad" value="10" min="5" max="50"
                                    class="w-full border rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Tipos de pregunta</label>
                                <div class="flex flex-wrap gap-2">
                                    <label class="flex items-center bg-gray-100 px-3 py-1 rounded-full text-sm"><input
                                            type="checkbox" checked class="mr-2"> Opci√≥n m√∫ltiple</label>
                                    <label class="flex items-center bg-gray-100 px-3 py-1 rounded-full text-sm"><input
                                            type="checkbox" checked class="mr-2"> Verdadero/Falso</label>
                                    <label class="flex items-center bg-gray-100 px-3 py-1 rounded-full text-sm"><input
                                            type="checkbox" class="mr-2"> Abiertas</label>
                                </div>
                            </div>
                            <button onclick="generarQuizPDF()"
                                class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition transform hover:-translate-y-1 shadow-lg">
                                <i class="fas fa-magic mr-2"></i> Generar Quiz con IA
                            </button>
                        </div>
                    </div>
                    <div id="quiz-result" class="mt-6 hidden">
                        <h4 class="font-bold mb-3">Preguntas Generadas</h4>
                        <div id="quiz-questions" class="space-y-3 max-h-96 overflow-y-auto"></div>
                    </div>
                </div>
            </div>

            <!-- TUTORIAS CONTENT -->
            <div id="section-tutorias" class="content-section hidden h-full flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-2xl font-bold">Gesti√≥n de Tutor√≠as</h3>
                        <p class="text-gray-600">Agenda y administra sesiones con estudiantes</p>
                    </div>
                    <button onclick="openModalTutoria()"
                        class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 shadow-lg">
                        <i class="fas fa-plus mr-2"></i> Nueva Tutor√≠a
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-4">
                        <div class="bg-white rounded-xl shadow-sm p-4">
                            <h4 class="font-bold mb-3">Pr√≥ximas Tutor√≠as</h4>
                            <div id="tutorias-list" class="space-y-3">
                                <div class="text-center text-gray-400 py-6">Cargando tutor√≠as...</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <h4 class="font-bold mb-3">Estad√≠sticas</h4>
                        <div class="space-y-4">
                            <div class="text-center p-4 bg-green-50 rounded-lg">
                                <p id="tutorias-total" class="text-3xl font-bold text-green-600">‚Äî</p>
                                <p class="text-sm text-gray-600">Tutor√≠as programadas</p>
                            </div>
                            <div class="text-center p-4 bg-blue-50 rounded-lg">
                                <p id="tutorias-completadas" class="text-3xl font-bold text-blue-600">‚Äî</p>
                                <p class="text-sm text-gray-600">Tutor√≠as completadas</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MI HORARIO CONTENT -->
            <div id="section-horario" class="content-section hidden h-full flex flex-col">
                <div class="bg-white rounded-xl shadow-sm p-6 h-full">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold"><i class="fas fa-clock text-blue-600 mr-2"></i> Mi Horario Semanal
                        </h3>
                        <button onclick="cargarMiHorario()"
                            class="bg-blue-100 text-blue-600 px-3 py-1 rounded-lg text-sm hover:bg-blue-200"><i
                                class="fas fa-sync mr-1"></i> Actualizar</button>
                    </div>
                    <div id="horario-container" class="space-y-3">
                        <div class="text-center text-gray-400 py-6">Cargando horario...</div>
                    </div>
                </div>
            </div>
            </main>
        </div>

        <!-- MODAL: Ver Entregas -->
        <div id="modal-entregas"
            class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
            <div
                class="bg-white rounded-xl shadow-2xl w-full max-w-4xl animate-enter max-h-[90vh] overflow-hidden flex flex-col">
                <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                    <div>
                        <h3 class="text-xl font-bold" id="entregas-titulo">Entregas de Tarea</h3>
                        <p class="text-sm text-gray-500" id="entregas-subtitulo">Ver y calificar entregas</p>
                    </div>
                    <button onclick="closeModal('modal-entregas')" class="text-gray-400 hover:text-gray-600"><i
                            class="fas fa-times text-xl"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-6" id="entregas-content">
                    <div class="text-center py-10 text-gray-400">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-brand-500 mx-auto mb-4"></div>
                        Cargando entregas...
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: Calificar Entrega -->
        <div id="modal-calificar"
            class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md animate-enter">
                <div class="p-6 border-b">
                    <h3 class="text-xl font-bold">Calificar Entrega</h3>
                    <p class="text-sm text-gray-500" id="calificar-estudiante">Estudiante</p>
                </div>
                <form onsubmit="submitCalificacion(event)" class="p-6 space-y-4">
                    <input type="hidden" id="calificar-entrega-id">
                    <div>
                        <label class="block text-sm font-medium mb-2">Calificaci√≥n (0-100)</label>
                        <input type="number" id="calificar-nota" min="0" max="100" required
                            class="w-full border rounded-lg px-4 py-3 text-2xl font-bold text-center">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Comentarios</label>
                        <textarea id="calificar-comentarios" rows="3" class="w-full border rounded-lg px-4 py-2"
                            placeholder="Comentarios para el estudiante..."></textarea>
                    </div>
                    <div class="flex space-x-3">
                        <button type="button" onclick="closeModal('modal-calificar')"
                            class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-200">Cancelar</button>
                        <button type="submit"
                            class="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700">Guardar
                            Calificaci√≥n</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MODAL: Mi Perfil -->
        <div id="modal-perfil"
            class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md animate-enter">
                <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                    <h3 class="text-xl font-bold">Mi Perfil Docente</h3>
                    <button onclick="closeModal('modal-perfil')" class="text-gray-400 hover:text-gray-600"><i
                            class="fas fa-times"></i></button>
                </div>
                <div class="p-6">
                    <div class="flex flex-col items-center mb-6">
                        <div
                            id="docente-avatar"
                            class="w-24 h-24 rounded-full bg-brand-500 flex items-center justify-center text-white text-4xl font-bold mb-3 border-4 border-white shadow-lg bg-cover bg-center"
                            style="background-image: url('{{ foto_perfil|default('') }}');">
                            {{ nombre_docente[0] if nombre_docente else 'D' }}
                        </div>
                        <h2 class="text-xl font-bold">{{ nombre_docente }}</h2>
                        <p class="text-gray-500">{{ email_docente }}</p>
                        <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold mt-2">Profesor
                            Verificado</span>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-2">Foto de perfil</label>
                        <div class="flex items-center gap-3">
                            <input id="docente-photo-input" type="file" accept="image/*" class="flex-1 text-sm">
                            <button type="button" onclick="uploadDocentePhoto()"
                                class="bg-brand-600 text-white px-3 py-2 rounded-lg font-bold hover:bg-brand-700">Subir</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Formatos permitidos: jpg, png, jpeg, gif, webp.</p>
                    </div>
                    <form class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Nombre Completo</label>
                            <input type="text" value="{{ nombre_docente }}"
                                class="w-full border rounded-lg px-3 py-2 bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Especialidad</label>
                            <input type="text" value="Ciencias Computacionales"
                                class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div class="pt-2">
                            <button type="button"
                                class="w-full bg-brand-600 text-white py-2 rounded-lg font-bold hover:bg-brand-700">Guardar
                                Cambios</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- MODAL: Crear Evaluaci√≥n -->
        <div id="modal-evaluacion"
            class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl animate-enter max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 class="text-xl font-bold">Crear Evaluaci√≥n</h3>
                    <button onclick="closeModal('modal-evaluacion')" class="text-gray-400 hover:text-gray-600"><i
                            class="fas fa-times"></i></button>
                </div>
                <form onsubmit="crearEvaluacion(event)" class="p-6 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">T√≠tulo</label>
                            <input type="text" id="eval-titulo" required class="w-full border rounded-lg px-4 py-2"
                                placeholder="Ej: Examen Parcial 1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Materia</label>
                            <select id="eval-materia" required class="w-full border rounded-lg px-4 py-2">
                                {% for m in materias %}<option value="{{ m.id }}">{{ m.nombre }}</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Descripci√≥n</label>
                        <textarea id="eval-descripcion" rows="2" class="w-full border rounded-lg px-4 py-2"
                            placeholder="Instrucciones para los estudiantes..."></textarea>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Duraci√≥n (min)</label>
                            <input type="number" id="eval-duracion" value="60" min="5"
                                class="w-full border rounded-lg px-4 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Fecha L√≠mite</label>
                            <input type="datetime-local" id="eval-fecha" class="w-full border rounded-lg px-4 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Intentos</label>
                            <input type="number" id="eval-intentos" value="1" min="1" max="5"
                                class="w-full border rounded-lg px-4 py-2">
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-bold mb-3">Preguntas</h4>
                        <div id="preguntas-container" class="space-y-3">
                            <div class="bg-white p-4 rounded-lg border pregunta-item">
                                <div class="flex items-start space-x-3">
                                    <span
                                        class="bg-indigo-100 text-indigo-700 w-8 h-8 rounded-full flex items-center justify-center font-bold">1</span>
                                    <div class="flex-1">
                                        <input type="text" placeholder="Escribe la pregunta..."
                                            class="w-full border-b border-gray-200 pb-2 focus:border-indigo-500 focus:outline-none">
                                        <div class="mt-2 space-y-1">
                                            <input type="text" placeholder="Opci√≥n A"
                                                class="w-full text-sm border rounded px-2 py-1">
                                            <input type="text" placeholder="Opci√≥n B"
                                                class="w-full text-sm border rounded px-2 py-1">
                                            <input type="text" placeholder="Opci√≥n C"
                                                class="w-full text-sm border rounded px-2 py-1">
                                            <input type="text" placeholder="Opci√≥n D (correcta)"
                                                class="w-full text-sm border rounded px-2 py-1 border-green-300 bg-green-50">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" onclick="agregarPregunta()"
                            class="mt-3 text-indigo-600 text-sm font-medium hover:underline"><i
                                class="fas fa-plus mr-1"></i> Agregar Pregunta</button>
                    </div>
                    <button type="submit"
                        class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700">Crear
                        Evaluaci√≥n</button>
                </form>
            </div>
        </div>

        <!-- MODAL: Crear Comunicado -->
        <div id="modal-comunicado"
            class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg animate-enter">
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 class="text-xl font-bold">Nuevo Comunicado</h3>
                    <button onclick="closeModal('modal-comunicado')" class="text-gray-400 hover:text-gray-600"><i
                            class="fas fa-times"></i></button>
                </div>
                <form onsubmit="crearComunicado(event)" class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">T√≠tulo</label>
                        <input type="text" id="comunicado-titulo" required class="w-full border rounded-lg px-4 py-2"
                            placeholder="T√≠tulo del comunicado">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Tipo</label>
                        <select id="comunicado-tipo" class="w-full border rounded-lg px-4 py-2">
                            <option value="general">General</option>
                            <option value="urgente">Urgente</option>
                            <option value="informativo">Informativo</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Contenido</label>
                        <textarea id="comunicado-contenido" rows="4" required class="w-full border rounded-lg px-4 py-2"
                            placeholder="Escribe tu mensaje..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Adjunto (opcional)</label>
                        <input type="file" id="comunicado-adjunto" class="w-full border rounded-lg px-4 py-2">
                    </div>
                    <button type="submit"
                        class="w-full bg-orange-600 text-white py-3 rounded-lg font-bold hover:bg-orange-700">Publicar
                        Comunicado</button>
                </form>
            </div>
        </div>

        <!-- MODAL: Crear/Editar Materia -->
        <div id="modal-materia"
            class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg animate-enter">
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 id="materia-modal-title" class="text-xl font-bold">Nueva Materia</h3>
                    <button onclick="closeModal('modal-materia')" class="text-gray-400 hover:text-gray-600"><i
                            class="fas fa-times"></i></button>
                </div>
                <form onsubmit="guardarMateria(event)" class="p-6 space-y-4">
                    <input type="hidden" id="materia-id">
                    <input type="hidden" id="materia-mode" value="crear">
                    <div>
                        <label class="block text-sm font-medium mb-1">Nombre</label>
                        <input type="text" id="materia-nombre" required class="w-full border rounded-lg px-4 py-2"
                            placeholder="Nombre de la materia">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Descripci√≥n</label>
                        <textarea id="materia-descripcion" rows="3" class="w-full border rounded-lg px-4 py-2"
                            placeholder="Descripci√≥n breve"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Semestre</label>
                        <input type="text" id="materia-semestre" required class="w-full border rounded-lg px-4 py-2"
                            placeholder="Ej: 2025-1">
                    </div>
                    <button type="submit"
                        class="w-full bg-brand-600 text-white py-3 rounded-lg font-bold hover:bg-brand-700">Guardar</button>
                </form>
            </div>
        </div>

        <!-- MODAL: Enviar Mensaje -->
        <div id="modal-mensaje"
            class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg animate-enter">
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 class="text-xl font-bold">Enviar Mensaje</h3>
                    <button onclick="closeModal('modal-mensaje')" class="text-gray-400 hover:text-gray-600"><i
                            class="fas fa-times"></i></button>
                </div>
                <form onsubmit="enviarMensaje(event)" class="p-6 space-y-4">
                    <input type="hidden" id="mensaje-destinatario-id">
                    <div>
                        <label class="block text-sm font-medium mb-1">Para</label>
                        <input type="text" id="mensaje-destinatario-nombre" readonly
                            class="w-full border rounded-lg px-4 py-2 bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Asunto</label>
                        <input type="text" id="mensaje-asunto" required class="w-full border rounded-lg px-4 py-2"
                            placeholder="Asunto del mensaje">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Mensaje</label>
                        <textarea id="mensaje-contenido" rows="4" required class="w-full border rounded-lg px-4 py-2"
                            placeholder="Escribe tu mensaje..."></textarea>
                    </div>
                    <button type="submit"
                        class="w-full bg-brand-600 text-white py-3 rounded-lg font-bold hover:bg-brand-700">Enviar
                        Mensaje</button>
                </form>
            </div>
        </div>

        <script>
            // Navigation
            function showSection(section) {
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

                const sectionEl = document.getElementById('section-' + section);
                if (sectionEl) sectionEl.classList.add('active');

                // Highlight nav item if clicked
                if (typeof event !== 'undefined' && event && event.target) {
                    const navItem = event.target.closest('.nav-item');
                    if (navItem) navItem.classList.add('active');
                }

                const titles = {
                    dashboard: 'Panel Docente',
                    materias: 'Mis Materias',
                    tareas: 'Gesti√≥n de Tareas',
                    estudiantes: 'Mis Estudiantes',
                    asistencia: 'Asistencia QR',
                    recursos: 'Recursos',
                    mensajes: 'Mensajes',
                    reportes: 'Reportes',
                    evaluaciones: 'Evaluaciones',
                    comunicados: 'Comunicados',
                    retos: 'Retos de C√≥digo',
                    calendario: 'Calendario Acad√©mico',
                    chatia: 'Asistente IA',
                    quizgen: 'Generador de Quiz',
                    tutorias: 'Gesti√≥n de Tutor√≠as',
                    horario: 'Mi Horario Semanal'
                };
                document.getElementById('page-title').textContent = titles[section] || 'Panel Docente';

                if (section === 'calendario') initCalendar();
            }

            // Modal openers
            function openModalCrearTarea() { document.getElementById('modal-tarea').classList.remove('hidden'); }
            function openModalRecurso() { document.getElementById('modal-recurso').classList.remove('hidden'); }
            function openModalEvaluacion() { document.getElementById('modal-evaluacion').classList.remove('hidden'); }
            function openModalComunicado() { document.getElementById('modal-comunicado').classList.remove('hidden'); }
            function openModalReto() { document.getElementById('modal-reto').classList.remove('hidden'); }
            function openModalPerfil() { document.getElementById('modal-perfil').classList.remove('hidden'); }
            function openModalQR() { showSection('asistencia'); }

            function openMateriaModal(mode = 'crear') {
                document.getElementById('materia-mode').value = mode;
                document.getElementById('materia-modal-title').textContent = mode === 'editar' ? 'Editar Materia' : 'Nueva Materia';
                if (mode === 'crear') {
                    document.getElementById('materia-id').value = '';
                    document.getElementById('materia-nombre').value = '';
                    document.getElementById('materia-descripcion').value = '';
                    document.getElementById('materia-semestre').value = '';
                }
                document.getElementById('modal-materia').classList.remove('hidden');
            }

            function openMateriaFromCard(evt, btn) {
                evt.stopPropagation();
                const card = btn.closest('.materia-card');
                if (!card) return;
                document.getElementById('materia-id').value = card.dataset.id;
                document.getElementById('materia-nombre').value = card.dataset.nombre || '';
                document.getElementById('materia-descripcion').value = card.dataset.descripcion || '';
                document.getElementById('materia-semestre').value = card.dataset.semestre || '';
                openMateriaModal('editar');
            }

            function desactivarMateriaFromCard(evt, btn) {
                evt.stopPropagation();
                const card = btn.closest('.materia-card');
                if (!card) return;
                const materiaId = card.dataset.id;
                Swal.fire({
                    title: '¬øDesactivar materia?',
                    text: 'La materia dejar√° de estar activa.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#ef4444',
                    cancelButtonText: 'Cancelar',
                    confirmButtonText: 'S√≠, desactivar'
                }).then(async result => {
                    if (!result.isConfirmed) return;
                    try {
                        const res = await fetch(`/api/docente/materias/${materiaId}`, { method: 'DELETE' });
                        const json = await res.json();
                        if (json.success) {
                            Swal.fire('Hecho', 'Materia desactivada', 'success').then(() => location.reload());
                        } else {
                            Swal.fire('Error', json.error || 'No se pudo desactivar', 'error');
                        }
                    } catch (e) {
                        Swal.fire('Error', 'Error de conexi√≥n', 'error');
                    }
                });
            }

            async function guardarMateria(e) {
                e.preventDefault();
                const mode = document.getElementById('materia-mode').value;
                const materiaId = document.getElementById('materia-id').value;
                const payload = {
                    nombre: document.getElementById('materia-nombre').value,
                    descripcion: document.getElementById('materia-descripcion').value,
                    semestre: document.getElementById('materia-semestre').value
                };
                try {
                    const url = mode === 'editar' ? `/api/docente/materias/${materiaId}` : '/api/docente/materias';
                    const method = mode === 'editar' ? 'PUT' : 'POST';
                    const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const json = await res.json();
                    if (json.success) {
                        Swal.fire('√âxito', 'Materia guardada', 'success').then(() => location.reload());
                    } else {
                        Swal.fire('Error', json.error || 'No se pudo guardar', 'error');
                    }
                } catch (e) {
                    Swal.fire('Error', 'Error de conexi√≥n', 'error');
                }
            }

            async function uploadDocentePhoto() {
                const input = document.getElementById('docente-photo-input');
                if (!input || !input.files || !input.files[0]) {
                    Swal.fire('Info', 'Selecciona una imagen.', 'info');
                    return;
                }

                const formData = new FormData();
                formData.append('photo', input.files[0]);

                try {
                    const res = await fetch('/api/profile/upload-photo', { method: 'POST', body: formData });
                    const data = await res.json();
                    if (res.ok && (data.success || data.foto_perfil)) {
                        const avatar = document.getElementById('docente-avatar');
                        const miniAvatar = document.getElementById('docente-avatar-mini');
                        if (avatar) {
                            avatar.style.backgroundImage = `url('${data.foto_perfil}')`;
                            avatar.textContent = '';
                        }
                        if (miniAvatar) {
                            miniAvatar.style.backgroundImage = `url('${data.foto_perfil}')`;
                            miniAvatar.textContent = '';
                        }
                        Swal.fire('¬°Listo!', 'Foto de perfil actualizada.', 'success');
                    } else {
                        throw new Error(data.error || 'Error al subir foto');
                    }
                } catch (e) {
                    console.error(e);
                    Swal.fire('Error', 'No se pudo subir la foto.', 'error');
                }
            }

            function lanzarAulaVirtual() {
                Swal.fire({
                    title: 'Entrando al Aula Virtual',
                    text: 'Ser√°s redirigido a una sala de videollamada segura.',
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'Entrar ahora',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Generar sala √∫nica basada en ID docente o random para demo
                        const room = 'Aula-Docente-' + Math.floor(Math.random() * 100000);
                        const url = 'https://meet.jit.si/' + room;
                        window.open(url, '_blank');
                    }
                });
            }

            let calendarDate = new Date();
            let calendarEvents = [];

            async function initCalendar() {
                await loadCalendarEvents();
                renderCalendar();
            }

            async function loadCalendarEvents() {
                try {
                    const res = await fetch('/api/eventos-personales');
                    const data = await res.json();
                    calendarEvents = Array.isArray(data) ? data : [];
                } catch (err) {
                    calendarEvents = [];
                }
            }

            function changeCalendarMonth(delta) {
                calendarDate.setMonth(calendarDate.getMonth() + delta);
                renderCalendar();
            }

            function goToToday() {
                calendarDate = new Date();
                renderCalendar();
            }

            function renderCalendar() {
                const grid = document.getElementById('calendar-grid');
                const title = document.getElementById('calendar-title');
                if (!grid) return;

                const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const year = calendarDate.getFullYear();
                const month = calendarDate.getMonth();
                if (title) title.textContent = `${monthNames[month]} ${year}`;

                const firstDay = new Date(year, month, 1);
                const startDay = firstDay.getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                const today = new Date();
                const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

                let html = '';
                for (let i = 0; i < startDay; i++) {
                    html += '<div class="bg-gray-100 p-2 h-24 rounded text-gray-400"></div>';
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayEvents = calendarEvents.filter(e => {
                        if (!e.fecha) return false;
                        const d = new Date(e.fecha);
                        return d.getFullYear() === year && d.getMonth() === month && d.getDate() === day;
                    });

                    const isToday = isCurrentMonth && today.getDate() === day;
                    const eventsHtml = dayEvents.slice(0, 2).map(ev => {
                        const color = ev.color || '#3b82f6';
                        return `<div class="mt-1 text-[11px] px-1 rounded truncate font-medium" style="background-color:${color}22;color:${color};">${ev.titulo}</div>`;
                    }).join('');

                    html += `
                    <div class="bg-white p-2 h-24 rounded border ${isToday ? 'border-brand-500' : 'border-transparent'} hover:border-brand-300 hover:shadow-md transition cursor-pointer relative">
                        <span class="font-bold text-gray-700 block mb-1">${day}</span>
                        ${eventsHtml}
                    </div>`;
                }

                grid.innerHTML = html || '<div class="col-span-full text-center text-gray-400 py-8">Sin eventos</div>';
            }

            let currentEstudianteId = null;

            function verDetalleEstudiante(id, nombre, matricula) {
                currentEstudianteId = id; // Guardar ID para acciones r√°pidas
                document.getElementById('modal-estudiante').classList.remove('hidden');
                document.getElementById('detalle-nombre').textContent = nombre;
                document.getElementById('detalle-matricula').textContent = matricula || 'Sin matr√≠cula';
                document.getElementById('detalle-avatar').textContent = nombre.charAt(0).toUpperCase();
                // Aqu√≠ se podr√≠a hacer fetch a /api/estudiante-detalle/${id} si existiera
            }

            function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

            // Crear Tarea
            async function crearTarea(e) {
                e.preventDefault();
                const fecha = document.getElementById('tarea-fecha').value.replace('T', ' ') + ':00';

                const formData = new FormData();
                formData.append('titulo', document.getElementById('tarea-titulo').value);
                formData.append('descripcion', document.getElementById('tarea-desc').value);
                formData.append('materia_id', document.getElementById('tarea-materia').value);
                formData.append('fecha_vencimiento', fecha);
                formData.append('valor_porcentaje', document.getElementById('tarea-valor').value);

                // Adjunto
                const fileInput = document.getElementById('tarea-archivo');
                if (fileInput.files.length > 0) {
                    Array.from(fileInput.files).forEach(file => formData.append('files', file));
                }

                try {
                    const res = await fetch('/api/crear-tarea', {
                        method: 'POST',
                        body: formData
                    });

                    const json = await res.json();

                    if (json.success || json.message || !json.error) {
                        Swal.fire('√âxito', 'Tarea creada correctamente', 'success');
                        closeModal('modal-tarea');

                        // SPA Logic: Refresh current subject if it matches
                        const selectedMateria = document.getElementById('tarea-materia').value;
                        if (currentMateriaId && currentMateriaId == selectedMateria) {
                            loadSubjectDetails(currentMateriaId);
                        } else {
                            // If not in SPA matching this subject, maybe reload or do nothing
                            if (!currentMateriaId) location.reload(); // Fallback for Dashboard view
                        }
                    } else {
                        Swal.fire('Error', json.error || 'Error al crear tarea', 'error');
                    }
                } catch (err) {
                    console.error(err);
                    Swal.fire('Error', 'Error de conexi√≥n', 'error');
                }
            }

            // ... (Lanzar Reto skipped, unchanged)

            // Lanzar Reto
            async function lanzarReto(e) {
                e.preventDefault();
                const testsStr = document.getElementById('reto-tests').value;
                let tests = [];
                try {
                    tests = JSON.parse(testsStr || '[]');
                } catch (err) {
                    Swal.fire('Error JSON', 'El formato de los tests no es v√°lido', 'error');
                    return;
                }

                const data = {
                    titulo: document.getElementById('reto-titulo').value,
                    materia_id: document.getElementById('reto-materia').value,
                    descripcion: document.getElementById('reto-desc').value,
                    dificultad: document.getElementById('reto-dificultad').value,
                    recompensa_xp: document.getElementById('reto-xp').value,
                    tests: tests
                };

                Swal.fire({ title: 'Lanzando Reto...', html: 'Notificando a los estudiantes', didOpen: () => Swal.showLoading() });

                try {
                    const res = await fetch('/api/lanzar_reto', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const json = await res.json();
                    if (json.success) {
                        Swal.fire('¬°Reto Lanzado!', 'El reto ha sido publicado y los alumnos notificados.', 'success');
                        closeModal('modal-reto');
                    } else {
                        Swal.fire('Error', json.error || 'Error al lanzar reto', 'error');
                    }
                } catch (err) { Swal.fire('Error', 'Error de conexi√≥n', 'error'); }
            }

            // Ver Entregas de una Tarea
            async function verEntregas(tareaId) {
                document.getElementById('modal-entregas').classList.remove('hidden');
                const container = document.getElementById('entregas-content');
                container.innerHTML = '<div class="text-center py-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-brand-500 mx-auto mb-4"></div>Cargando...</div>';

                try {
                    const res = await fetch(`/api/docente/tareas/${tareaId}/entregas`);
                    const entregas = await res.json();

                    if (!Array.isArray(entregas) || entregas.length === 0) {
                        container.innerHTML = '<div class="text-center py-10 text-gray-400">No hay entregas registradas</div>';
                        return;
                    }

                    container.innerHTML = `
                    <table class="w-full">
                        <thead class="bg-gray-50 text-xs uppercase text-gray-500">
                            <tr>
                                <th class="px-4 py-3 text-left">Estudiante</th>
                                <th class="px-4 py-3 text-left">Fecha Entrega</th>
                                <th class="px-4 py-3 text-left">Archivo</th>
                                <th class="px-4 py-3 text-center">Calificaci√≥n</th>
                                <th class="px-4 py-3 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            ${entregas.map(e => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-4 font-medium">${e.estudiante}</td>
                                    <td class="px-4 py-4 text-sm text-gray-500">${e.fecha_entrega || ''}</td>
                                    <td class="px-4 py-4">${e.archivo_url ? `<a href="${e.archivo_url}" target="_blank" class="text-brand-600 hover:underline"><i class="fas fa-file mr-1"></i>${e.archivo}</a>` : (e.archivo || 'Sin archivo')}</td>
                                    <td class="px-4 py-4 text-center">
                                        ${e.calificacion !== null
                            ? `<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full font-bold">${e.calificacion}</span>`
                            : '<span class="text-gray-400">Pendiente</span>'}
                                    </td>
                                    <td class="px-4 py-4 text-center">
                                        <button onclick="abrirCalificar(${e.id}, '${e.estudiante}')" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm hover:bg-blue-200">
                                            <i class="fas fa-edit mr-1"></i>${e.calificacion !== null ? 'Editar' : 'Calificar'}
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                } catch (err) {
                    container.innerHTML = '<div class="text-center py-10 text-red-500">Error al cargar entregas</div>';
                }
            }

            function abrirCalificar(entregaId, estudiante) {
                closeModal('modal-entregas');
                document.getElementById('modal-calificar').classList.remove('hidden');
                document.getElementById('calificar-entrega-id').value = entregaId;
                document.getElementById('calificar-estudiante').textContent = estudiante;
                document.getElementById('calificar-nota').value = '';
                document.getElementById('calificar-comentarios').value = '';
            }

            async function submitCalificacion(e) {
                e.preventDefault();
                const data = {
                    entrega_id: document.getElementById('calificar-entrega-id').value,
                    calificacion: parseInt(document.getElementById('calificar-nota').value),
                    comentarios: document.getElementById('calificar-comentarios').value
                };
                try {
                    const res = await fetch('/api/calificar-tarea', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                    const json = await res.json();
                    if (json.success) {
                        Swal.fire('√âxito', 'Calificaci√≥n guardada', 'success');
                        closeModal('modal-calificar');
                    } else {
                        Swal.fire('Error', json.error || 'Error al calificar', 'error');
                    }
                } catch (err) { Swal.fire('Error', 'Error de conexi√≥n', 'error'); }
            }

            async function generarQR() {
                const materia = document.getElementById('materia-qr').value;
                if (!materia) { Swal.fire('Error', 'Selecciona una materia', 'warning'); return; }

                const display = document.getElementById('qr-display');
                display.innerHTML = '<div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mb-4"></div><p>Generando...</p>';

                try {
                    const res = await fetch('/api/generar_qr_asistencia', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ materia_id: materia }) });
                    const json = await res.json();
                    if (json.codigo || json.qr_url) {
                        const qrUrl = json.qr_url || `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${json.codigo}`;
                        display.innerHTML = `
                        <img src="${qrUrl}" alt="QR" class="rounded-lg shadow-lg mb-4">
                        <p class="text-lg font-bold text-green-600">¬°QR Generado!</p>
                        <p class="text-sm text-gray-500 mt-2">V√°lido por 15 minutos</p>
                        <p class="text-xs text-gray-400 mt-1 font-mono bg-gray-100 px-3 py-1 rounded">${json.codigo}</p>
                        <button onclick="generarQR()" class="mt-4 bg-green-100 text-green-700 px-4 py-2 rounded-lg text-sm hover:bg-green-200">Regenerar</button>
                    `;
                    } else {
                        Swal.fire('Error', json.error || 'Error al generar QR', 'error');
                        display.innerHTML = '<i class="fas fa-exclamation-triangle text-4xl text-red-300 mb-4"></i><p class="text-red-500">Error al generar</p>';
                    }
                } catch (err) {
                    Swal.fire('Error', 'Error de conexi√≥n', 'error');
                }
            }

            async function subirRecurso(e) {
                e.preventDefault();
                const formData = new FormData();
                formData.append('title', document.getElementById('recurso-titulo').value);
                formData.append('description', document.getElementById('recurso-desc').value);
                formData.append('materia', document.getElementById('recurso-materia').value);
                const files = document.getElementById('recurso-files').files;
                for (let f of files) formData.append('files', f);

                try {
                    const res = await fetch('/api/resources', { method: 'POST', body: formData });
                    const json = await res.json();
                    if (json.success || !json.error) {
                        Swal.fire('√âxito', 'Recurso subido correctamente', 'success');
                        closeModal('modal-recurso');

                        const selectedMateria = document.getElementById('recurso-materia').value;
                        if (currentMateriaId && currentMateriaId == selectedMateria) {
                            loadSubjectDetails(currentMateriaId);
                        } else {
                            cargarRecursos();
                        }
                    } else {
                        Swal.fire('Error', json.error || 'Error', 'error');
                    }
                } catch (err) { Swal.fire('Error', 'Error de conexi√≥n', 'error'); }
            }

            async function cargarRecursos() {
                const container = document.getElementById('recursos-list');
                try {
                    const res = await fetch('/api/resources');
                    const recursos = await res.json();
                    if (!recursos || recursos.length === 0) {
                        container.innerHTML = '<div class="col-span-full bg-white rounded-xl p-8 text-center"><i class="fas fa-folder-open text-4xl text-gray-300 mb-4"></i><p class="text-gray-500">No hay recursos subidos</p></div>';
                        return;
                    }
                    container.innerHTML = recursos.map(r => `
                    <div class="bg-white rounded-xl shadow-sm p-4 hover:shadow-md transition">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center">
                                    <i class="fas fa-file-alt text-purple-600"></i>
                                </div>
                                <div>
                                    <p class="font-medium">${r.titulo}</p>
                                    <p class="text-xs text-gray-500">${r.materia_nombre || 'Sin materia'}</p>
                                </div>
                            </div>
                            <button onclick="eliminarRecurso(${r.id})" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">${r.descripcion || 'Sin descripci√≥n'}</p>
                        ${r.url ? `<a href="${r.url}" target="_blank" class="inline-flex items-center text-brand-600 text-sm hover:underline"><i class="fas fa-download mr-1"></i>Descargar</a>` : ''}
                    </div>
                `).join('');
                } catch (err) {
                    container.innerHTML = '<div class="col-span-full text-center py-8 text-red-400">Error al cargar recursos</div>';
                }
            }

            function eliminarTarea(tareaId) {
                Swal.fire({
                    title: '¬øEliminar tarea?',
                    text: 'Esta acci√≥n no se puede deshacer. Se eliminar√°n tambi√©n todas las entregas.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#ef4444',
                    cancelButtonText: 'Cancelar',
                    confirmButtonText: 'S√≠, eliminar'
                }).then(result => {
                    if (result.isConfirmed) {
                        fetch('/api/eliminar-tarea', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ tarea_id: tareaId }) })
                            .then(r => r.json())
                            .then(j => {
                                if (j.success) {
                                    Swal.fire('Eliminada', 'La tarea ha sido eliminada', 'success').then(() => location.reload());
                                } else {
                                    Swal.fire('Error', j.error || 'Error al eliminar', 'error');
                                }
                            });
                    }
                });
            }

            function eliminarRecurso(id) {
                Swal.fire({ title: '¬øEliminar recurso?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444', confirmButtonText: 'Eliminar' }).then(r => {
                    if (r.isConfirmed) {
                        fetch('/api/eliminar-recurso', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ recurso_id: id }) })
                            .then(() => { Swal.fire('Eliminado', '', 'success'); cargarRecursos(); });
                    }
                });
            }

            function enviarMensajeA(id, nombre) {
                // Abrir modal de mensaje con datos prellenados
                document.getElementById('modal-mensaje').classList.remove('hidden');
                document.getElementById('mensaje-destinatario-id').value = id;
                document.getElementById('mensaje-destinatario-nombre').value = nombre;

                // Opcional: Cerrar detalle estudiante si estaba abierto
                closeModal('modal-estudiante');
            }

            async function enviarMensaje(e) {
                e.preventDefault();
                const data = {
                    destinatario_id: document.getElementById('mensaje-destinatario-id').value,
                    asunto: document.getElementById('mensaje-asunto').value,
                    contenido: document.getElementById('mensaje-contenido').value
                };
                try {
                    const res = await fetch('/api/send_message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const json = await res.json();
                    if (json.success) {
                        Swal.fire('Enviado', 'Mensaje enviado correctamente', 'success');
                        closeModal('modal-mensaje');
                    } else {
                        Swal.fire('Error', json.error || 'Error al enviar', 'error');
                    }
                } catch (err) { Swal.fire('Error', 'Error de conexi√≥n', 'error'); }
            }

            async function crearComunicado(e) {
                e.preventDefault();
                const formData = new FormData();
                formData.append('title', document.getElementById('comunicado-titulo').value);
                formData.append('content', document.getElementById('comunicado-contenido').value);
                const adjunto = document.getElementById('comunicado-adjunto').files[0];
                if (adjunto) formData.append('adjunto', adjunto);

                try {
                    const res = await fetch('/api/announcements', { method: 'POST', body: formData });
                    const json = await res.json();
                    if (json.success) {
                        Swal.fire('Publicado', 'Comunicado publicado correctamente', 'success');
                        closeModal('modal-comunicado');
                        cargarComunicados();
                    } else {
                        Swal.fire('Error', json.error || 'Error al publicar', 'error');
                    }
                } catch (err) { Swal.fire('Error', 'Error de conexi√≥n', 'error'); }
            }

            async function cargarComunicados() {
                const container = document.getElementById('comunicados-list');
                if (!container) return;
                container.innerHTML = '<div class="p-6 text-center text-gray-400">Cargando comunicados...</div>';
                try {
                    const res = await fetch('/api/announcements');
                    const comunicados = await res.json();
                    if (!Array.isArray(comunicados) || comunicados.length === 0) {
                        container.innerHTML = '<div class="p-6 text-center text-gray-400">No hay comunicados</div>';
                        return;
                    }

                    container.innerHTML = comunicados.map(c => {
                        const safeTitle = (c.title || '').replace(/'/g, "\\'");
                        const safeContent = (c.content || '').replace(/'/g, "\\'");
                        return `
                        <div class="p-6 hover:bg-gray-50">
                            <div class="flex justify-between items-start">
                                <div>
                                    <span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded">General</span>
                                    <h3 class="font-bold text-lg mt-2">${c.title || 'Sin t√≠tulo'}</h3>
                                    <p class="text-sm text-gray-600 mt-1">${c.content || ''}</p>
                                    ${c.adjunto_url ? `<a href="${c.adjunto_url}" target="_blank" class="text-xs text-brand-600 hover:underline mt-2 inline-flex items-center"><i class="fas fa-paperclip mr-1"></i>Adjunto</a>` : ''}
                                    <p class="text-xs text-gray-400 mt-2"><i class="fas fa-clock mr-1"></i> ${c.date ? new Date(c.date).toLocaleString() : ''}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="editarComunicado(${c.id}, '${safeTitle}', '${safeContent}')" class="text-gray-400 hover:text-blue-500"><i class="fas fa-edit"></i></button>
                                    <button onclick="eliminarComunicado(${c.id})" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                    }).join('');
                } catch (err) {
                    container.innerHTML = '<div class="p-6 text-center text-red-400">Error al cargar comunicados</div>';
                }
            }

            function editarComunicado(id, titulo, contenido) {
                Swal.fire({
                    title: 'Editar comunicado',
                    html: `
                        <input id="swal-com-titulo" class="swal2-input" placeholder="T√≠tulo" value="${titulo}">
                        <textarea id="swal-com-contenido" class="swal2-textarea" placeholder="Contenido">${contenido}</textarea>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Guardar',
                    preConfirm: () => ({
                        title: document.getElementById('swal-com-titulo').value,
                        content: document.getElementById('swal-com-contenido').value
                    })
                }).then(async (result) => {
                    if (!result.isConfirmed) return;
                    try {
                        const res = await fetch(`/api/announcements/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(result.value)
                        });
                        const json = await res.json();
                        if (json.success) {
                            Swal.fire('Actualizado', 'Comunicado actualizado', 'success');
                            cargarComunicados();
                        } else {
                            Swal.fire('Error', json.error || 'No se pudo actualizar', 'error');
                        }
                    } catch (err) {
                        Swal.fire('Error', 'Error de conexi√≥n', 'error');
                    }
                });
            }

            function eliminarComunicado(id) {
                Swal.fire({
                    title: '¬øEliminar comunicado?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#ef4444',
                    confirmButtonText: 'Eliminar'
                }).then(async (result) => {
                    if (!result.isConfirmed) return;
                    try {
                        const res = await fetch(`/api/announcements/${id}`, { method: 'DELETE' });
                        const json = await res.json();
                        if (json.success) {
                            Swal.fire('Eliminado', 'Comunicado eliminado', 'success');
                            cargarComunicados();
                        } else {
                            Swal.fire('Error', json.error || 'No se pudo eliminar', 'error');
                        }
                    } catch (err) {
                        Swal.fire('Error', 'Error de conexi√≥n', 'error');
                    }
                });
            }

            async function cargarEvaluaciones() {
                const container = document.getElementById('evaluaciones-grid');
                if (!container) return;
                container.innerHTML = '<div class="col-span-full text-center py-8 text-gray-400">Cargando evaluaciones...</div>';
                try {
                    const res = await fetch('/api/docente/examenes');
                    const evaluaciones = await res.json();
                    if (!Array.isArray(evaluaciones) || evaluaciones.length === 0) {
                        container.innerHTML = '<div class="col-span-full text-center py-8 text-gray-400">No hay evaluaciones creadas</div>';
                        return;
                    }

                    container.innerHTML = evaluaciones.map(ev => {
                        const safeTitle = (ev.titulo || '').replace(/'/g, "\\'");
                        const safeDesc = (ev.descripcion || '').replace(/'/g, "\\'");
                        const fechaFin = ev.fecha_fin || '';
                        return `
                        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-indigo-500">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded">${ev.activo ? 'Activo' : 'Inactivo'}</span>
                                    <h3 class="font-bold text-lg mt-2">${ev.titulo}</h3>
                                    <p class="text-sm text-gray-500">${ev.materia || 'Sin materia'}</p>
                                </div>
                                <i class="fas fa-file-alt text-2xl text-indigo-300"></i>
                            </div>
                            <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
                                <span><i class="fas fa-clock mr-1"></i> ${ev.tiempo_limite || 0} min</span>
                                <span><i class="fas fa-users mr-1"></i> ${ev.respuestas_count || 0} respuestas</span>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editarExamen(${ev.id}, '${safeTitle}', '${safeDesc}', ${ev.tiempo_limite || 60}, '${fechaFin}')" class="flex-1 bg-indigo-100 text-indigo-700 py-2 rounded-lg text-sm hover:bg-indigo-200">Editar</button>
                                <button onclick="eliminarExamen(${ev.id})" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg text-sm hover:bg-gray-200">Eliminar</button>
                            </div>
                        </div>
                    `;
                    }).join('');
                } catch (err) {
                    container.innerHTML = '<div class="col-span-full text-center py-8 text-red-400">Error al cargar evaluaciones</div>';
                }
            }

            async function editarExamen(id, titulo, descripcion, tiempoLimite, fechaFin) {
                Swal.fire({
                    title: 'Editar evaluaci√≥n',
                    html: `
                        <input id="swal-eval-titulo" class="swal2-input" placeholder="T√≠tulo" value="${titulo}">
                        <textarea id="swal-eval-desc" class="swal2-textarea" placeholder="Descripci√≥n">${descripcion}</textarea>
                        <input id="swal-eval-tiempo" type="number" class="swal2-input" placeholder="Tiempo l√≠mite (min)" value="${tiempoLimite}">
                        <input id="swal-eval-fecha" type="datetime-local" class="swal2-input" value="${fechaFin ? fechaFin.replace(' ', 'T') : ''}">
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Guardar',
                    preConfirm: () => ({
                        titulo: document.getElementById('swal-eval-titulo').value,
                        descripcion: document.getElementById('swal-eval-desc').value,
                        tiempo_limite: parseInt(document.getElementById('swal-eval-tiempo').value, 10) || 60,
                        fecha_fin: document.getElementById('swal-eval-fecha').value || null
                    })
                }).then(async (result) => {
                    if (!result.isConfirmed) return;
                    try {
                        const payload = {
                            titulo: result.value.titulo,
                            descripcion: result.value.descripcion,
                            tiempo_limite: result.value.tiempo_limite,
                            fecha_fin: result.value.fecha_fin ? result.value.fecha_fin.replace('T', ' ') + ':00' : null
                        };
                        const res = await fetch(`/api/docente/examenes/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const json = await res.json();
                        if (json.success) {
                            Swal.fire('Actualizada', 'Evaluaci√≥n actualizada', 'success');
                            cargarEvaluaciones();
                        } else {
                            Swal.fire('Error', json.error || 'No se pudo actualizar', 'error');
                        }
                    } catch (err) {
                        Swal.fire('Error', 'Error de conexi√≥n', 'error');
                    }
                });
            }

            async function eliminarExamen(id) {
                Swal.fire({
                    title: '¬øEliminar evaluaci√≥n?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#ef4444',
                    confirmButtonText: 'Eliminar'
                }).then(async (result) => {
                    if (!result.isConfirmed) return;
                    try {
                        const res = await fetch(`/api/docente/examenes/${id}`, { method: 'DELETE' });
                        const json = await res.json();
                        if (json.status === 'ok' || json.success) {
                            Swal.fire('Eliminada', 'Evaluaci√≥n eliminada', 'success');
                            cargarEvaluaciones();
                        } else {
                            Swal.fire('Error', json.error || 'No se pudo eliminar', 'error');
                        }
                    } catch (err) {
                        Swal.fire('Error', 'Error de conexi√≥n', 'error');
                    }
                });
            }

            async function cargarReportesStats() {
                try {
                    const res = await fetch('/api/docente/reportes/estadisticas');
                    const data = await res.json();
                    const promedio = document.getElementById('stat-promedio');
                    const entregas = document.getElementById('stat-entregas');
                    const asistencia = document.getElementById('stat-asistencia');
                    if (promedio) promedio.textContent = data.promedio_general !== null ? Number(data.promedio_general).toFixed(1) : '‚Äî';
                    if (entregas) entregas.textContent = data.tasa_entrega !== null ? `${Math.round(data.tasa_entrega)}%` : '‚Äî';
                    if (asistencia) asistencia.textContent = data.asistencia_promedio !== null ? `${Math.round(data.asistencia_promedio)}%` : '‚Äî';
                } catch (err) {
                    const promedio = document.getElementById('stat-promedio');
                    if (promedio) promedio.textContent = '‚Äî';
                }
            }

            async function cargarRetos() {
                const container = document.getElementById('retos-list');
                if (!container) return;
                container.innerHTML = '<div class="bg-white rounded-xl shadow-sm p-8 text-center border-2 border-dashed border-gray-300"><i class="fas fa-code text-4xl text-gray-300 mb-4"></i><p class="text-gray-500">Cargando retos...</p></div>';
                try {
                    const res = await fetch('/api/docente/retos');
                    const retos = await res.json();
                    if (!Array.isArray(retos) || retos.length === 0) {
                        container.innerHTML = '<div class="bg-white rounded-xl shadow-sm p-8 text-center border-2 border-dashed border-gray-300"><i class="fas fa-code text-4xl text-gray-300 mb-4"></i><p class="text-gray-500">No hay retos activos</p></div>';
                        return;
                    }
                    container.innerHTML = retos.map(r => `
                        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-purple-500">
                            <div class="flex justify-between items-start">
                                <div>
                                    <span class="bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded-full font-bold">${r.activo ? 'Activo' : 'Inactivo'}</span>
                                    <h3 class="font-bold text-lg mt-2">${r.titulo}</h3>
                                    <p class="text-sm text-gray-600 mt-1">${r.descripcion || ''}</p>
                                    <p class="text-xs text-gray-400 mt-2">${r.materia || 'Sin materia'} ¬∑ Dificultad: ${r.dificultad || 'medio'}</p>
                                </div>
                                <div class="bg-purple-100 p-3 rounded-full text-purple-600">
                                    <i class="fas fa-trophy text-xl"></i>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center justify-between text-sm">
                                <span class="text-gray-500"><i class="fas fa-paper-plane mr-1"></i> ${r.envios || 0} env√≠os</span>
                            </div>
                        </div>
                    `).join('');
                } catch (err) {
                    container.innerHTML = '<div class="bg-white rounded-xl shadow-sm p-8 text-center border-2 border-dashed border-gray-300"><i class="fas fa-code text-4xl text-gray-300 mb-4"></i><p class="text-gray-500">Error al cargar retos</p></div>';
                }
            }

            async function cargarRankingRetos() {
                const container = document.getElementById('retos-ranking');
                if (!container) return;
                container.innerHTML = '<li class="text-sm text-gray-400">Cargando ranking...</li>';
                try {
                    const res = await fetch('/api/docente/retos/ranking');
                    const ranking = await res.json();
                    if (!Array.isArray(ranking) || ranking.length === 0) {
                        container.innerHTML = '<li class="text-sm text-gray-400">Sin ranking disponible</li>';
                        return;
                    }
                    container.innerHTML = ranking.map((r, idx) => `
                        <li class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <span class="text-gray-500 font-bold w-6">${idx + 1}</span>
                                <div>
                                    <p class="font-medium text-sm">${r.nombre}</p>
                                    <p class="text-xs text-gray-500">${r.envios} env√≠os</p>
                                </div>
                            </div>
                            <i class="fas fa-medal text-yellow-400"></i>
                        </li>
                    `).join('');
                } catch (err) {
                    container.innerHTML = '<li class="text-sm text-gray-400">Error al cargar ranking</li>';
                }
            }

            async function crearEvaluacion(e) {
                e.preventDefault();
                const titulo = document.getElementById('eval-titulo').value.trim();
                const materiaId = document.getElementById('eval-materia').value;
                const descripcion = document.getElementById('eval-descripcion').value.trim();
                const duracion = parseInt(document.getElementById('eval-duracion').value, 10) || 60;
                const fechaFin = document.getElementById('eval-fecha').value || null;

                const preguntas = Array.from(document.querySelectorAll('#preguntas-container .pregunta-item')).map((item, idx) => {
                    const inputs = item.querySelectorAll('input');
                    const pregunta = inputs[0]?.value?.trim() || '';
                    const opciones = Array.from(inputs).slice(1).map(i => i.value.trim()).filter(Boolean);
                    const respuesta_correcta = opciones.length >= 4 ? 3 : Math.max(0, opciones.length - 1);
                    return {
                        id: idx + 1,
                        pregunta,
                        opciones,
                        respuesta_correcta
                    };
                }).filter(p => p.pregunta && p.opciones.length >= 2);

                if (!titulo || !materiaId || preguntas.length === 0) {
                    Swal.fire('Error', 'Completa el t√≠tulo, la materia y al menos una pregunta.', 'warning');
                    return;
                }

                Swal.fire({ title: 'Creando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                try {
                    const res = await fetch('/api/docente/crear-examen', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            materia_id: materiaId,
                            titulo,
                            descripcion,
                            preguntas,
                            tiempo_limite: duracion,
                            fecha_inicio: null,
                            fecha_fin: fechaFin ? fechaFin.replace('T', ' ') + ':00' : null
                        })
                    });
                    const json = await res.json();
                    if (json.success) {
                        Swal.fire('Creada', 'Evaluaci√≥n creada correctamente', 'success');
                        closeModal('modal-evaluacion');
                        cargarEvaluaciones();
                    } else {
                        Swal.fire('Error', json.error || 'No se pudo crear la evaluaci√≥n', 'error');
                    }
                } catch (err) {
                    Swal.fire('Error', 'Error de conexi√≥n', 'error');
                }
            }

            async function generarEvaluacionAI() {
                const materia = document.getElementById('ai-materia-eval').value;
                const tema = document.getElementById('ai-tema-eval').value;
                if (!tema) { Swal.fire('Error', 'Ingresa un tema', 'warning'); return; }

                Swal.fire({ title: 'Generando con IA...', html: 'Gemini est√° creando preguntas sobre: ' + tema, allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                try {
                    const res = await fetch('/examenes/generar-ai', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ materia_id: materia, tema: tema, cantidad: 10 })
                    });
                    const json = await res.json();
                    Swal.fire('¬°Listo!', 'Evaluaci√≥n generada con IA. Revisa la secci√≥n de evaluaciones.', 'success');
                    cargarEvaluaciones();
                } catch (err) {
                    Swal.fire('Error', 'Error al generar con IA', 'error');
                }
            }

            let preguntaCount = 1;
            function agregarPregunta() {
                preguntaCount++;
                const container = document.getElementById('preguntas-container');
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-lg border pregunta-item';
                div.innerHTML = `
                <div class="flex items-start space-x-3">
                    <span class="bg-indigo-100 text-indigo-700 w-8 h-8 rounded-full flex items-center justify-center font-bold">${preguntaCount}</span>
                    <div class="flex-1">
                        <input type="text" placeholder="Escribe la pregunta..." class="w-full border-b border-gray-200 pb-2 focus:border-indigo-500 focus:outline-none">
                        <div class="mt-2 space-y-1">
                            <input type="text" placeholder="Opci√≥n A" class="w-full text-sm border rounded px-2 py-1">
                            <input type="text" placeholder="Opci√≥n B" class="w-full text-sm border rounded px-2 py-1">
                            <input type="text" placeholder="Opci√≥n C" class="w-full text-sm border rounded px-2 py-1">
                            <input type="text" placeholder="Opci√≥n D (correcta)" class="w-full text-sm border rounded px-2 py-1 border-green-300 bg-green-50">
                        </div>
                    </div>
                    <button type="button" onclick="this.closest('.pregunta-item').remove()" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button>
                </div>
            `;
                container.appendChild(div);
            }

            function filtrarEstudiantes() {
                const q = document.getElementById('buscar-estudiante').value.toLowerCase();
                document.querySelectorAll('.estudiante-item').forEach(e => {
                    e.style.display = e.textContent.toLowerCase().includes(q) ? '' : 'none';
                });
            }

            // ========== NOTIFICACIONES ==========
            let notifOpen = false;
            function toggleNotificaciones() {
                const dropdown = document.getElementById('notif-dropdown');
                notifOpen = !notifOpen;
                dropdown.classList.toggle('hidden', !notifOpen);
                if (notifOpen) cargarNotificaciones();
            }

            async function cargarNotificaciones() {
                const list = document.getElementById('notif-list');
                try {
                    const res = await fetch('/api/notifications');
                    const data = await res.json();
                    const notifs = Array.isArray(data) ? data : (data.notifications || []);
                    if (!notifs || notifs.length === 0) {
                        list.innerHTML = '<div class="p-4 text-center text-gray-400 text-sm">Sin notificaciones</div>';
                        document.getElementById('notif-badge').classList.add('hidden');
                        return;
                    }
                    if (data.unread_count && data.unread_count > 0) {
                        document.getElementById('notif-badge').classList.remove('hidden');
                    } else {
                        document.getElementById('notif-badge').classList.add('hidden');
                    }
                    list.innerHTML = notifs.slice(0, 10).map(n => `
                    <div class="p-3 hover:bg-gray-50 ${n.leida ? '' : 'bg-blue-50'}">
                        <p class="text-sm font-medium ${n.leida ? 'text-gray-600' : 'text-gray-800'}">${n.titulo || n.mensaje}</p>
                        <p class="text-xs text-gray-400">${n.fecha ? new Date(n.fecha).toLocaleString() : 'Reciente'}</p>
                    </div>
                `).join('');
                } catch (err) {
                    list.innerHTML = '<div class="p-4 text-center text-red-400 text-sm">Error al cargar</div>';
                }
            }

            function marcarTodasLeidas() {
                fetch('/api/notifications/read-all', { method: 'PUT' })
                    .then(() => {
                        Swal.fire('Marcadas', 'Todas las notificaciones le√≠das', 'success');
                        document.getElementById('notif-badge').classList.add('hidden');
                        document.getElementById('notif-dropdown').classList.add('hidden');
                        notifOpen = false;
                    });
            }

            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', (e) => {
                const container = document.getElementById('notif-container');
                if (container && !container.contains(e.target)) {
                    document.getElementById('notif-dropdown').classList.add('hidden');
                    notifOpen = false;
                }
            });

            // ========== REPORTE DE CONDUCTA (Desde modal estudiante) ==========
            function abrirReporteConducta(estudianteId, nombre) {
                closeModal('modal-estudiante');
                Swal.fire({
                    title: 'Reportar Conducta',
                    html: `
                    <p class="text-sm text-gray-500 mb-4">Estudiante: <strong>${nombre}</strong></p>
                    <select id="swal-tipo" class="swal2-input w-full">
                        <option value="positivo">Positivo</option>
                        <option value="academico">Acad√©mico</option>
                        <option value="disciplinario">Disciplinario</option>
                    </select>
                    <textarea id="swal-desc" class="swal2-textarea" placeholder="Descripci√≥n del reporte..."></textarea>
                `,
                    confirmButtonText: 'Enviar Reporte',
                    showCancelButton: true,
                    preConfirm: () => {
                        return {
                            tipo: document.getElementById('swal-tipo').value,
                            descripcion: document.getElementById('swal-desc').value
                        }
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const payload = {
                            alumno_id: estudianteId,
                            tipo: result.value.tipo,
                            descripcion: result.value.descripcion
                        };
                        fetch('/api/docente/reportes-conducta', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        }).then(r => r.json()).then(j => {
                            if (j.success) {
                                Swal.fire('Enviado', 'El reporte ha sido registrado en el sistema.', 'success');
                            } else {
                                Swal.fire('Error', j.error || 'No se pudo registrar el reporte', 'error');
                            }
                        }).catch(() => {
                            Swal.fire('Error', 'Error de conexi√≥n', 'error');
                        });
                    }
                });
            }

            // ========== EDITAR TAREA (Fetch y prepopular modal) ==========
            async function editarTarea(tareaId) {
                try {
                    const res = await fetch(`/api/obtener-tarea/${tareaId}`);
                    const tarea = await res.json();

                    document.getElementById('tarea-titulo').value = tarea.titulo;
                    document.getElementById('tarea-desc').value = tarea.descripcion || '';
                    document.getElementById('tarea-materia').value = tarea.materia_id;
                    document.getElementById('tarea-valor').value = tarea.valor_porcentaje || 10;

                    // Nota: Para edici√≥n real se necesitar√≠a un endpoint PUT
                    openModalCrearTarea();
                    Swal.fire('Modo Edici√≥n', 'Modifica los campos y guarda para crear una nueva tarea (edici√≥n real requiere endpoint PUT).', 'info');
                } catch (err) {
                    Swal.fire('Error', 'No se pudo cargar la tarea', 'error');
                }
            }

            // ========== CHAT IA (Gemini) ==========
            async function enviarChatIA(e) {
                e.preventDefault();
                const input = document.getElementById('chat-input');
                const mensajes = document.getElementById('chat-messages');
                const pregunta = input.value.trim();
                if (!pregunta) return;

                // Mostrar mensaje del usuario
                mensajes.innerHTML += `
                    <div class="flex items-start space-x-3 justify-end">
                        <div class="bg-purple-100 p-3 rounded-lg shadow-sm max-w-[80%]">
                            <p class="text-sm">${pregunta}</p>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center"><i class="fas fa-user text-gray-600"></i></div>
                    </div>`;
                input.value = '';
                mensajes.scrollTop = mensajes.scrollHeight;

                // Mostrar cargando
                const loadingId = 'loading-' + Date.now();
                mensajes.innerHTML += `<div id="${loadingId}" class="flex items-start space-x-3"><div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center"><i class="fas fa-robot text-purple-600 animate-pulse"></i></div><div class="bg-white p-3 rounded-lg shadow-sm"><p class="text-sm text-gray-400">Pensando...</p></div></div>`;

                try {
                    const res = await fetch('/api/chat/gemini', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: pregunta })
                    });
                    const data = await res.json();
                    document.getElementById(loadingId).remove();

                    mensajes.innerHTML += `
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center"><i class="fas fa-robot text-purple-600"></i></div>
                            <div class="bg-white p-3 rounded-lg shadow-sm max-w-[80%]">
                                <p class="text-sm whitespace-pre-wrap">${data.response || data.error || 'Sin respuesta'}</p>
                            </div>
                        </div>`;
                } catch (err) {
                    document.getElementById(loadingId).remove();
                    mensajes.innerHTML += `<div class="flex items-start space-x-3"><div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center"><i class="fas fa-exclamation text-red-600"></i></div><div class="bg-white p-3 rounded-lg shadow-sm"><p class="text-sm text-red-500">Error de conexi√≥n</p></div></div>`;
                }
                mensajes.scrollTop = mensajes.scrollHeight;
            }

            function sugerenciaChat(texto) {
                document.getElementById('chat-input').value = texto;
                enviarChatIA({ preventDefault: () => { } });
            }

            // ========== GENERADOR QUIZ PDF ==========
            function previewPDF(input) {
                if (input.files && input.files[0]) {
                    document.getElementById('pdf-name').textContent = input.files[0].name;
                    document.getElementById('pdf-name').classList.remove('hidden');
                }
            }

            async function generarQuizPDF() {
                const pdfInput = document.getElementById('quiz-pdf');
                if (!pdfInput.files || !pdfInput.files[0]) {
                    Swal.fire('Error', 'Selecciona un archivo PDF primero', 'warning');
                    return;
                }

                Swal.fire({ title: 'Generando Quiz...', html: 'Gemini est√° analizando el PDF y creando preguntas', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                const formData = new FormData();
                formData.append('temario_pdf', pdfInput.files[0]);
                formData.append('materia_id', document.getElementById('quiz-materia').value);

                try {
                    const res = await fetch('/api/generar_quiz', { method: 'POST', body: formData });
                    const data = await res.json();

                    if (data.quiz) {
                        document.getElementById('quiz-result').classList.remove('hidden');
                        const container = document.getElementById('quiz-questions');
                        container.innerHTML = data.quiz.map((q, i) => `
                            <div class="bg-gray-50 p-3 rounded-lg border">
                                <p class="font-medium text-sm"><span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded mr-2">${i + 1}</span>${q.pregunta}</p>
                                ${q.opciones ? '<div class="mt-2 pl-8 text-sm text-gray-600">' + q.opciones.map((o, j) => `<p>${String.fromCharCode(65 + j)}. ${o}</p>`).join('') + '</div>' : ''}
                            </div>
                        `).join('');
                        Swal.fire('¬°Listo!', 'Quiz generado exitosamente', 'success');
                    } else {
                        Swal.fire('Error', data.error || 'Error al generar', 'error');
                    }
                } catch (err) {
                    Swal.fire('Error', 'Error de conexi√≥n', 'error');
                }
            }

            // ========== TUTOR√çAS ==========
            function openModalTutoria() {
                const materiaOptions = Array.from(document.querySelectorAll('#tarea-materia option'))
                    .map(o => `<option value="${o.value}">${o.textContent}</option>`)
                    .join('');
                const alumnoOptions = (window.estudiantesData || []).map(e => `<option value="${e.id}">${e.nombre}</option>`).join('');
                Swal.fire({
                    title: 'Agendar Nueva Tutor√≠a',
                    html: `
                        <div class="text-left space-y-3">
                            <div><label class="block text-sm font-medium mb-1">Estudiante</label>
                            <select id="swal-alumno" class="swal2-select w-full">
                                ${alumnoOptions || '<option value="">Sin estudiantes</option>'}
                            </select></div>
                            <div><label class="block text-sm font-medium mb-1">Materia</label>
                            <select id="swal-materia" class="swal2-select w-full">
                                ${materiaOptions || '<option value="">Sin materias</option>'}
                            </select></div>
                            <div><label class="block text-sm font-medium mb-1">Fecha y Hora</label>
                            <input type="datetime-local" id="swal-fecha" class="swal2-input w-full"></div>
                            <div><label class="block text-sm font-medium mb-1">Notas</label>
                            <textarea id="swal-notas" class="swal2-textarea" placeholder="Tema o notas"></textarea></div>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Agendar',
                    preConfirm: () => ({
                        alumno_id: document.getElementById('swal-alumno').value,
                        materia_id: document.getElementById('swal-materia').value,
                        fecha: document.getElementById('swal-fecha').value,
                        notas: document.getElementById('swal-notas').value
                    })
                }).then((result) => {
                    if (!result.isConfirmed) return;
                    crearTutoria(result.value);
                });
            }

            async function crearTutoria(payload) {
                if (!payload.alumno_id || !payload.materia_id || !payload.fecha) {
                    Swal.fire('Error', 'Completa estudiante, materia y fecha.', 'warning');
                    return;
                }
                const fechaFormateada = payload.fecha.includes('T') ? payload.fecha.replace('T', ' ') + ':00' : payload.fecha;
                try {
                    const res = await fetch('/api/docente/tutorias', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...payload, fecha: fechaFormateada })
                    });
                    const json = await res.json();
                    if (json.success) {
                        Swal.fire('Agendada', 'Tutor√≠a programada correctamente.', 'success');
                        cargarTutorias();
                    } else {
                        Swal.fire('Error', json.error || 'No se pudo agendar', 'error');
                    }
                } catch (err) {
                    Swal.fire('Error', 'Error de conexi√≥n', 'error');
                }
            }

            // ========== MI HORARIO ==========
            async function cargarMiHorario() {
                try {
                    const res = await fetch('/api/docente/horario');
                    const data = await res.json();
                    const container = document.getElementById('horario-container');
                    if (!Array.isArray(data) || data.length === 0) {
                        container.innerHTML = '<div class="text-center text-gray-400 py-6">No hay horarios registrados</div>';
                        return;
                    }
                    container.innerHTML = data.map(h => `
                        <div class="bg-gray-50 rounded-lg p-4 border">
                            <p class="font-semibold text-gray-800">${h.materia}</p>
                            <p class="text-sm text-gray-500">${h.horario || 'Sin horario'}</p>
                        </div>
                    `).join('');
                } catch (err) {
                    const container = document.getElementById('horario-container');
                    if (container) container.innerHTML = '<div class="text-center text-gray-400 py-6">No se pudo cargar el horario</div>';
                }
            }

            async function cargarTutorias() {
                const list = document.getElementById('tutorias-list');
                if (!list) return;
                list.innerHTML = '<div class="text-center text-gray-400 py-6">Cargando tutor√≠as...</div>';
                try {
                    const res = await fetch('/api/docente/tutorias');
                    const tutorias = await res.json();
                    if (!Array.isArray(tutorias) || tutorias.length === 0) {
                        list.innerHTML = '<div class="text-center text-gray-400 py-6">No hay tutor√≠as programadas</div>';
                        document.getElementById('tutorias-total').textContent = '0';
                        document.getElementById('tutorias-completadas').textContent = '0';
                        return;
                    }

                    let completadas = 0;
                    list.innerHTML = tutorias.map(t => {
                        if (t.estado === 'completada') completadas += 1;
                        return `
                        <div class="flex items-center justify-between p-3 ${t.estado === 'completada' ? 'bg-blue-50 border-l-4 border-blue-500' : 'bg-green-50 border-l-4 border-green-500'} rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-full ${t.estado === 'completada' ? 'bg-blue-100' : 'bg-green-100'} flex items-center justify-center">
                                    <i class="fas fa-user ${t.estado === 'completada' ? 'text-blue-600' : 'text-green-600'}"></i>
                                </div>
                                <div>
                                    <p class="font-medium">${t.alumno_nombre}</p>
                                    <p class="text-xs text-gray-500">${t.materia || 'Sin materia'}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-green-600">${t.fecha}</p>
                                <span class="text-xs text-gray-400">${t.estado}</span>
                            </div>
                        </div>`;
                    }).join('');

                    document.getElementById('tutorias-total').textContent = `${tutorias.length}`;
                    document.getElementById('tutorias-completadas').textContent = `${completadas}`;
                } catch (err) {
                    list.innerHTML = '<div class="text-center text-gray-400 py-6">No se pudo cargar tutor√≠as</div>';
                }
            }

            // ========== DETECTAR PLAGIO ==========
            async function detectarPlagio(tareaId) {
                Swal.fire({
                    title: 'Analizando entregas...',
                    html: 'Detectando similitudes en c√≥digo fuente',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                const formData = new FormData();
                formData.append('tarea_id', tareaId);

                try {
                    const res = await fetch('/api/detectar_plagio', { method: 'POST', body: formData });
                    const data = await res.json();

                    if (data.plagios && data.plagios.length > 0) {
                        let html = '<div class="text-left space-y-2">';
                        data.plagios.forEach(p => {
                            html += `<div class="p-2 bg-red-50 rounded border-l-4 border-red-500">
                                <p class="font-bold text-red-700">Similitud: ${p.similitud.toFixed(1)}%</p>
                                <p class="text-sm">Estudiantes ${p.estudiante1} y ${p.estudiante2}</p>
                            </div>`;
                        });
                        html += '</div>';
                        Swal.fire({
                            title: '<i class="fas fa-exclamation-triangle text-red-500"></i> Plagio Detectado',
                            html: html,
                            icon: 'warning',
                            confirmButtonText: 'Entendido'
                        });
                    } else {
                        Swal.fire('Sin Plagio', 'No se detectaron similitudes sospechosas entre las entregas.', 'success');
                    }
                } catch (err) {
                    Swal.fire('Error', 'Error al analizar entregas', 'error');
                }
            }

            // ========== ESTUDIANTES EN RIESGO (Predicci√≥n Deserci√≥n) ==========
            async function cargarEstudiantesRiesgo() {
                const container = document.getElementById('estudiantes-riesgo-list');
                container.innerHTML = '<div class="text-center py-4"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-500 mx-auto"></div><p class="text-sm text-gray-400 mt-2">Analizando datos...</p></div>';

                try {
                    const res = await fetch('/api/docente/riesgo');
                    const estudiantes = await res.json();

                    if (!Array.isArray(estudiantes) || estudiantes.length === 0) {
                        container.innerHTML = '<p class="text-center text-gray-400 py-4">Sin estudiantes en riesgo</p>';
                        return;
                    }

                    container.innerHTML = '<div class="space-y-3">' + estudiantes.map(e => {
                        const riesgoNum = Number(e.probabilidad) || 0;
                        const colorClass = riesgoNum >= 70 ? 'red' : (riesgoNum >= 50 ? 'orange' : 'yellow');
                        return `
                            <div class="flex items-center justify-between p-3 bg-${colorClass}-50 rounded-lg border-l-4 border-${colorClass}-400">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 rounded-full bg-${colorClass}-100 flex items-center justify-center">
                                        <i class="fas fa-user text-${colorClass}-600"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium">${e.nombre}</p>
                                        <p class="text-xs text-gray-500">${e.riesgo || 'Riesgo'} ¬∑ ${e.motivo || 'Sin detalles'}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="bg-${colorClass}-${riesgoNum >= 70 ? '600' : '500'} text-white text-xs px-2 py-1 rounded-full font-bold">${riesgoNum}% Riesgo</span>
                                </div>
                            </div>`;
                    }).join('') + '</div>';
                } catch (err) {
                    container.innerHTML = '<p class="text-center text-gray-400 py-4">No se pudo cargar datos</p>';
                }
            }

            // ========== SPA MATERIA DETALLES ==========
            let currentMateriaId = null;

            async function loadSubjectDetails(id) {
                // Mostrar loading
                Swal.fire({ title: 'Cargando materia...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                try {
                    const res = await fetch(`/api/materia/${id}/details`);
                    if (!res.ok) throw new Error('Error al cargar materia');
                    const data = await res.json();

                    currentMateriaId = id;

                    // Llenar datos de cabecera
                    document.getElementById('materia-titulo').textContent = data.materia.nombre;
                    document.getElementById('materia-desc').textContent = data.materia.descripcion || 'Sin descripci√≥n';

                    // Renderizar Tareas
                    const tareasContainer = document.getElementById('m-tareas-list');
                    if (data.tareas && data.tareas.length > 0) {
                        tareasContainer.innerHTML = data.tareas.map(t => `
                            <div class="p-4 hover:bg-gray-50 flex justify-between items-center group">
                                <div>
                                    <p class="font-medium text-gray-800">${t.titulo}</p>
                                    <p class="text-xs text-gray-500">Vence: ${t.fecha_vencimiento ? new Date(t.fecha_vencimiento).toLocaleDateString() : 'Sin fecha'}</p>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded">${t.entregas_count} Entregas</span>
                                    <button onclick="verEntregas(${t.id})" class="text-gray-400 hover:text-brand-600 transition" title="Ver entregas"><i class="fas fa-eye"></i></button>
                                    <button onclick="editarTarea(${t.id})" class="text-gray-400 hover:text-blue-600 transition" title="Editar"><i class="fas fa-edit"></i></button>
                                    <button onclick="detectarPlagio(${t.id})" class="text-gray-400 hover:text-purple-600 transition" title="Detectar Plagio"><i class="fas fa-search"></i></button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        tareasContainer.innerHTML = '<div class="p-8 text-center text-gray-400">No hay tareas asignadas</div>';
                    }

                    // Renderizar Estudiantes
                    const estContainer = document.getElementById('m-estudiantes-list');
                    if (data.estudiantes && data.estudiantes.length > 0) {
                        estContainer.innerHTML = data.estudiantes.map(e => `
                            <div class="bg-white p-4 rounded-xl shadow-sm border flex flex-col items-center text-center hover:shadow-md transition">
                                <div class="w-16 h-16 rounded-full bg-gray-200 mb-3 overflow-hidden">
                                    <img src="${e.avatar_url || '/static/img/default_avatar.png'}" alt="${e.nombre}" class="w-full h-full object-cover" onerror="this.src='https://ui-avatars.com/api/?name=${e.nombre}&background=random'">
                                </div>
                                <h4 class="font-bold text-gray-800 text-sm truncate w-full" title="${e.nombre}">${e.nombre}</h4>
                                <p class="text-xs text-gray-500 mb-3">${e.numero_control}</p>
                                <button onclick="enviarMensajeA(${e.id}, '${e.nombre}')" class="text-xs bg-brand-50 text-brand-600 px-3 py-1 rounded-full hover:bg-brand-100 font-medium">Mensaje</button>
                            </div>
                        `).join('');
                    } else {
                        estContainer.innerHTML = '<div class="col-span-full py-8 text-center text-gray-400">No hay estudiantes inscritos</div>';
                    }

                    // Renderizar Recursos
                    const recContainer = document.getElementById('m-recursos-list');
                    if (data.recursos && data.recursos.length > 0) {
                        recContainer.innerHTML = data.recursos.map(r => `
                            <div class="bg-white p-4 rounded-xl shadow-sm border hover:border-purple-300 transition group">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="bg-purple-100 p-2 rounded-lg text-purple-600"><i class="fas fa-file-alt"></i></div>
                                    <button class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><i class="fas fa-trash"></i></button>
                                </div>
                                <h4 class="font-medium text-sm truncate" title="${r.titulo}">${r.titulo}</h4>
                                <p class="text-xs text-gray-500 mt-1">${new Date(r.fecha_creacion).toLocaleDateString()}</p>
                                <a href="${r.nombre_archivo ? '/uploads/recursos/' + data.materia.id + '/' + r.nombre_archivo : '#'}" target="_blank" class="block mt-3 text-center bg-gray-50 text-gray-600 text-xs py-2 rounded hover:bg-purple-50 hover:text-purple-600 font-bold transition">Descargar</a>
                            </div>
                        `).join('');
                    } else {
                        recContainer.innerHTML = '<div class="col-span-full py-8 text-center text-gray-400">No hay recursos compartidos</div>';
                    }

                    // Renderizar Evaluaciones (Placeholder)
                    const evalContainer = document.getElementById('m-evaluaciones-list');
                    if (data.evaluaciones && data.evaluaciones.length > 0) {
                        evalContainer.innerHTML = data.evaluaciones.map(ev => `<div>Evaluaci√≥n: ${ev.titulo}</div>`).join('');
                    } else {
                        evalContainer.innerHTML = '<div class="col-span-full py-8 text-center text-gray-400">No hay evaluaciones creadas</div>';
                    }

                    Swal.close();

                    // Mostrar secci√≥n detalles y ocultar dashboard
                    document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active')); // Ocultar todas
                    // Ocultar wrapper principal si fuera necesario, pero aqui usamos content-section
                    // Logica actual: dashboard es una section, materias es otra.
                    // Debemos ocultar la section activa actual y mostrar detalle
                    document.getElementById('section-detalle-materia').classList.add('active'); // Mostrar detalle
                    document.getElementById('section-detalle-materia').classList.remove('hidden'); // Asegurar visible

                } catch (err) {
                    console.error(err);
                    Swal.fire('Error', 'No se pudieron cargar los detalles de la materia', 'error');
                }
            }

            function closeMateriaDetails() {
                document.getElementById('section-detalle-materia').classList.remove('active');
                document.getElementById('section-detalle-materia').classList.add('hidden');
                document.getElementById('section-materias').classList.add('active'); // Volver a la lista de materias
            }

            function switchMateriaTab(tabName) {
                // Update buttons
                document.querySelectorAll('.materia-tab').forEach(b => {
                    if (b.getAttribute('onclick').includes(tabName)) {
                        b.classList.add('active', 'border-brand-500', 'text-brand-600');
                        b.classList.remove('border-transparent', 'text-gray-500');
                    } else {
                        b.classList.remove('active', 'border-brand-500', 'text-brand-600');
                        b.classList.add('border-transparent', 'text-gray-500');
                    }
                });

                // Update content
                document.querySelectorAll('.materia-tab-content').forEach(c => {
                    if (c.id === tabName) {
                        c.classList.remove('hidden');
                        c.classList.add('active');
                    } else {
                        c.classList.add('hidden');
                        c.classList.remove('active');
                    }
                });
            }

            document.addEventListener('DOMContentLoaded', () => {
                window.estudiantesData = {{ estudiantes|tojson }};
                window.materiasData = {{ materias|tojson }};
                cargarRecursos();
                cargarNotificaciones();
                cargarComunicados();
                cargarEvaluaciones();
                cargarReportesStats();
                cargarRetos();
                cargarRankingRetos();
                cargarEstudiantesRiesgo();
                initCalendar();
                cargarTutorias();
                cargarMiHorario();

                const params = new URLSearchParams(window.location.search);
                const panel = params.get('panel') || 'dashboard';
                showSection(panel);
            });
        </script>
</body>

</html>