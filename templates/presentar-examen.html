{% extends "base.html" %}
{% block title %}{{ examen.titulo }} | EduPlatform{% endblock %}
{% block content %}
<div class="min-h-screen bg-gray-100">
    <!-- Header -->
    <div class="bg-white shadow-sm">
        <div class="max-w-4xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">{{ examen.titulo }}</h1>
                    <p class="text-sm text-gray-500">{{ examen.materia_nombre }}</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <p class="text-sm text-gray-500">Tiempo restante</p>
                        <p class="text-2xl font-bold text-brand-600" id="timer">{{ examen.tiempo_limite }}:00</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-500">Pregunta</p>
                        <p class="text-2xl font-bold text-gray-800"><span id="current-q">1</span>/{{ preguntas|length }}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress bar -->
    <div class="bg-gray-200 h-2">
        <div class="bg-brand-500 h-2 transition-all duration-300" id="progress-bar" style="width: 0%"></div>
    </div>

    <!-- Content -->
    <div class="max-w-4xl mx-auto px-6 py-8">
        <form id="examen-form" action="/enviar-examen/{{ respuesta_id }}" method="POST">
            <input type="hidden" name="respuesta_id" value="{{ respuesta_id }}">

            {% for pregunta in preguntas %}
            <div class="question-slide bg-white rounded-xl shadow-sm p-8 mb-6 {% if not loop.first %}hidden{% endif %}"
                data-index="{{ loop.index }}">
                <div class="mb-6">
                    <span class="bg-brand-100 text-brand-700 px-3 py-1 rounded-full text-sm font-medium">
                        Pregunta {{ loop.index }} de {{ preguntas|length }}
                    </span>
                </div>

                <h2 class="text-xl font-semibold text-gray-800 mb-6">{{ pregunta.texto }}</h2>

                <div class="space-y-3">
                    {% set opciones = pregunta.opciones if pregunta.opciones is string else pregunta.opciones %}
                    {% for opcion in opciones %}
                    <label
                        class="flex items-center p-4 border-2 rounded-xl cursor-pointer hover:border-brand-300 hover:bg-brand-50 transition option-label">
                        <input type="radio" name="pregunta_{{ pregunta.id }}" value="{{ loop.index0 }}" class="hidden">
                        <div
                            class="w-8 h-8 border-2 border-gray-300 rounded-full mr-4 flex items-center justify-center option-circle">
                            <span class="text-sm font-semibold">{{ ['A','B','C','D','E'][loop.index0] }}</span>
                        </div>
                        <span class="text-gray-700">{{ opcion }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}

            <!-- Navigation -->
            <div class="flex items-center justify-between">
                <button type="button" onclick="prevQuestion()" id="btn-prev"
                    class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-300 disabled:opacity-50"
                    disabled>
                    <i class="fas fa-arrow-left mr-2"></i>Anterior
                </button>

                <button type="button" onclick="nextQuestion()" id="btn-next"
                    class="bg-brand-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-brand-700">
                    Siguiente<i class="fas fa-arrow-right ml-2"></i>
                </button>

                <button type="submit" id="btn-submit"
                    class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 hidden">
                    <i class="fas fa-paper-plane mr-2"></i>Enviar Examen
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    let currentQuestion = 1;
    const totalQuestions = {{ preguntas| length }};
    let timerSeconds = {{ examen.tiempo_limite }} * 60;

    // Timer
    const timerInterval = setInterval(() => {
        timerSeconds--;
        const mins = Math.floor(timerSeconds / 60);
        const secs = timerSeconds % 60;
        document.getElementById('timer').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

        if (timerSeconds <= 0) {
            clearInterval(timerInterval);
            document.getElementById('examen-form').submit();
        }

        if (timerSeconds <= 60) {
            document.getElementById('timer').classList.add('text-red-600');
        }
    }, 1000);

    function updateUI() {
        document.querySelectorAll('.question-slide').forEach((el, i) => {
            el.classList.toggle('hidden', i + 1 !== currentQuestion);
        });
        document.getElementById('current-q').textContent = currentQuestion;
        document.getElementById('progress-bar').style.width = ((currentQuestion - 1) / totalQuestions * 100) + '%';

        document.getElementById('btn-prev').disabled = currentQuestion === 1;
        document.getElementById('btn-next').classList.toggle('hidden', currentQuestion === totalQuestions);
        document.getElementById('btn-submit').classList.toggle('hidden', currentQuestion !== totalQuestions);
    }

    function nextQuestion() {
        if (currentQuestion < totalQuestions) {
            currentQuestion++;
            updateUI();
        }
    }

    function prevQuestion() {
        if (currentQuestion > 1) {
            currentQuestion--;
            updateUI();
        }
    }

    // Option selection styling
    document.querySelectorAll('.option-label').forEach(label => {
        label.addEventListener('click', function () {
            this.parentElement.querySelectorAll('.option-label').forEach(l => {
                l.classList.remove('border-brand-500', 'bg-brand-50');
                l.querySelector('.option-circle').classList.remove('border-brand-500', 'bg-brand-500', 'text-white');
            });
            this.classList.add('border-brand-500', 'bg-brand-50');
            this.querySelector('.option-circle').classList.add('border-brand-500', 'bg-brand-500', 'text-white');
        });
    });
</script>
{% endblock %}