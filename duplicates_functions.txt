FUNCIONES DUPLICADAS - LÍNEAS EXACTAS
======================================================================


======================================================================
RUTA: /api/teams
======================================================================

--- Instancia 1: api_teams (Línea 1862) ---
L1862: @app.route('/api/teams', methods=['GET', 'POST'])
L1863: def api_teams():
L1864:     if 'user_id' not in session: return jsonify({'error': 'Unauthorized'}), 401
L1865:     cursor = mysql.connection.cursor()
L1866:     if request.method == 'POST':
L1867:         data = request.json
L1868:         action = data.get('action', 'join')
L1869:         
L1870:         if action == 'create':
L1871:             cursor.execute("INSERT INTO equipos_estudio (nombre, materia_id, lider_id) VALUES (%s, %s, %s)",
L1872:                           (data.get('nombre', 'Nuevo Equipo'), data.get('materia_id'), session['user_id']))
L1873:             mysql.connection.commit()
L1874:             team_id = cursor.lastrowid
L1875:             cursor.execute("INSERT INTO miembros_equipo (equipo_id, usuario_id, rol) VALUES (%s, %s, 'lider')",
L1876:                           (team_id, session['user_id']))
...

--- Instancia 2: _old_manage_study_teams (Línea 18295) ---
L18295: # @app.route('/api/teams', methods=['GET', 'POST'])
L18296: # @login_required
L18297: # @role_required('alumno')
L18298: def _old_manage_study_teams():
L18299:     """Get user's teams or create a new one"""
L18300:     if request.method == 'GET':
L18301:         try:
L18302:             cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L18303:             cursor.execute("""
L18304:                 SELECT e.*, COUNT(em.usuario_id) as total_miembros
L18305:                 FROM equipos_estudio e
L18306:                 JOIN equipos_miembros em ON e.id = em.equipo_id
L18307:                 WHERE em.usuario_id = %s AND e.activo = 1
L18308:                 GROUP BY e.id
L18309:             """, (session['user_id'],))
...

--- Instancia 3: get_user_teams (Línea 19646) ---
L19646: @app.route('/api/teams', methods=['GET'])
L19647: @login_required
L19648: def get_user_teams():
L19649:     try:
L19650:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L19651:         cursor.execute("""
L19652:             SELECT e.*, 
L19653:                    (SELECT COUNT(*) FROM miembros_equipo WHERE equipo_id = e.id) as total_miembros 
L19654:             FROM equipos_estudio e
L19655:             JOIN miembros_equipo me ON e.id = me.equipo_id
L19656:             WHERE me.usuario_id = %s
L19657:         """, (session['user_id'],))
L19658:         teams = cursor.fetchall()
L19659:         cursor.close()
L19660:         return jsonify(teams)
...

--- Instancia 4: create_team (Línea 19664) ---
L19664: @app.route('/api/teams', methods=['POST'])
L19665: @login_required
L19666: def create_team():
L19667:     try:
L19668:         data = request.json
L19669:         import random, string
L19670:         codigo = ''.join(random.choices(string.ascii_uppercase + string.digits, k=6))
L19671:         
L19672:         cursor = mysql.connection.cursor()
L19673:         cursor.execute("""
L19674:             INSERT INTO equipos_estudio (nombre, descripcion, codigo_acceso, creador_id) 
L19675:             VALUES (%s, %s, %s, %s)
L19676:         """, (data['nombre'], data.get('descripcion'), codigo, session['user_id']))
L19677:         team_id = cursor.lastrowid
L19678:         
...

--- Instancia 5: alumno_get_teams (Línea 20420) ---
L20420: @app.route('/api/teams', methods=['GET'])
L20421: @login_required
L20422: def alumno_get_teams():
L20423:     """Obtener equipos del usuario"""
L20424:     try:
L20425:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L20426:         cursor.execute("""
L20427:             SELECT e.id, e.nombre, e.descripcion, e.codigo_acceso as codigo,
L20428:                    COUNT(me.usuario_id) as member_count
L20429:             FROM equipos_estudio e
L20430:             JOIN miembros_equipo me ON e.id = me.equipo_id
L20431:             WHERE me.usuario_id = %s OR e.creador_id = %s
L20432:             GROUP BY e.id
L20433:             ORDER BY e.fecha_creacion DESC
L20434:         """, (session['user_id'], session['user_id']))
...

--- Instancia 6: alumno_create_team (Línea 20443) ---
L20443: @app.route('/api/teams', methods=['POST'])
L20444: @login_required
L20445: def alumno_create_team():
L20446:     """Crear equipo de estudio"""
L20447:     try:
L20448:         data = request.get_json()
L20449:         codigo = uuid.uuid4().hex[:8].upper()
L20450:         
L20451:         cursor = mysql.connection.cursor()
L20452:         cursor.execute("""
L20453:             INSERT INTO equipos_estudio (nombre, descripcion, codigo_acceso, creador_id)
L20454:             VALUES (%s, %s, %s, %s)
L20455:         """, (data['nombre'], data.get('descripcion', ''), codigo, session['user_id']))
L20456:         team_id = cursor.lastrowid
L20457:         
...

--- Instancia 7: api_teams_list (Línea 27896) ---
L27896: @app.route('/api/teams', methods=['GET'])
L27897: @login_required
L27898: def api_teams_list():
L27899:     """Listar equipos del alumno"""
L27900:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L27901:     user_id = session['user_id']
L27902:     
L27903:     cursor.execute("""
L27904:         SELECT e.id, e.nombre, e.descripcion, e.codigo_acceso, e.materia_id
L27905:         FROM equipos_estudio e
L27906:         INNER JOIN miembros_equipo m ON e.id = m.equipo_id
L27907:         WHERE m.usuario_id = %s OR m.estudiante_id = %s OR e.creador_id = %s OR e.lider_id = %s
L27908:         GROUP BY e.id
L27909:     """, (user_id, user_id, user_id, user_id))
L27910:     
...

======================================================================
RUTA: /api/portfolio
======================================================================

--- Instancia 1: api_portfolio (Línea 1941) ---
L1941: @app.route('/api/portfolio', methods=['GET', 'POST'])
L1942: def api_portfolio():
L1943:     if 'user_id' not in session: return jsonify({'error': 'Unauthorized'}), 401
L1944:     cursor = mysql.connection.cursor()
L1945:     if request.method == 'POST':
L1946:         # Upload placeholder
L1947:         return jsonify({'status': 'ok'})
L1948:     
L1949:     cursor.execute("SELECT * FROM portafolio_items WHERE usuario_id = %s", (session['user_id'],))
L1950:     items = cursor.fetchall()
L1951:     return jsonify(items)
L1952: 
L1953: @app.route('/api/notifications', methods=['GET'])
L1954: @login_required
L1955: def api_notifications():
...

--- Instancia 2: manage_portfolio (Línea 18378) ---
L18378: @app.route('/api/portfolio', methods=['GET', 'POST'])
L18379: @login_required
L18380: @role_required('alumno')
L18381: def manage_portfolio():
L18382:     """Get portfolio items or add a new one"""
L18383:     if request.method == 'GET':
L18384:         try:
L18385:             cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L18386:             cursor.execute("""
L18387:                 SELECT * FROM portafolio_items 
L18388:                 WHERE usuario_id = %s 
L18389:                 ORDER BY destacado DESC, fecha_creacion DESC
L18390:             """, (session['user_id'],))
L18391:             items = cursor.fetchall()
L18392:             cursor.close()
...

--- Instancia 3: get_portfolio (Línea 19718) ---
L19718: @app.route('/api/portfolio', methods=['GET'])
L19719: @login_required
L19720: def get_portfolio():
L19721:     try:
L19722:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L19723:         cursor.execute("SELECT * FROM portafolio_items WHERE usuario_id = %s ORDER BY fecha_creacion DESC",
L19724:                       (session['user_id'],))
L19725:         items = cursor.fetchall()
L19726:         cursor.close()
L19727:         return jsonify(items)
L19728:     except Exception as e:
L19729:         return jsonify({'error': str(e)}), 500
L19730: 
L19731: @app.route('/api/portfolio', methods=['POST'])
L19732: @login_required
...

--- Instancia 4: add_portfolio_item (Línea 19731) ---
L19731: @app.route('/api/portfolio', methods=['POST'])
L19732: @login_required
L19733: def add_portfolio_item():
L19734:     try:
L19735:         data = request.json
L19736:         cursor = mysql.connection.cursor()
L19737:         cursor.execute("""
L19738:             INSERT INTO portafolio_items (usuario_id, titulo, descripcion, tipo, archivo_url)
L19739:             VALUES (%s, %s, %s, %s, %s)
L19740:         """, (session['user_id'], data['titulo'], data.get('descripcion'), data.get('tipo'), data.get('archivo_url')))
L19741:         mysql.connection.commit()
L19742:         cursor.close()
L19743:         return jsonify({'success': True}), 201
L19744:     except Exception as e:
L19745:         return jsonify({'error': str(e)}), 500
...

--- Instancia 5: alumno_get_portfolio (Línea 20504) ---
L20504: @app.route('/api/portfolio', methods=['GET'])
L20505: @login_required
L20506: def alumno_get_portfolio():
L20507:     """Obtener items del portafolio"""
L20508:     try:
L20509:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L20510:         cursor.execute("""
L20511:             SELECT id, titulo, descripcion, tipo, archivo_url, fecha_creacion
L20512:             FROM portafolio_items
L20513:             WHERE usuario_id = %s
L20514:             ORDER BY fecha_creacion DESC
L20515:         """, (session['user_id'],))
L20516:         items = cursor.fetchall()
L20517:         cursor.close()
L20518:         
...

--- Instancia 6: api_portfolio_list (Línea 27841) ---
L27841: @app.route('/api/portfolio', methods=['GET'])
L27842: @login_required
L27843: def api_portfolio_list():
L27844:     """Listar items del portafolio del alumno"""
L27845:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L27846:     user_id = session['user_id']
L27847:     
L27848:     cursor.execute("""
L27849:         SELECT id, titulo, descripcion, tipo as tipo, archivo_url as archivo_ruta, 
L27850:                fecha_creacion as fecha_subida
L27851:         FROM portafolio_items 
L27852:         WHERE usuario_id = %s 
L27853:         ORDER BY fecha_creacion DESC
L27854:     """, (user_id,))
L27855:     
...

======================================================================
RUTA: /api/notes
======================================================================

--- Instancia 1: manage_notes (Línea 18105) ---
L18105: @app.route('/api/notes', methods=['GET', 'POST'])
L18106: @login_required
L18107: @role_required('alumno')
L18108: def manage_notes():
L18109:     """Get all notes or create a new one"""
L18110:     if request.method == 'GET':
L18111:         try:
L18112:             cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L18113:             materia_id = request.args.get('materia_id')
L18114:             
L18115:             sql = "SELECT * FROM notas_personales WHERE usuario_id = %s"
L18116:             params = [session['user_id']]
L18117:             
L18118:             if materia_id:
L18119:                 sql += " AND materia_id = %s"
...

--- Instancia 2: get_notes (Línea 19577) ---
L19577: @app.route('/api/notes', methods=['GET'])
L19578: @login_required
L19579: def get_notes():
L19580:     """Obtener notas del usuario (alias para whiteboard)"""
L19581:     return get_whiteboards()
L19582: 
L19583: @app.route('/api/notes', methods=['POST'])
L19584: @login_required
L19585: def create_note():
L19586:     """Crear nota (alias para whiteboard)"""
L19587:     return create_personal_whiteboard()
L19588: 
L19589: @app.route('/api/notes/<int:note_id>', methods=['DELETE'])
L19590: @login_required
L19591: def delete_note(note_id):
...

--- Instancia 3: create_note (Línea 19583) ---
L19583: @app.route('/api/notes', methods=['POST'])
L19584: @login_required
L19585: def create_note():
L19586:     """Crear nota (alias para whiteboard)"""
L19587:     return create_personal_whiteboard()
L19588: 
L19589: @app.route('/api/notes/<int:note_id>', methods=['DELETE'])
L19590: @login_required
L19591: def delete_note(note_id):
L19592:     """Eliminar nota"""
L19593:     return delete_whiteboard(note_id)
L19594: 
L19595: 
L19596: # ==================== FLASHCARDS API ====================
L19597: 
...

--- Instancia 4: alumno_get_notes (Línea 20213) ---
L20213: @app.route('/api/notes', methods=['GET'])
L20214: @login_required
L20215: def alumno_get_notes():
L20216:     """Obtener notas del usuario"""
L20217:     try:
L20218:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L20219:         cursor.execute("""
L20220:             SELECT id, titulo, contenido_json as contenido, color, fecha_creacion, fecha_modificacion
L20221:             FROM notas_pizarron
L20222:             WHERE usuario_id = %s
L20223:             ORDER BY fecha_modificacion DESC
L20224:         """, (session['user_id'],))
L20225:         notes = cursor.fetchall()
L20226:         cursor.close()
L20227:         
...

--- Instancia 5: alumno_create_note (Línea 20239) ---
L20239: @app.route('/api/notes', methods=['POST'])
L20240: @login_required
L20241: def alumno_create_note():
L20242:     """Crear nueva nota"""
L20243:     try:
L20244:         data = request.get_json()
L20245:         cursor = mysql.connection.cursor()
L20246:         cursor.execute("""
L20247:             INSERT INTO notas_pizarron (usuario_id, titulo, contenido_json, color)
L20248:             VALUES (%s, %s, %s, %s)
L20249:         """, (session['user_id'], data['titulo'], data.get('contenido', ''), data.get('color', '#3b82f6')))
L20250:         mysql.connection.commit()
L20251:         note_id = cursor.lastrowid
L20252:         cursor.close()
L20253:         
...

--- Instancia 6: api_notes (Línea 27949) ---
L27949: @app.route('/api/notes', methods=['GET', 'POST'])
L27950: @login_required
L27951: def api_notes():
L27952:     """Listar o crear notas de clase"""
L27953:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L27954:     user_id = session['user_id']
L27955:     
L27956:     if request.method == 'POST':
L27957:         data = request.json
L27958:         titulo = data.get('titulo', 'Nota sin título')
L27959:         contenido = data.get('contenido', '')
L27960:         color = data.get('color', '#fef3c7')
L27961:         
L27962:         cursor.execute("""
L27963:             INSERT INTO notas_pizarron (usuario_id, titulo, contenido_json, color)
...

======================================================================
RUTA: /api/notes/<int:note_id>
======================================================================

--- Instancia 1: update_delete_note (Línea 18148) ---
L18148: @app.route('/api/notes/<int:note_id>', methods=['PUT', 'DELETE'])
L18149: @login_required
L18150: @role_required('alumno')
L18151: def update_delete_note(note_id):
L18152:     """Update or delete a specific note"""
L18153:     if request.method == 'PUT':
L18154:         try:
L18155:             data = request.json
L18156:             cursor = mysql.connection.cursor()
L18157:             cursor.execute("""
L18158:                 UPDATE notas_personales 
L18159:                 SET titulo=%s, contenido=%s, color=%s, favorito=%s
L18160:                 WHERE id=%s AND usuario_id=%s
L18161:             """, (data.get('titulo'), data.get('contenido'), data.get('color'), 
L18162:                   data.get('favorito', 0), note_id, session['user_id']))
...

--- Instancia 2: delete_note (Línea 19589) ---
L19589: @app.route('/api/notes/<int:note_id>', methods=['DELETE'])
L19590: @login_required
L19591: def delete_note(note_id):
L19592:     """Eliminar nota"""
L19593:     return delete_whiteboard(note_id)
L19594: 
L19595: 
L19596: # ==================== FLASHCARDS API ====================
L19597: 
L19598: @app.route('/api/flashcards/mazos', methods=['GET'])
L19599: @login_required
L19600: def get_flashcard_decks():
L19601:     try:
L19602:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L19603:         cursor.execute("""
...

--- Instancia 3: alumno_get_note (Línea 20258) ---
L20258: @app.route('/api/notes/<int:note_id>', methods=['GET'])
L20259: @login_required
L20260: def alumno_get_note(note_id):
L20261:     """Obtener nota específica"""
L20262:     try:
L20263:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L20264:         cursor.execute("""
L20265:             SELECT id, titulo, contenido_json as contenido, color
L20266:             FROM notas_pizarron
L20267:             WHERE id = %s AND usuario_id = %s
L20268:         """, (note_id, session['user_id']))
L20269:         note = cursor.fetchone()
L20270:         cursor.close()
L20271:         
L20272:         if note:
...

--- Instancia 4: alumno_update_note (Línea 20278) ---
L20278: @app.route('/api/notes/<int:note_id>', methods=['PUT'])
L20279: @login_required
L20280: def alumno_update_note(note_id):
L20281:     """Actualizar nota"""
L20282:     try:
L20283:         data = request.get_json()
L20284:         cursor = mysql.connection.cursor()
L20285:         cursor.execute("""
L20286:             UPDATE notas_pizarron 
L20287:             SET titulo = %s, contenido_json = %s, color = %s
L20288:             WHERE id = %s AND usuario_id = %s
L20289:         """, (data['titulo'], data.get('contenido', ''), data.get('color', '#3b82f6'), note_id, session['user_id']))
L20290:         mysql.connection.commit()
L20291:         cursor.close()
L20292:         
...

--- Instancia 5: alumno_delete_note (Línea 20297) ---
L20297: @app.route('/api/notes/<int:note_id>', methods=['DELETE'])
L20298: @login_required
L20299: def alumno_delete_note(note_id):
L20300:     """Eliminar nota"""
L20301:     try:
L20302:         cursor = mysql.connection.cursor()
L20303:         cursor.execute("DELETE FROM notas_pizarron WHERE id = %s AND usuario_id = %s", (note_id, session['user_id']))
L20304:         mysql.connection.commit()
L20305:         cursor.close()
L20306:         
L20307:         return jsonify({'success': True})
L20308:     except Exception as e:
L20309:         return jsonify({'success': False, 'error': str(e)}), 500
L20310: 
L20311: # ==================== FLASHCARDS API ====================
...

--- Instancia 6: api_notes_detail (Línea 27980) ---
L27980: @app.route('/api/notes/<int:note_id>', methods=['GET', 'PUT', 'DELETE'])
L27981: @login_required
L27982: def api_notes_detail(note_id):
L27983:     """Ver, actualizar o eliminar nota específica"""
L27984:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L27985:     user_id = session['user_id']
L27986:     
L27987:     if request.method == 'GET':
L27988:         cursor.execute("""
L27989:             SELECT id, titulo, contenido_json as contenido, color, fecha_creacion
L27990:             FROM notas_pizarron 
L27991:             WHERE id = %s AND usuario_id = %s
L27992:         """, (note_id, user_id))
L27993:         note = cursor.fetchone()
L27994:         if not note:
...

======================================================================
RUTA: /api/flashcards/mazos
======================================================================

--- Instancia 1: _old_manage_mazos (Línea 18184) ---
L18184: # @app.route('/api/flashcards/mazos', methods=['GET', 'POST'])
L18185: # @login_required
L18186: # @role_required('alumno')
L18187: def _old_manage_mazos():
L18188:     """Get all decks or create a new one"""
L18189:     if request.method == 'GET':
L18190:         try:
L18191:             cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L18192:             cursor.execute("""
L18193:                 SELECT m.*, COUNT(f.id) as total_tarjetas
L18194:                 FROM flashcards_mazos m
L18195:                 LEFT JOIN flashcards f ON m.id = f.mazo_id
L18196:                 WHERE m.usuario_id = %s
L18197:                 GROUP BY m.id
L18198:                 ORDER BY m.fecha_creacion DESC
...

--- Instancia 2: get_flashcard_decks (Línea 19598) ---
L19598: @app.route('/api/flashcards/mazos', methods=['GET'])
L19599: @login_required
L19600: def get_flashcard_decks():
L19601:     try:
L19602:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L19603:         cursor.execute("""
L19604:             SELECT m.*, COUNT(t.id) as total_tarjetas 
L19605:             FROM flashcard_mazos m 
L19606:             LEFT JOIN flashcard_tarjetas t ON m.id = t.mazo_id 
L19607:             WHERE m.usuario_id = %s 
L19608:             GROUP BY m.id
L19609:         """, (session['user_id'],))
L19610:         decks = cursor.fetchall()
L19611:         
L19612:         # Ensure 'total_tarjetas' key exists for frontend
...

--- Instancia 3: create_flashcard_deck (Línea 19627) ---
L19627: @app.route('/api/flashcards/mazos', methods=['POST'])
L19628: @login_required
L19629: def create_flashcard_deck():
L19630:     try:
L19631:         data = request.json
L19632:         if not data.get('nombre'):
L19633:             return jsonify({'error': 'Nombre requerido'}), 400
L19634:             
L19635:         cursor = mysql.connection.cursor()
L19636:         cursor.execute("INSERT INTO flashcard_mazos (usuario_id, nombre, descripcion) VALUES (%s, %s, %s)",
L19637:                       (session['user_id'], data['nombre'], data.get('descripcion')))
L19638:         mysql.connection.commit()
L19639:         cursor.close()
L19640:         return jsonify({'success': True}), 201
L19641:     except Exception as e:
...

--- Instancia 4: alumno_get_flashcard_decks (Línea 20312) ---
L20312: @app.route('/api/flashcards/mazos', methods=['GET'])
L20313: @login_required
L20314: def alumno_get_flashcard_decks():
L20315:     """Obtener mazos de flashcards"""
L20316:     try:
L20317:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L20318:         cursor.execute("""
L20319:             SELECT m.id, m.nombre, m.descripcion, m.fecha_creacion,
L20320:                    COUNT(t.id) as card_count
L20321:             FROM flashcard_mazos m
L20322:             LEFT JOIN flashcard_tarjetas t ON m.id = t.mazo_id
L20323:             WHERE m.usuario_id = %s
L20324:             GROUP BY m.id
L20325:             ORDER BY m.fecha_creacion DESC
L20326:         """, (session['user_id'],))
...

--- Instancia 5: alumno_create_flashcard_deck (Línea 20339) ---
L20339: @app.route('/api/flashcards/mazos', methods=['POST'])
L20340: @login_required
L20341: def alumno_create_flashcard_deck():
L20342:     """Crear mazo de flashcards"""
L20343:     try:
L20344:         data = request.get_json()
L20345:         cursor = mysql.connection.cursor()
L20346:         cursor.execute("""
L20347:             INSERT INTO flashcard_mazos (usuario_id, nombre, descripcion)
L20348:             VALUES (%s, %s, %s)
L20349:         """, (session['user_id'], data['nombre'], data.get('descripcion', '')))
L20350:         mysql.connection.commit()
L20351:         deck_id = cursor.lastrowid
L20352:         cursor.close()
L20353:         
...

--- Instancia 6: api_flashcards_mazos (Línea 27754) ---
L27754: @app.route('/api/flashcards/mazos', methods=['GET', 'POST'])
L27755: @login_required
L27756: def api_flashcards_mazos():
L27757:     """Listar o crear mazos de flashcards del alumno"""
L27758:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L27759:     user_id = session['user_id']
L27760:     
L27761:     if request.method == 'POST':
L27762:         data = request.json
L27763:         nombre = data.get('nombre', 'Mazo sin nombre')
L27764:         descripcion = data.get('descripcion', '')
L27765:         
L27766:         cursor.execute("""
L27767:             INSERT INTO flashcard_mazos (usuario_id, nombre, descripcion)
L27768:             VALUES (%s, %s, %s)
...

======================================================================
RUTA: /api/calendar/events
======================================================================

--- Instancia 1: get_calendar_events_v1 (Línea 19095) ---
L19095: @app.route('/api/calendar/events', methods=['GET'])
L19096: @login_required
L19097: def get_calendar_events_v1():
L19098:     """Obtener eventos del calendario del alumno"""
L19099:     try:
L19100:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L19101:         user_id = session['user_id']
L19102:         
L19103:         # Obtener mes y año del query param (default: actual)
L19104:         month = request.args.get('month', datetime.now().month, type=int)
L19105:         year = request.args.get('year', datetime.now().year, type=int)
L19106:         
L19107:         # Eventos personales del alumno
L19108:         cursor.execute("""
L19109:             SELECT id, titulo as title, descripcion as description, 
...

--- Instancia 2: create_calendar_event_v1 (Línea 19170) ---
L19170: @app.route('/api/calendar/events', methods=['POST'])
L19171: @login_required
L19172: def create_calendar_event_v1():
L19173:     """Crear evento personal en el calendario"""
L19174:     try:
L19175:         data = request.get_json()
L19176:         cursor = mysql.connection.cursor()
L19177:         
L19178:         cursor.execute("""
L19179:             INSERT INTO eventos_personales (usuario_id, titulo, descripcion, fecha)
L19180:             VALUES (%s, %s, %s, %s)
L19181:         """, (session['user_id'], data['titulo'], data.get('descripcion', ''), data['fecha']))
L19182:         
L19183:         mysql.connection.commit()
L19184:         event_id = cursor.lastrowid
...

--- Instancia 3: get_calendar_events (Línea 19749) ---
L19749: # @app.route('/api/calendar/events', methods=['GET'])
L19750: # @login_required
L19751: # def get_calendar_events():
L19752: #     """Obtener eventos del calendario del alumno (tareas, exámenes, eventos personales)"""
L19753: #     try:
L19754: #         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L19755: #         user_id = session['user_id']
L19756: #         
L19757: #         # Obtener semestre del alumno
L19758: #         cursor.execute("SELECT semestre FROM usuarios WHERE id = %s", (user_id,))
L19759: #         user = cursor.fetchone()
L19760: #         semestre = user['semestre'] if user else None
L19761: #         
L19762: #         events = []
L19763: #         
...

--- Instancia 4: create_calendar_event (Línea 19827) ---
L19827: # @app.route('/api/calendar/events', methods=['POST'])
L19828: # @login_required
L19829: # def create_calendar_event():
L19830: #     """Crear evento personal en el calendario"""
L19831: #     try:
L19832: #         data = request.json
L19833: #         cursor = mysql.connection.cursor()
L19834: #         
L19835: #         # Crear tabla si no existe
L19836: #         cursor.execute("""
L19837: #             CREATE TABLE IF NOT EXISTS eventos_personales (
L19838: #                 id INT AUTO_INCREMENT PRIMARY KEY,
L19839: #                 usuario_id INT NOT NULL,
L19840: #                 titulo VARCHAR(255) NOT NULL,
L19841: #                 descripcion TEXT,
...

--- Instancia 5: alumno_get_calendar_events (Línea 20136) ---
L20136: @app.route('/api/calendar/events', methods=['GET'])
L20137: @login_required
L20138: def alumno_get_calendar_events():
L20139:     """Obtener eventos del calendario para el alumno"""
L20140:     try:
L20141:         user_id = session['user_id']
L20142:         month = request.args.get('month', datetime.now().month, type=int)
L20143:         year = request.args.get('year', datetime.now().year, type=int)
L20144:         
L20145:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L20146:         
L20147:         # Obtener eventos personales
L20148:         cursor.execute("""
L20149:             SELECT id, titulo as title, fecha as date, 'evento' as type, completado
L20150:             FROM eventos_personales
...

--- Instancia 6: alumno_create_calendar_event (Línea 20191) ---
L20191: @app.route('/api/calendar/events', methods=['POST'])
L20192: @login_required
L20193: def alumno_create_calendar_event():
L20194:     """Crear evento personal"""
L20195:     try:
L20196:         data = request.get_json()
L20197:         user_id = session['user_id']
L20198:         
L20199:         cursor = mysql.connection.cursor()
L20200:         cursor.execute("""
L20201:             INSERT INTO eventos_personales (usuario_id, titulo, descripcion, fecha)
L20202:             VALUES (%s, %s, %s, %s)
L20203:         """, (user_id, data['titulo'], data.get('descripcion', ''), data['fecha']))
L20204:         mysql.connection.commit()
L20205:         event_id = cursor.lastrowid
...

======================================================================
RUTA: /api/notifications
======================================================================

--- Instancia 1: api_notifications (Línea 1953) ---
L1953: @app.route('/api/notifications', methods=['GET'])
L1954: @login_required
L1955: def api_notifications():
L1956:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L1957:     # Get unread messages count + active alerts
L1958:     cursor.execute("SELECT COUNT(*) as count FROM mensajes WHERE destinatario_id = %s AND leido = 0", (session['user_id'],))
L1959:     msg_count = cursor.fetchone()['count']
L1960:     return jsonify({'count': msg_count})
L1961: 
L1962: @app.route('/api/chat/gemini', methods=['POST'])
L1963: @login_required
L1964: def api_chat_gemini():
L1965:     data = request.json
L1966:     user_msg = data.get('message', '')
L1967:     if not user_msg: return jsonify({'error': 'Empty message'}), 400
...

--- Instancia 2: get_notifications (Línea 19230) ---
L19230: @app.route('/api/notifications', methods=['GET'])
L19231: @login_required
L19232: def get_notifications():
L19233:     """Obtener notificaciones del alumno"""
L19234:     try:
L19235:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L19236:         user_id = session['user_id']
L19237:         
L19238:         # Obtener notificaciones de la tabla
L19239:         cursor.execute("""
L19240:             SELECT id, tipo, titulo, contenido, enlace, leida, fecha_creacion
L19241:             FROM notificaciones_alumno
L19242:             WHERE usuario_id = %s
L19243:             ORDER BY fecha_creacion DESC
L19244:             LIMIT 20
...

--- Instancia 3: alumno_get_notifications (Línea 20595) ---
L20595: @app.route('/api/notifications', methods=['GET'])
L20596: @login_required
L20597: def alumno_get_notifications():
L20598:     """Obtener notificaciones del usuario"""
L20599:     try:
L20600:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L20601:         cursor.execute("""
L20602:             SELECT id, tipo, titulo, contenido, enlace, leida, fecha_creacion as fecha
L20603:             FROM notificaciones_alumno
L20604:             WHERE usuario_id = %s
L20605:             ORDER BY fecha_creacion DESC
L20606:             LIMIT 20
L20607:         """, (session['user_id'],))
L20608:         notifications = cursor.fetchall()
L20609:         
...

--- Instancia 4: api_notifications (Línea 28057) ---
L28057: @app.route('/api/notifications', methods=['GET'])
L28058: @login_required
L28059: def api_notifications():
L28060:     """Obtener conteo de notificaciones no leídas"""
L28061:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L28062:     user_id = session['user_id']
L28063:     
L28064:     count = 0
L28065:     
L28066:     # Contar mensajes no leídos
L28067:     cursor.execute("SELECT COUNT(*) as cnt FROM mensajes WHERE destinatario_id = %s AND leido = 0", (user_id,))
L28068:     result = cursor.fetchone()
L28069:     count += result['cnt'] if result else 0
L28070:     
L28071:     # Contar notificaciones de alumno no leídas
...

======================================================================
RUTA: /api/orientador/reportes
======================================================================

--- Instancia 1: api_orientador_reportes (Línea 3817) ---
L3817: @app.route('/api/orientador/reportes', methods=['GET', 'POST'])
L3818: @login_required
L3819: @role_required('orientador')
L3820: def api_orientador_reportes():
L3821:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L3822:     if request.method == 'POST':
L3823:         data = request.json
L3824:         cursor.execute("""
L3825:             INSERT INTO reportes_institucionales (orientador_id, tipo_reporte, titulo, periodo_inicio, periodo_fin, formato)
L3826:             VALUES (%s, %s, %s, %s, %s, %s)
L3827:         """, (session['user_id'], data['tipo_reporte'], data['titulo'], data.get('periodo_inicio'), data.get('periodo_fin'), data.get('formato', 'pdf')))
L3828:         mysql.connection.commit()
L3829:         reporte_id = cursor.lastrowid
L3830:         _generar_reporte_institucional(reporte_id)
L3831:         return jsonify({'status': 'ok', 'id': reporte_id})
...

--- Instancia 2: listar_reportes_conducta (Línea 6414) ---
L6414: @app.route('/api/orientador/reportes', methods=['GET'])
L6415: @login_required
L6416: @role_required('orientador')
L6417: def listar_reportes_conducta():
L6418:     """Listar reportes de conducta del orientador"""
L6419:     try:
L6420:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L6421:         tipo = request.args.get('tipo', '')
L6422:         alumno_id = request.args.get('alumno_id', '')
L6423:         
L6424:         sql = """
L6425:             SELECT rc.*, u.nombre as alumno_nombre, u.numero_control, u.semestre
L6426:             FROM reportes_conducta rc
L6427:             JOIN usuarios u ON rc.alumno_id = u.id
L6428:             WHERE rc.orientador_id = %s
...

--- Instancia 3: crear_reporte_conducta (Línea 6936) ---
L6936: @app.route('/api/orientador/reportes', methods=['POST'])
L6937: @login_required
L6938: @role_required('orientador')
L6939: def crear_reporte_conducta():
L6940:     """Crear un nuevo reporte de conducta con posible evidencia"""
L6941:     try:
L6942:         # Puede venir como form-data si hay archivo o como JSON
L6943:         if request.content_type and 'multipart/form-data' in request.content_type:
L6944:             alumno_id = request.form.get('alumno_id')
L6945:             tipo = request.form.get('tipo')
L6946:             descripcion = request.form.get('descripcion')
L6947:             evidencia = request.files.get('evidencia')
L6948:         else:
L6949:             data = request.json or {}
L6950:             alumno_id = data.get('alumno_id')
...

--- Instancia 4: orientador_historial_reportes (Línea 22465) ---
L22465: @app.route('/api/orientador/reportes', methods=['GET'])
L22466: @login_required
L22467: @role_required('orientador')
L22468: def orientador_historial_reportes():
L22469:     """Obtener historial de reportes de conducta"""
L22470:     try:
L22471:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L22472:         
L22473:         # Obtener reportes creados por este orientador
L22474:         cursor.execute("""
L22475:             SELECT r.id, r.tipo, r.descripcion, r.fecha, u.nombre as alumno_nombre, u.numero_control
L22476:             FROM reportes_conducta r
L22477:             JOIN usuarios u ON r.alumno_id = u.id
L22478:             WHERE r.orientador_id = %s
L22479:             ORDER BY r.fecha DESC
...

======================================================================
RUTA: /api/tutor/citas
======================================================================

--- Instancia 1: api_tutor_citas (Línea 4284) ---
L4284: @app.route('/api/tutor/citas', methods=['GET', 'POST'])
L4285: @login_required
L4286: @role_required('tutor')
L4287: def api_tutor_citas():
L4288:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L4289:     if request.method == 'POST':
L4290:         data = request.json
L4291:         cursor.execute("""
L4292:             INSERT INTO citas_tutor (tutor_id, alumno_id, tipo_cita, con_quien_tipo, con_quien_id, fecha_cita, duracion_minutos, lugar, modalidad, motivo)
L4293:             VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
L4294:         """, (session['user_id'], data['alumno_id'], data['tipo_cita'], data['con_quien_tipo'], data['con_quien_id'],
L4295:               data['fecha_cita'], data.get('duracion_minutos', 30), data.get('lugar'), data.get('modalidad', 'presencial'), data.get('motivo')))
L4296:         mysql.connection.commit()
L4297:         return jsonify({'status': 'ok', 'id': cursor.lastrowid})
L4298:     cursor.execute("SELECT ct.*, u.nombre as alumno_nombre FROM citas_tutor ct JOIN usuarios u ON ct.alumno_id = u.id WHERE ct.tutor_id = %s ORDER BY ct.fecha_cita DESC LIMIT 30", (session['user_id'],))
...

--- Instancia 2: tutor_citas (Línea 7219) ---
L7219: @app.route('/api/tutor/citas', methods=['GET', 'POST'])
L7220: @login_required
L7221: @role_required('tutor')
L7222: def tutor_citas():
L7223:     """Gestión de citas para el tutor"""
L7224:     try:
L7225:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L7226:         
L7227:         if request.method == 'POST':
L7228:             data = request.json
L7229:             
L7230:             tipo = data.get('type', '').lower()
L7231:             
L7232:             if 'orientador' in tipo:
L7233:                 cursor.execute("SELECT id FROM usuarios WHERE tipo_usuario = 'orientador' LIMIT 1")
...

--- Instancia 3: tutor_citas_v2 (Línea 22533) ---
L22533: @app.route('/api/tutor/citas', methods=['GET', 'POST'])
L22534: @login_required
L22535: @role_required('tutor')
L22536: def tutor_citas_v2():
L22537:     """Gestionar citas con personal escolar"""
L22538:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L22539:     
L22540:     if request.method == 'POST':
L22541:         try:
L22542:             data = request.json
L22543:             motivo = data.get('motivo')
L22544:             personal_id = data.get('personal_id') # ID de docente u orientador
L22545:             fecha_solicitada = data.get('fecha')
L22546:             
L22547:             if not all([motivo, personal_id, fecha_solicitada]):
...

--- Instancia 4: api_tutor_citas_alias (Línea 28117) ---
L28117: @app.route('/api/tutor/citas', methods=['GET', 'POST'])
L28118: @login_required
L28119: def api_tutor_citas_alias():
L28120:     """Alias de citas - redirige según el rol"""
L28121:     if session.get('user_role') == 'tutor':
L28122:         # Ya está manejado por api_tutor_citas en el módulo tutor
L28123:         pass
L28124:     # Para alumnos, usar la API de alumno
L28125:     return api_alumno_tutorias()
L28126: 
L28127: 
L28128: # ============ 8. ENTREGA DE TAREAS API ============
L28129: 
L28130: @app.route('/api/alumno/entregar-tarea', methods=['POST'])
L28131: @login_required
...

======================================================================
RUTA: /api/flashcards/mazos/<int:mazo_id>/cards
======================================================================

--- Instancia 1: _old_manage_flashcards (Línea 18225) ---
L18225: # @app.route('/api/flashcards/mazos/<int:mazo_id>/cards', methods=['GET', 'POST'])
L18226: # @login_required
L18227: # @role_required('alumno')
L18228: def _old_manage_flashcards(mazo_id):
L18229:     """Get all cards in a deck or add a new card"""
L18230:     if request.method == 'GET':
L18231:         try:
L18232:             cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L18233:             cursor.execute("SELECT * FROM flashcards WHERE mazo_id = %s ORDER BY fecha_creacion", 
L18234:                          (mazo_id,))
L18235:             cards = cursor.fetchall()
L18236:             cursor.close()
L18237:             
L18238:             return jsonify(cards), 200
L18239:         except Exception as e:
...

--- Instancia 2: alumno_get_flashcard_cards (Línea 20358) ---
L20358: @app.route('/api/flashcards/mazos/<int:mazo_id>/cards', methods=['GET'])
L20359: @login_required
L20360: def alumno_get_flashcard_cards(mazo_id):
L20361:     """Obtener tarjetas de un mazo"""
L20362:     try:
L20363:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L20364:         cursor.execute("""
L20365:             SELECT t.id, t.pregunta, t.respuesta, t.estado
L20366:             FROM flashcard_tarjetas t
L20367:             JOIN flashcard_mazos m ON t.mazo_id = m.id
L20368:             WHERE t.mazo_id = %s AND m.usuario_id = %s
L20369:             ORDER BY t.id ASC
L20370:         """, (mazo_id, session['user_id']))
L20371:         cards = cursor.fetchall()
L20372:         cursor.close()
...

--- Instancia 3: alumno_create_flashcard_card (Línea 20378) ---
L20378: @app.route('/api/flashcards/mazos/<int:mazo_id>/cards', methods=['POST'])
L20379: @login_required
L20380: def alumno_create_flashcard_card(mazo_id):
L20381:     """Crear tarjeta en mazo"""
L20382:     try:
L20383:         data = request.get_json()
L20384:         cursor = mysql.connection.cursor()
L20385:         cursor.execute("""
L20386:             INSERT INTO flashcard_tarjetas (mazo_id, pregunta, respuesta)
L20387:             VALUES (%s, %s, %s)
L20388:         """, (mazo_id, data['pregunta'], data['respuesta']))
L20389:         mysql.connection.commit()
L20390:         card_id = cursor.lastrowid
L20391:         cursor.close()
L20392:         
...

--- Instancia 4: api_flashcards_cards (Línea 27784) ---
L27784: @app.route('/api/flashcards/mazos/<int:mazo_id>/cards', methods=['GET', 'POST'])
L27785: @login_required
L27786: def api_flashcards_cards(mazo_id):
L27787:     """Listar o agregar tarjetas a un mazo"""
L27788:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L27789:     user_id = session['user_id']
L27790:     
L27791:     # Verificar que el mazo pertenece al usuario
L27792:     cursor.execute("SELECT id FROM flashcard_mazos WHERE id = %s AND usuario_id = %s", (mazo_id, user_id))
L27793:     if not cursor.fetchone():
L27794:         return jsonify({'error': 'Mazo no encontrado'}), 404
L27795:     
L27796:     if request.method == 'POST':
L27797:         data = request.json
L27798:         pregunta = data.get('pregunta', '')
...

======================================================================
RUTA: /api/portfolio/upload
======================================================================

--- Instancia 1: api_portfolio_upload (Línea 2003) ---
L2003: @app.route('/api/portfolio/upload', methods=['POST'])
L2004: @login_required
L2005: def api_portfolio_upload():
L2006:     if 'file' not in request.files: return jsonify({'error': 'No file'}), 400
L2007:     file = request.files['file']
L2008:     if file.filename == '': return jsonify({'error': 'Empty'}), 400
L2009:     
L2010:     if file and allowed_file(file.filename):
L2011:         filename = secure_filename(f"{session['user_id']}_{int(time.time())}_{file.filename}")
L2012:         path = os.path.join(app.config['UPLOAD_FOLDER'], filename)
L2013:         file.save(path)
L2014:         
L2015:         # Guardar en DB con metadatos reales
L2016:         titulo = request.form.get('nombre', file.filename)
L2017:         materia = request.form.get('materia', 'General')
...

--- Instancia 2: upload_portfolio_file (Línea 18415) ---
L18415: @app.route('/api/portfolio/upload', methods=['POST'])
L18416: @login_required
L18417: @role_required('alumno')
L18418: def upload_portfolio_file():
L18419:     """Subir archivo al portafolio con FormData"""
L18420:     try:
L18421:         titulo = request.form.get('titulo', 'Sin título')
L18422:         descripcion = request.form.get('descripcion', '')
L18423:         tipo = request.form.get('tipo', 'otro')
L18424:         
L18425:         if 'archivo' not in request.files:
L18426:             return jsonify({'error': 'No se envió archivo'}), 400
L18427:         
L18428:         archivo = request.files['archivo']
L18429:         if archivo.filename == '':
...

--- Instancia 3: api_portfolio_upload (Línea 27860) ---
L27860: @app.route('/api/portfolio/upload', methods=['POST'])
L27861: @login_required
L27862: def api_portfolio_upload():
L27863:     """Subir archivo al portafolio"""
L27864:     user_id = session['user_id']
L27865:     
L27866:     if 'file' not in request.files:
L27867:         return jsonify({'error': 'No se envió archivo'}), 400
L27868:     
L27869:     file = request.files['file']
L27870:     nombre = request.form.get('nombre', file.filename)
L27871:     materia = request.form.get('materia', '')
L27872:     
L27873:     if file.filename == '':
L27874:         return jsonify({'error': 'Nombre de archivo vacío'}), 400
...

======================================================================
RUTA: /api/tutor/comunicados
======================================================================

--- Instancia 1: api_tutor_comunicados (Línea 2086) ---
L2086: @app.route('/api/tutor/comunicados', methods=['GET'])
L2087: @login_required
L2088: @role_required('tutor')
L2089: def api_tutor_comunicados():
L2090:     # Retorna avisos dirigidos a 'tutor' o generales
L2091:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L2092:     cursor.execute("SELECT * FROM recordatorios WHERE tipo='aviso' AND (destinatario_grupo='tutor' OR destinatario_grupo='general') ORDER BY fecha_recordatorio DESC LIMIT 10")
L2093:     return jsonify(cursor.fetchall())
L2094: 
L2095: 
L2096: @app.route('/api/tutor/autorizar', methods=['POST'])
L2097: @login_required
L2098: @role_required('tutor')
L2099: def api_tutor_autorizar():
L2100:     data = request.json
...

--- Instancia 2: tutor_comunicados (Línea 7346) ---
L7346: @app.route('/api/tutor/comunicados', methods=['GET'])
L7347: @login_required
L7348: @role_required('tutor')
L7349: def tutor_comunicados():
L7350:     """Listar comunicados oficiales"""
L7351:     try:
L7352:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L7353:         cursor.execute("""
L7354:             SELECT id, titulo, contenido, fecha_publicacion, tipo
L7355:             FROM comunicados
L7356:             WHERE activo = 1
L7357:             ORDER BY fecha_publicacion DESC
L7358:             LIMIT 20
L7359:         """)
L7360:         comunicados = cursor.fetchall()
...

--- Instancia 3: tutor_comunicados_v2 (Línea 22511) ---
L22511: @app.route('/api/tutor/comunicados', methods=['GET'])
L22512: @login_required
L22513: @role_required('tutor')
L22514: def tutor_comunicados_v2():
L22515:     """Obtener comunicados oficiales"""
L22516:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L22517:     # Comunicados generales o para tutores
L22518:     cursor.execute("""
L22519:         SELECT * FROM comunicados 
L22520:         WHERE destinatario IN ('todos', 'tutores') 
L22521:         ORDER BY fecha_publicacion DESC LIMIT 20
L22522:     """)
L22523:     comunicados = cursor.fetchall()
L22524:     
L22525:     # Formatear fechas
...

======================================================================
RUTA: /api/buscar_alumnos
======================================================================

--- Instancia 1: api_buscar_alumnos (Línea 2114) ---
L2114: @app.route('/api/buscar_alumnos', methods=['GET'])
L2115: @login_required
L2116: def api_buscar_alumnos():
L2117:     query = request.args.get('q', '')
L2118:     if len(query) < 3: return jsonify([])
L2119:     
L2120:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L2121:     search = f"%{query}%"
L2122:     cursor.execute("SELECT id, nombre, numero_control FROM usuarios WHERE rol='alumno' AND (nombre LIKE %s OR numero_control LIKE %s) LIMIT 10", (search, search))
L2123:     return jsonify(cursor.fetchall())
L2124: 
L2125: @app.route('/api/enviar_reporte', methods=['POST'])
L2126: @login_required
L2127: @role_required('orientador', 'docente') # Docentes también pueden reportar
L2128: def api_enviar_reporte():
...

--- Instancia 2: buscar_alumnos (Línea 8583) ---
L8583: @app.route('/api/buscar_alumnos')
L8584: @login_required
L8585: @role_required('orientador')
L8586: def buscar_alumnos():
L8587:     query = request.args.get('q', '').strip()
L8588:     if len(query) < 3:
L8589:         return jsonify([])
L8590: 
L8591:     try:
L8592:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L8593:         cursor.execute("""
L8594:             SELECT u.id, u.nombre, u.semestre, u.rango,
L8595:                    (SELECT riesgo FROM predicciones_desercion WHERE alumno_id = u.id ORDER BY fecha_calculo DESC LIMIT 1) as riesgo
L8596:             FROM usuarios u
L8597:             WHERE u.tipo_usuario = 'alumno' 
...

--- Instancia 3: buscar_alumnos_orientador_endpoint (Línea 22194) ---
L22194: @app.route('/api/buscar_alumnos', methods=['GET'])
L22195: @login_required
L22196: @role_required('orientador') 
L22197: def buscar_alumnos_orientador_endpoint():
L22198:     """Buscador de alumnos para el orientador"""
L22199:     query = request.args.get('q', '')
L22200:     if len(query) < 3:
L22201:         return jsonify([])
L22202:     
L22203:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L22204:     # Buscar por nombre o número de control
L22205:     search = f"%{query}%"
L22206:     cursor.execute("""
L22207:         SELECT id, nombre, email, numero_control 
L22208:         FROM usuarios 
...

======================================================================
RUTA: /api/enviar_reporte
======================================================================

--- Instancia 1: api_enviar_reporte (Línea 2125) ---
L2125: @app.route('/api/enviar_reporte', methods=['POST'])
L2126: @login_required
L2127: @role_required('orientador', 'docente') # Docentes también pueden reportar
L2128: def api_enviar_reporte():
L2129:     data = request.json
L2130:     cursor = mysql.connection.cursor()
L2131:     cursor.execute("""
L2132:         INSERT INTO reportes_conducta (alumno_id, reportado_por, tipo, descripcion, fecha_reporte)
L2133:         VALUES (%s, %s, %s, %s, NOW())
L2134:     """, (data['alumno_id'], session['user_id'], data['tipo'], data['descripcion']))
L2135:     mysql.connection.commit()
L2136:     
L2137:     # Notificar al tutor si existe
L2138:     # (Lógica simplificada, se podría expandir)
L2139:     
...

--- Instancia 2: enviar_reporte (Línea 8610) ---
L8610: @app.route('/api/enviar_reporte', methods=['POST'])
L8611: @login_required
L8612: @role_required('orientador')
L8613: def enviar_reporte():
L8614:     alumno_id = request.form.get('alumno_id')
L8615:     tipo = request.form.get('tipo')
L8616:     descripcion = request.form.get('descripcion', '').strip()
L8617:     file = request.files.get('evidencia')
L8618: 
L8619:     if not alumno_id or not tipo or not descripcion:
L8620:         return jsonify({'error': 'Faltan datos'}), 400
L8621: 
L8622:     evidencia_ruta = None
L8623:     if file and allowed_file(file.filename):
L8624:         filename = secure_filename(file.filename)
...

--- Instancia 3: enviar_reporte_conducta (Línea 22217) ---
L22217: @app.route('/api/enviar_reporte', methods=['POST'])
L22218: @login_required
L22219: @role_required('orientador')
L22220: def enviar_reporte_conducta():
L22221:     """Guardar reporte de conducta"""
L22222:     try:
L22223:         data = request.json
L22224:         alumno_id = data.get('alumno_id')
L22225:         tipo = data.get('tipo', 'leve')
L22226:         descripcion = data.get('descripcion')
L22227:         
L22228:         if not all([alumno_id, descripcion]):
L22229:             return jsonify({'error': 'Faltan datos requeridos'}), 400
L22230:             
L22231:         cursor = mysql.connection.cursor()
...

======================================================================
RUTA: /api/buscar_horarios
======================================================================

--- Instancia 1: api_buscar_horarios (Línea 2142) ---
L2142: @app.route('/api/buscar_horarios', methods=['GET'])
L2143: @login_required
L2144: def api_buscar_horarios():
L2145:     grupo = request.args.get('grupo')
L2146:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L2147:     cursor.execute("SELECT * FROM horarios_grupos WHERE grupo = %s", (grupo,))
L2148:     return jsonify(cursor.fetchall())
L2149: 
L2150: @app.route('/api/orientador/avisos', methods=['POST'])
L2151: @login_required
L2152: @role_required('orientador')
L2153: def api_orientador_avisos():
L2154:     data = request.json
L2155:     cursor = mysql.connection.cursor()
L2156:     cursor.execute("""
...

--- Instancia 2: buscar_horarios (Línea 7803) ---
L7803: @app.route('/api/buscar_horarios', methods=['GET'])
L7804: def buscar_horarios():
L7805:     """Buscar todos los horarios cargados"""
L7806:     try:
L7807:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L7808:         cursor.execute("""
L7809:             SELECT id, grupo, semestre, archivo_nombre, archivo_ruta, fecha_actualizacion 
L7810:             FROM horarios_clases 
L7811:             ORDER BY fecha_actualizacion DESC
L7812:         """)
L7813:         horarios = cursor.fetchall()
L7814:         cursor.close()
L7815:         
L7816:         print(f"[DEBUG] Horarios encontrados: {len(horarios)}")
L7817:         for h in horarios:
...

--- Instancia 3: buscar_horarios_grupo (Línea 22248) ---
L22248: @app.route('/api/buscar_horarios', methods=['GET'])
L22249: @login_required
L22250: @role_required('orientador')
L22251: def buscar_horarios_grupo():
L22252:     """Buscar horarios de clase por grupo"""
L22253:     grupo = request.args.get('grupo')
L22254:     if not grupo:
L22255:         return jsonify({'error': 'Grupo requerido'}), 400
L22256:         
L22257:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L22258:     cursor.execute("""
L22259:         SELECT h.*, m.nombre as materia_nombre, u.nombre as docente_nombre
L22260:         FROM horarios_clases h
L22261:         JOIN materias m ON h.materia_id = m.id
L22262:         JOIN usuarios u ON m.docente_id = u.id
...

======================================================================
RUTA: /api/orientador/avisos
======================================================================

--- Instancia 1: api_orientador_avisos (Línea 2150) ---
L2150: @app.route('/api/orientador/avisos', methods=['POST'])
L2151: @login_required
L2152: @role_required('orientador')
L2153: def api_orientador_avisos():
L2154:     data = request.json
L2155:     cursor = mysql.connection.cursor()
L2156:     cursor.execute("""
L2157:         INSERT INTO recordatorios (usuario_id, mensaje, fecha_recordatorio, tipo, destinatario_grupo)
L2158:         VALUES (%s, %s, %s, 'aviso', %s)
L2159:     """, (session['user_id'], data['mensaje'], data['fecha'], data['destinatario'])) 
L2160:     # Nota: Esto es un uso simplificado de la tabla recordatorios para avisos generales
L2161:     mysql.connection.commit()
L2162:     return jsonify({'success': True, 'message': 'Aviso enviado'})
L2163: 
L2164: @app.route('/api/orientador/justificantes', methods=['POST'])
...

--- Instancia 2: orientador_avisos (Línea 21478) ---
L21478: @app.route('/api/orientador/avisos', methods=['GET', 'POST'])
L21479: @login_required
L21480: @role_required('orientador')
L21481: def orientador_avisos():
L21482:     """Gestión de avisos institucionales"""
L21483:     if request.method == 'POST':
L21484:         try:
L21485:             data = request.json
L21486:             cursor = mysql.connection.cursor()
L21487:             cursor.execute("""
L21488:                 INSERT INTO comunicados (titulo, contenido, tipo, fecha_publicacion)
L21489:                 VALUES (%s, %s, 'academico', NOW())
L21490:             """, (data['titulo'], data['contenido']))
L21491:             mysql.connection.commit()
L21492:             cursor.close()
...

--- Instancia 3: orientador_enviar_aviso (Línea 22292) ---
L22292: @app.route('/api/orientador/avisos', methods=['POST'])
L22293: @login_required
L22294: @role_required('orientador')
L22295: def orientador_enviar_aviso():
L22296:     """Enviar aviso o recordatorio a grupo o alumno específico"""
L22297:     try:
L22298:         data = request.json
L22299:         destinatario = data.get('destinatario', '')  # Nombre de grupo o alumno
L22300:         tipo = data.get('tipo', 'aviso')  # 'aviso' o 'recordatorio'
L22301:         mensaje = data.get('mensaje', '')
L22302:         fecha = data.get('fecha')
L22303:         
L22304:         if not all([destinatario, mensaje]):
L22305:             return jsonify({'error': 'Faltan datos requeridos'}), 400
L22306:         
...

======================================================================
RUTA: /api/eliminar_horario
======================================================================

--- Instancia 1: api_eliminar_horario (Línea 2229) ---
L2229: @app.route('/api/eliminar_horario', methods=['POST'])
L2230: @login_required
L2231: @role_required('orientador')
L2232: def api_eliminar_horario():
L2233:     data = request.json
L2234:     horario_id = data.get('id')
L2235:     cursor = mysql.connection.cursor()
L2236:     cursor.execute("DELETE FROM horarios_grupos WHERE id = %s", (horario_id,))
L2237:     mysql.connection.commit()
L2238:     return jsonify({'success': True})
L2239: 
L2240: @app.route('/app')
L2241: @login_required
L2242: def vue_app():
L2243:     update_db_schema_recovery()
...

--- Instancia 2: eliminar_horario_legacy (Línea 7757) ---
L7757: @app.route('/api/eliminar_horario', methods=['POST'])
L7758: @login_required
L7759: @role_required('admin')
L7760: def eliminar_horario_legacy():
L7761:     try:
L7762:         data = request.get_json()
L7763:         horario_id = data.get('id')
L7764:         archivo_ruta = data.get('archivo_ruta')
L7765: 
L7766:         if not horario_id or not archivo_ruta:
L7767:             return jsonify({'error': 'Faltan datos'}), 400
L7768: 
L7769:         # Ruta física del archivo
L7770:         file_path = os.path.join(app.config['UPLOAD_FOLDER'], archivo_ruta)
L7771: 
...

--- Instancia 3: eliminar_horario_clase (Línea 22270) ---
L22270: @app.route('/api/eliminar_horario', methods=['POST'])
L22271: @login_required
L22272: @role_required('orientador')
L22273: def eliminar_horario_clase():
L22274:     """Eliminar un horario de clase"""
L22275:     try:
L22276:         data = request.json
L22277:         horario_id = data.get('id')
L22278:         
L22279:         if not horario_id:
L22280:             return jsonify({'error': 'ID requerido'}), 400
L22281:             
L22282:         cursor = mysql.connection.cursor()
L22283:         cursor.execute("DELETE FROM horarios_clases WHERE id = %s", (horario_id,))
L22284:         mysql.connection.commit()
...

======================================================================
RUTA: /api/orientador/alertas
======================================================================

--- Instancia 1: api_orientador_alertas (Línea 3438) ---
L3438: @app.route('/api/orientador/alertas', methods=['GET'])
L3439: @login_required
L3440: @role_required('orientador')
L3441: def api_orientador_alertas():
L3442:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L3443:     estado = request.args.get('estado')
L3444:     nivel = request.args.get('nivel')
L3445:     query = "SELECT a.*, u.nombre as alumno_nombre FROM alertas_orientador a LEFT JOIN usuarios u ON a.alumno_id = u.id WHERE 1=1"
L3446:     params = []
L3447:     if estado:
L3448:         query += " AND a.estado = %s"
L3449:         params.append(estado)
L3450:     if nivel:
L3451:         query += " AND a.nivel = %s"
L3452:         params.append(nivel)
...

--- Instancia 2: listar_alertas_academicas (Línea 6233) ---
L6233: @app.route('/api/orientador/alertas', methods=['GET'])
L6234: @login_required
L6235: @role_required('orientador')
L6236: def listar_alertas_academicas():
L6237:     """Listar todas las alertas académicas"""
L6238:     try:
L6239:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L6240:         activa = request.args.get('activa', '1')
L6241:         tipo = request.args.get('tipo', '')
L6242:         nivel = request.args.get('nivel', '')
L6243:         
L6244:         sql = """
L6245:             SELECT aa.*, u.nombre as alumno_nombre, u.numero_control, u.semestre,
L6246:                    c.nombre as creador_nombre
L6247:             FROM alertas_academicas aa
...

--- Instancia 3: crear_alerta_academica (Línea 6282) ---
L6282: @app.route('/api/orientador/alertas', methods=['POST'])
L6283: @login_required
L6284: @role_required('orientador')
L6285: def crear_alerta_academica():
L6286:     """Crear nueva alerta académica"""
L6287:     try:
L6288:         data = request.json
L6289:         required = ['alumno_id', 'tipo', 'descripcion']
L6290:         if not all(field in data for field in required):
L6291:             return jsonify({'error': 'Faltan campos obligatorios: alumno_id, tipo, descripcion'}), 400
L6292:         
L6293:         cursor = mysql.connection.cursor()
L6294:         cursor.execute("""
L6295:             INSERT INTO alertas_academicas 
L6296:             (alumno_id, tipo, descripcion, nivel, creado_por)
...

======================================================================
RUTA: /api/orientador/citas/<int:cita_id>
======================================================================

--- Instancia 1: obtener_cita_orientacion (Línea 6116) ---
L6116: @app.route('/api/orientador/citas/<int:cita_id>', methods=['GET'])
L6117: @login_required
L6118: @role_required('orientador')
L6119: def obtener_cita_orientacion(cita_id):
L6120:     """Obtener detalle de una cita específica"""
L6121:     try:
L6122:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L6123:         cursor.execute("""
L6124:             SELECT co.*, 
L6125:                    u.nombre as alumno_nombre, u.numero_control, u.email as alumno_email,
L6126:                    u.semestre, u.telefono as alumno_telefono
L6127:             FROM citas_orientacion co
L6128:             JOIN usuarios u ON co.alumno_id = u.id
L6129:             WHERE co.id = %s AND co.orientador_id = %s
L6130:         """, (cita_id, session['user_id']))
...

--- Instancia 2: actualizar_cita_orientacion (Línea 6148) ---
L6148: @app.route('/api/orientador/citas/<int:cita_id>', methods=['PUT'])
L6149: @login_required
L6150: @role_required('orientador')
L6151: def actualizar_cita_orientacion(cita_id):
L6152:     """Actualizar una cita de orientación"""
L6153:     try:
L6154:         data = request.json
L6155:         
L6156:         cursor = mysql.connection.cursor()
L6157:         
L6158:         # Verificar que la cita existe y pertenece al orientador
L6159:         cursor.execute("SELECT id FROM citas_orientacion WHERE id = %s AND orientador_id = %s", 
L6160:                       (cita_id, session['user_id']))
L6161:         if not cursor.fetchone():
L6162:             cursor.close()
...

--- Instancia 3: eliminar_cita_orientacion (Línea 6203) ---
L6203: @app.route('/api/orientador/citas/<int:cita_id>', methods=['DELETE'])
L6204: @login_required
L6205: @role_required('orientador')
L6206: def eliminar_cita_orientacion(cita_id):
L6207:     """Eliminar/cancelar una cita de orientación"""
L6208:     try:
L6209:         cursor = mysql.connection.cursor()
L6210:         
L6211:         # Verificar pertenencia
L6212:         cursor.execute("SELECT id FROM citas_orientacion WHERE id = %s AND orientador_id = %s", 
L6213:                       (cita_id, session['user_id']))
L6214:         if not cursor.fetchone():
L6215:             cursor.close()
L6216:             return jsonify({'error': 'Cita no encontrada'}), 404
L6217:         
...

======================================================================
RUTA: /api/orientador/alertas/<int:alerta_id>
======================================================================

--- Instancia 1: obtener_alerta_academica (Línea 6317) ---
L6317: @app.route('/api/orientador/alertas/<int:alerta_id>', methods=['GET'])
L6318: @login_required
L6319: @role_required('orientador')
L6320: def obtener_alerta_academica(alerta_id):
L6321:     """Obtener detalle de una alerta"""
L6322:     try:
L6323:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L6324:         cursor.execute("""
L6325:             SELECT aa.*, u.nombre as alumno_nombre, u.numero_control, u.email, u.semestre
L6326:             FROM alertas_academicas aa
L6327:             JOIN usuarios u ON aa.alumno_id = u.id
L6328:             WHERE aa.id = %s
L6329:         """, (alerta_id,))
L6330:         alerta = cursor.fetchone()
L6331:         cursor.close()
...

--- Instancia 2: actualizar_alerta_academica (Línea 6347) ---
L6347: @app.route('/api/orientador/alertas/<int:alerta_id>', methods=['PUT'])
L6348: @login_required
L6349: @role_required('orientador')
L6350: def actualizar_alerta_academica(alerta_id):
L6351:     """Actualizar una alerta académica"""
L6352:     try:
L6353:         data = request.json
L6354:         cursor = mysql.connection.cursor()
L6355:         
L6356:         updates = []
L6357:         params = []
L6358:         
L6359:         if 'descripcion' in data:
L6360:             updates.append("descripcion = %s")
L6361:             params.append(data['descripcion'])
...

--- Instancia 3: eliminar_alerta_academica (Línea 6389) ---
L6389: @app.route('/api/orientador/alertas/<int:alerta_id>', methods=['DELETE'])
L6390: @login_required
L6391: @role_required('orientador')
L6392: def eliminar_alerta_academica(alerta_id):
L6393:     """Resolver/cerrar una alerta académica"""
L6394:     try:
L6395:         cursor = mysql.connection.cursor()
L6396:         cursor.execute("""
L6397:             UPDATE alertas_academicas 
L6398:             SET activa = 0, fecha_resolucion = NOW() 
L6399:             WHERE id = %s
L6400:         """, (alerta_id,))
L6401:         mysql.connection.commit()
L6402:         cursor.close()
L6403:         
...

======================================================================
RUTA: /api/orientador/reportes/<int:reporte_id>
======================================================================

--- Instancia 1: obtener_reporte_conducta (Línea 6456) ---
L6456: @app.route('/api/orientador/reportes/<int:reporte_id>', methods=['GET'])
L6457: @login_required
L6458: @role_required('orientador')
L6459: def obtener_reporte_conducta(reporte_id):
L6460:     """Obtener detalle de un reporte"""
L6461:     try:
L6462:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L6463:         cursor.execute("""
L6464:             SELECT rc.*, u.nombre as alumno_nombre, u.numero_control, u.email, u.semestre
L6465:             FROM reportes_conducta rc
L6466:             JOIN usuarios u ON rc.alumno_id = u.id
L6467:             WHERE rc.id = %s AND rc.orientador_id = %s
L6468:         """, (reporte_id, session['user_id']))
L6469:         reporte = cursor.fetchone()
L6470:         cursor.close()
...

--- Instancia 2: actualizar_reporte_conducta (Línea 6485) ---
L6485: @app.route('/api/orientador/reportes/<int:reporte_id>', methods=['PUT'])
L6486: @login_required
L6487: @role_required('orientador')
L6488: def actualizar_reporte_conducta(reporte_id):
L6489:     """Actualizar un reporte de conducta"""
L6490:     try:
L6491:         data = request.json
L6492:         cursor = mysql.connection.cursor()
L6493:         
L6494:         # Verificar que el reporte pertenece al orientador
L6495:         cursor.execute("SELECT id FROM reportes_conducta WHERE id = %s AND orientador_id = %s", 
L6496:                       (reporte_id, session['user_id']))
L6497:         if not cursor.fetchone():
L6498:             cursor.close()
L6499:             return jsonify({'error': 'Reporte no encontrado'}), 404
...

--- Instancia 3: eliminar_reporte_conducta (Línea 6529) ---
L6529: @app.route('/api/orientador/reportes/<int:reporte_id>', methods=['DELETE'])
L6530: @login_required
L6531: @role_required('orientador')
L6532: def eliminar_reporte_conducta(reporte_id):
L6533:     """Eliminar un reporte de conducta"""
L6534:     try:
L6535:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L6536:         
L6537:         # Verificar y obtener ruta de evidencia
L6538:         cursor.execute("SELECT evidencia_ruta FROM reportes_conducta WHERE id = %s AND orientador_id = %s", 
L6539:                       (reporte_id, session['user_id']))
L6540:         reporte = cursor.fetchone()
L6541:         
L6542:         if not reporte:
L6543:             cursor.close()
...

======================================================================
RUTA: /api/tutor/mensajes
======================================================================

--- Instancia 1: tutor_enviar_mensaje (Línea 7273) ---
L7273: @app.route('/api/tutor/mensajes', methods=['POST'])
L7274: @login_required
L7275: @role_required('tutor')
L7276: def tutor_enviar_mensaje():
L7277:     """Enviar mensaje a personal escolar"""
L7278:     try:
L7279:         data = request.json
L7280:         cursor = mysql.connection.cursor()
L7281:         
L7282:         # Por defecto enviamos al orientador si no se especifica
L7283:         cursor.execute("SELECT id FROM usuarios WHERE tipo_usuario = 'orientador' LIMIT 1")
L7284:         res = cursor.fetchone()
L7285:         receptor_id = res[0] if res else session['user_id']
L7286:         
L7287:         cursor.execute("""
...

--- Instancia 2: tutor_inbox (Línea 7297) ---
L7297: @app.route('/api/tutor/mensajes', methods=['GET'])
L7298: @login_required
L7299: @role_required('tutor')
L7300: def tutor_inbox():
L7301:     """Bandeja de entrada del tutor"""
L7302:     try:
L7303:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L7304:         cursor.execute("""
L7305:             SELECT m.id, m.asunto, m.contenido, m.fecha_envio, u.nombre as emisor
L7306:             FROM mensajes m
L7307:             JOIN usuarios u ON m.emisor_id = u.id
L7308:             WHERE m.receptor_id = %s
L7309:             ORDER BY m.fecha_envio DESC
L7310:         """, (session['user_id'],))
L7311:         mensajes = cursor.fetchall()
...

--- Instancia 3: tutor_mensajes (Línea 22683) ---
L22683: @app.route('/api/tutor/mensajes', methods=['GET', 'POST'])
L22684: @login_required
L22685: @role_required('tutor')
L22686: def tutor_mensajes():
L22687:     """Gestionar bandeja de mensajes del tutor"""
L22688:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L22689:     
L22690:     if request.method == 'POST':
L22691:         try:
L22692:             data = request.json
L22693:             destinatario_id = data.get('student_id')  # Can be student or teacher
L22694:             asunto = data.get('subject', 'Sin asunto')
L22695:             contenido = data.get('content', '')
L22696:             
L22697:             if not all([destinatario_id, contenido]):
...

======================================================================
RUTA: /api/encuestas-docentes
======================================================================

--- Instancia 1: listar_encuestas_docentes (Línea 9570) ---
L9570: @app.route('/api/encuestas-docentes', methods=['GET'])
L9571: @login_required
L9572: @role_required('alumno')
L9573: def listar_encuestas_docentes():
L9574:     """Lista las encuestas de docentes activas que el alumno puede responder"""
L9575:     try:
L9576:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L9577:         estudiante_id = session['user_id']
L9578:         
L9579:         # Obtener encuestas activas donde el alumno no ha respondido aún
L9580:         cursor.execute("""
L9581:             SELECT ed.id, ed.titulo, ed.descripcion, ed.fecha_inicio, ed.fecha_fin,
L9582:                    u.nombre as docente_nombre, u.id as docente_id,
L9583:                    m.nombre as materia_nombre, m.id as materia_id
L9584:             FROM encuestas_docentes ed
...

--- Instancia 2: get_encuestas_docentes (Línea 23267) ---
L23267: @app.route('/api/encuestas-docentes', methods=['GET'])
L23268: @login_required
L23269: def get_encuestas_docentes():
L23270:     """Obtener encuestas de docentes disponibles para responder"""
L23271:     try:
L23272:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L23273:         
L23274:         if session.get('role') == 'alumno':
L23275:             # Obtener encuestas pendientes para este alumno
L23276:             cursor.execute("""
L23277:                 SELECT e.id, e.titulo, e.descripcion, e.fecha_limite, 
L23278:                        m.nombre as materia, u.nombre as docente, e.xp_recompensa
L23279:                 FROM encuestas_docentes e
L23280:                 JOIN materias m ON e.materia_id = m.id
L23281:                 JOIN usuarios u ON e.docente_id = u.id
...

--- Instancia 3: api_encuestas_docentes (Línea 28223) ---
L28223: @app.route('/api/encuestas-docentes', methods=['GET'])
L28224: @login_required
L28225: def api_encuestas_docentes():
L28226:     """Listar encuestas de evaluación docente pendientes"""
L28227:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L28228:     user_id = session['user_id']
L28229:     
L28230:     try:
L28231:         # Obtener materias del alumno y sus docentes
L28232:         cursor.execute("""
L28233:             SELECT DISTINCT e.id, e.titulo, e.descripcion, e.fecha_fin,
L28234:                    m.nombre as materia_nombre, u.id as docente_id, u.nombre as docente_nombre
L28235:             FROM encuestas e
L28236:             CROSS JOIN matriculas ma ON ma.estudiante_id = %s
L28237:             INNER JOIN materias m ON ma.materia_id = m.id
...

======================================================================
RUTA: /api/responder-encuesta-docente
======================================================================

--- Instancia 1: responder_encuesta_docente (Línea 9603) ---
L9603: @app.route('/api/responder-encuesta-docente', methods=['POST'])
L9604: @login_required
L9605: @role_required('alumno')
L9606: def responder_encuesta_docente():
L9607:     """Guardar respuesta de alumno a encuesta de docente"""
L9608:     try:
L9609:         data = request.json
L9610:         estudiante_id = session['user_id']
L9611:         
L9612:         required = ['encuesta_id', 'docente_id', 'calificacion_general']
L9613:         if not all(field in data for field in required):
L9614:             return jsonify({'error': 'Faltan campos obligatorios'}), 400
L9615:         
L9616:         calificacion = int(data['calificacion_general'])
L9617:         if calificacion < 1 or calificacion > 5:
...

--- Instancia 2: responder_encuesta_docente_v2 (Línea 23308) ---
L23308: @app.route('/api/responder-encuesta-docente', methods=['POST'])
L23309: @login_required
L23310: @role_required('alumno')
L23311: def responder_encuesta_docente_v2():
L23312:     """Guardar respuesta de encuesta docente"""
L23313:     try:
L23314:         data = request.json
L23315:         encuesta_id = data.get('encuesta_id')
L23316:         respuestas = data.get('respuestas', {})
L23317:         comentario = data.get('comentario', '')
L23318:         
L23319:         if not encuesta_id or not respuestas:
L23320:             return jsonify({'error': 'Datos incompletos'}), 400
L23321:         
L23322:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
...

--- Instancia 3: api_responder_encuesta_docente (Línea 28258) ---
L28258: @app.route('/api/responder-encuesta-docente', methods=['POST'])
L28259: @login_required
L28260: def api_responder_encuesta_docente():
L28261:     """Responder encuesta de evaluación docente"""
L28262:     data = request.json
L28263:     user_id = session['user_id']
L28264:     
L28265:     encuesta_id = data.get('encuesta_id')
L28266:     docente_id = data.get('docente_id')
L28267:     calificacion_general = data.get('calificacion_general', 3)
L28268:     dominio_tema = data.get('dominio_tema', 3)
L28269:     claridad_explicacion = data.get('claridad_explicacion', 3)
L28270:     puntualidad = data.get('puntualidad', 3)
L28271:     material_didactico = data.get('material_didactico', 3)
L28272:     comentarios = data.get('comentarios', '')
...

======================================================================
RUTA: /api/ai-chat
======================================================================

--- Instancia 1: ai_chat (Línea 9748) ---
L9748: @app.route('/api/ai-chat', methods=['POST'])
L9749: @login_required
L9750: def ai_chat():
L9751:     """Chat con Gemini AI Tutor para estudiantes"""
L9752:     try:
L9753:         data = request.json
L9754:         message = data.get('message', '').strip()
L9755:         
L9756:         if not message:
L9757:             return jsonify({'error': 'Mensaje vacío'}), 400
L9758:         
L9759:         # Configurar el modelo de Gemini
L9760:         try:
L9761:             model = genai.GenerativeModel('gemini-1.5-flash')
L9762:         except Exception:
...

--- Instancia 2: api_ai_chat (Línea 23241) ---
L23241: @app.route('/api/ai-chat', methods=['POST'])
L23242: @login_required
L23243: def api_ai_chat():
L23244:     """Chat con IA Gemini para alumnos"""
L23245:     try:
L23246:         data = request.json
L23247:         message = data.get('message', '')
L23248:         context = data.get('context', 'general')
L23249:         
L23250:         if not message:
L23251:             return jsonify({'error': 'Mensaje requerido'}), 400
L23252:         
L23253:         # Usar Gemini para generar respuesta
L23254:         try:
L23255:             model = genai.GenerativeModel('gemini-pro')
...

--- Instancia 3: api_ai_chat (Línea 28180) ---
L28180: @app.route('/api/ai-chat', methods=['POST'])
L28181: @login_required
L28182: def api_ai_chat():
L28183:     """Chat con IA usando Gemini"""
L28184:     data = request.json
L28185:     message = data.get('message', '')
L28186:     
L28187:     if not message:
L28188:         return jsonify({'response': 'Por favor, escribe tu pregunta.'})
L28189:     
L28190:     try:
L28191:         # Usar la función gemini_chat ya definida
L28192:         system_context = """Eres un tutor virtual amigable para estudiantes de preparatoria.
L28193:         Ayudas con dudas de matemáticas, ciencias, historia y programación.
L28194:         Responde de forma clara, concisa y motivadora. Usa ejemplos cuando sea útil.
...

======================================================================
RUTA: /api/flashcards/<int:card_id>/review
======================================================================

--- Instancia 1: _old_review_flashcard (Línea 18259) ---
L18259: # @app.route('/api/flashcards/<int:card_id>/review', methods=['POST'])
L18260: # @login_required
L18261: # @role_required('alumno')
L18262: def _old_review_flashcard(card_id):
L18263:     """Update review stats for a flashcard"""
L18264:     try:
L18265:         data = request.json
L18266:         acertada = data.get('acertada', False)
L18267:         
L18268:         cursor = mysql.connection.cursor()
L18269:         if acertada:
L18270:             cursor.execute("""
L18271:                 UPDATE flashcards 
L18272:                 SET nivel_dominio = LEAST(nivel_dominio + 1, 5),
L18273:                     veces_acertada = veces_acertada + 1,
...

--- Instancia 2: alumno_review_flashcard (Línea 20397) ---
L20397: @app.route('/api/flashcards/<int:card_id>/review', methods=['POST'])
L20398: @login_required
L20399: def alumno_review_flashcard(card_id):
L20400:     """Revisar tarjeta (SRS)"""
L20401:     try:
L20402:         data = request.get_json()
L20403:         quality = data.get('quality', 'good')  # again, good, easy
L20404:         
L20405:         # Actualizar estado de la tarjeta basado en calidad
L20406:         new_state = 'revision' if quality == 'again' else 'aprendido'
L20407:         
L20408:         cursor = mysql.connection.cursor()
L20409:         cursor.execute("""
L20410:             UPDATE flashcard_tarjetas SET estado = %s WHERE id = %s
L20411:         """, (new_state, card_id))
...

--- Instancia 3: api_flashcards_review (Línea 27816) ---
L27816: @app.route('/api/flashcards/<int:card_id>/review', methods=['POST'])
L27817: @login_required
L27818: def api_flashcards_review(card_id):
L27819:     """Registrar repaso de tarjeta con algoritmo SM-2 simplificado"""
L27820:     data = request.json
L27821:     quality = data.get('quality', 3)  # 1=difícil, 3=bien, 5=fácil
L27822:     
L27823:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L27824:     cursor.execute("SELECT * FROM flashcard_tarjetas WHERE id = %s", (card_id,))
L27825:     card = cursor.fetchone()
L27826:     
L27827:     if not card:
L27828:         return jsonify({'error': 'Tarjeta no encontrada'}), 404
L27829:     
L27830:     # Actualizar estado basado en calidad del repaso
...

======================================================================
RUTA: /api/teams/join
======================================================================

--- Instancia 1: join_study_team (Línea 18343) ---
L18343: @app.route('/api/teams/join', methods=['POST'])
L18344: @login_required
L18345: @role_required('alumno')
L18346: def join_study_team():
L18347:     """Join a team using access code (e.g., 'TEAM001')"""
L18348:     try:
L18349:         codigo = request.json.get('codigo')
L18350:         
L18351:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L18352:         cursor.execute("SELECT * FROM equipos_estudio WHERE codigo_acceso = %s AND activo = 1", (codigo,))
L18353:         team = cursor.fetchone()
L18354:         
L18355:         if not team:
L18356:             return jsonify({'error': 'Código inválido'}), 404
L18357:         
...

--- Instancia 2: _old_join_team (Línea 19688) ---
L19688: @app.route('/api/teams/join', methods=['POST'])
L19689: @login_required
L19690: def _old_join_team():
L19691:     try:
L19692:         data = request.json
L19693:         codigo = data.get('codigo', '').strip().upper()
L19694:         
L19695:         cursor = mysql.connection.cursor()
L19696:         cursor.execute("SELECT id FROM equipos_estudio WHERE codigo_acceso = %s", (codigo,))
L19697:         team = cursor.fetchone()
L19698:         
L19699:         if not team:
L19700:             return jsonify({'error': 'Mazo no encontrado'}), 404
L19701:             
L19702:         # Check if already member
...

--- Instancia 3: alumno_join_team (Línea 20470) ---
L20470: @app.route('/api/teams/join', methods=['POST'])
L20471: @login_required
L20472: def alumno_join_team():
L20473:     """Unirse a equipo por código"""
L20474:     try:
L20475:         data = request.get_json()
L20476:         codigo = data['codigo'].upper()
L20477:         
L20478:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L20479:         cursor.execute("SELECT id FROM equipos_estudio WHERE codigo_acceso = %s", (codigo,))
L20480:         team = cursor.fetchone()
L20481:         
L20482:         if not team:
L20483:             return jsonify({'success': False, 'error': 'Código inválido'}), 404
L20484:         
...

======================================================================
RUTA: /api/whiteboard/<int:board_id>
======================================================================

--- Instancia 1: get_whiteboard (Línea 19474) ---
L19474: @app.route('/api/whiteboard/<int:board_id>', methods=['GET'])
L19475: @login_required
L19476: def get_whiteboard(board_id):
L19477:     """Obtener un pizarrón específico con su contenido"""
L19478:     try:
L19479:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L19480:         cursor.execute("""
L19481:             SELECT id, titulo, contenido_json, color, fecha_modificacion
L19482:             FROM notas_pizarron
L19483:             WHERE id = %s AND usuario_id = %s
L19484:         """, (board_id, session['user_id']))
L19485:         pizarron = cursor.fetchone()
L19486:         cursor.close()
L19487:         
L19488:         if pizarron:
...

--- Instancia 2: update_whiteboard (Línea 19524) ---
L19524: @app.route('/api/whiteboard/<int:board_id>', methods=['PUT'])
L19525: @login_required
L19526: def update_whiteboard(board_id):
L19527:     """Actualizar pizarrón (contenido, título, miniatura)"""
L19528:     try:
L19529:         data = request.get_json()
L19530:         cursor = mysql.connection.cursor()
L19531:         
L19532:         updates = []
L19533:         values = []
L19534:         
L19535:         if 'titulo' in data:
L19536:             updates.append("titulo = %s")
L19537:             values.append(data['titulo'])
L19538:         if 'contenido' in data:
...

--- Instancia 3: delete_whiteboard (Línea 19561) ---
L19561: @app.route('/api/whiteboard/<int:board_id>', methods=['DELETE'])
L19562: @login_required
L19563: def delete_whiteboard(board_id):
L19564:     """Eliminar pizarrón"""
L19565:     try:
L19566:         cursor = mysql.connection.cursor()
L19567:         cursor.execute("DELETE FROM notas_pizarron WHERE id = %s AND usuario_id = %s", 
L19568:                       (board_id, session['user_id']))
L19569:         mysql.connection.commit()
L19570:         cursor.close()
L19571:         return jsonify({'success': True})
L19572:     except Exception as e:
L19573:         return jsonify({'error': str(e)}), 500
L19574: 
L19575: 
...

======================================================================
RUTA: /api/teams/create
======================================================================

--- Instancia 1: api_teams_create (Línea 1910) ---
L1910: @app.route('/api/teams/create', methods=['POST'])
L1911: @login_required
L1912: def api_teams_create():
L1913:     data = request.json
L1914:     cursor = mysql.connection.cursor()
L1915:     # Create team
L1916:     cursor.execute("INSERT INTO equipos_estudio (nombre, materia_id, lider_id) VALUES (%s, %s, %s)", 
L1917:                   (data['nombre'], data.get('materia_id'), session['user_id']))
L1918:     mysql.connection.commit()
L1919:     team_id = cursor.lastrowid
L1920:     
L1921:     # Add leader as member
L1922:     cursor.execute("INSERT INTO miembros_equipo (equipo_id, usuario_id, rol) VALUES (%s, %s, 'lider')",
L1923:                   (team_id, session['user_id']))
L1924:     mysql.connection.commit()
...

--- Instancia 2: api_teams_create (Línea 27914) ---
L27914: @app.route('/api/teams/create', methods=['POST'])
L27915: @login_required
L27916: def api_teams_create():
L27917:     """Crear nuevo equipo de estudio"""
L27918:     data = request.json
L27919:     user_id = session['user_id']
L27920:     nombre = data.get('nombre', 'Nuevo Equipo')
L27921:     
L27922:     # Generar código de acceso único
L27923:     import random
L27924:     import string
L27925:     codigo = ''.join(random.choices(string.ascii_uppercase + string.digits, k=6))
L27926:     
L27927:     cursor = mysql.connection.cursor()
L27928:     try:
...

======================================================================
RUTA: /api/messages
======================================================================

--- Instancia 1: api_messages (Línea 1927) ---
L1927: @app.route('/api/messages', methods=['GET'])
L1928: @login_required
L1929: def api_messages():
L1930:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L1931:     cursor.execute("""
L1932:         SELECT m.*, u.nombre as remitente_nombre, u.avatar_url 
L1933:         FROM mensajes m 
L1934:         JOIN usuarios u ON m.remitente_id = u.id 
L1935:         WHERE m.destinatario_id = %s 
L1936:         ORDER BY m.fecha_envio DESC
L1937:     """, (session['user_id'],))
L1938:     msgs = cursor.fetchall()
L1939:     return jsonify(msgs)
L1940: 
L1941: @app.route('/api/portfolio', methods=['GET', 'POST'])
...

--- Instancia 2: api_messages_list (Línea 28016) ---
L28016: @app.route('/api/messages', methods=['GET'])
L28017: @login_required
L28018: def api_messages_list():
L28019:     """Listar mensajes del alumno"""
L28020:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L28021:     user_id = session['user_id']
L28022:     
L28023:     cursor.execute("""
L28024:         SELECT m.id, m.contenido, m.fecha_envio, m.leido,
L28025:                u.nombre as remitente_nombre
L28026:         FROM mensajes m
L28027:         JOIN usuarios u ON m.remitente_id = u.id
L28028:         WHERE m.destinatario_id = %s
L28029:         ORDER BY m.fecha_envio DESC
L28030:         LIMIT 50
...

======================================================================
RUTA: /api/meet/join
======================================================================

--- Instancia 1: api_meet_join (Línea 1976) ---
L1976: @app.route('/api/meet/join', methods=['POST'])
L1977: @login_required
L1978: def api_meet_join():
L1979:     data = request.json
L1980:     room_type = data.get('type', 'tutor') # tutor, team, class
L1981:     ref_id = data.get('id', 'general')
L1982:     
L1983:     room_name = f"EduPlatform-{room_type}-{ref_id}-{uuid.uuid4().hex[:4]}"
L1984:     meet_url = generate_jitsi_meet(room_name)
L1985:     
L1986:     return jsonify({'url': meet_url, 'room': room_name})
L1987: 
L1988: @app.route('/api/schedule', methods=['GET'])
L1989: @login_required
L1990: def api_schedule():
...

--- Instancia 2: api_meet_join (Línea 28203) ---
L28203: @app.route('/api/meet/join', methods=['POST'])
L28204: @login_required
L28205: def api_meet_join():
L28206:     """Generar o unirse a una videollamada"""
L28207:     data = request.json
L28208:     meeting_type = data.get('type', 'general')
L28209:     
L28210:     # Generar un código de sala único
L28211:     import random
L28212:     import string
L28213:     room_code = ''.join(random.choices(string.ascii_lowercase + string.digits, k=10))
L28214:     
L28215:     # URL de ejemplo usando Jitsi Meet (gratuito)
L28216:     meet_url = f"https://meet.jit.si/EduPlatform-{meeting_type}-{room_code}"
L28217:     
...

======================================================================
RUTA: /api/schedule
======================================================================

--- Instancia 1: api_schedule (Línea 1988) ---
L1988: @app.route('/api/schedule', methods=['GET'])
L1989: @login_required
L1990: def api_schedule():
L1991:     # Obtener materias y sus horarios
L1992:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L1993:     cursor.execute("""
L1994:         SELECT m.nombre, m.horario, u.nombre as docente
L1995:         FROM materias m
L1996:         JOIN matriculas mat ON m.id = mat.materia_id
L1997:         JOIN usuarios u ON m.docente_id = u.id
L1998:         WHERE mat.estudiante_id = %s AND m.activo = 1
L1999:     """, (session['user_id'],))
L2000:     schedule = cursor.fetchall()
L2001:     return jsonify(schedule)
L2002: 
...

--- Instancia 2: api_schedule (Línea 28038) ---
L28038: @app.route('/api/schedule', methods=['GET'])
L28039: @login_required
L28040: def api_schedule():
L28041:     """Obtener horario del alumno basado en sus materias"""
L28042:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L28043:     user_id = session['user_id']
L28044:     
L28045:     cursor.execute("""
L28046:         SELECT m.id, m.nombre, m.horario, u.nombre as docente
L28047:         FROM materias m
L28048:         INNER JOIN matriculas ma ON m.id = ma.materia_id
L28049:         LEFT JOIN usuarios u ON m.docente_id = u.id
L28050:         WHERE ma.estudiante_id = %s
L28051:         ORDER BY m.nombre
L28052:     """, (user_id,))
...

======================================================================
RUTA: /api/tutor/justificantes
======================================================================

--- Instancia 1: api_tutor_justificantes (Línea 2034) ---
L2034: @app.route('/api/tutor/justificantes', methods=['POST'])
L2035: @login_required
L2036: @role_required('tutor')
L2037: def api_tutor_justificantes():
L2038:     if 'evidencia' not in request.files: return jsonify({'error': 'No file'}), 400
L2039:     file = request.files['evidencia']
L2040:     alumno_id = request.form.get('alumno_id')
L2041:     fecha = request.form.get('fecha_falta')
L2042:     motivo = request.form.get('motivo')
L2043:     
L2044:     if file and allowed_file(file.filename):
L2045:         filename = secure_filename(f"justificante_{alumno_id}_{int(time.time())}_{file.filename}")
L2046:         path = os.path.join(app.config['UPLOAD_FOLDER'], filename)
L2047:         file.save(path)
L2048:         
...

--- Instancia 2: tutor_justificantes (Línea 22826) ---
L22826: @app.route('/api/tutor/justificantes', methods=['GET', 'POST'])
L22827: @login_required
L22828: @role_required('tutor')
L22829: def tutor_justificantes():
L22830:     """Crear o listar justificantes médicos del tutor"""
L22831:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L22832:     
L22833:     if request.method == 'POST':
L22834:         try:
L22835:             alumno_id = request.form.get('alumno_id')
L22836:             fecha_falta = request.form.get('fecha_falta')
L22837:             motivo = request.form.get('motivo', '')
L22838:             
L22839:             if not all([alumno_id, fecha_falta, motivo]):
L22840:                 return jsonify({'error': 'Faltan datos requeridos'}), 400
...

======================================================================
RUTA: /api/tutor/autorizaciones
======================================================================

--- Instancia 1: api_tutor_autorizaciones (Línea 2058) ---
L2058: @app.route('/api/tutor/autorizaciones', methods=['GET'])
L2059: @login_required
L2060: @role_required('tutor')
L2061: def api_tutor_autorizaciones():
L2062:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L2063:     # Obtener hijos
L2064:     cursor.execute("SELECT estudiante_id FROM tutores_estudiantes WHERE tutor_id = %s", (session['user_id'],))
L2065:     hijos = [h['estudiante_id'] for h in cursor.fetchall()]
L2066:     
L2067:     if not hijos: return jsonify([])
L2068:     
L2069:     format_strings = ','.join(['%s'] * len(hijos))
L2070:     cursor.execute(f"SELECT * FROM autorizaciones WHERE alumno_id IN ({format_strings}) ORDER BY fecha_creacion DESC", tuple(hijos))
L2071:     return jsonify(cursor.fetchall())
L2072: 
...

--- Instancia 2: tutor_autorizaciones (Línea 23010) ---
L23010: @app.route('/api/tutor/autorizaciones', methods=['GET', 'POST'])
L23011: @login_required
L23012: @role_required('tutor')
L23013: def tutor_autorizaciones():
L23014:     """Gestionar autorizaciones de eventos"""
L23015:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L23016:     
L23017:     if request.method == 'POST':
L23018:         try:
L23019:             data = request.json
L23020:             evento_id = data.get('evento_id')
L23021:             alumno_id = data.get('alumno_id')
L23022:             autorizado = data.get('autorizado', False)
L23023:             comentario = data.get('comentario', '')
L23024:             
...

======================================================================
RUTA: /api/tutor/pagos
======================================================================

--- Instancia 1: api_tutor_pagos (Línea 2073) ---
L2073: @app.route('/api/tutor/pagos', methods=['GET'])
L2074: @login_required
L2075: @role_required('tutor')
L2076: def api_tutor_pagos():
L2077:     # Simulación de pagos (ya que no tenemos tabla de pagos completa definida en el plan inicial, usamos datos dummy o tabla pagos si existe)
L2078:     # Asumimos que no existe tabla pagos compleja, retornamos datos simulados para el mockup
L2079:     pagos = [
L2080:         {'concepto': 'Colegiatura Septiembre', 'monto': 3500, 'fecha_limite': '2024-09-30', 'estado': 'pagado'},
L2081:         {'concepto': 'Colegiatura Octubre', 'monto': 3500, 'fecha_limite': '2024-10-31', 'estado': 'pendiente'},
L2082:         {'concepto': 'Seguro Escolar', 'monto': 1200, 'fecha_limite': '2024-08-15', 'estado': 'pagado'}
L2083:     ]
L2084:     return jsonify(pagos)
L2085: 
L2086: @app.route('/api/tutor/comunicados', methods=['GET'])
L2087: @login_required
...

--- Instancia 2: tutor_pagos (Línea 22576) ---
L22576: @app.route('/api/tutor/pagos', methods=['GET'])
L22577: @login_required
L22578: @role_required('tutor')
L22579: def tutor_pagos():
L22580:     """Ver pagos pendientes e historial"""
L22581:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L22582:     
L22583:     # Obtener IDs de los hijos primero
L22584:     cursor.execute("SELECT estudiante_id FROM tutores_estudiantes WHERE tutor_id = %s", (session['user_id'],))
L22585:     hijos_rows = cursor.fetchall()
L22586:     hijos_ids = [row['estudiante_id'] for row in hijos_rows]
L22587:     
L22588:     if not hijos_ids:
L22589:         return jsonify([])
L22590:         
...

======================================================================
RUTA: /api/orientador/justificantes
======================================================================

--- Instancia 1: api_orientador_justificantes_crear (Línea 2164) ---
L2164: @app.route('/api/orientador/justificantes', methods=['POST'])
L2165: @login_required
L2166: @role_required('orientador')
L2167: def api_orientador_justificantes_crear():
L2168:     data = request.json
L2169:     # Buscar ID de alumno por nombre (asumiendo input de nombre) o ID directo si el frontend lo maneja
L2170:     # Aquí asumimos que el frontend envía nombre y lo buscamos (limitación del diseño actual)
L2171:     cursor = mysql.connection.cursor()
L2172:     cursor.execute("SELECT id FROM usuarios WHERE nombre = %s AND rol='alumno'", (data['alumno'],))
L2173:     alumno = cursor.fetchone()
L2174:     
L2175:     if not alumno: return jsonify({'error': 'Alumno no encontrado'}), 404
L2176:     
L2177:     cursor.execute("""
L2178:         INSERT INTO justificantes (alumno_id, tutor_id, fecha_falta, motivo, estado, comentarios_escuela)
...

--- Instancia 2: orientador_crear_justificante (Línea 22348) ---
L22348: @app.route('/api/orientador/justificantes', methods=['POST'])
L22349: @login_required
L22350: @role_required('orientador')
L22351: def orientador_crear_justificante():
L22352:     """Crear justificante de falta para un alumno"""
L22353:     try:
L22354:         data = request.json
L22355:         alumno_nombre = data.get('alumno', '')
L22356:         fecha_falta = data.get('fecha')
L22357:         motivo = data.get('motivo', '')
L22358:         
L22359:         if not all([alumno_nombre, fecha_falta, motivo]):
L22360:             return jsonify({'error': 'Faltan datos requeridos'}), 400
L22361:         
L22362:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
...

======================================================================
RUTA: /api/tutor/notificaciones
======================================================================

--- Instancia 1: api_tutor_notificaciones (Línea 4410) ---
L4410: @app.route('/api/tutor/notificaciones', methods=['GET'])
L4411: @login_required
L4412: @role_required('tutor')
L4413: def api_tutor_notificaciones():
L4414:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L4415:     cursor.execute("""
L4416:         SELECT * FROM notificaciones_tutor WHERE tutor_id = %s AND archivada = 0
L4417:         AND (fecha_expiracion IS NULL OR fecha_expiracion > NOW())
L4418:         ORDER BY leida, prioridad DESC, fecha_creacion DESC LIMIT 30
L4419:     """, (session['user_id'],))
L4420:     return jsonify(cursor.fetchall())
L4421: 
L4422: @app.route('/api/tutor/notificaciones/<int:id>/leer', methods=['POST'])
L4423: @login_required
L4424: @role_required('tutor')
...

--- Instancia 2: tutor_notificaciones (Línea 21813) ---
L21813: @app.route('/api/tutor/notificaciones')
L21814: @login_required
L21815: @role_required('tutor')
L21816: def tutor_notificaciones():
L21817:     """Notificaciones y alertas de los hijos del tutor"""
L21818:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L21819:     
L21820:     # Alertas de hijos
L21821:     cursor.execute("""
L21822:         SELECT a.*, u.nombre as hijo_nombre
L21823:         FROM alertas_academicas a
L21824:         JOIN usuarios u ON a.alumno_id = u.id
L21825:         WHERE u.tutor_id = %s AND a.activa = 1
L21826:         ORDER BY a.fecha_creacion DESC
L21827:     """, (session['user_id'],))
...

======================================================================
RUTA: /panel-orientador
======================================================================

--- Instancia 1: panel_orientador (Línea 5924) ---
L5924: @app.route('/panel-orientador')
L5925: @login_required
L5926: @role_required('orientador')
L5927: def panel_orientador():
L5928:     """Panel principal del orientador"""
L5929:     try:
L5930:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L5931:         orientador_id = session['user_id']
L5932:         
L5933:         # Obtener info del usuario
L5934:         cursor.execute("SELECT nombre FROM usuarios WHERE id = %s", (orientador_id,))
L5935:         user_info = cursor.fetchone()
L5936:         nombre = user_info['nombre'] if user_info else 'Orientador'
L5937:         iniciales = ''.join([p[0].upper() for p in nombre.split()[:2]]) if nombre else 'OR'
L5938:         
...

--- Instancia 2: panel_orientador_v2 (Línea 27346) ---
L27346: @app.route('/panel-orientador')
L27347: @login_required
L27348: @role_required('orientador')
L27349: def panel_orientador_v2():
L27350:     try:
L27351:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L27352:         
L27353:         # Obtener info del orientador
L27354:         cursor.execute("""
L27355:             SELECT nombre, email FROM usuarios WHERE id = %s
L27356:         """, (session['user_id'],))
L27357:         orientador_info = cursor.fetchone()
L27358:         nombre = orientador_info['nombre'] if orientador_info else 'Orientador'
L27359:         email = orientador_info['email'] if orientador_info else ''
L27360:         
...

======================================================================
RUTA: /api/orientador/citas
======================================================================

--- Instancia 1: listar_citas_orientacion (Línea 6029) ---
L6029: @app.route('/api/orientador/citas', methods=['GET'])
L6030: @login_required
L6031: @role_required('orientador')
L6032: def listar_citas_orientacion():
L6033:     """Listar todas las citas del orientador"""
L6034:     try:
L6035:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L6036:         estado = request.args.get('estado', '')
L6037:         fecha_desde = request.args.get('fecha_desde', '')
L6038:         fecha_hasta = request.args.get('fecha_hasta', '')
L6039:         
L6040:         sql = """
L6041:             SELECT co.*, 
L6042:                    u.nombre as alumno_nombre, u.numero_control, u.semestre,
L6043:                    t.nombre as tutor_nombre
...

--- Instancia 2: crear_cita_orientacion (Línea 6081) ---
L6081: @app.route('/api/orientador/citas', methods=['POST'])
L6082: @login_required
L6083: @role_required('orientador')
L6084: def crear_cita_orientacion():
L6085:     """Crear nueva cita de orientación"""
L6086:     try:
L6087:         data = request.json
L6088:         required = ['alumno_id', 'fecha', 'hora', 'motivo']
L6089:         if not all(field in data for field in required):
L6090:             return jsonify({'error': 'Faltan campos obligatorios: alumno_id, fecha, hora, motivo'}), 400
L6091:         
L6092:         cursor = mysql.connection.cursor()
L6093:         cursor.execute("""
L6094:             INSERT INTO citas_orientacion 
L6095:             (alumno_id, orientador_id, fecha, hora, motivo, estado)
...

======================================================================
RUTA: /api/orientador/seguimiento
======================================================================

--- Instancia 1: listar_seguimientos (Línea 6691) ---
L6691: @app.route('/api/orientador/seguimiento', methods=['GET'])
L6692: @login_required
L6693: @role_required('orientador')
L6694: def listar_seguimientos():
L6695:     """Listar observaciones/seguimientos activos"""
L6696:     try:
L6697:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L6698:         estado = request.args.get('estado', 'activa')
L6699:         
L6700:         sql = """
L6701:             SELECT oa.*, u.nombre as alumno_nombre, u.numero_control,
L6702:                    t.nombre as tutor_nombre
L6703:             FROM observaciones_academicas oa
L6704:             JOIN usuarios u ON oa.alumno_id = u.id
L6705:             LEFT JOIN usuarios t ON oa.tutor_id = t.id
...

--- Instancia 2: crear_seguimiento (Línea 6733) ---
L6733: @app.route('/api/orientador/seguimiento', methods=['POST'])
L6734: @login_required
L6735: @role_required('orientador')
L6736: def crear_seguimiento():
L6737:     """Crear nuevo plan de seguimiento para un alumno"""
L6738:     try:
L6739:         data = request.json
L6740:         required = ['alumno_id', 'motivo', 'plan_mejora', 'fecha_inicio', 'fecha_limite']
L6741:         if not all(field in data for field in required):
L6742:             return jsonify({'error': 'Faltan campos obligatorios'}), 400
L6743:         
L6744:         cursor = mysql.connection.cursor()
L6745:         cursor.execute("""
L6746:             INSERT INTO observaciones_academicas 
L6747:             (alumno_id, tutor_id, motivo, plan_mejora, objetivos, fecha_inicio, fecha_limite, estado)
...

======================================================================
RUTA: /panel-tutor
======================================================================

--- Instancia 1: panel_tutor (Línea 7099) ---
L7099: @app.route('/panel-tutor')
L7100: @login_required
L7101: @role_required('tutor')
L7102: def panel_tutor():
L7103:     """Panel del tutor"""
L7104:     try:
L7105:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L7106:         
L7107:         # Obtener estudiantes asociados al tutor
L7108:         cursor.execute('''
L7109:             SELECT u.id, u.nombre, u.numero_control, u.email, u.rango, u.xp,
L7110:                    AVG(CASE WHEN et.calificacion IS NOT NULL THEN et.calificacion END) as promedio,
L7111:                    COUNT(CASE WHEN a.presente = 1 THEN 1 END) * 100.0 / COUNT(a.id) as asistencia
L7112:             FROM usuarios u
L7113:             JOIN tutores_estudiantes te ON u.id = te.estudiante_id
...

--- Instancia 2: panel_tutor_v2 (Línea 27380) ---
L27380: @app.route('/panel-tutor')
L27381: @login_required
L27382: @role_required('tutor')
L27383: def panel_tutor_v2():
L27384:     try:
L27385:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L27386:         
L27387:         # Obtener info del tutor actual
L27388:         cursor.execute("""
L27389:             SELECT nombre, email FROM usuarios WHERE id = %s
L27390:         """, (session['user_id'],))
L27391:         tutor_info = cursor.fetchone()
L27392:         nombre = tutor_info['nombre'] if tutor_info else 'Tutor'
L27393:         email = tutor_info['email'] if tutor_info else ''
L27394:         
...

======================================================================
RUTA: /api/tutor/estudiante/<int:estudiante_id>/detalle
======================================================================

--- Instancia 1: tutor_estudiante_detalle (Línea 7157) ---
L7157: @app.route('/api/tutor/estudiante/<int:estudiante_id>/detalle')
L7158: @login_required
L7159: @role_required('tutor')
L7160: def tutor_estudiante_detalle(estudiante_id):
L7161:     """Obtener detalle académico completo de un estudiante asignado"""
L7162:     try:
L7163:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L7164:         
L7165:         # Verificar que el estudiante pertenece al tutor
L7166:         cursor.execute("SELECT * FROM tutores_estudiantes WHERE tutor_id = %s AND estudiante_id = %s", 
L7167:                       (session['user_id'], estudiante_id))
L7168:         if not cursor.fetchone():
L7169:             return jsonify({'error': 'Estudiante no asignado a este tutor'}), 403
L7170: 
L7171:         # Promedio General
...

--- Instancia 2: tutor_estudiante_detalle_v2 (Línea 22605) ---
L22605: @app.route('/api/tutor/estudiante/<int:estudiante_id>/detalle', methods=['GET'])
L22606: @login_required
L22607: @role_required('tutor')
L22608: def tutor_estudiante_detalle_v2(estudiante_id):
L22609:     """Obtener reporte detallado de un estudiante"""
L22610:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L22611:     
L22612:     # Verificar que el estudiante pertenece a este tutor
L22613:     cursor.execute("""
L22614:         SELECT te.id FROM tutores_estudiantes te
L22615:         WHERE te.tutor_id = %s AND te.estudiante_id = %s
L22616:     """, (session['user_id'], estudiante_id))
L22617:     vinculo = cursor.fetchone()
L22618:     
L22619:     if not vinculo:
...

======================================================================
RUTA: /api/tasks
======================================================================

--- Instancia 1: handle_tasks (Línea 8218) ---
L8218: @app.route('/api/tasks', methods=['GET', 'POST'])
L8219: @login_required
L8220: def handle_tasks():
L8221:     if request.method == 'POST':
L8222:         if session['user_role'] != 'alumno':
L8223:             return jsonify({'error': 'No autorizado'}), 403
L8224:         files = request.files.getlist('files')
L8225:         subject = request.form['subject']
L8226:         group = request.form['group']
L8227:         title = request.form['title']
L8228:         comments = request.form['comments']
L8229:         try:
L8230:             cursor = mysql.connection.cursor()
L8231:             cursor.execute('INSERT INTO tareas (titulo, descripcion, materia_id, docente_id, fecha_vencimiento, valor_porcentaje, fecha_creacion) VALUES (%s, %s, %s, %s, NOW() + INTERVAL 7 DAY, 10.0, NOW())',
L8232:                            (title, comments, subject, session['user_id']))
...

--- Instancia 2: create_task (Línea 18868) ---
L18868: @app.route('/api/tasks', methods=['POST'])
L18869: @login_required
L18870: @role_required('docente')
L18871: def create_task():
L18872:     try:
L18873:         if 'title' not in request.form:
L18874:              return jsonify({'error': 'Falta el título'}), 400
L18875:              
L18876:         titulo = request.form['title']
L18877:         descripcion = request.form.get('description', '')
L18878:         fecha_vencimiento = request.form.get('due_date')
L18879:         materia_id = request.form.get('materia_id')
L18880:         valor = float(request.form.get('value', 10.0))
L18881: 
L18882:         if not materia_id:
...

======================================================================
RUTA: /api/resources
======================================================================

--- Instancia 1: handle_resources (Línea 8287) ---
L8287: @app.route('/api/resources', methods=['GET', 'POST'])
L8288: @login_required
L8289: @role_required('docente')
L8290: def handle_resources():
L8291:     upload_path = UPLOAD_FOLDER
L8292: 
L8293:     if request.method == 'POST':
L8294:         try:
L8295:             title = request.form.get('title', '').strip()
L8296:             description = request.form.get('description', '').strip()
L8297:             materia_id = request.form.get('materia')
L8298:             files = request.files.getlist('files')
L8299: 
L8300:             if not title or not description or not materia_id:
L8301:                 return jsonify({'error': 'Faltan campos'}), 400
...

--- Instancia 2: upload_resource (Línea 18989) ---
L18989: @app.route('/api/resources', methods=['POST'])
L18990: @login_required
L18991: @role_required('docente')
L18992: def upload_resource():
L18993:     try:
L18994:         if 'file' not in request.files:
L18995:             return jsonify({'error': 'No file part'}), 400
L18996:         
L18997:         file = request.files['file']
L18998:         materia_id = request.form.get('materia_id')
L18999:         titulo = request.form.get('title', file.filename)
L19000:         descripcion = request.form.get('description', '')
L19001: 
L19002:         if not materia_id:
L19003:             return jsonify({'error': 'Materia ID missing'}), 400
...

======================================================================
RUTA: /api/generar_quiz
======================================================================

--- Instancia 1: generar_quiz (Línea 9080) ---
L9080: @app.route('/api/generar_quiz', methods=['POST'])
L9081: @login_required
L9082: @role_required('docente')
L9083: def generar_quiz():
L9084:     if 'temario_pdf' not in request.files:
L9085:         return jsonify({'error': 'PDF requerido'}), 400
L9086: 
L9087:     file = request.files['temario_pdf']
L9088:     materia_id = request.form.get('materia_id')
L9089: 
L9090:     if not allowed_file(file.filename):
L9091:         return jsonify({'error': 'Formato no permitido'}), 400
L9092: 
L9093:     filename = secure_filename(file.filename)
L9094:     filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
...

--- Instancia 2: generar_quiz_ia (Línea 23409) ---
L23409: @app.route('/api/generar_quiz', methods=['POST'])
L23410: @login_required
L23411: @role_required('docente')
L23412: def generar_quiz_ia():
L23413:     """Generar preguntas de quiz con IA"""
L23414:     try:
L23415:         tema = request.form.get('tema', 'General')
L23416:         cantidad = int(request.form.get('cantidad', 5))
L23417:         materia_id = request.form.get('materia_id')
L23418:         
L23419:         # Usar Gemini para generar preguntas
L23420:         try:
L23421:             model = genai.GenerativeModel('gemini-pro')
L23422:             prompt = f"""Genera {cantidad} preguntas de opción múltiple sobre "{tema}".
L23423:             Formato JSON: [{{"pregunta": "...", "opciones": ["A) ...", "B) ...", "C) ...", "D) ..."], 
...

======================================================================
RUTA: /api/detectar_plagio
======================================================================

--- Instancia 1: detectar_plagio_v1 (Línea 9120) ---
L9120: @app.route('/api/detectar_plagio', methods=['POST'])
L9121: @login_required
L9122: @role_required('docente')
L9123: def detectar_plagio_v1():
L9124:     tarea_id = request.form.get('tarea_id')
L9125:     if not tarea_id:
L9126:         return jsonify({'error': 'Tarea requerida'}), 400
L9127: 
L9128:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L9129:     cursor.execute("SELECT estudiante_id, codigo_fuente FROM entregas_tareas WHERE tarea_id = %s AND codigo_fuente IS NOT NULL", (tarea_id,))
L9130:     entregas = cursor.fetchall()
L9131:     cursor.close()
L9132: 
L9133:     plagios = []
L9134:     for i in range(len(entregas)):
...

--- Instancia 2: detectar_plagio (Línea 23354) ---
L23354: @app.route('/api/detectar_plagio', methods=['POST'])
L23355: @login_required
L23356: @role_required('docente')
L23357: def detectar_plagio():
L23358:     """Detectar plagio en entregas de tareas"""
L23359:     try:
L23360:         tarea_id = request.form.get('tarea_id')
L23361:         
L23362:         if not tarea_id:
L23363:             return jsonify({'error': 'ID de tarea requerido'}), 400
L23364:         
L23365:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L23366:         
L23367:         # Obtener todas las entregas de esta tarea
L23368:         cursor.execute("""
...

======================================================================
RUTA: /api/stats_encuestas
======================================================================

--- Instancia 1: stats_encuestas (Línea 9552) ---
L9552: @app.route('/api/stats_encuestas', methods=['GET'])
L9553: @login_required
L9554: @role_required('admin')
L9555: def stats_encuestas():
L9556:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L9557:     cursor.execute("""
L9558:         SELECT e.titulo, AVG(re.puntuacion) as promedio, COUNT(re.id) as respuestas
L9559:         FROM encuestas e
L9560:         LEFT JOIN respuestas_encuestas re ON e.id = re.encuesta_id
L9561:         GROUP BY e.id
L9562:     """)
L9563:     stats = cursor.fetchall()
L9564:     cursor.close()
L9565:     return jsonify(stats)
L9566: 
...

--- Instancia 2: stats_encuestas_v2 (Línea 23444) ---
L23444: @app.route('/api/stats_encuestas', methods=['GET'])
L23445: @login_required
L23446: @role_required('admin')
L23447: def stats_encuestas_v2():
L23448:     """Estadísticas de encuestas docentes"""
L23449:     try:
L23450:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L23451:         cursor.execute("""
L23452:             SELECT COUNT(*) as total_encuestas,
L23453:                    SUM(CASE WHEN activa = 1 THEN 1 ELSE 0 END) as activas,
L23454:                    (SELECT COUNT(*) FROM respuestas_encuesta_docente) as total_respuestas
L23455:             FROM encuestas_docentes
L23456:         """)
L23457:         stats = cursor.fetchone()
L23458:         cursor.close()
...

======================================================================
RUTA: /api/crear-encuesta-docente
======================================================================

--- Instancia 1: crear_encuesta_docente (Línea 9675) ---
L9675: @app.route('/api/crear-encuesta-docente', methods=['POST'])
L9676: @login_required
L9677: @role_required('admin')
L9678: def crear_encuesta_docente():
L9679:     """Crear nueva encuesta de evaluación docente"""
L9680:     try:
L9681:         data = request.json
L9682:         required = ['docente_id', 'fecha_inicio', 'fecha_fin']
L9683:         if not all(field in data for field in required):
L9684:             return jsonify({'error': 'Faltan campos obligatorios (docente_id, fecha_inicio, fecha_fin)'}), 400
L9685:         
L9686:         cursor = mysql.connection.cursor()
L9687:         cursor.execute("""
L9688:             INSERT INTO encuestas_docentes (docente_id, materia_id, titulo, descripcion, fecha_inicio, fecha_fin, creado_por)
L9689:             VALUES (%s, %s, %s, %s, %s, %s, %s)
...

--- Instancia 2: crear_encuesta_docente_v2 (Línea 23522) ---
L23522: @app.route('/api/crear-encuesta-docente', methods=['POST'])
L23523: @login_required
L23524: @role_required('admin')
L23525: def crear_encuesta_docente_v2():
L23526:     """Crear nueva encuesta para evaluar docente"""
L23527:     try:
L23528:         data = request.json
L23529:         titulo = data.get('titulo')
L23530:         descripcion = data.get('descripcion', '')
L23531:         docente_id = data.get('docente_id')
L23532:         materia_id = data.get('materia_id')
L23533:         preguntas = data.get('preguntas', [])
L23534:         fecha_limite = data.get('fecha_limite')
L23535:         xp_recompensa = data.get('xp_recompensa', 10)
L23536:         
...

======================================================================
RUTA: /api/ai-generar-encuesta
======================================================================

--- Instancia 1: ai_generar_encuesta (Línea 9807) ---
L9807: @app.route('/api/ai-generar-encuesta', methods=['POST'])
L9808: @login_required
L9809: @role_required('admin')
L9810: def ai_generar_encuesta():
L9811:     """Genera preguntas de encuesta usando Gemini AI"""
L9812:     try:
L9813:         data = request.json
L9814:         tema = data.get('tema', 'evaluación docente')
L9815:         
L9816:         model = genai.GenerativeModel('gemini-1.5-flash')
L9817:         
L9818:         prompt = f"""Genera 5 preguntas para una encuesta de {tema} en un contexto educativo.
L9819:         
L9820: Formato de respuesta (JSON):
L9821: {{
...

--- Instancia 2: ai_generar_encuesta_v2 (Línea 23557) ---
L23557: @app.route('/api/ai-generar-encuesta', methods=['POST'])
L23558: @login_required
L23559: @role_required('admin')
L23560: def ai_generar_encuesta_v2():
L23561:     """Generar preguntas de encuesta con IA"""
L23562:     try:
L23563:         data = request.json
L23564:         tipo = data.get('tipo', 'evaluacion_docente')
L23565:         cantidad = data.get('cantidad', 5)
L23566:         
L23567:         try:
L23568:             model = genai.GenerativeModel('gemini-pro')
L23569:             prompt = f"""Genera {cantidad} preguntas para una encuesta de {tipo}.
L23570:             Formato JSON: [{{"pregunta": "...", "tipo": "escala_1_5"}}]
L23571:             Las preguntas deben evaluar aspectos como metodología, claridad, puntualidad, etc.
...

======================================================================
RUTA: /api/stats_pagos
======================================================================

--- Instancia 1: stats_pagos (Línea 9850) ---
L9850: @app.route('/api/stats_pagos', methods=['GET'])
L9851: @login_required
L9852: @role_required('admin')
L9853: def stats_pagos():
L9854:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L9855:     cursor.execute("""
L9856:         SELECT SUM(monto) as total, SUM(CASE WHEN pagado = 1 THEN monto ELSE 0 END) as pagado,
L9857:                COUNT(CASE WHEN pagado = 0 THEN 1 END) as pendientes
L9858:         FROM pagos
L9859:     """)
L9860:     stats = cursor.fetchone()
L9861:     cursor.close()
L9862:     return jsonify(stats)
L9863: 
L9864: # Nueva ruta para asistencias stats
...

--- Instancia 2: stats_pagos_v2 (Línea 23463) ---
L23463: @app.route('/api/stats_pagos', methods=['GET'])
L23464: @login_required
L23465: @role_required('admin')
L23466: def stats_pagos_v2():
L23467:     """Estadísticas de pagos"""
L23468:     try:
L23469:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L23470:         cursor.execute("""
L23471:             SELECT COUNT(*) as total_pagos,
L23472:                    SUM(CASE WHEN estado = 'pagado' THEN 1 ELSE 0 END) as pagados,
L23473:                    SUM(CASE WHEN estado = 'pendiente' THEN 1 ELSE 0 END) as pendientes,
L23474:                    SUM(CASE WHEN estado = 'pagado' THEN monto ELSE 0 END) as monto_recaudado
L23475:             FROM pagos_pendientes
L23476:         """)
L23477:         stats = cursor.fetchone()
...

======================================================================
RUTA: /api/stats_asistencias
======================================================================

--- Instancia 1: stats_asistencias (Línea 9865) ---
L9865: @app.route('/api/stats_asistencias', methods=['GET'])
L9866: @login_required
L9867: @role_required('admin')
L9868: def stats_asistencias():
L9869:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L9870:     cursor.execute("""
L9871:         SELECT AVG(presente)*100 as promedio_global,
L9872:                (SELECT COUNT(*) FROM asistencias WHERE presente = 0) as faltas_total
L9873:         FROM asistencias
L9874:     """)
L9875:     stats = cursor.fetchone()
L9876:     cursor.close()
L9877:     return jsonify(stats)
L9878: 
L9879: # Nueva ruta para mensajes stats
...

--- Instancia 2: stats_asistencias_v2 (Línea 23483) ---
L23483: @app.route('/api/stats_asistencias', methods=['GET'])
L23484: @login_required
L23485: @role_required('admin')
L23486: def stats_asistencias_v2():
L23487:     """Estadísticas de asistencias"""
L23488:     try:
L23489:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L23490:         cursor.execute("""
L23491:             SELECT COUNT(*) as total_registros,
L23492:                    SUM(CASE WHEN presente = 1 THEN 1 ELSE 0 END) as presentes,
L23493:                    ROUND(AVG(presente) * 100, 1) as porcentaje_asistencia
L23494:             FROM qr_asistencias
L23495:         """)
L23496:         stats = cursor.fetchone()
L23497:         cursor.close()
...

======================================================================
RUTA: /api/stats_gamificacion
======================================================================

--- Instancia 1: stats_gamificacion (Línea 9908) ---
L9908: @app.route('/api/stats_gamificacion', methods=['GET'])
L9909: @login_required
L9910: @role_required('admin')
L9911: def stats_gamificacion():
L9912:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L9913:     cursor.execute("""
L9914:         SELECT rango, COUNT(*) as count
L9915:         FROM usuarios
L9916:         WHERE tipo_usuario = 'alumno'
L9917:         GROUP BY rango
L9918:     """)
L9919:     rangos = cursor.fetchall()
L9920:     cursor.execute("SELECT AVG(xp) as xp_promedio, AVG(racha) as racha_promedio FROM usuarios WHERE tipo_usuario = 'alumno'")
L9921:     promedios = cursor.fetchone()
L9922:     cursor.close()
...

--- Instancia 2: stats_gamificacion_v2 (Línea 23502) ---
L23502: @app.route('/api/stats_gamificacion', methods=['GET'])
L23503: @login_required
L23504: @role_required('admin')
L23505: def stats_gamificacion_v2():
L23506:     """Estadísticas de gamificación"""
L23507:     try:
L23508:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L23509:         cursor.execute("""
L23510:             SELECT SUM(xp) as total_xp,
L23511:                    AVG(xp) as promedio_xp,
L23512:                    SUM(educoins) as total_educoins,
L23513:                    (SELECT COUNT(*) FROM usuario_insignias) as insignias_otorgadas
L23514:             FROM usuarios WHERE tipo_usuario = 'alumno'
L23515:         """)
L23516:         stats = cursor.fetchone()
...

======================================================================
RUTA: /api/search_logs
======================================================================

--- Instancia 1: search_logs (Línea 9926) ---
L9926: @app.route('/api/search_logs', methods=['POST'])
L9927: @login_required
L9928: @role_required('admin')
L9929: def search_logs():
L9930:     data = request.json
L9931:     query = data.get('query', '')
L9932: 
L9933:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L9934:     sql = """
L9935:         SELECT la.id, u.nombre as usuario, la.accion, la.descripcion, la.modulo, la.fecha, la.ip
L9936:         FROM logs_auditoria la
L9937:         LEFT JOIN usuarios u ON la.usuario_id = u.id
L9938:         WHERE la.descripcion LIKE %s OR la.accion LIKE %s OR la.modulo LIKE %s
L9939:         ORDER BY la.fecha DESC
L9940:         LIMIT 50
...

--- Instancia 2: search_logs_v2 (Línea 23587) ---
L23587: @app.route('/api/search_logs', methods=['POST'])
L23588: @login_required
L23589: @role_required('admin')
L23590: def search_logs_v2():
L23591:     """Buscar en logs de auditoría"""
L23592:     try:
L23593:         data = request.json
L23594:         query = data.get('query', '')
L23595:         fecha_inicio = data.get('fecha_inicio')
L23596:         fecha_fin = data.get('fecha_fin')
L23597:         tipo = data.get('tipo')
L23598:         limit = data.get('limit', 100)
L23599:         
L23600:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L23601:         
...

======================================================================
RUTA: /api/backup_bd
======================================================================

--- Instancia 1: backup_bd (Línea 9948) ---
L9948: @app.route('/api/backup_bd', methods=['POST'])
L9949: @login_required
L9950: @role_required('admin')
L9951: def backup_bd():
L9952:     # Usar mysqldump o similar en producción
L9953:     backup_path = os.path.join(app.config['UPLOAD_FOLDER'], f'backup_{datetime.now().strftime("%Y%m%d")}.sql')
L9954:     # Código para dump
L9955:     with open(backup_path, 'w') as f:
L9956:         f.write(" -- Backup simulado -- ")
L9957: 
L9958:     log_accion('backup_bd', 'Backup de BD generado', session['user_id'])
L9959: 
L9960:     return jsonify({'success': 'Backup generado', 'path': backup_path})
L9961: 
L9962: # Nueva ruta para restore BD (simulado)
...

--- Instancia 2: backup_bd_v2 (Línea 23638) ---
L23638: @app.route('/api/backup_bd', methods=['POST'])
L23639: @login_required
L23640: @role_required('admin')
L23641: def backup_bd_v2():
L23642:     """Crear backup de la base de datos"""
L23643:     try:
L23644:         import subprocess
L23645:         from datetime import datetime
L23646:         
L23647:         timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
L23648:         backup_file = f"backup_{timestamp}.sql"
L23649:         backup_path = os.path.join(app.config['UPLOAD_FOLDER'], 'backups', backup_file)
L23650:         
L23651:         # Crear directorio si no existe
L23652:         os.makedirs(os.path.dirname(backup_path), exist_ok=True)
...

======================================================================
RUTA: /api/restore_bd
======================================================================

--- Instancia 1: restore_bd (Línea 9963) ---
L9963: @app.route('/api/restore_bd', methods=['POST'])
L9964: @login_required
L9965: @role_required('admin')
L9966: def restore_bd():
L9967:     # En producción,小心
L9968:     log_accion('restore_bd', 'Restore de BD ejecutado', session['user_id'])
L9969:     return jsonify({'success': 'Restore ejecutado'})
L9970: 
L9971: # Nueva ruta para configuración sistema
L9972: @app.route('/api/config_sistema', methods=['GET', 'POST'])
L9973: @login_required
L9974: @role_required('admin')
L9975: def config_sistema():
L9976:     if request.method == 'POST':
L9977:         data = request.json
...

--- Instancia 2: restore_bd_v2 (Línea 23669) ---
L23669: @app.route('/api/restore_bd', methods=['POST'])
L23670: @login_required
L23671: @role_required('admin')
L23672: def restore_bd_v2():
L23673:     """Restaurar backup de base de datos"""
L23674:     try:
L23675:         if 'file' not in request.files:
L23676:             return jsonify({'error': 'Archivo de backup requerido'}), 400
L23677:         
L23678:         file = request.files['file']
L23679:         if not file.filename.endswith('.sql'):
L23680:             return jsonify({'error': 'Debe ser un archivo .sql'}), 400
L23681:         
L23682:         # En producción: ejecutar el SQL
L23683:         # Por seguridad, aquí solo simulamos
...

======================================================================
RUTA: /api/examen/<int:examen_id>
======================================================================

--- Instancia 1: actualizar_examen (Línea 14839) ---
L14839: @app.route('/api/examen/<int:examen_id>', methods=['PUT'])
L14840: @login_required
L14841: @role_required('docente')
L14842: def actualizar_examen(examen_id):
L14843:     """Actualizar metadatos del examen (título, fechas, tiempo límite)."""
L14844:     try:
L14845:         data = request.json
L14846:         cursor = mysql.connection.cursor()
L14847:         
L14848:         # Verificar que el examen pertenece al docente
L14849:         cursor.execute("SELECT id FROM examenes WHERE id = %s AND docente_id = %s", 
L14850:                       (examen_id, session['user_id']))
L14851:         if not cursor.fetchone():
L14852:             cursor.close()
L14853:             return jsonify({'error': 'Examen no encontrado o sin permisos'}), 404
...

--- Instancia 2: eliminar_examen (Línea 14877) ---
L14877: @app.route('/api/examen/<int:examen_id>', methods=['DELETE'])
L14878: @login_required
L14879: @role_required('docente')
L14880: def eliminar_examen(examen_id):
L14881:     """Eliminar examen y todas sus preguntas y respuestas asociadas."""
L14882:     try:
L14883:         cursor = mysql.connection.cursor()
L14884:         
L14885:         # Verificar que el examen pertenece al docente
L14886:         cursor.execute("SELECT id FROM examenes WHERE id = %s AND docente_id = %s", 
L14887:                       (examen_id, session['user_id']))
L14888:         if not cursor.fetchone():
L14889:             cursor.close()
L14890:             return jsonify({'error': 'Examen no encontrado o sin permisos'}), 404
L14891:         
...

======================================================================
RUTA: /api/alumno/entregar-tarea
======================================================================

--- Instancia 1: submit_homework (Línea 19032) ---
L19032: @app.route('/api/alumno/entregar-tarea', methods=['POST'])
L19033: @login_required
L19034: @role_required('alumno')
L19035: def submit_homework():
L19036:     try:
L19037:         if 'file' not in request.files:
L19038:              return jsonify({'error': 'No se encontró el archivo'}), 400
L19039:         
L19040:         file = request.files['file']
L19041:         tarea_id = request.form.get('tarea_id')
L19042:         comentarios = request.form.get('comentarios', '')
L19043:         
L19044:         if not tarea_id:
L19045:              return jsonify({'error': 'Falta el ID de la tarea'}), 400
L19046: 
...

--- Instancia 2: api_alumno_entregar_tarea (Línea 28130) ---
L28130: @app.route('/api/alumno/entregar-tarea', methods=['POST'])
L28131: @login_required
L28132: def api_alumno_entregar_tarea():
L28133:     """Entregar tarea con archivo adjunto"""
L28134:     user_id = session['user_id']
L28135:     tarea_id = request.form.get('tarea_id')
L28136:     comentarios = request.form.get('comentarios', '')
L28137:     
L28138:     if not tarea_id:
L28139:         return jsonify({'error': 'ID de tarea requerido'}), 400
L28140:     
L28141:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L28142:     
L28143:     # Verificar que la tarea existe y no está vencida
L28144:     cursor.execute("SELECT * FROM tareas WHERE id = %s", (tarea_id,))
...

======================================================================
RUTA: /api/calendar/events/<int:event_id>
======================================================================

--- Instancia 1: update_calendar_event (Línea 19192) ---
L19192: @app.route('/api/calendar/events/<int:event_id>', methods=['PUT'])
L19193: @login_required
L19194: def update_calendar_event(event_id):
L19195:     """Actualizar evento personal"""
L19196:     try:
L19197:         data = request.get_json()
L19198:         cursor = mysql.connection.cursor()
L19199:         
L19200:         cursor.execute("""
L19201:             UPDATE eventos_personales 
L19202:             SET titulo = %s, descripcion = %s, fecha = %s, completado = %s
L19203:             WHERE id = %s AND usuario_id = %s
L19204:         """, (data['titulo'], data.get('descripcion', ''), data['fecha'], 
L19205:               data.get('completado', 0), event_id, session['user_id']))
L19206:         
...

--- Instancia 2: delete_calendar_event (Línea 19214) ---
L19214: @app.route('/api/calendar/events/<int:event_id>', methods=['DELETE'])
L19215: @login_required
L19216: def delete_calendar_event(event_id):
L19217:     """Eliminar evento personal"""
L19218:     try:
L19219:         cursor = mysql.connection.cursor()
L19220:         cursor.execute("DELETE FROM eventos_personales WHERE id = %s AND usuario_id = %s", 
L19221:                       (event_id, session['user_id']))
L19222:         mysql.connection.commit()
L19223:         cursor.close()
L19224:         return jsonify({'success': True})
L19225:     except Exception as e:
L19226:         return jsonify({'error': str(e)}), 500
L19227: 
L19228: 
...

======================================================================
RUTA: /api/notifications/<int:notif_id>/read
======================================================================

--- Instancia 1: mark_notification_read (Línea 19309) ---
L19309: @app.route('/api/notifications/<int:notif_id>/read', methods=['PUT'])
L19310: @login_required
L19311: def mark_notification_read(notif_id):
L19312:     """Marcar notificación como leída"""
L19313:     try:
L19314:         cursor = mysql.connection.cursor()
L19315:         cursor.execute("""
L19316:             UPDATE notificaciones_alumno SET leida = 1 
L19317:             WHERE id = %s AND usuario_id = %s
L19318:         """, (notif_id, session['user_id']))
L19319:         mysql.connection.commit()
L19320:         cursor.close()
L19321:         return jsonify({'success': True})
L19322:     except Exception as e:
L19323:         return jsonify({'error': str(e)}), 500
...

--- Instancia 2: alumno_mark_notification_read (Línea 20626) ---
L20626: @app.route('/api/notifications/<int:notif_id>/read', methods=['PUT'])
L20627: @login_required
L20628: def alumno_mark_notification_read(notif_id):
L20629:     """Marcar notificación como leída"""
L20630:     try:
L20631:         cursor = mysql.connection.cursor()
L20632:         cursor.execute("""
L20633:             UPDATE notificaciones_alumno SET leida = 1 
L20634:             WHERE id = %s AND usuario_id = %s
L20635:         """, (notif_id, session['user_id']))
L20636:         mysql.connection.commit()
L20637:         cursor.close()
L20638:         
L20639:         return jsonify({'success': True})
L20640:     except Exception as e:
...

======================================================================
RUTA: /api/notifications/read-all
======================================================================

--- Instancia 1: mark_all_notifications_read (Línea 19325) ---
L19325: @app.route('/api/notifications/read-all', methods=['PUT'])
L19326: @login_required
L19327: def mark_all_notifications_read():
L19328:     """Marcar todas las notificaciones como leídas"""
L19329:     try:
L19330:         cursor = mysql.connection.cursor()
L19331:         cursor.execute("""
L19332:             UPDATE notificaciones_alumno SET leida = 1 
L19333:             WHERE usuario_id = %s
L19334:         """, (session['user_id'],))
L19335:         mysql.connection.commit()
L19336:         cursor.close()
L19337:         return jsonify({'success': True})
L19338:     except Exception as e:
L19339:         return jsonify({'error': str(e)}), 500
...

--- Instancia 2: alumno_mark_all_notifications_read (Línea 20643) ---
L20643: @app.route('/api/notifications/read-all', methods=['PUT'])
L20644: @login_required
L20645: def alumno_mark_all_notifications_read():
L20646:     """Marcar todas las notificaciones como leídas"""
L20647:     try:
L20648:         cursor = mysql.connection.cursor()
L20649:         cursor.execute("""
L20650:             UPDATE notificaciones_alumno SET leida = 1 
L20651:             WHERE usuario_id = %s
L20652:         """, (session['user_id'],))
L20653:         mysql.connection.commit()
L20654:         cursor.close()
L20655:         
L20656:         return jsonify({'success': True})
L20657:     except Exception as e:
...

======================================================================
RUTA: /api/profile
======================================================================

--- Instancia 1: get_profile (Línea 19343) ---
L19343: @app.route('/api/profile', methods=['GET'])
L19344: @login_required
L19345: def get_profile():
L19346:     """Obtener datos del perfil del usuario"""
L19347:     try:
L19348:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L19349:         cursor.execute("""
L19350:             SELECT nombre, email, telefono, foto_perfil, avatar_url, tema, 
L19351:                    xp, educoins, racha, rango
L19352:             FROM usuarios WHERE id = %s
L19353:         """, (session['user_id'],))
L19354:         user = cursor.fetchone()
L19355:         cursor.close()
L19356:         
L19357:         if user:
...

--- Instancia 2: update_profile_settings (Línea 19412) ---
L19412: @app.route('/api/profile', methods=['PUT'])
L19413: @login_required
L19414: def update_profile_settings():
L19415:     """Actualizar configuración del perfil"""
L19416:     try:
L19417:         data = request.get_json()
L19418:         cursor = mysql.connection.cursor()
L19419:         
L19420:         # Solo permitir actualizar ciertos campos
L19421:         allowed_fields = ['telefono', 'tema']
L19422:         updates = []
L19423:         values = []
L19424:         
L19425:         for field in allowed_fields:
L19426:             if field in data:
...

======================================================================
RUTA: /api/profile/upload-photo
======================================================================

--- Instancia 1: upload_profile_photo (Línea 19374) ---
L19374: @app.route('/api/profile/upload-photo', methods=['POST'])
L19375: @login_required
L19376: def upload_profile_photo():
L19377:     """Subir foto de perfil"""
L19378:     try:
L19379:         if 'photo' not in request.files:
L19380:             return jsonify({'error': 'No se envió ninguna foto'}), 400
L19381:         
L19382:         file = request.files['photo']
L19383:         if file.filename == '':
L19384:             return jsonify({'error': 'No se seleccionó ningún archivo'}), 400
L19385:         
L19386:         # Validar extensión
L19387:         allowed = {'png', 'jpg', 'jpeg', 'gif', 'webp'}
L19388:         ext = file.filename.rsplit('.', 1)[1].lower() if '.' in file.filename else ''
...

--- Instancia 2: alumno_upload_profile_photo (Línea 20661) ---
L20661: @app.route('/api/profile/upload-photo', methods=['POST'])
L20662: @login_required
L20663: def alumno_upload_profile_photo():
L20664:     """Subir foto de perfil"""
L20665:     try:
L20666:         if 'photo' not in request.files:
L20667:             return jsonify({'success': False, 'error': 'No se envió foto'}), 400
L20668:         
L20669:         file = request.files['photo']
L20670:         if file.filename == '':
L20671:             return jsonify({'success': False, 'error': 'Archivo vacío'}), 400
L20672:         
L20673:         if file and allowed_file(file.filename):
L20674:             ext = file.filename.rsplit('.', 1)[1].lower()
L20675:             filename = f"profile_{session['user_id']}_{datetime.now().strftime('%Y%m%d%H%M%S')}.{ext}"
...

======================================================================
RUTA: /api/whiteboard
======================================================================

--- Instancia 1: get_whiteboards (Línea 19444) ---
L19444: @app.route('/api/whiteboard', methods=['GET'])
L19445: @login_required
L19446: def get_whiteboards():
L19447:     """Obtener pizarrones del usuario"""
L19448:     try:
L19449:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L19450:         cursor.execute("""
L19451:             SELECT id, titulo, color, miniatura_base64, fecha_creacion, fecha_modificacion
L19452:             FROM notas_pizarron
L19453:             WHERE usuario_id = %s
L19454:             ORDER BY fecha_modificacion DESC
L19455:         """, (session['user_id'],))
L19456:         pizarrones = cursor.fetchall()
L19457:         cursor.close()
L19458:         
...

--- Instancia 2: create_personal_whiteboard (Línea 19500) ---
L19500: @app.route('/api/whiteboard', methods=['POST'])
L19501: @login_required
L19502: def create_personal_whiteboard():
L19503:     """Crear nuevo pizarrón personal"""
L19504:     try:
L19505:         data = request.get_json()
L19506:         cursor = mysql.connection.cursor()
L19507:         
L19508:         cursor.execute("""
L19509:             INSERT INTO notas_pizarron (usuario_id, titulo, color, contenido_json)
L19510:             VALUES (%s, %s, %s, %s)
L19511:         """, (session['user_id'], 
L19512:               data.get('titulo', 'Sin título'), 
L19513:               data.get('color', '#ffd966'),
L19514:               data.get('contenido', '{}')))
...

======================================================================
RUTA: /api/chat/conversations
======================================================================

--- Instancia 1: get_chat_conversations (Línea 19864) ---
L19864: @app.route('/api/chat/conversations', methods=['GET'])
L19865: @login_required
L19866: def get_chat_conversations():
L19867:     """Obtener lista de conversaciones del usuario"""
L19868:     try:
L19869:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L19870:         user_id = session['user_id']
L19871:         
L19872:         # 1. Obtener conversaciones existentes (individuales y grupos)
L19873:         cursor.execute("""
L19874:             SELECT c.id, c.tipo, c.nombre, c.ultima_actividad,
L19875:                    (SELECT COUNT(*) FROM chat_mensajes m 
L19876:                     WHERE m.conversacion_id = c.id 
L19877:                     AND m.fecha_envio > (SELECT ultimo_acceso FROM chat_participantes 
L19878:                                          WHERE conversacion_id = c.id AND usuario_id = %s)) as no_leidos
...

--- Instancia 2: alumno_get_chat_conversations (Línea 20528) ---
L20528: @app.route('/api/chat/conversations', methods=['GET'])
L20529: @login_required
L20530: def alumno_get_chat_conversations():
L20531:     """Obtener conversaciones del usuario"""
L20532:     try:
L20533:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L20534:         cursor.execute("""
L20535:             SELECT c.id, c.tipo, 
L20536:                    CASE WHEN c.tipo = 'grupo' THEN c.nombre
L20537:                         ELSE (SELECT nombre FROM usuarios WHERE id = (
L20538:                             SELECT usuario_id FROM chat_participantes 
L20539:                             WHERE conversacion_id = c.id AND usuario_id != %s LIMIT 1
L20540:                         )) 
L20541:                    END as nombre,
L20542:                    c.ultima_actividad
...

======================================================================
RUTA: /api/alumno/tutorias
======================================================================

--- Instancia 1: alumno_tutorias (Línea 20939) ---
L20939: @app.route('/api/alumno/tutorias', methods=['GET'])
L20940: @login_required
L20941: @role_required('alumno')
L20942: def alumno_tutorias():
L20943:     """Ver tutorías asignadas al alumno"""
L20944:     try:
L20945:         cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L20946:         
L20947:         # Obtener tutor asignado
L20948:         cursor.execute("""
L20949:             SELECT u.id, u.nombre, u.email, u.telefono
L20950:             FROM tutores_estudiantes te
L20951:             JOIN usuarios u ON te.tutor_id = u.id
L20952:             WHERE te.estudiante_id = %s
L20953:         """, (session['user_id'],))
...

--- Instancia 2: api_alumno_tutorias (Línea 28084) ---
L28084: @app.route('/api/alumno/tutorias', methods=['GET', 'POST'])
L28085: @login_required
L28086: def api_alumno_tutorias():
L28087:     """Gestionar citas de tutoría del alumno"""
L28088:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L28089:     user_id = session['user_id']
L28090:     
L28091:     if request.method == 'POST':
L28092:         data = request.json
L28093:         fecha_hora = data.get('fecha_hora')
L28094:         tutor_id = data.get('tutor_id', 1)  # Default tutor
L28095:         motivo = data.get('motivo', 'academico')
L28096:         
L28097:         cursor.execute("""
L28098:             INSERT INTO citas_tutoria (tutor_id, estudiante_id, fecha_hora, estado, notas)
...

======================================================================
RUTA: /api/tutor/hijos
======================================================================

--- Instancia 1: tutor_hijos (Línea 21658) ---
L21658: @app.route('/api/tutor/hijos')
L21659: @login_required
L21660: @role_required('tutor')
L21661: def tutor_hijos():
L21662:     """Listar hijos del tutor con información básica"""
L21663:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L21664:     
L21665:     cursor.execute("""
L21666:         SELECT id, nombre, numero_control, email, xp, rango, racha_actual
L21667:         FROM usuarios
L21668:         WHERE tutor_id = %s AND tipo_usuario = 'alumno'
L21669:     """, (session['user_id'],))
L21670:     hijos = cursor.fetchall()
L21671:     cursor.close()
L21672:     return jsonify(hijos)
...

--- Instancia 2: tutor_hijos_v2 (Línea 22495) ---
L22495: @app.route('/api/tutor/hijos', methods=['GET'])
L22496: @login_required
L22497: @role_required('tutor')
L22498: def tutor_hijos_v2():
L22499:     """Obtener hijos/estudiantes vinculados al tutor"""
L22500:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L22501:     cursor.execute("""
L22502:         SELECT u.id, u.nombre, u.email, u.foto_perfil, u.grado, u.grupo
L22503:         FROM usuarios u
L22504:         JOIN tutores_estudiantes te ON u.id = te.estudiante_id
L22505:         WHERE te.tutor_id = %s
L22506:     """, (session['user_id'],))
L22507:     hijos = cursor.fetchall()
L22508:     cursor.close()
L22509:     return jsonify(hijos)
...

======================================================================
RUTA: /api/admin/grupos
======================================================================

--- Instancia 1: admin_grupos (Línea 21976) ---
L21976: @app.route('/api/admin/grupos', methods=['GET', 'POST', 'PUT', 'DELETE'])
L21977: @login_required
L21978: @role_required('admin')
L21979: def admin_grupos():
L21980:     """CRUD completo de grupos"""
L21981:     cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
L21982:     
L21983:     if request.method == 'POST':
L21984:         try:
L21985:             data = request.json
L21986:             cursor.execute("""
L21987:                 INSERT INTO grupos (nombre, semestre, turno, orientador_id, activo)
L21988:                 VALUES (%s, %s, %s, %s, 1)
L21989:             """, (data['nombre'], data.get('semestre'), data.get('turno', 'matutino'), data.get('orientador_id')))
L21990:             grupo_id = cursor.lastrowid
...

--- Instancia 2: admin_grupos_crud (Línea 27628) ---
L27628: @app.route('/api/admin/grupos', methods=['GET', 'POST'])
L27629: def admin_grupos_crud():
L27630:     cursor = mysql.connection.cursor()
L27631:     if request.method == 'POST':
L27632:         data = request.json
L27633:         try:
L27634:             cursor.execute("INSERT INTO grupos (nombre, descripcion, semestre) VALUES (%s, %s, %s)",
L27635:                           (data['nombre'], data.get('descripcion'), data.get('semestre')))
L27636:             mysql.connection.commit()
L27637:             return jsonify({'status': 'ok'}), 201
L27638:         except Exception as e:
L27639:             return jsonify({'error': str(e)}), 500
L27640: 
L27641:     cursor.execute("SELECT * FROM grupos ORDER BY nombre")
L27642:     columns = [col[0] for col in cursor.description]
...
